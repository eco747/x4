var t=this&&this.__createBinding||(Object.create?function(t,e,s,i){void 0===i&&(i=s),Object.defineProperty(t,i,{enumerable:!0,get:function(){return e[s]}})}:function(t,e,s,i){void 0===i&&(i=s),t[i]=e[s]}),e=this&&this.__exportStar||function(e,s){for(var i in e)"default"===i||Object.prototype.hasOwnProperty.call(s,i)||t(s,e,i)};define("x4/x4_events",["require","exports"],(function(t,e){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.EventSource=e.EvDrag=e.EvMessage=e.EvTimer=e.EvContextMenu=e.EvSelectionChange=e.EvChange=e.EvClick=e.BasicEvent=void 0;const s=function(){this.propagationStopped=!0},i=function(){this.defaultPrevented=!0};function o(t){return{stopPropagation:s,preventDefault:i,...t}}e.BasicEvent=o,e.EvClick=function(t=null){return o({context:t})},e.EvChange=function(t,e=null){return o({value:t,context:e})},e.EvSelectionChange=function(t,e=null){return o({selection:t,context:e})},e.EvContextMenu=function(t,e=null){return o({uievent:t,context:e})},e.EvTimer=function(t,e=0,s=null){return o({timer:t,time:e,context:s})},e.EvMessage=function(t,e,s){return o({msg:t,params:e,source:s})},e.EvDrag=function(t,e,s){return o({element:t,data:e,context:s})};e.EventSource=class EventSource{m_source;m_eventRegistry;m_defaultHandlers;constructor(t=null){this.m_source=t??this}emit(t,e){this._emit(t,e)}_emit(t,e){let o=this.m_eventRegistry?.get(t);const n=this.m_defaultHandlers?.get(t);if(e||(e={}),e.source||(e.source=this.m_source),e.type||(e.type=t),o&&o.length)if(e.preventDefault||(e.preventDefault=i),e.stopPropagation||(e.stopPropagation=s),1==o.length)o[0](e);else{const t=o.slice();for(let s=0,i=t.length;s<i&&(t[s](e),!e.propagationStopped);s++);}if(n&&n.length&&!e.defaultPrevented)return n[0](e)}signal(t,e,s=-1){this._signal(t,e,s)}_signal(t,e,s=-1){if(!this.m_eventRegistry)return;const i=this.m_eventRegistry.get(t);if(i&&i.length)if(e||(e={}),e.type||(e.type=t),e.source||(e.source=this.m_source),e.preventDefault=e.stopPropagation=()=>{console.error("this event cannot be stopped not default prevented")},1==i.length&&-1==s)i[0](e);else{const t=i.slice(),o=()=>{for(let s=0,i=t.length;s<i;s++)t[s](e)};-1==s?o():setTimeout(o,s)}}once(t,e){this._once(t,e)}_once(t,e){const s=i=>{this.off(t,s),e(i)};if(this._on(t,s),!e)return new Promise((function(t){e=t}))}setDefaultHandler(t,e){let s=this.m_defaultHandlers;s||(s=this.m_defaultHandlers=new Map);let i=s.get(t);if(i){const t=i.indexOf(e);-1!=t&&i.splice(t,1),i.unshift(e)}else s.set(t,[e])}removeDefaultHandler(t,e){const s=this.m_defaultHandlers;if(!s)return;const i=s.get(t);if(i){const t=i.indexOf(e);-1!=t&&i.splice(t,1)}}listen(t){for(let e in t)this._on(e,t[e])}defaults(t){for(let e in t)this.setDefaultHandler(e,t[e])}on(t,e){return this._on(t,e)}_on(t,e,s=!1){this.m_eventRegistry||(this.m_eventRegistry=new Map);let i=this.m_eventRegistry.get(t);return i||(i=[],this.m_eventRegistry.set(t,i)),-1==i.indexOf(e)&&(s?i.unshift(e):i.push(e)),{dispose:()=>{this.off(t,e)}}}off(t,e){if(!this.m_eventRegistry)return;let s=this.m_eventRegistry.get(t);if(!s)return;const i=s.indexOf(e);-1!==i&&s.splice(i,1)}removeAllListeners(t){t?(this.m_eventRegistry&&(this.m_eventRegistry[t]=void 0),this.m_defaultHandlers&&(this.m_defaultHandlers[t]=void 0)):this.m_eventRegistry=this.m_defaultHandlers=void 0}}})),define("x4/base_component",["require","exports","x4/x4_events"],(function(t,e,s){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.BaseComponent=void 0;class BaseComponent extends s.EventSource{m_props;m_timers;constructor(t){super(),this.m_props=t,t.events&&this.listen(t.events)}startTimer(t,e,i=!0,o=null){this.m_timers?this.stopTimer(t):this.m_timers=new Map;const n=(i?setInterval:setTimeout)((e=>{const i=Date.now();o?o(t,i):this.emit("timer",(0,s.EvTimer)(t,i))}),e);this.m_timers.set(t,(()=>{(i?clearInterval:clearTimeout)(n)}))}stopTimer(t){const e=this.m_timers.get(t);e&&e()}disposeTimers(){this.m_timers?.forEach((t=>t())),this.m_timers=void 0}singleShot(t,e=0){setTimeout(t,e)}}e.BaseComponent=BaseComponent})),define("x4/i18n",["require","exports"],(function(t,e){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.extendTranslation=e.selectLanguage=e.isLanguage=e._tr=void 0;let s={global:{ok:"OK",cancel:"Annuler",ignore:"Ignorer",yes:"Oui",no:"Non",open:"Ouvrir",new:"Nouveau",delete:"Supprimer",close:"Fermer",save:"Enregistrer",search:"Rechercher",search_tip:"Saisissez le texte à rechercher. <b>Enter</b> pour lancer la recherche. <b>Esc</b> pour annuler.",required_field:"information requise",invalid_format:"format invalide",invalid_email:"adresse mail invalide",invalid_number:"valeur numérique invalide",diff_date_seconds:"{0} seconds",diff_date_minutes:"{0} minutes",diff_date_hours:"{0} hours",invalid_date:"Date non reconnue ({0})",empty_list:"Liste vide",date_input_formats:"d/m/y|d.m.y|d m y|d-m-y|dmy",date_format:"D/M/Y",day_short:["dim","lun","mar","mer","jeu","ven","sam"],day_long:["dimanche","lundi","mardi","mercredi","jeudi","vendredi","samedi"],month_short:["jan","fév","mar","avr","mai","jun","jui","aoû","sep","oct","nov","déc"],month_long:["janvier","février","mars","avril","mai","juin","juillet","août","septembre","octobre","novembre","décembre"],property:"Propriété",value:"Valeur",err_403:"Vous n'avez pas les droits suffisants pour effectuer cette action",copy:"Copier",cut:"Couper",paste:"Coller"}},i={fr:s,en:r(n({},{global:{ok:"OK",cancel:"Cancel",ignore:"Ignore",yes:"Yes",no:"No",required_field:"required field",invalid_format:"invalid format",diff_date_seconds:"{0} seconds",diff_date_minutes:"{0} minutes",diff_date_hours:"{0} hours",invalid_date:"Bad date format {0}",copy:"Copy",cut:"Cut",paste:"Paste"}}))};function o(t){return void 0!==i[t]}function n(t,e){for(let s in e)t[s]instanceof Object?n(t[s],e[s]):(t[s]=e[s],t[s]instanceof Object&&(t[s]=r(t[s])));return t}function r(t){return new Proxy(t,{get:function(t,e,i){let o=t[e];return void 0===o?s[e]:o}})}e._tr=i.fr,e.isLanguage=o,e.selectLanguage=function(t){o(t)&&(e._tr=i[t])},e.extendTranslation=function(t,e){o(t)&&n(i[t],e)}})),define("x4/tools",["require","exports","x4/i18n"],(function(t,e,s){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.classNames=e.mix=e.crc32=e.Clipboard=e.isHtmlString=e.html=e.HtmlString=e.clamp=e.getMousePos=e.NetworkError=e.markdownToHtml=e.asap=e.deferCall=e.waitFontLoading=e.isNumber=e.pad=e.isLiteralObject=e.isFunction=e.isArray=e.isString=e.downloadData=e.calcAge=e.formatIntlDate=e.parseIntlDate=e.date_calc_weeknum=e.date_clone=e.date_hash=e.date_sql_utc=e.date_to_sql=e.date_diff=e.date_format=e._date_set_locale=e.removeHtmlTags=e.escapeHtml=e.sprintf=e.Rect=e.Size=e.Point=e.pascalCase=e.parseIntlFloat=e.roundTo=e.isTouchDevice=void 0,e.isTouchDevice=function(){return"ontouchstart"in window},e.roundTo=function(t,e){let s=Math.pow(10,e),i=Math.round(t*s)/s;return-0===i&&(i=0),i},e.parseIntlFloat=function(t){return 0==(t=(t=t.replace(/\s*/g,"")).replace(",",".")).length?0:parseFloat(t)};e.pascalCase=function(t){let e=t;return e=e.replace(/([a-z])([A-Z])/g,"$1 $2"),e=e.toLowerCase(),e=e.replace(/[^- a-z0-9]+/g," "),e.indexOf(" ")<0?e:(e=e.trim(),e.replace(/ /g,"-"))};class Point{x;y;constructor(t=0,e=0){this.x=t,this.y=e}}e.Point=Point;class Size{width;height;constructor(t=0,e=0){this.width=t,this.height=e}}e.Size=Size;class Rect{left;top;width;height;constructor(t,e,s,i){if(void 0===t)this.left=this.top=this.right=this.bottom=0;else if(t instanceof Rect||t instanceof DOMRect){let e=t;this.left=e.left,this.top=e.top,this.width=e.width,this.height=e.height}else this.left=t,this.top=e,this.width=s,this.height=i}set(t,e,s,i){this.left=t,this.top=e,this.width=s,this.height=i}get bottom(){return this.top+this.height}set bottom(t){this.height=t-this.top}get right(){return this.left+this.width}set right(t){this.width=t-this.left}get topLeft(){return new Point(this.left,this.top)}get bottomRight(){return new Point(this.right,this.bottom)}get size(){return new Size(this.width,this.height)}moveTo(t,e){return this.left=t,this.top=e,this}movedTo(t,e){return new Rect(t,e,this.width,this.height)}moveBy(t,e){return this.left+=t,this.top+=e,this}movedBy(t,e){return new Rect(this.left+t,this.top+e,this.width,this.height)}isEmpty(){return 0==this.width&&0==this.height}normalize(){let t=this.width,e=this.height;return t<0&&(this.left+=t,this.width=-t),e<0&&(this.top+=e,this.height=-e),this}normalized(){let t=new Rect(this),e=t.width,s=t.height;return e<0&&(t.left+=e,t.width=-e),s<0&&(t.top+=s,t.height=-s),t}containsPt(t,e){return t>=this.left&&t<=this.right&&e>=this.top&&e<=this.bottom}contains(t){return t instanceof Rect?t.left>=this.left&&t.right<=this.right&&t.top>=this.top&&t.bottom<=this.bottom:t.x>=this.left&&t.x<this.right&&t.y>=this.top&&t.y<this.bottom}touches(t){return!(this.left>t.right||this.right<t.left||this.top>t.bottom||this.bottom<t.top)}inflate(t,e){void 0===e&&(e=t),this.left-=t,this.top-=e,this.width+=t+t,this.height+=e+e}inflatedBy(t,e){return void 0===e&&(e=t),new Rect(this.left-t,this.top-e,this.width+t+t,this.height+e+e)}combine(t){let e=Math.min(this.left,t.left),s=Math.min(this.top,t.top),i=Math.max(this.right,t.right),o=Math.max(this.bottom,t.bottom);this.left=e,this.top=s,this.right=i,this.bottom=o}}function i(t,...e){return t.replace(/{(\d+)}/g,(function(t,s){return void 0!==e[s]?e[s]:t}))}function o(t,e=!1){if(!t||0==t.length)return t;let s=t.replace(/[<>\&\"\']/g,(function(t){return"&#"+t.charCodeAt(0)+";"}));return e&&(s=s.replace(/(\r\n|\n\r|\r|\n)/g,"<br/>")),s}e.Rect=Rect,e.sprintf=i,e.escapeHtml=o,e.removeHtmlTags=function(t,e=!1){if(!t||0==t.length)return t;let s="";for(let e=0;e<t.length;e++){const i=t.codePointAt(e);s+=i>127?"&#"+i+";":60==i?"&lt;":t.charAt(e)}return s};let n="fr-FR";function r(t){return t.getFullYear()<<16|t.getMonth()<<8|t.getDate()}function a(t){return new Date(t.getTime())}function l(t){const e=new Date(t.getFullYear(),0,1),s=(t.valueOf()-e.valueOf())/864e5;return Math.ceil((s+e.getDay()+1)/7)}function h(t,e=s._tr.global.date_format){if(!t)return"";let i="",o=0;for(let n of e){if("{"==n){if(1==++o)continue}else if("}"==n&&0==--o)continue;if(o)i+=n;else if("d"==n)i+=t.getDate();else if("D"==n)i+=m(t.getDate(),-2);else if("j"==n){let e=t.getDay();i+=s._tr.global.day_short[e]}else if("J"==n){let e=t.getDay();i+=s._tr.global.day_long[e]}else if("w"==n)i+=l(t);else if("W"==n)i+=m(l(t),-2);else if("m"==n)i+=t.getMonth()+1;else if("M"==n)i+=m(t.getMonth()+1,-2);else if("o"==n){let e=t.getMonth();i+=s._tr.global.month_short[e]}else if("O"==n){let e=t.getMonth();i+=s._tr.global.month_long[e]}else i+="y"==n||"Y"==n?m(t.getFullYear(),-4):"a"==n||"A"==n?t.getHours()<12?"am":"pm":"h"==n?t.getHours():"H"==n?m(t.getHours(),-2):"i"==n?t.getMinutes():"I"==n?m(t.getMinutes(),-2):"s"==n?t.getSeconds():"S"==n?m(t.getSeconds(),-2):n}return i}function c(t){return"string"==typeof t}function m(t,e,s="0"){let i,o;return o=c(t)?t:""+t,e>0?(i=s.repeat(e),o+=i,o.substr(0,e)):(i=s.repeat(-e),o=i+o,o.substr(e))}e._date_set_locale=function(t){n=t},e.date_format=function(t,e){return h(t)},e.date_diff=function(t,e,o){let n=(t.getTime()-e.getTime())/1e3;if(n<60)return i(s._tr.global.diff_date_seconds,Math.round(n));let r=Math.floor(n/60);if(r<60)return i(s._tr.global.diff_date_minutes,Math.round(r));let a=Math.floor(r/60);return i(s._tr.global.diff_date_hours,a,r%60)},e.date_to_sql=function(t,e){return h(t,e?"Y-M-D H:I:S":"Y-M-D")},e.date_sql_utc=function(t){return new Date(t+" GMT")},e.date_hash=r,Date.prototype.hash=()=>r(this),e.date_clone=a,e.date_calc_weeknum=l,e.parseIntlDate=function(t,e=s._tr.global.date_input_formats){let i=e.split("|");for(let e of i){let s="";for(let t of e)s+="d"==t||"D"==t?"(?<day>\\d{1,2})":"m"==t||"M"==t?"(?<month>\\d{1,2})":"y"==t||"Y"==t?"(?<year>\\d{1,4})":"h"==t||"H"==t?"(?<hour>\\d{1,2})":"i"==t||"I"==t?"(?<min>\\d{1,2})":"s"==t||"S"==t?"(?<sec>\\d{1,2})":" "==t?"\\s+":"\\s*\\"+t+"\\s*";let i=new RegExp("^"+s+"$","m").exec(t);if(i){let t=parseInt(i.groups.day??"1"),e=parseInt(i.groups.month??"1"),s=parseInt(i.groups.year??"1970"),o=parseInt(i.groups.hour??"0"),n=parseInt(i.groups.min??"0"),r=parseInt(i.groups.sec??"0");s>0&&s<100&&(s+=2e3);let a=new Date(s,e-1,t,o,n,r,0),l=a.getFullYear(),h=a.getMonth()+1,c=a.getDate();return l!=s||h!=e||c!=t?null:a}}return null},e.formatIntlDate=h,e.calcAge=function(t,e){if(void 0===e&&(e=new Date),!t)return 0;let s=e.getFullYear()-t.getFullYear();return(e.getMonth()<t.getMonth()||e.getMonth()==t.getMonth()&&e.getDate()<t.getDate())&&s--,s},Date.prototype.isSameDay=function(t){return this.getDate()==t.getDate()&&this.getMonth()==t.getMonth()&&this.getFullYear()==t.getFullYear()},Date.prototype.hash=function(){return r(this)},Date.prototype.clone=function(){return a(this)},Date.prototype.weekNum=function(){return l(this)},Date.prototype.format=function(t){return h(this,t)},e.downloadData=function(t,e,s){let i=new Blob([t],{type:e}),o=window.URL.createObjectURL(i),n=document.createElement("a");n.style.display="none",n.href=o,n.download=s,document.body.appendChild(n),n.click(),window.URL.revokeObjectURL(o)},e.isString=c,e.isArray=function(t){return t instanceof Array},e.isFunction=function(t){return t instanceof Function},e.isLiteralObject=function(t){return!!t&&t.constructor===Object},e.pad=m,e.isNumber=function(t){return"number"==typeof t&&isFinite(t)},e.waitFontLoading=function(t){let e=document.createElement("div");return e.style.position="absolute",e.style.fontFamily=t,e.style.fontSize="44px",e.style.opacity="0.001",e.innerText="X",document.body.appendChild(e),new Promise((t=>{let s=e.getBoundingClientRect(),i=setInterval((()=>{e.getBoundingClientRect().height!=s.height&&(clearInterval(i),document.body.removeChild(e),t())}),0)}))},e.deferCall=function(t,e=0,...s){setTimeout(t,e,...s)},e.asap=function(t){requestAnimationFrame(t)},e.markdownToHtml=function(t){if(!t)return"";let e=t.split("\n"),s="para",i="p",n=[];return e.forEach((t=>{let e=t.trim();if("para"==s){if("-"==e[0])e=e.substr(1),n.push("<ul>"),s="list",i="li";else if(">"==e[0])e=e.substr(1),n.push("<blockquote>"),s="quote",i="p";else if("#"==e[0]){let t=0;do{e=e.substr(1),t++}while("#"==e[0]&&t<5);i="h"+t,s="title"}}else"list"==s?"-"!=e[0]?(n.push("</ul>"),s="para",i="p"):e=e.substr(1):"quote"==s&&(">"!=e[0]?(n.push("</blockquote>"),s="para",i="p"):e=e.substr(1));e=o(e,!1),e=e.replace(/\*\*([^*]+)\*\*/gi,((t,...e)=>"<b>"+t.substr(2,t.length-4)+"</b>"));e=e.replace(/\*([^*]+)\*/gi,((t,...e)=>"<i>"+t.substr(1,t.length-2)+"</i>")),""==e&&(e="&nbsp;"),n.push(`<${i}>`+e+`</${i}>`),"title"==s&&(s="para",i="p")})),"list"==s?n.push("</ul>"):"quote"==s&&n.push("</blockquote>"),n.join("")};class NetworkError extends Error{m_code;constructor(t,e){t instanceof Response?(super(t.statusText),this.m_code=t.status):(super(e),this.m_code=t)}get code(){return this.m_code}}e.NetworkError=NetworkError,e.getMousePos=function(t,e){let s="offsetX",i="offsetY";if(e&&(s="clientX",i="clientY"),"mousemove"==t.type||"mousedown"==t.type||"mouseup"==t.type){let e=t;return new Point(e[s],e[i])}if("pointermove"==t.type||"pointerdown"==t.type||"pointerup"==t.type){let e=t;return new Point(e[s],e[i])}if("touchmove"==t.type||"touchstart"==t.type){let e=t;return new Point(e.touches[0][s],e.touches[0][i])}if("contextmenu"==t.type){let e=t;return new Point(e[s],e[i])}return new Point(0,0)},e.clamp=function(t,e,s){return Math.min(Math.max(t,e),s)};class HtmlString extends String{constructor(t){super(t)}static from(t){return new HtmlString(t)}}e.HtmlString=HtmlString,e.html=function(t,...e){return HtmlString.from(String.raw(t,...e))},e.isHtmlString=function(t){return t instanceof HtmlString};e.Clipboard=class Clipboard{static copy(t){navigator.clipboard&&navigator.clipboard.writeText(JSON.stringify(t))}static paste(t){navigator.clipboard?navigator.clipboard.readText().then((e=>t(e))):console.error("no clipboard, are you in https ?")}},e.crc32=function(t){let e=-1;for(let s=0,i=t.length;s<i;s++)e=e>>>8^d[255&(e^t.charCodeAt(s))];return Math.abs(-1^e)};var d=[0,1996959894,3993919788,2567524794,124634137,1886057615,3915621685,2657392035,249268274,2044508324,3772115230,2547177864,162941995,2125561021,3887607047,2428444049,498536548,1789927666,4089016648,2227061214,450548861,1843258603,4107580753,2211677639,325883990,1684777152,4251122042,2321926636,335633487,1661365465,4195302755,2366115317,997073096,1281953886,3579855332,2724688242,1006888145,1258607687,3524101629,2768942443,901097722,1119000684,3686517206,2898065728,853044451,1172266101,3705015759,2882616665,651767980,1373503546,3369554304,3218104598,565507253,1454621731,3485111705,3099436303,671266974,1594198024,3322730930,2970347812,795835527,1483230225,3244367275,3060149565,1994146192,31158534,2563907772,4023717930,1907459465,112637215,2680153253,3904427059,2013776290,251722036,2517215374,3775830040,2137656763,141376813,2439277719,3865271297,1802195444,476864866,2238001368,4066508878,1812370925,453092731,2181625025,4111451223,1706088902,314042704,2344532202,4240017532,1658658271,366619977,2362670323,4224994405,1303535960,984961486,2747007092,3569037538,1256170817,1037604311,2765210733,3554079995,1131014506,879679996,2909243462,3663771856,1141124467,855842277,2852801631,3708648649,1342533948,654459306,3188396048,3373015174,1466479909,544179635,3110523913,3462522015,1591671054,702138776,2966460450,3352799412,1504918807,783551873,3082640443,3233442989,3988292384,2596254646,62317068,1957810842,3939845945,2647816111,81470997,1943803523,3814918930,2489596804,225274430,2053790376,3826175755,2466906013,167816743,2097651377,4027552580,2265490386,503444072,1762050814,4150417245,2154129355,426522225,1852507879,4275313526,2312317920,282753626,1742555852,4189708143,2394877945,397917763,1622183637,3604390888,2714866558,953729732,1340076626,3518719985,2797360999,1068828381,1219638859,3624741850,2936675148,906185462,1090812512,3747672003,2825379669,829329135,1181335161,3412177804,3160834842,628085408,1382605366,3423369109,3138078467,570562233,1426400815,3317316542,2998733608,733239954,1555261956,3268935591,3050360625,752459403,1541320221,2607071920,3965973030,1969922972,40735498,2617837225,3943577151,1913087877,83908371,2512341634,3803740692,2075208622,213261112,2463272603,3855990285,2094854071,198958881,2262029012,4057260610,1759359992,534414190,2176718541,4139329115,1873836001,414664567,2282248934,4279200368,1711684554,285281116,2405801727,4167216745,1634467795,376229701,2685067896,3608007406,1308918612,956543938,2808555105,3495958263,1231636301,1047427035,2932959818,3654703836,1088359270,936918e3,2847714899,3736837829,1202900863,817233897,3183342108,3401237130,1404277552,615818150,3134207493,3453421203,1423857449,601450431,3009837614,3294710456,1567103746,711928724,3020668471,3272380065,1510334235,755167117];e.mix=t=>new MixinBuilder(t);class MixinBuilder{superclass;constructor(t){this.superclass=t}with(...t){return t.reduce(((t,e)=>e(t)),this.superclass)}}e.classNames=function(...t){let e="";for(const s of t)if("string"==typeof s)e+=" "+s;else if(s)for(const t in s)s[t]&&(e+=" "+t);return e}})),define("x4/styles",["require","exports","x4/tools"],(function(t,e,s){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.ComputedStyle=e.CSSParser=e.Stylesheet=void 0;class Stylesheet{m_sheet;m_rules=new Map;constructor(){if(this.m_sheet=function(t){for(let e=0;e<document.styleSheets.length;e++){let s=document.styleSheets[e];if(s.title===t)return s}}("@dynamic-css"),!this.m_sheet){let t=document.createElement("style");t.setAttribute("id","@dynamic-css"),document.head.appendChild(t),this.m_sheet=t.sheet}}setRule(t,e){if((0,s.isString)(e)){let s=this.m_rules.get(t);void 0!==s?this.m_sheet.deleteRule(s):s=this.m_sheet.cssRules.length,this.m_rules.set(t,this.m_sheet.insertRule(e,s))}else{let s=1;for(let i in e){let o=i+" { ",n=e[i];for(let t in n){let e=n[t];for(let s=0;s<e.length;s++)o+=t+": "+e[s]+"; "}o+="}",console.log(o),this.setRule(t+"--"+s,o),s++}}}static getVar(t){return Stylesheet.doc_style||(Stylesheet.doc_style=getComputedStyle(document.documentElement)),Stylesheet.doc_style.getPropertyValue("--"+t)}static guid=1;static doc_style}e.Stylesheet=Stylesheet;class CSSParser{result={};parse(t){return this.result={},this.parse_json("",t),CSSParser.mk_string(this.result)}static mk_string(t){let e="";for(let s in t){let i=t[s];e+=s+" { ";for(let t in i){let s=i[t];for(let i=0;i<s.length;i++)e+=t+": "+s[i]+"; "}e+="}\n"}return e}parse_json(t,e){t&&!this.result[t]&&(this.result[t]={});for(let i in e){let o=e[i];if((0,s.isArray)(o)){let e=o;for(let s=0;s<e.length;s++)this.addProperty(t,i,e[s])}else switch(typeof o){case"number":case"string":this.addProperty(t,i,o);break;case"object":this.parse_json(this.makeSelectorName(t,i),o);break;default:console.error("ignoring unknown type "+typeof o+" in property "+i)}}}makePropertyName(t){return(0,s.pascalCase)(t)}makeSelectorName(t,e){let s=[],i=e.split(/\s*,\s*/),o=t.split(/\s*,\s*/);for(let t=0;t<o.length;t++){let e=o[t];for(let t=0;t<i.length;t++){let o=i[t],n=!1;"&"==o.charAt(0)&&(o=o.substr(1),n=!0),"%"===o.charAt(0)&&(o=".o-"+o.substr(1)),n?s.push(e+o):s.push(e?e+" "+o:o)}}return s.join(", ")}addProperty(t,e,s){let i=e.split(/\s*,\s*/);for(let e=0;e<i.length;e++){let o=this.makePropertyName(i[e]);this.result[t][o]?this.result[t][o].push(s):this.result[t][o]=[s];let n={"box-shadow":["-moz-box-shadow","-webkit-box-shadow"],"border-radius":["-moz-border-radius","-webkit-border-radius"],"border-radius-topleft":["-moz-border-radius-topleft","-webkit-border-top-left-radius"],"border-radius-topright":["-moz-border-radius-topright","-webkit-border-top-right-radius"],"border-radius-bottomleft":["-moz-border-radius-bottomleft","-webkit-border-bottom-left-radius"],"border-radius-bottomright":["-moz-border-radius-bottomright","-webkit-border-bottom-right-radius"]}[o];for(let e=0;n&&e<n.length;e++)this.addProperty(t,n[e],s)}}}e.CSSParser=CSSParser;e.ComputedStyle=class ComputedStyle{m_style;constructor(t){this.m_style=t}value(t){return t=(0,s.pascalCase)(t),this.m_style[t]}parse(t){return t=(0,s.pascalCase)(t),parseInt(this.m_style[t])}}})),define("x4/dom_events",["require","exports"],(function(t,e){"use strict";Object.defineProperty(e,"__esModule",{value:!0})})),define("x4/component",["require","exports","x4/tools","x4/styles","x4/x4_events","x4/base_component","x4/tools"],(function(t,e,s,i,o,n,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Container=e.SizerOverlay=e.EvOverlayResize=e.Separator=e.EvSize=e.Space=e.Flex=e.flyWrap=e.Component=e.EvFocus=e.EvDblClick=e.html=e.isHtmlString=e.HtmlString=void 0,Object.defineProperty(e,"HtmlString",{enumerable:!0,get:function(){return r.HtmlString}}),Object.defineProperty(e,"isHtmlString",{enumerable:!0,get:function(){return r.isHtmlString}}),Object.defineProperty(e,"html",{enumerable:!0,get:function(){return r.html}});const a=Symbol(),l=Symbol(),h={animationIterationCount:1,borderImageOutset:1,borderImageSlice:1,borderImageWidth:1,boxFlex:1,boxFlexGroup:1,boxOrdinalGroup:1,columnCount:1,flex:1,flexGrow:1,flexPositive:1,flexShrink:1,flexNegative:1,flexOrder:1,gridRow:1,gridColumn:1,fontWeight:1,lineClamp:1,lineHeight:1,opacity:1,order:1,orphans:1,tabSize:1,widows:1,zIndex:1,zoom:1,fillOpacity:1,floodOpacity:1,stopOpacity:1,strokeDasharray:1,strokeDashoffset:1,strokeMiterlimit:1,strokeOpacity:1,strokeWidth:1},c={mouseleave:1,mouseenter:1,load:1,unload:1,scroll:1,focus:1,blur:1,rowexit:1,beforeunload:1,stop:1,dragdrop:1,dragenter:1,dragexit:1,draggesture:1,dragover:1,contextmenu:1,create:2,sizechange:2},m={touchstart:1,touchmove:1,touchend:1},d=/^-?\d+(\.\d+)?$/;e.EvDblClick=function(t=null){return(0,o.BasicEvent)({context:t})},e.EvFocus=function(t=!0,e=null){return(0,o.BasicEvent)({focus:t,context:e})};class Component extends n.BaseComponent{m_dom;m_iprops;static __sb_width;static __comp_guid=1e3;static __privateEvents={};static __sizeObserver;static __createObserver;static __intersectionObserver;static __capture=null;static __capture_mask=null;static __css=null;constructor(t=null){super(t??{}),this.m_iprops={classes:{},dom_events:{},uid:Component.__comp_guid++}}get uid(){return this.m_iprops.uid}setContent(t,e=!0){this.m_props.content=t??[],e?this.update():this._updateContent()}appendChild(t){if(!t)return;const e=t=>{this.m_props.content?(0,s.isArray)(this.m_props.content)||(this.m_props.content=[this.m_props.content]):this.m_props.content=[],this.m_props.content.push(t),this.m_dom&&this._appendChild(t)};(0,s.isArray)(t)?t.forEach(e):e(t)}getProp(t){return this.m_props[t]}setProp(t,e){this.m_props[t]=e}getData(t){if(void 0!==this.m_props.data)return this.m_props.data[t]}setData(t,e){let s=this.m_props.data;void 0===s&&(s=this.m_props.data={}),s[t]=e}get dom(){return this.m_dom}show(t){void 0===t||!0===t?this.removeClass("@hidden"):this.addClass("@hidden")}hide(){this.addClass("@hidden")}enable(t){void 0===t||!0===t?(this.removeClass("@disable"),this.removeAttribute("disabled")):this.disable()}disable(){this.addClass("@disable"),this.setAttribute("disabled","")}focus(){console.assert(!!this.m_dom),this.m_dom.focus()}setStyle(t){for(let e in t)this.setStyleValue(e,t[e])}setStyleValue(t,e){let s=this.m_props.style;s||(s=this.m_props.style={}),s[t]=e,this._setDomStyleValue(t,e)}_setDomStyleValue(t,e){this.m_dom&&(void 0===e?e=null:h[t]||!(0,s.isNumber)(e)&&!d.test(e)||(e+="px"),this.m_dom.style[t]=e)}getComputedStyle(t){return this.dom?new i.ComputedStyle(getComputedStyle(this.dom,t??null)):new i.ComputedStyle(this.m_props.style)}getStyleValue(t){return this.getComputedStyle()[t]}setAttributes(t){for(let e in t)this.setAttribute(e,t[e])}setAttribute(t,e){if(!1===e||void 0===e)this.removeAttribute(t);else{!0===e?e="":(0,s.isNumber)(e)&&(e=""+e);let i=this.m_props.attrs;i||(i=this.m_props.attrs={}),i[t]=e,this._setDomAttribute(t,e)}}_setDomAttribute(t,e){this.m_dom&&this.m_dom.setAttribute(t,e)}removeAttribute(t){let e=this.m_props.attrs;e&&(delete e[t],this.m_dom&&this.m_dom.removeAttribute(t))}getAttribute(t){return this.m_dom?this.m_dom.getAttribute(t):this.m_props.attrs?this.m_props.attrs[t]:void 0}hasAttribute(t){return this.m_dom?this.m_dom.hasAttribute(t):this.m_props.attrs.hasOwnProperty(t)}addClass(t){if(null==t)return;if(""===(t=t.trim()))return;let e=t=>{null!=t&&""!==t&&(t=this._makeCls(t),s[t]=!0,this.m_dom&&this.m_dom.classList.add(t))},s=this.m_iprops.classes;if(t.indexOf(" ")<0)e(t);else{t.split(" ").forEach((t=>e(t)))}}removeClass(t){if(void 0===t)return;let e=t=>{null!=t&&""!==t&&(t=this._makeCls(t),delete this.m_iprops.classes[t],this.m_dom&&this.m_dom.classList.remove(t))};if(t.indexOf(" ")<0)e(t);else{let s=t.trim().split(" ");for(let t of s)null!=t&&""!==t&&e(t)}}setClass(t,e){return e?this.addClass(t):this.removeClass(t),this}toggleClass(t){let e=t=>{void 0===t&&null===t&&""===t||(t=this._makeCls(t),this.m_iprops.classes[t]?delete this.m_iprops.classes[t]:this.m_iprops.classes[t]=!0,this.m_dom&&this.m_dom.classList.toggle(t))};if(t.indexOf(" ")<0)e(t);else{let s=t.trim().split(" ");for(let t of s)e(t)}}hasClass(t){let e=this._makeCls(t);return this.m_dom?this.dom.classList.contains(e):!!this.m_iprops.classes[e]}clearClasses(){if(this.m_iprops.classes={},this.m_dom)return this.m_dom.classList.value=""}Build(){}_build(){return this.m_dom||this._createDOM(),this.m_dom}render(t){this.m_props.tag}_createDOM(){if(this.m_dom)return this.m_dom;const t=this.m_props;if(void 0!==t.tabIndex&&this._setTabIndex(t.tabIndex),this.render(t),void 0!==t.left&&this.setStyleValue("left",t.left),void 0!==t.top&&this.setStyleValue("top",t.top),void 0!==t.width&&this.setStyleValue("width",t.width),void 0!==t.height&&this.setStyleValue("height",t.height),void 0!==t.flex&&(this.addClass("@flex"),1!=t.flex&&this.setStyleValue("flex",t.flex)),!1===t.enabled&&this.disable(),void 0!==t.tooltip&&this.setAttribute("tip",t.tooltip.replace(/\n/gi,"<br/>")),t.dom_events)for(let e in t.dom_events)this._setDomEvent(e,t.dom_events[e]);this._genClassName(),this.m_props.cls=void 0;let e=this.m_iprops;this.m_props.ns?this.m_dom=document.createElementNS(t.ns,t.tag??"div"):this.m_dom=document.createElement(t.tag??"div"),this.m_dom[l]=this,this.m_dom.classList.add(...Object.keys(e.classes));let i=t.style;if(i)for(let t in i)this._setDomStyleValue(t,i[t]);let o=t.attrs;if(o)for(let t in o){const e=o[t];!1!==e&&void 0!==e&&this._setDomAttribute(t,o[t])}this.m_props.id&&this._setDomAttribute("id",this.m_props.id);let n=this.m_iprops.dom_events;if(n)for(let t in n){let e=n[t];for(let s of e)this.createEvent(t,s)}let r=t.content;return r&&((0,s.isArray)(r)||(r=[r]),r.forEach((t=>{t&&((0,s.isString)(t)?this.m_dom.insertAdjacentText("beforeend",t):(0,s.isHtmlString)(t)?this.m_dom.insertAdjacentHTML("beforeend",t):t instanceof Component?this.m_dom.append(t._build()):console.log("unknown element type: ",t))}))),Component.__createObserver||(Component.__createObserver=new MutationObserver(Component._observeCreation),Component.__createObserver.observe(document.body,{childList:!0,subtree:!0})),this.m_dom}_setTabIndex(t,e=0){!0===t?t=0:void 0===t&&(t=e),!1!==t&&void 0!==t&&this.setAttribute("tabindex",t),this.m_props.tabIndex=t}static _observeCreation(t){for(let e of t)if("childList"==e.type)for(let t=0,s=e.addedNodes.length;t<s;t++){let s=e.addedNodes[t][l];s&&(s.enumChilds((t=>{t.dom&&t.m_iprops.dom_events&&t.m_iprops.dom_events.create&&t.dom.dispatchEvent(new Event("create")),t.componentCreated()}),!0),s.m_iprops.dom_events&&s.m_iprops.dom_events.create&&s.dom.dispatchEvent(new Event("create")),s.componentCreated())}}dispose(){this.m_dom&&this._dispose(!0)}_dispose(t){let e=this.m_dom;delete e[l],delete e[a],t&&e.remove(),this.enumChilds((t=>{t._dispose(!1)})),this.m_dom=null,this.disposeTimers(),this.componentDisposed()}componentDisposed(){}componentCreated(){}update(t=0){if(this.m_dom){const e=()=>{let t=this.m_dom;this._dispose(!1);let e=this._build();console.assert(!!t.parentNode,"update in componentCreated is not allowed, use updateContent"),t.parentNode.replaceChild(e,t)};t?this.singleShot(e,t):e()}}_updateContent(){if(!this.m_dom)return;this.m_dom.innerText="";let t=this.m_props.content;t&&((0,s.isArray)(t)||(t=[t]),t.forEach((t=>{t&&((0,s.isHtmlString)(t)?this.m_dom.insertAdjacentHTML("beforeend",t):t instanceof Component?this.m_dom.append(t._build()):this.m_dom.insertAdjacentText("beforeend",t+""))})))}getBoundingRect(t=!1){console.assert(null!=this.dom,"cannot get bounding rect of an non DOM element");let e=this.dom.getBoundingClientRect(),i=new s.Rect(e.left,e.top,e.width,e.height);if(t){let t=this.getComputedStyle(),e=t.parse("marginTop"),s=t.parse("marginBottom"),o=t.parse("marginLeft"),n=t.parse("marginRight");i.left-=o,i.width+=o+n,i.top-=e,i.height+=e+s}return i}setDomEvent(t,e){let s=e;this._setDomEvent(t,s)}_setDomEvent(t,e){this.m_iprops.dom_events||(this.m_iprops.dom_events={});let s=this.m_iprops.dom_events[t];s?s.push(e):s=this.m_iprops.dom_events[t]=[e],this.m_dom&&this.createEvent(t,e)}clearDomEvent(t){if(!this.m_iprops.dom_events)return;delete this.m_iprops.dom_events[t];let e=this.m_dom;if(e){let s=e[a];s&&delete s[t]}}mapPropEvents(t,...e){e.forEach((e=>{t[e]&&this._on(e,t[e])}))}createEvent(t,e){let s=this.m_dom,i=s[a];i||(i=s[a]={}),i[t]?i[t].push(e):i[t]=[e],1===c[t]?s["on"+t]=Component._dispatchUnbubbleEvent:Component.__privateEvents[t]||(Component.__privateEvents[t]=!0,m[t]?document.addEventListener(t,Component._dispatchEvent,{passive:!1,capture:!0}):document.addEventListener(t,Component._dispatchEvent,!0)),"sizechange"===t&&(Component.__sizeObserver||(Component.__sizeObserver=new ResizeObserver(Component._observeSize)),Component.__sizeObserver.observe(this.m_dom))}static _dispatchEvent(t){let e=t.target,s=2===c[t.type];for(;e;){if(e[a]){let i=e[a][t.type];if(i){let o=e[l],n=o?.root??null;if(i instanceof Array?i.some((e=>{if(e(t,n),!o.dom)return!0})):i(t,n),t.cancelBubble||t.defaultPrevented||s)break}}if(e=e.parentNode,e==document)break}}static _dispatchUnbubbleEvent(t){let e=t.currentTarget||t.target,s=t.type,i=e[a],o=i&&i[s];if(o){let s=e[l]?.root??null;o instanceof Array?o.forEach((e=>{e(t,s)})):o(t,s)}}static _observeSize(t){t.forEach((t=>{let e=t.target;null!==e.offsetParent&&e.dispatchEvent(new Event("sizechange"))}))}enumChilds(t,e=!1){if(this.m_dom){let s=this.m_dom.firstChild;for(;s;){let i=s[l];if(i&&(t(i),e&&!0===i.enumChilds(t,!0)))return!0;s=s.nextSibling}}else{let i=this.m_props.content;if(!i)return;(0,s.isArray)(i)||(i=[i]),i.some((i=>{if(i&&!(0,s.isString)(i)&&!(0,s.isHtmlString)(i))return!!t(i)||(!(!e||!0!==i.enumChilds(t,!0))||void 0)}))}return!1}_appendChild(t){if((0,s.isString)(t))this.m_dom.insertAdjacentText("beforeend",t);else if((0,s.isHtmlString)(t))this.m_dom.insertAdjacentHTML("beforeend",t);else{let e=t;try{e._build(),this.m_dom.appendChild(e.m_dom)}catch(t){console.error(t)}}}_genClassName(){this.addClass("@comp");let t=Object.getPrototypeOf(this);for(;t&&t.constructor!==Component;){let e=t.constructor.name;this.addClass("@"+(0,s.pascalCase)(e)),t=Object.getPrototypeOf(t)}this.addClass(this.m_props.cls)}_makeCls(t){return"@"==t[0]?"x-"+t.substring(1):t}static dispatchCaptures(t){Component.__capture.handler(t)}static setCapture(t,e){console.assert(!Component.__capture),Component.__capture;let s=document.querySelectorAll("iframe");s.forEach((t=>{p(t).setStyleValue("pointer-events","none")}));let i=document.querySelectorAll(":hover"),o=null;if(i.length){let t=i[i.length-1];o=window.getComputedStyle(t).cursor}Component.__capture_mask=document.createElement("div");let n=p(Component.__capture_mask);n.addClass("@capture-mask"),o&&n.setStyleValue("cursor",o),document.body.appendChild(n.dom),document.addEventListener("mousedown",Component.dispatchCaptures),document.addEventListener("mousemove",Component.dispatchCaptures),document.addEventListener("mouseup",Component.dispatchCaptures),document.addEventListener("touchstart",Component.dispatchCaptures),document.addEventListener("touchmove",Component.dispatchCaptures),document.addEventListener("touchend",Component.dispatchCaptures),Component.__capture={initiator:t,handler:e,iframes:s}}static releaseCapture(){console.assert(!!Component.__capture),document.removeEventListener("touchstart",Component.dispatchCaptures),document.removeEventListener("touchmove",Component.dispatchCaptures),document.removeEventListener("touchend",Component.dispatchCaptures),document.removeEventListener("mousedown",Component.dispatchCaptures),document.removeEventListener("mousemove",Component.dispatchCaptures),document.removeEventListener("mouseup",Component.dispatchCaptures),Component.__capture.iframes.forEach((t=>{p(t).setStyleValue("pointer-events",null)})),Component.__capture=null,Component.__capture_mask&&(document.body.removeChild(Component.__capture_mask),Component.__capture_mask=null)}scrollIntoView(t){if(this.m_dom){const t=new s.Rect(this.dom.getBoundingClientRect());let e,i,o=this.dom.parentElement;for(;o&&o!=document.body;){const t=o.getBoundingClientRect();(void 0===e||e<t.top)&&(e=t.top),(void 0===i||i>t.bottom)&&(i=t.bottom),o=o.parentElement}(void 0===e||t.top<e||t.bottom>i)&&this.m_dom.scrollIntoView({behavior:"auto",block:"nearest",inline:"start"})}}queryItem(t){let e=this.dom.querySelector(t);return e?Component.getElement(e):null}queryAll(t,e){document.querySelectorAll(t).forEach((t=>{e(p(t))}))}itemWithId(t){let e=this.dom.querySelector("#"+t);return e?Component.getElement(e):null}itemWithRef(t){let e=null;return this.enumChilds((s=>{if(s.m_props.ref===t)return e=s,!0}),!0),e}get ref(){return this.m_props.ref}static getCss(){return Component.__css||(Component.__css=new i.Stylesheet),Component.__css}getParent(){console.assert(!!this.m_dom);let t=this.dom.parentNode;return Component.getElement(t)}static getElement(t,e){if(e){const i=(0,s.isString)(e);for(;t;){let s=t[l];if(i){if(s&&s.hasClass(e))return s}else if(s instanceof e)return s;t=t.parentElement}return null}return t?t[l]:null}static getScrollbarSize(){if(void 0===Component.__sb_width){let t=document.createElement("div");t.style.cssText="overflow:auto;position:absolute;top:0;width:100px;height:100px";let e=document.createElement("div");e.style.width="200px",e.style.height="200px",t.appendChild(e),document.body.appendChild(t),Component.__sb_width=t.offsetWidth-t.clientWidth,document.body.removeChild(t)}return Component.__sb_width}isUserVisible(){return!!this.m_dom&&null!==this.m_dom.offsetParent}}e.Component=Component;let u=null;function p(t){if(t[l])return t[l];let e=u;return e||(e=u=new Component({})),e.m_dom=t,e}e.flyWrap=p;e.Flex=class Flex extends Component{constructor(t={}){t.flex||(t.flex=1),super(t)}};function _(t,e=null,s=null){return(0,o.BasicEvent)({size:t,mode:e,context:s})}e.Space=class Space extends Component{m_size;constructor(t){super({}),this.m_size=t}componentCreated(){let t=this.dom,e=null;for(;t;){let s=t[l];if(s.hasClass("@hlayout")){e={width:this.m_size};break}if(s.hasClass("@vlayout")){e={height:this.m_size};break}t=t.parentElement}e||(e={width:this.m_size,height:this.m_size}),this.setStyle(e)}},e.EvSize=_;function g(t,e,s=null){return(0,o.BasicEvent)({ui_event:t,sens:e,context:s})}e.Separator=class Separator extends Component{m_irect;m_delta;m_target;constructor(t){super(t),this.setDomEvent("mousedown",(t=>this._mousedown(t))),this.setDomEvent("touchstart",(t=>this._mousedown(t))),this.setDomEvent("dblclick",(t=>this._collapse(t)))}render(){this.addClass(this.m_props.orientation)}_collapse(t){this.m_props.collapsible&&(this._findTarget(),this.m_target&&this.m_target.toggleClass("@collapsed"))}_mousedown(t){if("touchstart"==t.type){let e=t;1==e.touches.length&&this._startMoving(e.touches[0].pageX,e.touches[0].pageY,t)}else{let e=t;this._startMoving(e.pageX,e.pageY,t)}}_startMoving(t,e,s){this._findTarget(),this.m_target&&("horizontal"==this.m_props.orientation?"before"==this.m_props.sizing?this.m_delta=t-this.m_irect.right:this.m_delta=t-this.m_irect.left:"before"==this.m_props.sizing?this.m_delta=e-this.m_irect.bottom:this.m_delta=e-this.m_irect.top,s.preventDefault(),s.stopPropagation(),this.m_target.addClass("sizing"),Component.setCapture(this,(t=>this._pointerMoved(t))))}_pointerMoved(t){let e=(t,e)=>{if("horizontal"==this.m_props.orientation){let e;if(e="after"==this.m_props.sizing?this.m_irect.right-(t-this.m_delta):t-this.m_delta-this.m_irect.left,e>0){let t=new s.Size(e,0);this.emit("resize",_(t)),this.m_target.setStyleValue("width",t.width),this.m_target.setStyleValue("flex",null),this.m_target.removeClass("@flex")}}else{let t;if(t="after"==this.m_props.sizing?this.m_irect.bottom-(e-this.m_delta):e-this.m_delta-this.m_irect.top,t>0){let e=new s.Size(0,t);this.emit("resize",_(e)),this.m_target.setStyleValue("height",e.height),this.m_target.setStyleValue("flex",null),this.m_target.removeClass("@flex")}}};if("mousemove"==t.type){let s=t;e(s.pageX,s.pageY),t.preventDefault(),t.stopPropagation()}else if("touchmove"==t.type){let s=t;e(s.touches[0].pageX,s.touches[0].pageY),t.preventDefault(),t.stopPropagation()}else"mouseup"!=t.type&&"touchend"!=t.type||(this.m_target.removeClass("sizing"),Component.releaseCapture(),t.preventDefault(),t.stopPropagation())}_findTarget(){if(!this.m_target)if("before"==this.m_props.sizing){let t=this.dom.previousElementSibling,e=t?Component.getElement(t):null;this.m_target=e}else{let t=this.dom.nextElementSibling,e=t?Component.getElement(t):null;this.m_target=e}this.m_target?this.m_irect=this.m_target.getBoundingRect():this.m_irect=null}},e.EvOverlayResize=g;e.SizerOverlay=class SizerOverlay extends Component{m_delta;m_irect;constructor(t){super(t),this.addClass(t.sens),this.setDomEvent("mousedown",(t=>this._mousedown(t))),this.setDomEvent("touchstart",(t=>this._mousedown(t))),this.setDomEvent("dblclick",(t=>this.resetflex(t))),t.target.appendChild(this),t.resize&&this.on("resize",this.m_props.resize)}resetflex(t){this.m_props.target.addClass("@flex"),this.emit("resize",_({width:-1,height:0})),t.preventDefault(),t.stopPropagation()}_mousedown(t){t.preventDefault(),t.stopPropagation();let e=g(t,this.m_props.sens);if(this.emit("rawresize",e),e.defaultPrevented)return;let i=(0,s.getMousePos)(t,!0);this.m_irect=this.m_props.target.getBoundingRect(),"right"==this.m_props.sens?this.m_delta=i.x-this.m_irect.right:"left"==this.m_props.sens?this.m_delta=i.x-this.m_irect.left:"bottom"==this.m_props.sens?this.m_delta=i.y-this.m_irect.bottom:"top"==this.m_props.sens&&(this.m_delta=i.y-this.m_irect.top),this.m_props.target.addClass("sizing"),Component.setCapture(this,(t=>this._handle_mouse(t)))}_is_horz(){return"left"==this.m_props.sens||"right"==this.m_props.sens}get sens(){return this.m_props.sens}_handle_mouse(t){let e=(t,e)=>{if(this._is_horz()){let e;if(e="left"==this.m_props.sens?this.m_irect.right-(t-this.m_delta):t-this.m_delta-this.m_irect.left,e>0){let t={width:e,height:void 0};this.emit("resize",_(t)),this.m_props.target.setStyleValue("width",t.width),this.m_props.target.setStyleValue("flex",null),this.m_props.target.removeClass("@flex")}}else{let t;if(t="top"==this.m_props.sens?this.m_irect.bottom-(e-this.m_delta):e-this.m_delta-this.m_irect.top,t>0){let e=new s.Size(0,t);this.emit("resize",_(e)),this.m_props.target.setStyleValue("height",e.height),this.m_props.target.setStyleValue("flex",null),this.m_props.target.removeClass("@flex")}}};if("mousemove"==t.type){let s=t;e(s.pageX,s.pageY),t.preventDefault(),t.stopPropagation()}else if("touchmove"==t.type){let s=t;e(s.touches[0].pageX,s.touches[0].pageY),t.preventDefault(),t.stopPropagation()}else"mouseup"!=t.type&&"touchend"!=t.type||(this.m_props.target.removeClass("sizing"),Component.releaseCapture(),t.preventDefault(),t.stopPropagation())}};e.Container=class Container extends Component{m_shortcuts;constructor(t){super(t)}addShortcut(t,e,i=null,o=!1){this.m_shortcuts||(this.m_shortcuts=[],this.setDomEvent("keydown",(t=>this._handleKeydown(t)))),(0,s.isArray)(t)||(t=[t]),t.forEach((t=>{let s="";t.match(/SHIFT/i)&&(t=t.replace(/SHIFT/i,""),s+="shift+"),t.match(/CTRL/i)&&(t=t.replace(/CTRL/i,""),s+="ctrl+"),t.match(/ALT/i)&&(t=t.replace(/ALT/i,""),s+="alt+"),s+=t.replace("+","").toLowerCase(),this.m_shortcuts.push({sequence:s,name:e,immediate:o,callback:i})}))}removeShortcuts(){this.m_shortcuts&&(this.m_shortcuts=[])}_handleKeydown(t){if(!this.m_shortcuts)return;let e="";t.shiftKey&&(e+="shift+"),t.ctrlKey&&(e+="ctrl+"),t.altKey&&(e+="alt+"),e+=t.key.toLowerCase(),this.m_shortcuts.some((i=>{if(i.sequence==e)return i.callback?i.immediate?i.callback(t):(0,s.asap)((()=>{i.callback(t)})):this.emit("shortcut",function(t){return(0,o.BasicEvent)({name:t})}(i.name)),t.preventDefault(),t.stopPropagation(),!0}))}}})),define("x4/request",["require","exports","x4/tools"],(function(t,e,s){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.ajax=e.ajaxAsText=e.ajaxAsJSON=e.ajaxRequest=void 0;function i(t,e){if(!t)return"";let i=[];for(let e in t){let o=t[e];if((0,s.isArray)(o))for(let t=0,s=o.length;t<s;t++)i.push(encodeURIComponent(e)+"[]="+encodeURIComponent(""+o[t]));else void 0===o&&(o=""),i.push(encodeURIComponent(e)+"="+encodeURIComponent(""+o))}let o=i.join("&");return e?"?"+o:o}async function o(t,e,i){let o={method:"GET",headers:{"X-Requested-With":"XMLHttpRequest"}};if(i&&(o.headers["Content-Type"]=i),e&&(o={...o,...e},e.body&&!(0,s.isString)(e.body))){let t=!1;(0,s.isLiteralObject)(e.body)?t=!0:e.body instanceof Blob||e.body instanceof ArrayBuffer||e.body instanceof FormData||e.body instanceof URLSearchParams||e.body instanceof ReadableStream||(t=!0),o.body=t?JSON.stringify(e.body):e.body}let n=await fetch(t,o);if(e&&e.noGenX)return n;if(!n.ok)throw new s.NetworkError(n);return n}e.ajaxRequest=function(t){let e,s=t.url,o=t.method||"GET",n=!1;t.params instanceof FormData?(e=t.params,n=!0):"POST"==o?e=i(t.params,!1):s+=i(t.params,!0),s=encodeURI(s);let r=new XMLHttpRequest;if(r.open(o,s),r.upload.addEventListener("progress",(function(e){if(console.log(e),t.progress)try{if(e.lengthComputable){let s=a(e.loaded)+" / "+a(e.total);t.progress(e.loaded,e.total,s)}}catch(t){console.error("unhandled exception:",t)}}),!1),r.addEventListener("timeout",l),r.addEventListener("error",l),r.addEventListener("load",(function(){if(r.status>=200&&r.status<300){if(t.success)try{t.success(r.response,t.userData)}catch(t){console.error("unhandled exception:",t)}}else l()})),n||r.setRequestHeader("Content-type","application/x-www-form-urlencoded; charset=UTF-8"),"POST"!=o&&(r.responseType=t.responseType||"json",r.timeout=t.timeout||1e4),t.headers)for(let e in t.headers)this.xhr.setRequestHeader(e,t.headers[e]);function a(t){let e,s;return t>=1e9?(e="Gb",s=t/1e9):t>=1e6?(e="Mb",s=t/1e6):t>=1e3?(e="Kb",s=t/1e3):(e="bytes",s=t),s.toFixed(2)+e}function l(){t.failure&&t.failure(r.status,r.statusText,t.userData)}return n||"POST"==o?r.send(e):r.send(),function(){r.abort()}},e.ajaxAsJSON=async function(t,e){return(await o(t,e,"application/json")).json()},e.ajaxAsText=async function(t,e){return(await o(t,e,"text/plain")).text()},e.ajax=o})),define("x4/datastore",["require","exports","x4/request","x4/tools","x4/x4_events","x4/base_component"],(function(t,e,s,i,o,n){"use strict";function r(t,e){return(0,o.BasicEvent)({type:t,id:e})}Object.defineProperty(e,"__esModule",{value:!0}),e.DataView=e.EvViewChange=e.DataStore=e.DataProxy=e.AutoRecord=e.Record=e.data_array=e.data_calc=e.data_date=e.data_bool=e.data_float=e.data_int=e.data_string=e.data_field=e.data_id=void 0;class MetaInfos{id;fields;constructor(){this.id=void 0,this.fields=[]}}function a(t,e=!0){let s=t.constructor,i=`~meta~${s.name.toLowerCase()}~infos`,o=s[i];if(void 0===o){e||console.assert(void 0!==o),o=t.constructor[i]=new MetaInfos;let n=Object.getPrototypeOf(s);for(;n!=Record;){s=n;let t=a(s.prototype,!1);o.fields=[...t.fields,...o.fields],n=Object.getPrototypeOf(s),console.assert(void 0===o.id,"cannot define mutiple record id"),o.id||(o.id=t.id)}}return o}function l(t){return(e,s)=>{a(e).fields.push({name:s,...t})}}e.data_id=function(){return(t,e)=>{let s=a(t);s.fields.push({name:e,type:"any",required:!0}),s.id=e}},e.data_field=l,e.data_string=function(t){return l({...t,type:"string"})},e.data_int=function(t){return l({...t,type:"int"})},e.data_float=function(t){return l({...t,type:"float"})},e.data_bool=function(t){return l({...t,type:"bool"})},e.data_date=function(t){return l({...t,type:"date"})},e.data_calc=function(t){return l({...t,type:"calc"})},e.data_array=function(t,e){return l({...e,type:"array",model:new t})};class Record{constructor(t,e){void 0!==t&&this.unSerialize(t,e)}clone(t){let e=new this.constructor;return t&&e.unSerialize(t),e}getID(){return this[a(this,!1).id]}getFields(){return a(this,!1).fields}validate(){let t=null;return this.getFields().forEach((e=>{e.required&&!this.getField(e.name)&&(t&&(t=[]),t.push(new Error(`field ${e.name} is required.`)))})),t}getFieldIndex(t){return this.getFields().findIndex((e=>e.name==t))}serialize(){let t={};return this.getFields().forEach((e=>{void 0===e.calc&&(t[e.name]=t[e.name])})),t}unSerialize(t,e){let s=this.getFields();return s.forEach((e=>{let s=t[e.name];void 0!==s&&(this[e.name]=this._convertField(e,s))})),void 0!==e?this[s[0].name]=e:console.assert(void 0!==this.getID()),this}_convertField(t,e){switch(t.type){case"float":{let s="number"==typeof e?e:parseFloat(e);if(void 0!==t.prec){let e=Math.pow(10,t.prec);s=Math.round(s*e)/e}return s}case"int":return"number"==typeof e?e:parseInt(e);case"date":return(0,i.isString)(e)?new Date(e):e;case"array":{let s=[];if(t.model)return e.forEach((e=>{s.push(t.model.clone(e))})),s;break}}return e}getRaw(t){let e,s=this.getFields();if("string"==typeof t){if(e=s.findIndex((e=>e.name==t)),e<0)return void console.assert(!1,"unknown field: "+t)}else{if(!(t>=0&&t<s.length))return void console.assert(!1,"bad field name: "+t);e=t}let i=s[e];return void 0!==i.calc?i.calc.call(this):this[i.name]}setRaw(t,e){this[t]=e}getField(t){let e=this.getRaw(t);return null==e?"":""+e}setField(t,e){let s=this.getFields(),i=s.findIndex((e=>e.name==t));if(i<0)return void console.assert(!1,"unknown field: "+t);let o=s[i];void 0===o.calc?this.setRaw(o.name,e):console.assert(!1,"cannot set calc field: "+t)}}e.Record=Record;class AutoRecord extends Record{m_data;m_fid;constructor(t){super(),this.m_data=t}getID(){if(!this.m_fid){let t=Object.keys(this.m_data);this.m_fid=t[0]}return this.m_data[this.m_fid]}getFields(){return Object.keys(this.m_data).map((t=>({name:t})))}getRaw(t){return this.m_data[t]}setRaw(t,e){this.m_data[t]=e}clone(t){return new AutoRecord({...t})}}e.AutoRecord=AutoRecord;class DataProxy extends n.BaseComponent{constructor(t){super(t)}load(){this._refresh()}save(t){"local"==this.m_props.type&&console.assert(!1)}_refresh(t=0){"local"==this.m_props.type?console.assert(!1):setTimeout((()=>{(0,s.ajaxRequest)({url:this.m_props.path,method:"GET",params:this.m_props.params,success:t=>{this.emit("change",(0,o.EvChange)(t))}})}),t)}}e.DataProxy=DataProxy;class DataStore extends o.EventSource{m_model;m_fields;m_records;m_proxy;m_rec_index;constructor(t){super(),this.m_fields=void 0,this.m_records=[],this.m_rec_index=null,this.m_model=t.model,this.m_fields=t.model.getFields(),t.data?this.setRawData(t.data):t.url&&this.load(t.url)}load(t){"file://"===t.substr(0,7)?(this.m_proxy=new DataProxy({type:"local",path:t.substr(7),events:{change:t=>{this.setData(t.value)}}}),this.m_proxy.load()):(this.m_proxy=new DataProxy({type:"ajax",path:t,events:{change:t=>{this.setData(t.value)}}}),this.m_proxy.load())}reload(){this.m_proxy.load()}setData(t){let e=[];t.forEach((t=>{e.push(this.m_model.clone(t))})),this.setRawData(e)}setRawData(t){this.m_records=t,this._rebuildIndex(),this.emit("data_change",r("change"))}_rebuildIndex(){this.m_rec_index=null,this.m_rec_index=this.createIndex(null),this.m_rec_index=this.sortIndex(this.m_rec_index,null)}update(t){let e=t.getID(),s=this.indexOfId(e);return!(s<0)&&(this.m_records[this.m_rec_index[s]]=t,this.emit("data_change",r("update",e)),!0)}append(t){if(!(t instanceof Record)){t=this.m_model.clone().unSerialize(t)}console.assert(t.getID()),this.m_records.push(t),this._rebuildIndex(),this.emit("data_change",r("create",t.getID()))}getMaxId(){let t;return this.m_records.forEach((e=>{let s=e.getID();(void 0===t||t<s)&&(t=s)})),t}delete(t){let e=this.indexOfId(t);return!(e<0)&&(e=this.m_rec_index[e],this.m_records.splice(e,1),this._rebuildIndex(),this.emit("data_change",r("delete",t)),!0)}get count(){return this.m_rec_index?this.m_rec_index.length:this.m_records.length}get fields(){return this.m_fields}indexOfId(t){for(let e=this.count,s=0;0!=e;e>>=1){let i=s+(e>>1),o=this.m_rec_index[i],n=this.m_records[o].getID();if(n==t)return i;n<t&&(s=i+1,e--)}return-1}getById(t){let e=this.indexOfId(t);return e<0?null:(e=this.m_rec_index[e],this.m_records[e])}getByIndex(t){let e=this.m_rec_index[t];return this._getRecord(e)}_getRecord(t){return this.m_records[t]??null}moveTo(t){t.setRawData(this.m_records)}createView(t){let e={...t,store:this};return new DataView(e)}createIndex(t){if(t&&"empty-result"===t.op)return new Uint32Array(0);let e=new Uint32Array(this.m_records.length),s=0;if(t)if("function"==typeof t.op){let i=t.op;this.forEach(((t,o)=>{t&&i(t)&&(e[s++]=o)}))}else{let o=this.m_model.getFieldIndex(t.field);if(o<0)return console.assert(!1,"unknown field name in filter"),new Uint32Array(0);let n,r,a=t.value;function l(t){return t<a}function h(t){return t<=a}function c(t){return t==a}function m(t){return t!=a}function d(t){return t>=a}function u(t){return t>a}function p(t){return r.lastIndex=-1,r.test(t)}if((0,i.isString)(a)&&!t.caseSensitive&&(a=a.toUpperCase()),a instanceof RegExp)r=a,n=p;else switch(t.op){case"<":n=l;break;case"<=":n=h;break;case"=":n=c;break;case">=":n=d;break;case">":n=u;break;case"<>":n=m}this.forEach(((i,r)=>{if(!i)return;let a=i.getRaw(o);null==a?a="":(a=""+a,t.caseSensitive||(a=a.toUpperCase())),n(a)&&(e[s++]=r)}))}else this.forEach(((t,i)=>{e[s++]=i}));return e.slice(0,s)}sortIndex(t,e){let s=0,i=[];if(null===e?i.push({fidx:0,asc:!0}):i=e.map((t=>{let e=this.m_model.getFieldIndex(t.field);return-1==e&&(console.assert(!1,"unknown field name in sort"),s++),{fidx:e,asc:t.ascending}})),s||0==i.length)return t;if(1==i.length){let e=i[0].fidx;t.sort(((t,s)=>{let i=this.getByIndex(t).getRaw(e)??"",o=this.getByIndex(s).getRaw(e)??"";return i>o?1:i<o?-1:0})),i[0].asc||t.reverse()}else t.sort(((t,e)=>{for(let s=0;s<i.length;s++){let o=i[s].fidx,n=i[s].asc?1:-1,r=this.getByIndex(t).getRaw(o)??"",a=this.getByIndex(e).getRaw(o)??"";if(r>a)return n;if(r<a)return-n}return 0}));return t}forEach(t){this.m_rec_index?this.m_rec_index.some(((e,s)=>{if(t(this.m_records[e],s))return s})):this.m_records.some(((e,s)=>{if(e&&t(e,s))return s}))}export(){return this.m_records}changed(){this.emit("data_change",r("change"))}}function h(t){return(0,o.BasicEvent)({action:t})}e.DataStore=DataStore,e.EvViewChange=h;class DataView extends n.BaseComponent{m_index;m_store;m_sort;m_filter;constructor(t){super(t),this.m_store=t.store,this.m_index=null,this.m_filter=null,this.m_sort=null,this.filter(t.filter),t.order?(0,i.isString)(t.order)?this.sort([{field:t.order,ascending:!0}]):(0,i.isArray)(t.order)?this.sort(t.order):this.sort([t.order]):this.sort(null),this.m_store.on("data_change",(t=>this._storeChange(t)))}_storeChange(t){this._filter(this.m_filter,"change"!=t.type),this._sort(this.m_sort,"change"!=t.type),this.emit("view_change",h("change"))}filter(t){return this.m_index=null,this._filter(t,!0)}_filter(t,e){return this.m_index=this.m_store.createIndex(t),this.m_filter=t,this.m_sort&&this.sort(this.m_sort),e&&this.emit("view_change",h("filter")),this.m_index.length}sort(t){this._sort(t,!0)}_sort(t,e){this.m_index=this.m_store.sortIndex(this.m_index,t),this.m_sort=t,e&&this.emit("view_change",h("sort"))}get store(){return this.m_store}get count(){return this.m_index.length}indexOfId(t){let e=this.m_store.indexOfId(t);return this.m_index.findIndex((t=>t===e))}getByIndex(t){if(t>=0&&t<this.m_index.length){let e=this.m_index[t];return this.m_store.getByIndex(e)}return null}getById(t){return this.m_store.getById(t)}changed(){this.emit("view_change",h("change"))}forEach(t){this.m_index.some((e=>{let s=this.m_store.getByIndex(e);if(s&&t(s,e))return e}))}}e.DataView=DataView})),define("x4/hosts/host",["require","exports"],(function(t,e){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.host=e.Host=void 0;e.Host=class Host{constructor(){e.host=this}makePath(...t){return t.join("/")}readBinary(t){return Promise.reject("not imp")}writeBinary(t,e){return Promise.reject("not imp")}readUtf8(t){return Promise.reject("not imp")}writeUtf8(t,e){return Promise.reject("not imp")}compress(t){return Promise.reject("not imp")}decompress(t){return Promise.reject("not imp")}readLocalStorage(t){return localStorage.getItem(t)}writeLocalStorage(t,e){localStorage.setItem(t,e)}stat(t){throw"not imp"}readDir(t){throw"not imp"}require(t){throw"not imp"}cwd(){throw"not imp"}getPath(t){throw"not imp"}getPathPart(t,e){throw"not imp"}},e.host=null})),define("x4/settings",["require","exports","x4/hosts/host"],(function(t,e,s){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Settings=void 0;e.Settings=class Settings{m_data;m_name;constructor(t){this.m_data=null,this.m_name=t??"settings"}set(t,e){this._load(),this.m_data[t]=e,this._save()}get(t,e){return this._load(),this.m_data[t]??e}_save(){let t=JSON.stringify(this.m_data);s.host.writeLocalStorage(this.m_name,t)}_load(){if(this.m_data)return;this.m_data={};let t=s.host.readLocalStorage(this.m_name);null!==t&&(t=JSON.parse(t),t?this.m_data=t:console.info("There was an error attempting to read your settings."))}}})),define("x4/application",["require","exports","x4/base_component","x4/settings","x4/tools","x4/i18n"],(function(t,e,s,i,o,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Application=void 0;class Application extends s.BaseComponent{static self=null;static instance(){return Application.self}m_mainView;m_locale;moneyFormatter;moneySymbol;m_app_name;m_app_version;m_app_uid;m_local_storage;m_user_data;constructor(t){console.assert(null===Application.self,"application is a singleton"),super(t),this.m_app_name=t.app_name??"application",this.m_app_version=t.app_version??"1.0",this.m_app_uid=t.app_uid??"application",this.m_locale=t.locale??"fr-FR",this.setCurrencySymbol(null);let e=`${this.m_app_name}.${this.m_app_version}.settings`;this.m_local_storage=new i.Settings(e),this.m_user_data={},Application.self=this,"onload"in globalThis?globalThis.addEventListener("load",(()=>{this.ApplicationCreated()})):this.ApplicationCreated()}ApplicationCreated(){}get locale(){return this.m_locale}get app_name(){return this.m_app_name}get app_uid(){return this.m_app_uid}get app_version(){return this.m_app_version}get local_storage(){return this.m_local_storage}get user_data(){return this.m_user_data}get history(){return null}setCurrencySymbol(t){this.moneyFormatter=t?new Intl.NumberFormat(this.locale,{style:"currency",currency:t,currencyDisplay:"symbol"}):new Intl.NumberFormat(this.locale,{style:"decimal",useGrouping:!0,minimumFractionDigits:2,maximumFractionDigits:2})}set mainView(t){this.m_mainView=t,(0,o.deferCall)((()=>{document.body.appendChild(t._build())}))}get mainView(){return this.m_mainView}getStore(t){return console.assert(!1,"not implemented"),null}setTitle(t){document.title=n._tr.global.app_name+" > "+t}disableZoomWheel(){window.addEventListener("mousewheel",(function(t){t.ctrlKey&&t.preventDefault()}),{passive:!1,capture:!0})}enterModal(t){}}e.Application=Application})),define("x4/icon",["require","exports","x4/component","x4/styles","x4/tools","x4/x4_events"],(function(t,e,s,i,o,n){"use strict";function r(t,e,s=null){return(0,n.BasicEvent)({url:t,svg:e,context:s})}Object.defineProperty(e,"__esModule",{value:!0}),e.Icon=e.EvLoaded=void 0,e.EvLoaded=r;class Loader extends n.EventSource{svgs;constructor(){super(),this.svgs=new Map}load(t){if(this.svgs.has(t)){const e=this.svgs.get(t);e&&this.signal("loaded",r(t,e))}else{this.svgs.set(t,null);const e=async t=>{const e=await fetch(t);if(e.ok){const s=await e.text();this.svgs.set(t,s),this.signal("loaded",r(t,s))}};e(t)}}}const a=new Loader;class Icon extends s.Component{m_icon;m_iconName;constructor(t){super(t),this._setIcon(t.icon,!1),t.size&&this.setStyleValue("fontSize",t.size)}_setIcon(t,e){const o=/\s*url\s*\(\s*(.+)\s*\)\s*/gi,n=/\s*svg\s*\(\s*(.+)\s*\)\s*/gi,r=/(.*\.svg)$/gi;if(!t)return void(this.m_iconName="");let a,l;if("number"==typeof t)a=t=t.toString(16);else{let e=n.exec(t)||r.exec(t);if(e)return l=e[1].trim(),void this._setSVG(l);{this.removeClass("@svg");let e=o.exec(t);e?(l=e[1].trim(),a=l.replace(/[/\\\.\* ]/g,"_")):(a=t,""!=(t=i.Stylesheet.getVar("icon-"+t))&&void 0!==t||(console.assert(!1),t="0"))}}if(this.m_iconName=a,this.m_icon===t)return;let h,c=s.Component.getCss();if(e&&this.m_icon&&(h="icon-"+a,this.removeClass(h)),h="icon-"+a,void 0===Icon.icon_cache[h]){let e;Icon.icon_cache[h]=!0,e=l?`display: block; content: ' '; background-image: url(${l}); background-size: contain; width: 100%; height: 100%; background-repeat: no-repeat; color: white;`:`content: "\\${t}";`,c.setRule(h,`.${h}::before {${e}}`)}this.addClass(h),this.m_icon=t}set icon(t){this._setIcon(t,!0)}get icon(){return this.m_iconName}_setSVG(t){const e=s=>{s.url==t&&(this.addClass("@svg-icon"),this.setContent(o.HtmlString.from(s.svg),!1),a.off("loaded",e))};a.on("loaded",e),a.load(t)}static icon_cache=[]}e.Icon=Icon})),define("x4/label",["require","exports","x4/component","x4/tools","x4/icon"],(function(t,e,s,i,o){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Label=void 0;class Label extends s.Component{constructor(t){"string"==typeof t||t instanceof i.HtmlString?super({text:t}):super(t)}render(t){t.icon?(this.setProp("tag","span"),this.addClass("@hlayout"),this.setContent([new o.Icon({icon:t.icon}),new s.Component({content:this.m_props.text,ref:"text"})])):this.setContent(this.m_props.text),this.addClass(t.align??"left")}set text(t){let e=this.m_props;if(e.text!==t&&(e.text=t,this.dom)){let t=this;this.m_props.icon&&(t=this.itemWithRef("text")),t.setContent(this.m_props.text)}}get text(){return this.m_props.text}}e.Label=Label})),define("x4/popup",["require","exports","x4/component","x4/tools","x4/x4_events","x4/application"],(function(t,e,s,i,o,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Popup=e.EvMove=void 0,e.EvMove=function(t){return(0,o.BasicEvent)({pos:t})};class Popup extends s.Container{m_ui_mask;m_hasMask=!0;static modal_stack=[];constructor(t){super(t),this.addClass("@hidden")}enableMask(t=!0){this.m_hasMask=t}show(t){if(void 0!==t?this.m_hasMask=!!t:t=this.m_hasMask,this.m_hasMask){const t=document.activeElement;for(t&&t.blur(),this.m_ui_mask=document.body.lastChild;this.m_ui_mask;){if(1==this.m_ui_mask.nodeType){let t=(0,s.flyWrap)(this.m_ui_mask);if(t.hasClass("@menu")||t.hasClass("@non-maskable"));else if("none"!=t.getStyleValue("display")&&t.isUserVisible()){if(t.hasClass("@comp"))break}else;}this.m_ui_mask=this.m_ui_mask.previousSibling}this.m_ui_mask&&(0,s.flyWrap)(this.m_ui_mask).addClass("@mask")}t&&n.Application.instance().enterModal(!0),this.setStyle({left:0,top:0}),document.body.appendChild(this._build()),this.removeClass("@hidden");let e=this.getBoundingRect(),i=(document.body.clientWidth-e.width)/2,o=(document.body.clientHeight-e.height)/2;if(this.setStyleValue("left",i),this.setStyleValue("top",o),t){let t=document.activeElement;if(!this.dom.contains(t)){const t=this.queryItem("[autofocus]");if(t)t.focus();else{let t=this.queryItem("[tabindex]");if(t){let e=[].map.call(t,(t=>t));e=e.filter((t=>null!==t.offsetParent)),e.length&&e[0].focus()}}}Popup.modal_stack.push(this.dom)}}displayAt(t,e,s="top left",i){this.show();let o="l",n="t";s.indexOf("right")>=0&&(o="r"),s.indexOf("bottom")>=0&&(n="b");let r=document.body.getBoundingClientRect(),a=this.getBoundingRect();"r"==o&&(t-=a.width),"b"==n&&(e-=a.height),i&&(t+=i.x,e+=i.y),t<4&&(t=4),t+a.width>r.right-4&&(t=r.right-4-a.width,i?.x<0&&(t+=i.x)),e<4&&(e=4),e+a.height>r.bottom-4&&(e=r.bottom-4-a.height,i?.y<0&&(e+=i.y)),this.setStyle({left:t,top:e})}close(){if(this.hide(),this.m_hasMask&&this.m_ui_mask){(0,s.flyWrap)(this.m_ui_mask).removeClass("@mask");n.Application.instance().enterModal(!1)}let t=Popup.modal_stack.indexOf(this.dom);t>=0&&Popup.modal_stack.splice(t),this.dispose()}componentCreated(){if(this.m_props.sizable){this.addClass("@size-all");let t=["top","right","bottom","left","topleft","topright","bottomleft","bottomright"];for(let e of t)new s.SizerOverlay({target:this,sens:e,events:{rawresize:t=>this._mouseResize(t)}})}}_mouseResize(t){t.preventDefault();let e=this.getBoundingRect(),o=this.getComputedStyle(),n=t.ui_event,r=o.parse("marginTop"),a=o.parse("marginLeft"),l=o.parse("marginRight"),h=o.parse("marginBottom"),c=0,m=0,d=(0,i.getMousePos)(n,!0);switch(t.sens){case"topright":case"bottomright":case"right":c=e.right-l-d.x;break;case"topleft":case"bottomleft":case"left":c=e.left-a-d.x}switch(t.sens){case"bottomleft":case"bottomright":case"bottom":m=e.bottom-h-d.y;break;case"topleft":case"topright":case"top":m=e.top-r-d.y}e.left-=a,e.top-=r;let u=t.sens;s.Component.setCapture(this,(t=>{let o=(t,o)=>{let n,r,a=e.left,l=e.top,h=e.width,d=e.height,p=t+c,_=o+m;switch(p<0&&(p=0),_<0&&(_=0),u){case"topright":case"bottomright":case"right":h=p-a;break;case"topleft":case"bottomleft":case"left":n=a-p,h+=n,a-=n}switch(u){case"bottomleft":case"bottomright":case"bottom":d=_-l;break;case"topleft":case"topright":case"top":r=l-_,d+=r,l-=r}let g=new i.Size(h,d);this.setStyle({left:a,top:l,width:g.width,height:g.height}),this.emit("size",(0,s.EvSize)(g))};if("mouseup"==t.type||"touchend"==t.type)s.Component.releaseCapture();else if("mousemove"==t.type){let e=t;o(e.pageX,e.pageY)}else if("touchmove"==t.type){let e=t;o(e.touches[0].pageX,e.touches[0].pageY)}}))}}function r(t){if("Tab"==t.key||"Enter"==t.key){const e=t.target;if("TEXTAREA"==e.tagName)return;const i=s.Component.getElement(e);if(i&&(i.hasAttribute("wants-tab")||i.hasAttribute("wants-enter")))return;let o=document.body;Popup.modal_stack.length&&(o=Popup.modal_stack[Popup.modal_stack.length-1]),function(t,e,i){let o=document.activeElement;if(!t.contains(o))return;s.Component.getElement(e);let n=t.querySelectorAll("[tabindex]"),r=[].map.call(n,(t=>t));if(r=r.filter((t=>null!==t.offsetParent)),!r.length)return;let a=r.indexOf(e);a<0?a=0:i?a>0?a--:a=r.length-1:a<r.length-1?a++:a=0;r[a].focus()}(o,t.target,t.shiftKey),t.stopPropagation(),t.preventDefault()}}function a(){document.body.addEventListener("keydown",r,!0)}e.Popup=Popup,document.body?a():window.addEventListener("load",a)})),define("x4/layout",["require","exports","x4/component","x4/tools"],(function(t,e,s,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.ScrollView=e.TableLayout=e.GridLayout=e.AutoLayout=e.VLayout=e.HLayout=e.AbsLayout=void 0;class AbsLayout extends s.Container{}e.AbsLayout=AbsLayout;class HLayout extends s.Container{}e.HLayout=HLayout;class VLayout extends s.Container{}e.VLayout=VLayout;class AutoLayout extends s.Container{constructor(t){super(t),this.setDomEvent("sizechange",(()=>this._updateLayout()))}componentCreated(){super.componentCreated(),this._updateLayout()}_updateLayout(){let t="horizontal"==this.m_props.defaultLayout;if(this.m_props.switchSize<=0&&window.screen.height>window.screen.width)t=!t;else{let e=this.getBoundingRect();(t&&e.width<this.m_props.switchSize||!t&&e.height<this.m_props.switchSize)&&(t=!t)}t?(this.removeClass("@vlayout"),this.addClass("@hlayout")):(this.addClass("@vlayout"),this.removeClass("@hlayout"))}}e.AutoLayout=AutoLayout;class GridLayout extends s.Container{constructor(t){super(t)}render(){this.m_props.colSizes&&this.setStyleValue("grid-template-columns",this.m_props.colSizes),this.m_props.rowSizes&&this.setStyleValue("grid-template-rows",this.m_props.rowSizes),this.m_props.colGap&&this.setStyleValue("grid-gap",this.m_props.colGap),this.m_props.template&&this.setStyleValue("grid-template-areas",this.m_props.template.join("\n"))}}e.GridLayout=GridLayout;class TableLayout extends s.Container{m_cells;constructor(t){super(t),this.setProp("tag","table"),this.m_cells=new Map}_getCell(t,e,s=!0){let i=o(t,e);return this.m_cells.get(i)??(s?{item:void 0}:null)}_setCell(t,e,i,n=!1){let r=o(t,e);this.m_cells.set(r,i),this.dom&&i.item&&n&&(i.item instanceof s.Component?i.item.update():this.enumChilds((s=>{if(s.getData("row")==t){if(s.getData("col")==e)return s.setContent(i.item),s.update(),!0}})))}setCell(t,e,s){let i=this._getCell(t,e);i.item=s,this._setCell(t,e,i,!0)}merge(t,e,s,i){let o=this._getCell(t,e);o.rowSpan=s,o.colSpan=i,this._setCell(t,e,o)}setCellWidth(t,e,s){let i=this._getCell(t,e);i.width=s,this._setCell(t,e,i)}setCellHeight(t,e,s){let i=this._getCell(t,e);i.height=s,this._setCell(t,e,i)}setCellClass(t,e,s){let i=this._getCell(t,e);i.cls=s,this._setCell(t,e,i)}setColClass(t,e){let s=this._getCell(-1,t);s.cls=e,this._setCell(-1,t,s)}setRowClass(t,e){let s=this._getCell(t,999);s.cls=e,this._setCell(t,999,s)}getCell(t,e){return this._getCell(t,e)?.item}render(){let t=[],e=[];for(let i=0;i<this.m_props.rows;i++){let n=[];for(let t=0;t<this.m_props.columns;t++){let r=o(i,t);if(e.indexOf(r)>=0)continue;let a=this.m_cells.get(r),l=this.m_cells.get(o(-1,t)),h="";a&&a.cls&&(h=a.cls),l&&l.cls&&(h+=" "+l.cls);let c=new s.Component({tag:"td",content:a?.item,width:a?.width,height:a?.height,data:{row:i,col:t},cls:h});if(a){let s=a.rowSpan??0,n=a.colSpan??0;if(s>0&&c.setAttribute("rowspan",s+1),n>0&&c.setAttribute("colspan",n+1),s||n)for(let r=0;r<=s;r++)for(let s=0;s<=n;s++)e.push(o(r+i,s+t))}n.push(c)}let r=this._getCell(i,999,!1),a=new s.Component({tag:"tr",data:{row:i},content:n,cls:r?.cls});t.push(a)}this.setContent(t)}}function o(t,e){return 1e3*t+e}e.TableLayout=TableLayout;class ScrollView extends s.Component{constructor(t){super(t),this.setContent(t.content)}setContent(t){if(t){let e;e=(0,i.isArray)(t)?new VLayout({content:t}):t,e.addClass("@scroll-container"),super.setContent(e)}else super.setContent(null)}}e.ScrollView=ScrollView})),define("x4/menu",["require","exports","x4/component","x4/x4_events","x4/popup","x4/icon","x4/label","x4/layout"],(function(t,e,s,i,o,n,r,a){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.MenuBar=e.MenuItem=e.Menu=e.MenuTitle=e.MenuSeparator=void 0;class MenuSeparator extends s.Component{}e.MenuSeparator=MenuSeparator;class MenuTitle extends r.Label{}e.MenuTitle=MenuTitle;class Menu extends o.Popup{static watchCount=0;static rootMenu=null;m_subMenu;m_opener;m_virtual;m_lock;constructor(t,e){super(t),this.addClass("@shadow"),this.m_opener=e,this.m_virtual=!1,this.m_lock=0,this.enableMask(!1)}lock(t){this.m_lock+=t?1:-1}setVirtual(){this.m_virtual=!0}setSubMenu(t){this.m_subMenu=t}hideSubMenu(){this.m_subMenu&&(this.m_subMenu.m_opener._close(),this.m_subMenu.hide(),this.m_subMenu=null)}render(t){this.setContent(t.items)}show(){this.m_virtual||Menu._addMenu(this),super.show()}close(){(this.dom||this.m_virtual)&&(this.m_opener&&this.m_opener._close(),this.m_subMenu&&(this.m_subMenu.close(),this.m_subMenu=null),super.close(),Menu._removeMenu())}clear(){this.m_props.items=[]}static _addMenu(t){0==Menu.watchCount&&(Menu.rootMenu=t,document.addEventListener("mousedown",Menu._mouseWatcher)),Menu.watchCount++}static _removeMenu(){console.assert(Menu.watchCount>0),Menu.watchCount--,0==Menu.watchCount&&document.removeEventListener("mousedown",Menu._mouseWatcher)}static _mouseWatcher(t){if(t.defaultPrevented)return;let e=t.target;for(;e;){let t=s.Component.getElement(e);if(t&&t instanceof Menu)return;e=e.parentElement}Menu._discardAll()}static _discardAll(){Menu.rootMenu&&(Menu.rootMenu.close(),Menu.rootMenu=null)}displayAt(t,e,s="top left",i){this.m_lock||Menu._discardAll(),super.displayAt(t,e,s,i)}}e.Menu=Menu;class MenuItem extends s.Component{m_menu;m_isOpen;constructor(t){super(t),this.m_menu=null,this.m_isOpen=!1,this.setDomEvent("mousedown",(t=>this._mousedown(t))),this.setDomEvent("click",(t=>this._click(t))),this.mapPropEvents(t,"click")}render(t){let e=t.icon??32,s=t.text;void 0!==t.checked&&(e=t.checked?61452:0),this.isPopup&&this.addClass("@popup-menu-item"),s||e||this.addClass("@separator"),t.cls&&this.addClass(t.cls),this.setProp("tag","a"),this.setContent([e<0?null:new n.Icon({icon:e}),new r.Label({flex:1,text:s})])}get id(){return this.m_props.itemId}get text(){return this.m_props.text}get isPopup(){return!!this.m_props.items}_close(){this.removeClass("@opened"),this.m_isOpen=!1}_click(t){this.isPopup||(this.emit("click",(0,i.EvClick)()),Menu._discardAll())}_mousedown(t){if(this.isPopup){this.m_menu||(this.m_menu=new Menu({items:this.m_props.items},this));let e=this.m_isOpen,i=s.Component.getElement(this.dom,Menu);if(i&&i.hideSubMenu(),!e){i&&i.setSubMenu(this.m_menu),this.m_isOpen=!0;let t=this.getBoundingRect();this.m_menu.lock(!0),i?this.m_menu.displayAt(t.right,t.top):this.m_menu.displayAt(t.left,t.bottom),this.m_menu.lock(!1),this.addClass("@opened")}t.preventDefault()}}}e.MenuItem=MenuItem;class MenuBar extends a.HLayout{m_items;constructor(t,e){super(t),console.assert(!1,"not imp"),this.addClass("@shadow"),this.m_items=t.items}render(){this.setContent(this.m_items)}}e.MenuBar=MenuBar})),define("x4/button",["require","exports","x4/component","x4/x4_events","x4/icon","x4/label","x4/menu","x4/tools"],(function(t,e,s,i,o,n,r,a){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.ToggleButton=e.Button=e.BaseButton=void 0;class BaseButton extends s.Component{constructor(t){super(t),this.setProp("tag","button"),this.setDomEvent("click",(t=>this._handleClick(t))),this.setDomEvent("mousedown",(()=>{this._startAutoRep(!0)})),this.setDomEvent("mouseup",(()=>{this._startAutoRep(!1)})),this.setDomEvent("keydown",(t=>this._handleKeyDown(t))),this.mapPropEvents(t,"click")}render(t){let e=t.icon?new o.Icon({icon:t.icon,cls:"left",ref:"l_icon"}):null,s=new n.Label({flex:1,text:t.text??"",align:t.align,ref:"label"}),i=t.rightIcon?new o.Icon({icon:t.rightIcon,cls:"right",ref:"r_icon"}):null;this.setContent([e,s,i]),this._setTabIndex(t.tabIndex)}_startAutoRep(t){this.m_props.autoRepeat&&(t?this.startTimer("repeat",700,!1,(()=>{this.startTimer("repeat",this.m_props.autoRepeat,!0,this._sendClick)})):this.stopTimer("repeat"))}_handleKeyDown(t){t.ctrlKey||t.shiftKey||t.altKey||"Enter"!=t.key&&" "!=t.key||(this._sendClick(),t.preventDefault(),t.stopPropagation())}_handleClick(t){if(this.m_props.menu){let t=new r.Menu({items:(0,a.isFunction)(this.m_props.menu)?this.m_props.menu():this.m_props.menu}),e=this.getBoundingRect();t.displayAt(e.left,e.bottom,"tl")}else this._sendClick();t.preventDefault(),t.stopPropagation()}_sendClick(){if(this.m_props.menu){let t=new r.Menu({items:(0,a.isFunction)(this.m_props.menu)?this.m_props.menu():this.m_props.menu}),e=this.getBoundingRect();t.displayAt(e.left,e.bottom,"tl")}else this.emit("click",(0,i.EvClick)())}set text(t){this.m_props.text=t;let e=this.itemWithRef("label");e&&(e.text=t)}get text(){return this.itemWithRef("label")?.text}set icon(t){this.m_props.icon=t;let e=this.itemWithRef("l_icon");e&&(e.icon=t)}get icon(){return this.itemWithRef("l_icon")?.icon}set rightIcon(t){this.m_props.rightIcon=t;let e=this.itemWithRef("r_icon");e&&(e.icon=t)}get rightIcon(){return this.itemWithRef("l_icon")?.icon}set menu(t){this.m_props.menu=t}}e.BaseButton=BaseButton;e.Button=class Button extends BaseButton{};e.ToggleButton=class ToggleButton extends BaseButton{constructor(t){super(t)}render(t){super.render(t),t.checked&&(this.addClass("checked"),this._updateIcon())}_sendClick(){super._sendClick(),this.m_props.checked=!this.m_props.checked,this.setClass("checked",this.m_props.checked),this.emit("change",(0,i.EvChange)(this.m_props.checked)),this._updateIcon()}_updateIcon(){if(this.m_props.checkedIcon){const t=this.m_props.checked?this.m_props.checkedIcon:this.m_props.icon;let e=this.itemWithRef("l_icon");e&&(e.icon=t)}}}})),define("x4/calendar",["require","exports","x4/button","x4/popup","x4/component","x4/x4_events","x4/i18n","x4/label","x4/layout","x4/tools","x4/menu"],(function(t,e,s,i,o,n,r,a,l,h,c){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.PopupCalendar=e.Calendar=void 0;class Calendar extends l.VLayout{m_date;constructor(t){super(t),this.mapPropEvents(t,"change"),this.m_date=t.date?.clone()??new Date}render(t){let e=(0,h.date_clone)(this.m_date);e.setDate(1);let i=e.getDay();0==i&&(i=7),e.setDate(1-i+1);let n=(0,h.date_clone)(e),c=this.m_date.hash(),m=(0,h.date_clone)(this.m_date);m.setDate(1),m.setMonth(m.getMonth()+1),m.setDate(0);let d=(0,h.date_hash)(m),u=[],p=new l.HLayout({cls:"month-sel",content:[new a.Label({cls:"month",text:(0,h.formatIntlDate)(this.m_date,"O"),dom_events:{click:()=>this._choose("month")}}),new a.Label({cls:"year",text:(0,h.formatIntlDate)(this.m_date,"Y"),dom_events:{click:()=>this._choose("year")}}),new o.Flex,new s.Button({text:"<",click:()=>this._next(!1)}),new s.Button({text:">",click:()=>this._next(!0)})]});u.push(p);let _=[];_.push(new l.HLayout({cls:"weeknum cell"}));for(let t=0;t<7;t++)_.push(new a.Label({cls:"cell",flex:1,text:r._tr.global.day_short[(t+1)%7]}));u.push(new l.HLayout({cls:"week header",content:_}));let g=this.m_date.getMonth(),f=!0;for(;(0,h.date_hash)(n)<=d;){let t=[new l.HLayout({cls:"weeknum cell",content:new o.Component({tag:"span",content:(0,h.formatIntlDate)(n,"w")})})];for(let e=0;e<7;e++){let e="cell day";n.hash()==c&&(e+=" today"),n.getMonth()!=g&&(e+=" out"),t.push(new l.HLayout({cls:e,flex:1,content:new o.Component({tag:"span",content:(0,h.formatIntlDate)(n,"d")}),dom_events:{click:()=>this.select(n.clone())}})),n.setDate(n.getDate()+1),f=!1}u.push(new l.HLayout({cls:"week",flex:1,content:t}))}this.setContent(u)}select(t){this.m_date=t,this.emit("change",(0,n.EvChange)(t)),this.update()}_next(t){this.m_date.setMonth(this.m_date.getMonth()+(t?1:-1)),this.update()}_choose(t){let e=[];if("month"==t)for(let t=0;t<12;t++)e.push(new c.MenuItem({text:r._tr.global.month_long[t],click:()=>{this.m_date.setMonth(t),this.update()}}));else if("year"==t){let t=this.m_props.minDate?.getFullYear()??2e3,s=this.m_props.maxDate?.getFullYear()??2048;for(let i=t;i<s;i++)e.push(new c.MenuItem({text:""+i,click:()=>{this.m_date.setFullYear(i),this.update()}}))}let s=new c.Menu({items:e}),i=this.getBoundingRect();s.displayAt(i.left,i.top)}get date(){return this.m_date}set date(t){this.m_date=t,this.update()}}e.Calendar=Calendar;class PopupCalendar extends i.Popup{m_cal;constructor(t){super({tabIndex:1}),this.enableMask(!1),this.m_cal=new Calendar(t),this.m_cal.addClass("@fit"),this.setContent(this.m_cal)}_handleClick=t=>{if(!this.dom)return;let e=t.target;this.dom.contains(e)||o.Component.getElement(e,c.MenuItem)||this.close()};show(t){document.addEventListener("mousedown",this._handleClick),super.show(t)}close(){document.removeEventListener("mousedown",this._handleClick),super.close()}}e.PopupCalendar=PopupCalendar})),define("x4/canvas",["require","exports","x4/component","x4/x4_events"],(function(t,e,s,i){"use strict";function o(t,e=null,s=!0){if(t.length<2)return;if(e||(e=this),2==t.length)return!1!==s?e.moveTo(t[0].x,t[0].y):e.lineTo(t[0].x,t[0].y),void e.lineTo(t[1].x,t[1].y);function i(t,e){return{x:t.x+(e.x-t.x)/2,y:t.y+(e.y-t.y)/2}}let o=t[0],n=t[1],r=o;e.moveTo(o.x,o.y);for(let s=1,p=t.length;s<p;s++){let p=i(o,n);for(let t=0;t<8;t++){let{x:s,y:i}=(a=t/8,l=r.x,h=r.y,c=o.x,m=o.y,d=p.x,u=p.y,{x:(1-a)*(1-a)*l+2*(1-a)*a*c+a*a*d,y:(1-a)*(1-a)*h+2*(1-a)*a*m+a*a*u});e.lineTo(s,i)}o=t[s],n=t[s+1],r=p}var a,l,h,c,m,d,u;e.lineTo(o.x,o.y)}function n(t,e=.5,s=10,i=null,o=!0,n=!1){let r=[];for(let e=0,s=t.length;e<s;e++)r.push(t[e].x),r.push(t[e].y);let a,l=1,h=r.length,c=0,m=new Float32Array((h-2)*s+2+(n?2*s:0)),d=new Float32Array(4*(s+2)),u=4;for(a=r.slice(0),n?(a.unshift(r[h-1]),a.unshift(r[h-2]),a.push(r[0],r[1])):(a.unshift(r[1]),a.unshift(r[0]),a.push(r[h-2],r[h-1])),d[0]=1;l<s;l++){var p=l/s,_=p*p,g=_*p,f=2*g,x=3*_;d[u++]=f-x+1,d[u++]=x-f,d[u++]=g-2*_+p,d[u++]=g-_}function b(t,i,o){for(var n,r=2;r<o;r+=2){var a=t[r],l=t[r+1],h=t[r+2],d=t[r+3],u=(h-t[r-2])*e,p=(d-t[r-1])*e,_=(t[r+4]-a)*e,g=(t[r+5]-l)*e;for(n=0;n<s;n++){var f=n<<2,x=i[f],b=i[f+1],v=i[f+2],w=i[f+3];m[c++]=x*a+b*h+v*u+w*_,m[c++]=x*l+b*d+v*p+w*g}}}d[u]=1,b(a,d,h),n&&(a=[],a.push(r[h-4],r[h-3],r[h-2],r[h-1]),a.push(r[0],r[1],r[2],r[3]),b(a,d,4)),h=n?0:r.length-2,m[c++]=r[h],m[c]=r[h+1],i||(i=this);for(let t=0,e=m.length;t<e;t+=2)0==t&&!1!==o?i.moveTo(m[t],m[t+1]):i.lineTo(m[t],m[t+1])}function r(t,e,s,i,o,n=1){this.save(),this.beginPath(),this.moveTo(t,e),this.lineTo(s,i),this.lineWidth=n,this.strokeStyle=o,this.stroke(),this.restore()}function a(t,e,s,i,o){this.moveTo(t+o,e),this.lineTo(t+s-o,e),this.quadraticCurveTo(t+s,e,t+s,e+o),this.lineTo(t+s,e+i-o),this.quadraticCurveTo(t+s,e+i,t+s-o,e+i),this.lineTo(t+o,e+i),this.quadraticCurveTo(t,e+i,t,e+i-o),this.lineTo(t,e+o),this.quadraticCurveTo(t,e,t+o,e),this.closePath()}function l(t,e=!1){let s=this.measureText(t),i=s.fontBoundingBoxAscent+s.fontBoundingBoxDescent;return e?{width:Math.round(s.width),height:Math.round(i)}:{width:s.width,height:i}}function h(t){let e=Math.round(t)+"px";this.font=this.font.replace(/\d+px/,e)}function c(t,e,s){this.moveTo(t+s,e),this.arc(t,e,s,0,2*Math.PI)}Object.defineProperty(e,"__esModule",{value:!0}),e.Canvas=void 0;class Canvas extends s.Component{m_iwidth=-1;m_iheight=-1;m_scale=1;m_canvas;constructor(t){super(t),this.setDomEvent("sizechange",(()=>{this._paint()})),this.mapPropEvents(t,"paint")}render(){this.m_iwidth=-1,this.m_iheight=-1,this.m_canvas=new s.Component({tag:"canvas"}),this.setContent(this.m_canvas)}update(t=0){this.m_iheight=this.m_iwidth=-1,super.update(t)}scale(t){this.m_scale=t,this.m_iwidth=-1,this.redraw()}get canvas(){return this.m_canvas}$update_rep=0;redraw(t){void 0!==t?++this.$update_rep>=20?(this.stopTimer("update"),this._paint()):this.startTimer("update",t,!1,(()=>this._paint())):(this.stopTimer("update"),this._paint())}_paint(){this.$update_rep=0;let t=this.dom;if(!this.isUserVisible())return;let e=this.m_canvas.dom,s=t.clientWidth,i=t.clientHeight,m=e.getContext("2d");if(s!=this.m_iwidth||i!=this.m_iheight){let t=window.devicePixelRatio||1,e=m.webkitBackingStorePixelRatio||m.mozBackingStorePixelRatio||m.msBackingStorePixelRatio||m.oBackingStorePixelRatio||m.backingStorePixelRatio||1,o=this.canvas;if(t!==e||1!=this.m_scale){let n=t/e,r=s*n,a=i*n;o.setAttribute("width",""+r),o.setAttribute("height",""+a),o.setStyleValue("width",s),o.setStyleValue("height",i),n*=this.m_scale,m.scale(n,n)}else o.setAttribute("width",""+s),o.setAttribute("height",""+i),o.setStyleValue("width",s),o.setStyleValue("height",i),m.scale(1,1);this.m_iwidth=s,this.m_iheight=i}if(s&&i){let t=function(t,e,s){let i=t;return i.width=e,i.height=s,i.smoothLine=o,i.smoothLineEx=n,i.line=r,i.roundRect=a,i.calcTextSize=l,i.setFontSize=h,i.circle=c,i}(m,s,i);this.m_props.autoClear&&t.clearRect(0,0,s,i),t.save(),t.translate(-.5,-.5),this.paint(t),t.restore()}}paint(t){try{this.m_props.painter?this.m_props.painter(t):this.emit("paint",function(t){return(0,i.BasicEvent)({ctx:t})}(t))}catch(t){console.assert(!1,t)}}}e.Canvas=Canvas})),define("x4/input",["require","exports","x4/component"],(function(t,e,s){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Input=void 0;class Input extends s.Component{constructor(t){super(t)}render(t){this.setProp("tag","input"),this._setTabIndex(t.tabIndex),this.setAttributes({value:t.value,type:t.type||"text",name:t.name,placeholder:t.placeHolder,autofocus:t.autoFocus,readonly:t.readOnly,autocomplete:"chrome-off",tabindex:t.tabIndex,min:t.min,max:t.max,...t.attrs}),t.uppercase&&this.setStyleValue("textTransform","uppercase")}getType(){return this.m_props.type}get value(){if(this.dom&&(this.m_props.value=this.dom.value),this.m_props.uppercase){let t=this.m_props.value.toUpperCase();this.dom&&t!=this.m_props.value&&(this.dom.value=t),this.m_props.value=t}return this.m_props.value}set value(t){this.m_props.value=t,this.dom&&(this.dom.value=t)}getStoreValue(){if(this.m_props.value_hook)return this.m_props.value_hook.get();{let t=this.getAttribute("type");t&&(t=t.toLowerCase());let e,s=this.dom;if("file"===t){e=[];let t=s.files;for(let s=0;s<t.length;s++)e.push(t[s].name)}else"checkbox"===t?e=s.checked?1:0:"radio"===t?s.checked&&(e=this.value):"date"===t||(e=this.value);return e}}setStoreValue(t){if(this.m_props.value_hook)return this.m_props.value_hook.set(t);{let e=this.getAttribute("type"),s=this.dom;if(e&&(e=e.toLowerCase()),"checkbox"===e){let e=null!==t&&"0"!==t&&0!==t&&!1!==t;e!==s.checked&&(s.setAttribute("checked",""+e),s.dispatchEvent(new Event("change")))}else this.value=t}}set readOnly(t){this.setAttribute("readonly",t)}selectAll(){this.dom.select()}select(t,e=9999){this.dom.setSelectionRange(t,t+e)}getSelection(){let t=this.dom;return{start:t.selectionStart,length:t.selectionEnd-t.selectionStart}}}e.Input=Input})),define("x4/checkbox",["require","exports","x4/component","x4/x4_events","x4/input","x4/label"],(function(t,e,s,i,o,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.CheckBox=void 0;class CheckBox extends s.Component{constructor(t){super(t),this.setDomEvent("focus",(()=>this._setFocus())),this.mapPropEvents(t,"change")}render(t){let e=t.labelWidth??-1,s="__cb_"+this.uid;this.addClass("@hlayout"),this.addClass(t.align??"left"),this.setProp("tag","label"),this.setContent([new o.Input({ref:"input",type:"checkbox",name:t.name,id:s,tabIndex:t.tabIndex,value:t.value??"on",attrs:{checked:t.checked?"":void 0},dom_events:{change:this._change.bind(this)}}),new n.Label({text:t.text??"",width:e<0?void 0:e,flex:e<0?-e:void 0,align:t.labelAlign??"left",style:{order:"right"==t.align?-1:1},attrs:{for:s}})])}_change(){this.emit("change",(0,i.EvChange)(this.check))}_setFocus(){this.itemWithRef("input").focus()}get check(){if(this.dom){return this.itemWithRef("input").dom.checked}return this.m_props.checked}set check(t){if(this.dom){const e=this.itemWithRef("input").dom;e&&(e.checked=t)}this.m_props.checked=t}get text(){return this.itemWithRef("label").text}set text(t){this.itemWithRef("label").text=t}toggle(){this.check=!this.check}}e.CheckBox=CheckBox})),define("x4/listview",["require","exports","x4/component","x4/layout","x4/popup","x4/tools","x4/menu","x4/x4_events"],(function(t,e,s,i,o,n,r,a){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.PopupListView=e.EvCancel=e.ListView=e.ListViewItem=void 0;e.ListViewItem=class ListViewItem{id;text;html;icon;data};class ListView extends i.VLayout{m_selection;m_defer_sel;m_container;m_view;m_topIndex;m_itemHeight;m_cache;constructor(t){super(t),this.setDomEvent("keydown",(t=>this._handleKey(t))),this.setDomEvent("click",(t=>this._handleClick(t))),this.setDomEvent("dblclick",(t=>this._handleClick(t))),this.setDomEvent("contextmenu",(t=>this._handleCtxMenu(t))),this._setTabIndex(t.tabIndex,0),this.mapPropEvents(t,"click","dblClick","contentMenu","selectionChange","cancel")}componentCreated(){this.m_props.virtual?this._buildItems():this.m_props.populate&&(this.items=this.m_props.populate())}render(t){t.items=t.items||[],t.gadgets=t.gadgets,t.renderItem=t.renderItem,t.virtual=t.virtual??!1,this.m_topIndex=0,t.virtual?(console.assert(void 0!==t.itemheight),this.m_itemHeight=t.itemheight,this.m_cache=new Map,this.addClass("virtual")):(this.m_itemHeight=void 0,this.m_cache=void 0),this._buildContent()}set items(t){this.m_props.items=t,this.m_selection=null,this._buildContent()}_handleKey(t){let e=t=>{let e,s;if((0,n.isFunction)(this.m_props.items)?(e=this.m_props.items(),this.m_props.items=e):e=this.m_props.items,this.m_selection){let i=e.findIndex((t=>t===this.m_selection.item));s=t>0&&i<e.length-1?e[i+1]:t<0&&i>0?e[i-1]:this.selection}else e&&(s=e[0]);let i=this._findItemWithId(s?.id);this._selectItem(s,i,!0)};switch(t.key){case"ArrowDown":e(1),t.stopPropagation();break;case"ArrowUp":e(-1),t.stopPropagation()}}_buildContent(){let t=this.m_props;t.virtual?(this.m_container=new s.Container({cls:"@scroll-container",content:[]}),this.m_view=new s.Container({cls:"@scroll-view",flex:1,content:this.m_container,dom_events:{sizechange:()=>this._updateScroll(!0),scroll:()=>this._updateScroll(!1)}}),this.setContent([this.m_view,t.gadgets?new i.HLayout({cls:"gadgets",content:t.gadgets}):null])):(this.m_view=void 0,this.m_container=new i.VLayout({cls:"@scroll-container",content:[]}),this.addClass("@scroll-view"),this.setContent(this.m_container,!1)),t.virtual&&this.m_container.setStyleValue("height",t.items.length*this.m_itemHeight),!this.dom&&t.virtual||this._buildItems()}_updateScroll(t){const e=()=>{let e=Math.floor(this.m_view.dom.scrollTop/this.m_itemHeight);(e!=this.m_topIndex||t)&&(this.m_topIndex=e,this._buildItems())};t?this.startTimer("scroll",10,!1,e):e()}async _buildItems(){let t=this.m_props,e=[],s=t.items;if((0,n.isFunction)(s)&&(s=s()),t.virtual){let s=this.getBoundingRect(),i=100,o=0,n=this.m_topIndex*this.m_itemHeight,r=this.m_topIndex,a=s.height,l=t.items.length,h=[],c=this.m_cache;this.m_cache=new Map;let m=this.m_selection?.item.id;for(;o<a&&r<l&&--i>0;){let s,i=t.items[r];c.has(r)?(s=c.get(r),c.delete(r)):(s=this._renderItem(i),s.addClass("@list-item"),s.setData("item-id",i.id),h.push(s)),m==i.id&&s.addClass("@selected"),s.setStyleValue("top",n+o),e.push(s),this.m_cache.set(r,s),o+=this.m_itemHeight,r++}c.forEach((t=>{t.dispose()})),h.forEach((t=>{this.m_container.appendChild(t)}))}else{let t=this.m_selection?.item.id;s.forEach((s=>{let i=this._renderItem(s);i.addClass("@list-item"),i.setData("item-id",s.id),t==s.id&&i.addClass("@selected"),e.push(i)})),this.m_container.setContent(e)}if(this.m_defer_sel){let t=this.m_defer_sel;this.m_defer_sel=void 0,this.selection=t}}_renderItem(t){return this.m_props.renderItem?this.m_props.renderItem(t):new i.HLayout({content:t.text})}_handleClick(t){let e=t.target,i=this.dom,o=this.m_props.items;for(;e&&e!=i;){let i=s.Component.getElement(e),n=i?.getData("item-id");if(void 0!==n){let e=o.find((t=>t.id==n));if(e){let o;"click"==t.type?(o=(0,a.EvClick)(e),this.emit("click",o)):(o=(0,s.EvDblClick)(e),this.emit("dblClick",o)),o.defaultPrevented||this._selectItem(e,i)}else this._selectItem(null,null);return}e=e.parentElement}}_handleCtxMenu(t){let e=t.target,i=this.dom,o=this.m_props.items;for(;e&&e!=i;){let i=s.Component.getElement(e),n=i?.getData("item-id");if(n){let e=o.find((t=>t.id==n));return void(e&&(this._selectItem(e,i),this.emit("contextMenu",(0,a.EvContextMenu)(t,e)),t.preventDefault()))}e=e.parentElement}}_selectItem(t,e,s=!0){this.m_selection&&this.m_selection.citem&&this.m_selection.citem.removeClass("@selected"),this.m_selection={item:t,citem:e},this.m_selection&&this.m_selection.citem&&this.m_selection.citem.addClass("@selected"),s&&this.emit("selectionChange",(0,a.EvSelectionChange)(t))}get selection(){return this.m_selection?this.m_selection.item:null}set selection(t){if(null==t)this._selectItem(null,null);else if((0,n.isFunction)(this.m_props.items))this.m_defer_sel=t;else{let e=this.m_props.items.find((e=>e.id==t)),s=this._findItemWithId(e.id);this._selectItem(e,s,!1)}}_findItemWithId(t){let e=null;return this.dom&&this.m_container.enumChilds((s=>{if(s.getData("item-id")==t)return s.scrollIntoView(),e=s,!0})),e}append(t,e=!1){e?this.m_props.items.unshift(t):this.m_props.items.push(t),this.m_view?this.m_view._updateContent():this._buildContent()}}function l(t=null){return(0,a.BasicEvent)({context:t})}e.ListView=ListView,e.EvCancel=l;class PopupListView extends o.Popup{m_list;constructor(t){super({tabIndex:!1}),this.enableMask(!1),t.tabIndex=!1,this.m_list=new ListView(t),this.setContent(this.m_list),this.mapPropEvents(t,"cancel")}set items(t){this.m_list.items=t}_handleClick=t=>{if(!this.dom)return;let e=t.target;this.dom.contains(e)||s.Component.getElement(e,r.MenuItem)||(this.signal("cancel",l()),this.close())};show(t){document.addEventListener("mousedown",this._handleClick),super.show(t)}hide(){document.removeEventListener("mousedown",this._handleClick),super.hide()}close(){document.removeEventListener("mousedown",this._handleClick),super.close()}get selection(){return this.m_list.selection}set selection(t){this.m_list.selection=t}}e.PopupListView=PopupListView})),define("x4/combobox",["require","exports","x4/component","x4/x4_events","x4/input","x4/label","x4/button","x4/layout","x4/listview","x4/datastore","x4/tools"],(function(t,e,s,i,o,n,r,a,l,h,c){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.ComboBox=void 0;class ComboBox extends a.HLayout{m_ui_input;m_ui_button;m_popup;m_selection;m_defer_sel;constructor(t){super(t),this.setDomEvent("keypress",(()=>this.showPopup())),this.setDomEvent("click",(()=>this.showPopup())),this.mapPropEvents(t,"selectionChange")}set items(t){this.m_props.items=t,this.m_popup&&(this.m_popup.items=t)}render(t){let e,i;t.renderer?this.m_ui_input=new s.Component({flex:1,cls:"@fake-input @hlayout",tabIndex:1}):this.m_ui_input=new o.Input({flex:1,readOnly:!0,tabIndex:0,name:t.name,value_hook:{get:()=>this.value,set:t=>{this.value=t}}});let l=t.labelWidth??0;l>0?e=l:l<0&&(i=-l),this.setContent([new n.Label({cls:"label1"+(t.label?"":" @hidden"),text:t.label,width:e,flex:i,align:t.labelAlign}),new a.HLayout({flex:1,content:[this.m_ui_input,this.m_ui_button=new r.Button({cls:"gadget",icon:61703,tabIndex:!1,click:()=>this.showPopup(),dom_events:{focus:()=>{this.dom.focus()}}})]})]),void 0!==t.value&&(this.value=t.value)}componentDisposed(){this.m_popup&&this.m_popup.close(),super.componentDisposed()}showPopup(){let t=this.m_props;if(t.readOnly)return;if(!this.m_popup){let e=this.getComputedStyle(),s=e.value("fontFamily"),i=e.value("fontSize");this.m_popup=new l.PopupListView({cls:"@combo-popup",items:t.items,populate:t.populate,renderItem:this.m_props.renderer,selectionChange:t=>this._selectItem(t),cancel:t=>this.signal("cancel",t),style:{fontFamily:s,fontSize:i}})}let e=this.m_ui_button.getBoundingRect(),s=this.m_ui_input.getBoundingRect();this.m_popup.setStyle({minWidth:e.right-s.left}),this.m_popup.displayAt(s.left,s.bottom),void 0!==this.value&&(this.m_popup.selection=this.value)}_selectItem(t){let e=t.selection;this._setInput(e),this.m_selection={id:e.id,text:e.text},this.emit("selectionChange",(0,i.EvSelectionChange)(e)),this.emit("change",(0,i.EvChange)(e.id)),this.m_popup.hide()}_setInput(t){this.m_ui_input&&(this.m_ui_input instanceof o.Input?this.m_ui_input.value=t.text:this.m_ui_input.setContent(this.m_props.renderer(t)))}get value(){return this.m_selection?this.m_selection.id:void 0}get valueText(){return this.m_selection?this.m_selection.text:void 0}set value(t){let e=this.m_props.items;(0,c.isFunction)(e)&&(e=e()),e.some((e=>{if(e.id===t)return this._setInput(e),this.m_selection=e,!0}))}get input(){return this.m_ui_input instanceof o.Input?this.m_ui_input:null}static storeProxy(t){t.store instanceof h.DataStore?t.store.createView():t.store;return()=>{let e=new Array(t.store.count);return t.store.forEach(((s,i)=>{e[i]={id:s.getID(),text:t.display(s)}})),e}}}e.ComboBox=ComboBox})),define("x4/color",["require","exports","x4/styles"],(function(t,e,s){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Color=void 0;const i={lightsalmon:4294942842,lightseagreen:4280332970,lightskyblue:4287090426,lightslategray:4286023833,lightsteelblue:4289774814,lightyellow:4294967264,lime:4278255360,limegreen:4281519410,linen:4294635750,magenta:4294902015,maroon:4286578688,mediumaquamarine:4284927402,mediumblue:4278190285,mediumorchid:4290401747,mediumpurple:4287852763,mediumseagreen:4282168177,mediumslateblue:4286277870,mediumspringgreen:4278254234,mediumturquoise:4282962380,mediumvioletred:4291237253,midnightblue:4279834992,mintcream:4294311930,mistyrose:4294960353,moccasin:4294960309,navajowhite:4294958765,navy:4278190208,oldlace:4294833638,olive:4286611456,olivedrab:4285238819,orange:4294944e3,orangered:4294919424,orchid:4292505814,palegoldenrod:4293847210,palegreen:4288215960,paleturquoise:4289720046,palevioletred:4292571283,papayawhip:4294963157,peachpuff:4294957753,peru:4291659071,pink:4294951115,plum:4292714717,powderblue:4289781990,purple:4286578816,red:4294901760,rosybrown:4290547599,royalblue:4282477025,saddlebrown:4287317267,salmon:4294606962,sandybrown:4294616160,seagreen:4281240407,seashell:4294964718,sienna:4288696877,silver:4290822336,skyblue:4287090411,slateblue:4285160141,slategray:4285563024,snow:4294966010,springgreen:4278255487,steelblue:4282811060,tan:4291998860,teal:4278222976,thistle:4292394968,tomato:4294927175,turquoise:4282441936,violet:4293821166,wheat:4294303411,white:4294967295,whitesmoke:4294309365,yellow:4294967040,yellowgreen:4288335154,aliceblue:4293982463,antiquewhite:4294634455,aqua:4278255615,aquamarine:4286578644,azure:4293984255,beige:4294309340,bisque:4294960324,black:4278190080,blanchedalmond:4294962125,blue:4278190335,blueviolet:4287245282,brown:4289014314,burlywood:4292786311,cadetblue:4284456608,chartreuse:4286578432,chocolate:4291979550,coral:4294934352,cornflowerblue:4284782061,cornsilk:4294965468,crimson:4292613180,cyan:4278255615,darkblue:4278190219,darkcyan:4278225803,darkgoldenrod:4290283019,darkgray:4289309097,darkgreen:4278215680,darkkhaki:4290623339,darkmagenta:4287299723,darkolivegreen:4283788079,darkorange:4294937600,darkorchid:4288230092,darkred:4287299584,darksalmon:4293498490,darkseagreen:4287609999,darkslateblue:4282924427,darkslategray:4281290575,darkturquoise:4278243025,darkviolet:4287889619,deeppink:4294907027,deepskyblue:4278239231,dimgray:4285098345,dodgerblue:4280193279,firebrick:4289864226,floralwhite:4294966e3,forestgreen:4280453922,fuchsia:4294902015,gainsboro:4292664540,ghostwhite:4294506751,gold:4294956800,goldenrod:4292519200,gray:4286611584,green:4278222848,greenyellow:4289593135,honeydew:4293984240,hotpink:4294928820,indianred:4291648604,indigo:4283105410,ivory:4294967280,khaki:4293977740,lavender:4293322490,lavenderblush:4294963445,lawngreen:4286381056,lemonchiffon:4294965965,lightblue:4289583334,lightcoral:4293951616,lightcyan:4292935679,lightgoldenrodyellow:4294638290,lightgreen:4287688336,lightgrey:4292072403,lightpink:4294948545,none:0,transparent:0};class Color{m_value;static custom=[];constructor(t,e,s,i){let o=arguments.length,n=this;this.m_value=function(){if(!o)return 4278190080;if(1==o)return Number.isSafeInteger(t)?4278190080|16777215&t:n._getCustomColor(t);if(2==o){let s,i=(255&(255*e|0))<<24;return s=Number.isSafeInteger(t)?t:n._getCustomColor(t),16777215&s|i}return 4==o&&void 0!==i&&i<=1?i<=0?0:(i*=255,(255&(i|=0))<<24|(255&t)<<16|(255&e)<<8|255&s):4278190080|(255&t)<<16|(255&e)<<8|255&s}()}_shade(t){let e=t<0?0:255,s=t<0?-t:t,i=this._split();return new Color(Math.round((e-i.r)*s)+i.r,Math.round((e-i.g)*s)+i.g,Math.round((e-i.b)*s)+i.b,i.a/255)}darken(t){return t<0&&(t=0),t>100&&(t=100),this._shade(-t/100)}lighten(t){return t<0&&(t=0),t>100&&(t=100),this._shade(t/100)}static mix(t,e,s){let i=t._split(),o=e._split(),n=i.a===o.a?i.a:Math.round(o.a*s+i.a*(1-s)),r=i.r===o.r?i.r:Math.round(o.r*s+i.r*(1-s)),a=i.g===o.g?i.g:Math.round(o.g*s+i.g*(1-s)),l=i.b===o.b?i.b:Math.round(o.b*s+i.b*(1-s));return new Color(r,a,l,n/255)}_split(){let t=this.m_value;return{a:t>>24&255,r:t>>16&255,g:t>>8&255,b:255&t}}fadeout(t){let e=this._split();if(e.a=e.a/255,e.a=e.a-e.a*t/100,e.a>1)e.a=1;else if(e.a<=0)return Color.NONE;return new Color(e.r,e.g,e.b,e.a)}static fromHSV(t,e,s,i=1){let o,n,r,a=Math.min(5,Math.floor(6*t)),l=6*t-a,h=s*(1-e),c=s*(1-l*e),m=s*(1-(1-l)*e);switch(a){case 0:o=s,n=m,r=h;break;case 1:o=c,n=s,r=h;break;case 2:o=h,n=s,r=m;break;case 3:o=h,n=c,r=s;break;case 4:o=m,n=h,r=s;break;case 5:o=s,n=h,r=c}return new Color(255*o,255*n,255*r,i)}static toHSV(t){let e=t._split();e.r/=255,e.g/=255,e.b/=255,e.a/=255;let s,i=Math.max(e.r,e.g,e.b),o=i-Math.min(e.r,e.g,e.b),n=0===i?0:o/i,r=i;if(0===o)s=0;else switch(i){case e.r:s=(e.g-e.b)/o/6+(e.g<e.b?1:0);break;case e.g:s=(e.b-e.r)/o/6+1/3;break;case e.b:s=(e.r-e.g)/o/6+2/3}return{h:s,s:n,v:r,a:e.a}}static fromHLS(t,e,s){let i,o,n;if(0==s)i=o=n=e;else{function r(t,e,s){return s<0&&(s+=1),s>1&&(s-=1),s<1/6?t+6*(e-t)*s:s<.5?e:s<2/3?t+(e-t)*(2/3-s)*6:t}let a=e<.5?e*(1+s):e+s-e*s,l=2*e-a;i=r(l,a,t+1/3),o=r(l,a,t),n=r(l,a,t-1/3)}return i=255&(255*i|0),o=255&(255*o|0),n=255&(255*n|0),new Color(i,o,n)}static toHLS(t){let e=t.m_value,s=(e>>16&255)/255,i=(e>>8&255)/255,o=(255&e)/255,n=s,r=s;i<n&&(n=i),o<n&&(n=o),i>r&&(r=i),o>r&&(r=o);let a,l,h=0,c=0,m=0,d=r-n,u=r+n,p=.5*u;return r==n?{h:0,l:p,s:0}:(h=(r-s)/d,c=(r-i)/d,m=(r-o)/d,a=p<.5?d/u:d/(2-u),l=s==r?60*(6+m-c):i==r?60*(2+h-m):60*(4+c-h),l>360&&(l-=360),{h:l/360,l:p,s:a})}red(){return this.m_value>>16&255}green(){return this.m_value>>8&255}blue(){return 255&this.m_value}alpha(){return(this.m_value>>24&255)/255}value(){return this.m_value}toString(){if(0===this.m_value)return"transparent";let t=this._split();if(255===t.a)return`rgb(${t.r},${t.g},${t.b})`;{t.a/=255;let e=t.a.toFixed(3);return`rgba(${t.r},${t.g},${t.b},${e})`}}toHex(t=!0){if(0===this.m_value)return"transparent";let e=this._split();return 255!==e.a&&t?`#${o(e.r)}${o(e.g)}${o(e.b)}${o(e.a)}`:`#${o(e.r)}${o(e.g)}${o(e.b)}`}static addCustomColor(t,e){Color.custom[t]=e}static addCssColor(t){let e=s.Stylesheet.getVar(t);Color.custom["css:"+t]=Color.parse(e)}static parse(t){let e;if("#"==t[0]){if(null!==(e=/#(?<r>[a-fA-F0-9]{2})(?<g>[a-fA-F0-9]{2})(?<b>[a-fA-F0-9]{2})(?<a>[a-fA-F0-9]{2})?/.exec(t))){let t=e.groups;return new Color(parseInt(t.r,16),parseInt(t.g,16),parseInt(t.b,16),void 0!==t.a?parseInt(t.a,16)/255:1)}if(null!==(e=/#(?<r>[a-fA-F0-9])(?<g>[a-fA-F0-9])(?<b>[a-fA-F0-9])/.exec(t))){let t=e.groups;const s=parseInt(t.r,16),i=parseInt(t.g,16),o=parseInt(t.b,16);return new Color(s<<4|s,i<<4|i,o<<4|o,1)}}if("r"==t[0]){if(null!==(e=/rgb\(\s*(?<r>\d+)\s*\,\s*(?<g>\d+)\s*\,\s*(?<b>\d+)\s*\)/.exec(t))){let t=e.groups;return new Color(parseInt(t.r,10),parseInt(t.g,10),parseInt(t.b,10),1)}if(null!==(e=/rgba\(\s*(?<r>\d+)\s*\,\s*(?<g>\d+)\s*\,\s*(?<b>\d+)\s*\,\s*(?<a>[0-9.]+)\s*\)/.exec(t))){let t=e.groups;return new Color(parseInt(t.r,10),parseInt(t.g,10),parseInt(t.b,10),parseFloat(t.a))}}return console.log("invalid color value: "+t),new Color(0)}_getCustomColor(t){if(null===t)return 0;let e=i[t];return void 0!==e?e:void 0!==Color.custom[t]?Color.custom[t].m_value:"css:"==t.substr(0,4)?(Color.addCssColor(t.substr(4)),Color.custom[t].m_value):Color.parse(t).m_value}static contrastColor(t){let e=t._split();return(.299*e.r+.587*e.g+.114*e.b)/255>.5?Color.BLACK:Color.WHITE}static WHITE=new Color(255,255,255);static BLACK=new Color(0,0,0);static NONE=new Color(0,0,0,0);static valueFromColorName(t){let e=i[t];return e?new Color(e):null}static fromCssVar(t){return new Color(t).toString()}}function o(t){return("00"+t.toString(16)).substr(-2).toUpperCase()}e.Color=Color})),define("x4/tooltips",["require","exports","x4/component","x4/label","x4/icon","x4/tools"],(function(t,e,s,i,o,n){"use strict";let r,a;Object.defineProperty(e,"__esModule",{value:!0}),e.initTooltips=e.Tooltip=void 0;class Tooltip extends s.Component{m_text;set text(t){this.m_text.text=t}render(){this.setClass("@non-maskable",!0),this.setContent([new o.Icon({icon:61530}),this.m_text=new i.Label({text:"help"})])}displayAt(t,e,s="top left"){this.show();let i="l",o="t";s.indexOf("right")>=0&&(i="r"),s.indexOf("bottom")>=0&&(o="b");let n=document.body.getBoundingClientRect(),r=this.getBoundingRect();"r"==i&&(t-=r.width),"b"==o&&(e-=r.height),t+r.width>n.right&&(t=n.right-r.width),e+r.height>n.bottom&&(e=n.bottom-r.height-17),this.setStyle({left:t,top:e})}}e.Tooltip=Tooltip,e.initTooltips=function(t){if((0,n.isTouchDevice)())return;let e={target:null,x:0,y:0};function s(s){let o=s.target,n=null;for(e.x=s.pageX+10,e.y=s.pageY+15;o&&(n=o.getAttribute("tip"),!n);)o=o.parentElement;if(!(o==e.target||a&&o==a.dom)){if(!o||!n)return e.target=null,void(t?t(null):i());e.target=o,t?t(null):i(),t?t(n):r=setTimeout((()=>{void 0===a&&(a=new Tooltip({}),document.body.appendChild(a._build())),a.text=n,a.displayAt(e.x+17,e.y+17,"top left")}),700)}}function i(){r&&clearTimeout(r),a&&a.hide()}document.body.addEventListener("mouseover",s),document.body.addEventListener("mouseout",s),document.body.addEventListener("mousemove",(function(t){e.x=t.pageX,e.y=t.pageY}))}})),define("x4/textedit",["require","exports","x4/component","x4/input","x4/button","x4/layout","x4/label","x4/calendar","x4/tools","x4/tooltips","x4/x4_events","x4/i18n"],(function(t,e,s,i,o,n,r,a,l,h,c,m){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.TextEdit=void 0;const d=/^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;class TextEdit extends s.Component{m_cal_popup;m_ui_input;m_error_tip;constructor(t){super(t),this.addClass("@hlayout"),this.mapPropEvents(t,"change","click","focus")}componentCreated(){super.componentCreated(),this.m_props.autoFocus&&this.focus()}componentDisposed(){this.m_error_tip&&this.m_error_tip.dispose(),super.componentDisposed()}focus(){this.m_ui_input.focus()}render(t){let e,s={flex:1,dom_events:{focus:this._focus.bind(this),blur:this._blur.bind(this),input:this._change.bind(this)},value:t.value,name:t.name,type:t.type,placeHolder:t.placeHolder,autoFocus:t.autoFocus,readOnly:t.readOnly,value_hook:t.value_hook,uppercase:t.uppercase,tabIndex:void 0===t.tabIndex||t.tabIndex,attrs:t.attrs,min:t.min,max:t.max};if("date"==t.type){t.format=t.format??"Y-M-D",s.type="text";let e={get:()=>this._date_get_hook(),set:t=>this._date_set_hook(t)};s.value_hook=t.value_hook??e}this.m_ui_input=new i.Input(s),t.icon?e=new o.Button({icon:t.icon,click:()=>this._btnClick(),tabIndex:!1}):"date"==t.type&&(e=new o.Button({cls:"gadget",icon:61555,tabIndex:!1,click:()=>this._showDatePicker(e)}),t.validator||(t.validator=this._date_validator));let a=t.gadgets??[];a.forEach((t=>{t.addClass("gadget")}));let l=[e,...a];this.setClass("@required",t.required),t.gadgets&&t.gadgets.length&&this.addClass("with-gadgets");let h,c,m,d=t.labelWidth;d>0&&(h=d),d<0&&(c=-d);let u=t.labelAlign,p=!1;t.label&&("top"==u&&(u="left",p=!0,c=1),m=new r.Label({ref:"label",tag:"label",cls:"label1"+(t.label?"":" @hidden"),text:t.label??"",width:h,flex:c,align:u})),p?(this.removeClass("@hlayout"),this.addClass("@vlayout vertical"),this.setContent([m,new n.HLayout({width:h,content:[this.m_ui_input,...l]})])):(this.addClass("@hlayout"),this.setContent([m,this.m_ui_input,...l]))}enable(t){!0===t&&this.m_ui_input.enable(),super.enable(t)}disable(){this.m_ui_input.disable(),super.disable()}_btnClick(){this.emit("click",(0,c.EvClick)(this.value))}setDateStoreFormat(t){this.m_props.format=t}setStoreValue(t){this.m_ui_input.setStoreValue(t)}getStoreValue(){return this.m_ui_input.getStoreValue()}_date_get_hook(){let t=(0,l.parseIntlDate)(this.value),e=this.m_props;return"native"==e.format?t:t?(0,l.formatIntlDate)(t,e.format):null}_date_set_hook(t){let e=this.m_props;if("native"==e.format)this.value=(0,l.formatIntlDate)(t);else if(t){let s=(0,l.parseIntlDate)(t,e.format);this.value=(0,l.formatIntlDate)(s)}else this.value=""}showError(t){this.m_error_tip||(this.m_error_tip=new h.Tooltip({cls:"error"}),document.body.appendChild(this.m_error_tip._build()));let e=this.m_ui_input.getBoundingRect();this.m_error_tip.text=t,this.m_error_tip.displayAt(e.right,e.top,"top left"),this.addClass("@error")}clearError(){this.m_error_tip&&(this.m_error_tip.hide(),this.removeClass("@error"))}get value(){return this.m_ui_input?this.m_ui_input.value:this.m_props.value}set value(t){this.m_ui_input?this.m_ui_input.value=t:this.m_props.value=t}selectAll(){this.m_ui_input.selectAll()}select(t,e=9999){this.m_ui_input.select(t,e)}getSelection(){return this.m_ui_input.getSelection()}set readOnly(t){this.m_ui_input.readOnly=t}get label(){return this.itemWithRef("label")?.text}set label(t){this.itemWithRef("label").text=t}_change(){let t=this.m_ui_input.value;this.emit("change",(0,c.EvChange)(t))}_focus(){this.clearError(),this.emit("focus",(0,s.EvFocus)(!0))}_blur(){this._validate(this.m_ui_input.value),this.emit("focus",(0,s.EvFocus)(!1))}validate(){return this._validate(this.value)}_validate(t){let e=this.m_props,s=!1;if(e.required&&0==t.length)return this.showError(m._tr.global.required_field),!1;if(""!=t){let i=this.getAttribute("pattern");if(i){let e=new RegExp(i);if(e&&!e.test(t))return this.showError(m._tr.global.invalid_format),!1}if("email"==e.type){if(!d.test(t.toLowerCase()))return this.showError(m._tr.global.invalid_email),!1}else if("number"==e.type){const e=parseFloat(t);if(isNaN(e))return this.showError(m._tr.global.invalid_number),!1;let i=parseFloat(this.m_ui_input.getAttribute("min"));void 0!==i&&e<i&&(t=""+i,s=!0);let o=parseFloat(this.m_ui_input.getAttribute("max"));void 0!==o&&e>o&&(t=""+o,s=!0)}}if(e.validator)try{this.value=e.validator(t)}catch(t){return this.showError(t instanceof Error?t.message:t),!1}else s&&(this.value=t);return!0}_date_validator(t){if(""==(t=t.trim()))return"";let e;if("@"==t)e=new Date;else if(e=(0,l.parseIntlDate)(t),!e)throw(0,l.sprintf)(m._tr.global.invalid_date,m._tr.global.date_format);return(0,l.formatIntlDate)(e)}_showDatePicker(t){this.m_cal_popup||(this.m_cal_popup=new a.PopupCalendar({change:t=>{this.value=(0,l.formatIntlDate)(t.value),this.m_cal_popup.close()}}));let e=this.m_ui_input.getBoundingRect();this.m_cal_popup.displayAt(e.left,e.bottom,"top left")}get input(){return this.m_ui_input}get type(){return this.m_props.type}}e.TextEdit=TextEdit})),define("x4/form",["require","exports","x4/component","x4/layout","x4/button","x4/textedit","x4/request","x4/dialog","x4/i18n"],(function(t,e,s,i,o,n,r,a,l){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Form=void 0;class Form extends i.VLayout{m_height;m_container;m_buttons;constructor(t){let e=t.content;t.content=null;let s=t.height;t.height=void 0,super(t),this.setProp("tag","form"),this.mapPropEvents(t,"btnClick"),this.updateContent(e,t.buttons,s)}get container(){return this.m_container}onChange(t){}updateContent(t,e,s=0){s&&(this.m_height=s);let o=[this.m_container=new i.VLayout({cls:"container",height:this.m_height,content:t}),this.m_buttons=this._makeButtons(e)];this.setContent(o)}enableButton(t,e=!0){let s=this.getButton(t);s&&s.enable(e)}getButton(t){return this.itemWithRef("@"+t)}_makeButtons(t){if(!t)return null;let e=[];for(let i of t)if(i instanceof s.Component)e.push(i);else switch(i){case"ok":e.push(new o.Button({ref:"@"+i,text:l._tr.global.ok,click:()=>{this._click(i)}}));break;case"cancel":e.push(new o.Button({ref:"@"+i,text:l._tr.global.cancel,click:()=>{this._click(i)}}));break;case"ignore":e.push(new o.Button({ref:"@"+i,text:l._tr.global.ignore,click:()=>{this._click(i)}}));break;case"yes":e.push(new o.Button({ref:"@"+i,text:l._tr.global.yes,click:()=>{this._click(i)}}));break;case"no":e.push(new o.Button({ref:"@"+i,text:l._tr.global.no,click:()=>{this._click(i)}}));break;case"close":e.push(new o.Button({ref:"@"+i,text:l._tr.global.close,click:()=>{this._click(i)}}));break;case"save":e.push(new o.Button({ref:"@"+i,text:l._tr.global.save,click:()=>{this._click(i)}}));break;case"dontsave":e.push(new o.Button({ref:"@"+i,text:l._tr.global.dontsave,click:()=>{this._click(i)}}))}return 1==e.length&&e[0].setAttribute("autofocus",!0),new i.HLayout({cls:"footer",content:e})}validate(){let t=this.dom.querySelectorAll("input"),e=!0;for(let i=0;i<t.length;i++){let o=s.Component.getElement(t[i],n.TextEdit);o&&!o.validate()&&(e=!1)}return e}_click(t){this.emit("btnClick",(0,a.EvBtnClick)(t))}setValues(t){console.assert(!!this.dom);let e=this.dom.elements;for(let i=0;i<e.length;i++){let o=e[i],n=s.Component.getElement(o);if(!n.hasAttribute("name"))continue;let r=n.getAttribute("name");n.getAttribute("type");void 0!==t[r]&&n.setStoreValue(t[r])}}getValues(){console.assert(!!this.dom);let t={},e=this.dom.elements;for(let i=0;i<e.length;i++){let o=e[i],n=s.Component.getElement(o);if(!n.hasAttribute("name"))continue;let r=n.getAttribute("name"),a=n.getStoreValue();void 0!==a&&(t[r]=a)}return t}submit(t,e){if(!this.validate())return!1;let s=this.getValues();if(e&&!e(s))return!1;let i=new FormData;for(let t in s)s.hasOwnProperty(t)&&i.append(t,void 0===s[t]?"":s[t]);return t.params=i,(0,r.ajaxRequest)(t)}}e.Form=Form})),define("x4/dialog",["require","exports","x4/popup","x4/icon","x4/layout","x4/label","x4/form","x4/component","x4/x4_events","x4/tools"],(function(t,e,s,i,o,n,r,a,l,h){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Dialog=e.EvBtnClick=void 0,e.EvBtnClick=function(t){return(0,l.BasicEvent)({button:t})};class Dialog extends s.Popup{m_icon;m_title;m_form;m_buttons;m_closable;m_movable;m_maximized;m_minimized;m_maximizable;m_minimizable;m_needFormResize;m_rc_max;m_rc_min;m_el_title;m_last_down;m_auto_close;m_ui_title;m_form_cb;constructor(t){let e,s,i=t.content,o=0;t.content=null,(0,h.isString)(t.width)?o|=1:(e=t.width,t.width=void 0),(0,h.isString)(t.height)?o|=2:(s=t.height,t.height=void 0),super(t),this.m_needFormResize=o,this.enableMask(!0),t.form?(0,h.isFunction)(t.form)?this.m_form_cb=t.form:(this.m_form=t.form,this.m_form.setStyle({width:e,height:s}),this.m_form.on("btnClick",(t=>this._handleClick(t)))):this.m_form=new r.Form({width:e,height:s,content:i,buttons:t.buttons,btnClick:t=>this._handleClick(t)}),this.m_movable=t.movable,this.m_auto_close=t.autoClose??!0,this.m_icon=t.icon,this.m_title=t.title,this.m_buttons=t.buttons??null,this.m_closable=t.closable??!1,this.m_last_down=0,this.on("size",(t=>{this.addClass("@resized"),this.m_form.setStyleValue("width",null),this.m_form.setStyleValue("height",null)})),this.m_maximized=!1,this.m_minimized=!1,this.m_maximizable=!1,this.m_minimizable=!1,void 0!==t.maximizable&&(this.m_maximizable=t.maximizable),void 0!==t.minimizable&&(this.m_minimizable=t.minimizable),1==t.maximized&&(this.m_maximizable=!0),t.btnClick&&this.on("btnClick",t.btnClick)}componentCreated(){super.componentCreated(),this.m_needFormResize&&this.addClass("@resized"),this.m_props.maximized&&(this._maximize(),this.emit("size",(0,a.EvSize)(null)))}_handleClick(t){this.emit("btnClick",t),t.defaultPrevented||this.close()}setGeometry(t){t.minimized&&this.m_minimizable?(this._minimize(!1),this.m_rc_min=new h.Rect(t.left,t.top,t.width,t.height),this.displayAt(t.left,t.top,"top-left")):t.maximized&&this.m_maximizable?(this._maximize(!1),this.m_rc_max=new h.Rect(t.left,t.top,t.width,t.height)):(this.setSize(t.width,t.height),this.displayAt(t.left,t.top,"top-left"))}getGeometry(){if(this.m_minimized)return{left:this.m_rc_min.left,top:this.m_rc_min.top,width:this.m_rc_min.width,height:this.m_rc_min.height,minimized:!0,maximized:!1};if(this.m_maximized)return{left:this.m_rc_max.left,top:this.m_rc_max.top,width:this.m_rc_max.width,height:this.m_rc_max.height,minimized:!1,maximized:!0};let t=this.getBoundingRect();return{left:t.left,top:t.top,width:t.width,height:t.height,minimized:!1,maximized:!1}}setSize(t,e){this.setStyle({width:t,height:e}),this.emit("size",(0,a.EvSize)({width:t,height:e}))}render(){this.m_form_cb&&(this.m_form=this.m_form_cb(),this.m_form.on("btnClick",(t=>this._handleClick(t))),this.m_form_cb=null);let t=void 0!==this.m_icon||this.m_closable||void 0!==this.m_title||this.m_movable;this.m_el_title=null,t&&(this.m_el_title=new o.HLayout({cls:"title",content:[this.m_icon?new i.Icon({icon:this.m_icon}):null,this.m_ui_title=new n.Label({flex:1,text:this.m_title}),this.m_minimizable?new i.Icon({cls:"min-btn",icon:62161,dom_events:{click:()=>this._toggleMin()}}):null,this.m_maximizable?new i.Icon({cls:"max-btn",icon:62160,dom_events:{click:()=>this._toggleMax()}}):null,this.m_closable?new i.Icon({icon:62480,dom_events:{click:()=>this.close()}}):null]}),this.m_movable&&((0,h.isTouchDevice)()?this.m_el_title.setDomEvent("touchstart",(t=>this._mouseDown(t))):this.m_el_title.setDomEvent("mousedown",(t=>this._mouseDown(t))))),this.setContent([this.m_el_title,this.m_form])}get form(){return this.m_form}close(){this.emit("close",{}),super.close()}_toggleMax(){this.m_maximizable&&(this.m_maximized?(this.removeClass("maximized"),this.setStyle({left:this.m_rc_max.left,top:this.m_rc_max.top,width:this.m_rc_max.width,height:this.m_rc_max.height}),this.m_maximized=!1,this.emit("size",(0,a.EvSize)(null,"restore"))):(this._maximize(),this.emit("size",(0,a.EvSize)(null,"maximize"))))}_toggleMin(){this.m_minimizable&&(this.m_minimized?(this.removeClass("minimized"),this.setStyle({width:this.m_rc_min.width,height:this.m_rc_min.height}),this.m_minimized=!1,this.emit("size",(0,a.EvSize)(null,"restore"))):(this._minimize(),this.emit("size",(0,a.EvSize)(null,"minimize"))))}_isIcon(t){let e=a.Component.getElement(t);return e&&e.hasClass("@icon")}_mouseDown(t){let{x:e,y:i}=(0,h.getMousePos)(t,!0),o=(0,a.flyWrap)(document.body).getBoundingRect(),n=this.getBoundingRect(!0),r=this.m_el_title.getBoundingRect(),l=e-n.left,c=i-n.top,m=this.getComputedStyle(),d=m.parse("marginTop")+m.parse("paddingTop")+m.parse("borderTopWidth"),u=m.parse("marginBottom")+m.parse("paddingBottom")+m.parse("borderBottomWidth"),p=m.parse("marginLeft")+m.parse("paddingLeft")+m.parse("borderLeftWidth"),_=m.parse("marginRight")+m.parse("paddingRight")+m.parse("borderRightWidth");o.top+=d-r.height,o.height-=d+u-r.height,o.left+=p,o.width-=p+_;const g=Date.now(),f=g-this.m_last_down;if(this.m_maximizable&&f<700)return void this._toggleMax();if(this.m_last_down=g,this.m_maximized)return;let x=(t,e)=>{let s=t-l,i=e-c;s+n.width<o.left?s=o.left-n.width:s>o.right&&(s=o.right),i<o.top?i=o.top:i>o.bottom&&(i=o.bottom),this.setStyle({left:s,top:i})};a.Component.setCapture(this,(t=>{if("mousemove"==t.type){let e=t;x(e.clientX,e.clientY)}else if("touchmove"==t.type){let e=t;1==e.touches.length&&x(e.touches[0].clientX,e.touches[0].clientY)}else"mouseup"==t.type||"touchend"==t.type?(a.Component.releaseCapture(),this.emit("move",(0,s.EvMove)(null))):"mousedown"==t.type||t.type}))}maximize(){this.m_maximizable&&!this.m_maximized&&(this._maximize(),this.emit("size",(0,a.EvSize)(null)))}_maximize(t=!0){t&&(this.m_rc_max=this.getBoundingRect(!1)),this.addClass("maximized"),this.m_maximized=!0,this.setStyle({left:void 0,top:void 0,width:void 0,height:void 0})}minimize(){this.m_minimizable&&!this.m_minimized&&(this._minimize(),this.emit("size",(0,a.EvSize)(null)))}_minimize(t=!0){t&&(this.m_rc_min=this.getBoundingRect(!1)),this.addClass("minimized"),this.m_minimized=!0,this.setStyle({width:void 0,height:void 0})}set title(t){this.m_title=t,this.m_ui_title&&(this.m_ui_title.text=t)}}e.Dialog=Dialog})),define("x4/colorpicker",["require","exports","x4/component","x4/checkbox","x4/dialog","x4/x4_events","x4/layout","x4/label","x4/color","x4/tools","x4/textedit","x4/menu"],(function(t,e,s,i,o,n,r,a,l,h,c,m){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.ColorPickerEditor=e.ColorPickerBox=e.ColorPicker=void 0;const d=[940682,1076131,1277117,2856406,4763632],u=[681536,884816,1022304,1422193,4050065],p=[10904353,12546854,14254635,15899977,16757606],_=[11020842,12726320,14366519,16078422,16741235],g=[10365710,12071441,13711635,15422253,16739914],f=[11018837,12724066,14363759,16075147,16737953],x=[6038876,7679861,9386383,11031720,12743874],b=[5653158,6507967,7428057,9533938,11377151],v=[2050969,2382003,2713036,4554982,6725375],w=[32885,39308,45988,1363133,3073750],y=[1930020,2329644,2729524,4439885,6478187],C=[7506979,8889897,10207024,11983180,13759085],k=[10909960,12553226,14261771,15906852,16763200],S=[6504734,8212773,9855533,11565894,13211493];class ColorPicker extends s.Container{m_colorSel;m_colorHue;m_colorAlpha;m_sample;m_selMark;m_hueMark;m_alphaMark;m_baseHSV;m_baseColor;m_transpCk;m_colorEdit;m_palmode;static last_palmode=!1;constructor(t){super(t),this.m_palmode=ColorPicker.last_palmode,this.setDomEvent("contextmenu",(t=>this._showCtx(t)))}_showCtx(t){const e=new m.Menu({items:[new m.MenuItem({text:"Palette",checked:this.m_palmode,click:()=>{this.m_palmode=!this.m_palmode,ColorPicker.last_palmode=this.m_palmode,this.update()}})]});let s=(0,h.getMousePos)(t,!0);e.displayAt(s.x,s.y)}render(t){if(this.m_baseColor=t.color,this.m_baseHSV=l.Color.toHSV(this.m_baseColor),this.m_palmode){this.addClass("pal-mode");let t=null;const e=e=>{const i=this.m_baseColor.value(),o=e.map((e=>{const o=e==i;let n=(0,h.classNames)("clr-box",{selected:o}),r=new s.Component({cls:n,style:{backgroundColor:new l.Color(e).toHex()},data:{color:e}});return o&&(t=r),r}));return new r.VLayout({cls:"vcol",content:o})};let o=new r.HLayout({cls:"hcol",content:[e(d),e(u),e(p),e(_),e(g),e(f),e(x),e(b),e(v),e(w),e(y),e(C),e(k),e(S)]});this.m_colorEdit=new c.TextEdit({cls:"hexv",value:"",attrs:{spellcheck:!1},change:t=>{const e=new l.Color(t.value);e&&(this.m_baseColor=e,this.m_baseHSV=l.Color.toHSV(e),this._updateColor(!1))}}),this.m_transpCk=new i.CheckBox({cls:"transp",text:"transparent",change:t=>{this.m_baseHSV.a=t.value?0:1,this._updateColor()}}),this.setContent([o,this.m_transpCk,this.m_colorEdit]),o.setDomEvent("click",(e=>{t&&(t.removeClass("selected"),t=null);let i=s.Component.getElement(e.target,"clr-box");if(i){const e=new l.Color(i.getData("color"));this.m_baseColor=e,this.m_baseHSV=l.Color.toHSV(e),this._updateColor(),t=i,i.addClass("selected")}}))}else this.removeClass("pal-mode"),this.m_selMark=new s.Component({cls:"marker"}),this.m_colorSel=new s.Component({cls:"sel",content:[new s.Component({cls:"@fit light"}),new s.Component({cls:"@fit dark"}),this.m_selMark]}),this.m_hueMark=new s.Component({cls:"marker"}),this.m_colorHue=new s.Component({cls:"hue",content:[this.m_hueMark]}),this.m_sample=new s.Component({cls:"sample"}),t.hasAlpha?(this.addClass("with-alpha"),this.m_alphaMark=new s.Component({cls:"marker"}),this.m_colorAlpha=new s.Component({cls:"alpha",content:[new s.Component({cls:"bk @fit",ref:"color"}),this.m_alphaMark]})):(this.removeClass("with-alpha"),this.m_transpCk=new i.CheckBox({cls:"transp",text:"transparent",change:t=>{this.m_baseHSV.a=t.value?0:1,this._updateColor()}})),this.m_colorEdit=new c.TextEdit({cls:"hexv",value:"",attrs:{spellcheck:!1},change:t=>{const e=new l.Color(t.value);e&&(this.m_baseColor=e,this.m_baseHSV=l.Color.toHSV(e),this._updateColor(!1))}}),this.setContent([this.m_colorSel,this.m_colorHue,this.m_colorAlpha,this.m_transpCk,this.m_colorEdit,this.m_sample]),this.m_colorSel.setDomEvent("mousedown",(t=>{s.Component.setCapture(this,(t=>this._selChange(t)))})),this.m_colorHue.setDomEvent("mousedown",(t=>{s.Component.setCapture(this,(t=>this._hueChange(t)))})),t.hasAlpha&&this.m_colorAlpha.setDomEvent("mousedown",(t=>{s.Component.setCapture(this,(t=>this._alphaChange(t)))})),this._updateColor()}set color(t){this.m_baseColor=t,this.m_baseHSV=l.Color.toHSV(this.m_baseColor),this._updateColor()}get color(){return this.m_baseColor}_selChange(t){let e=(0,h.getMousePos)(t,!0);console.log(e);let i=this.m_colorSel.getBoundingRect();this.m_props.hasAlpha||(this.m_baseHSV.a=1),this.m_baseHSV.s=(0,h.clamp)((e.x-i.left)/i.width,0,1),this.m_baseHSV.v=1-(0,h.clamp)((e.y-i.top)/i.height,0,1),this._updateColor(),"mouseup"!=t.type&&"touchend"!=t.type||s.Component.releaseCapture()}_hueChange(t){let e=(0,h.getMousePos)(t,!0),i=this.m_colorHue.getBoundingRect();this.m_baseHSV.h=(0,h.clamp)((e.y-i.top)/i.height,0,1),this._updateColor(),"mouseup"!=t.type&&"touchend"!=t.type||s.Component.releaseCapture()}_alphaChange(t){let e=(0,h.getMousePos)(t,!0),i=this.m_colorAlpha.getBoundingRect();this.m_baseHSV.a=(0,h.clamp)((e.x-i.left)/i.width,0,1),this._updateColor(),"mouseup"!=t.type&&"touchend"!=t.type||s.Component.releaseCapture()}_updateColor(t=!0){let e;if(this.m_palmode)this.m_transpCk.check=0==this.m_baseHSV.a;else{if(e=l.Color.fromHSV(this.m_baseHSV.h,1,1,1),this.m_colorSel.setStyleValue("backgroundColor",e.toString()),e=l.Color.fromHSV(this.m_baseHSV.h,this.m_baseHSV.s,this.m_baseHSV.v,1),this.m_sample.setStyleValue("backgroundColor",e.toString()),this.m_props.hasAlpha){let t=`linear-gradient(to right, rgba(0,0,0,0) 0%, ${e.toString()} 100%)`;this.m_colorAlpha.itemWithRef("color").setStyleValue("backgroundImage",t)}this.m_selMark.setStyle({left:100*this.m_baseHSV.s+"%",top:100-100*this.m_baseHSV.v+"%"}),this.m_hueMark.setStyle({top:100*this.m_baseHSV.h+"%"}),this.m_props.hasAlpha?this.m_alphaMark.setStyle({left:100*this.m_baseHSV.a+"%"}):this.m_transpCk.check=0==this.m_baseHSV.a}e=l.Color.fromHSV(this.m_baseHSV.h,this.m_baseHSV.s,this.m_baseHSV.v,this.m_baseHSV.a),this.m_baseColor=e,t&&(this.m_colorEdit.value=1==e.alpha()?e.toHex():e.toString()),this._change()}_change(){this.emit("change",(0,n.EvChange)(this.m_baseColor))}}e.ColorPicker=ColorPicker;class ColorPickerBox extends o.Dialog{m_picker;constructor(t){t.icon=void 0,t.buttons=void 0,super(t),this.mapPropEvents(t,"change"),this.m_picker=new ColorPicker({color:t.color,hasAlpha:t.hasAlpha,style:{padding:8},width:250,height:250});let e=this._makeCustoms(t.cust_colors);this.form.updateContent([new r.VLayout({content:[this.m_picker,e]})],["ok","cancel"]),this.on("btnClick",(t=>{"ok"==t.button&&this.emit("change",(0,n.EvChange)(this.m_picker.color))}))}_makeCustoms(t){let e=null;if(t&&t.length>0){let s=[];for(let e=0;e<t.length;e+=8){let i=[];for(let s=0;s<8;s++){let o=t[e+s];i.push(new a.Label({cls:"cust-cc",text:"",flex:1,style:{backgroundColor:o?o.toString():"transparent"},tooltip:o?o.toString():void 0,dom_events:{click:()=>{o&&(this.m_picker.color=o,this.emit("change",(0,n.EvChange)(o)),this.close())}}}))}s.push(new r.HLayout({cls:"line",content:i}))}e=new r.VLayout({cls:"customs",content:s})}return e}set color(t){this.m_picker.color=t}get color(){return this.m_picker.color}static show(t){let e;return e=(0,h.isString)(t)?new ColorPickerBox({color:new l.Color(t)}):new ColorPickerBox(t),e.show(),e}}e.ColorPickerBox=ColorPickerBox;class ColorPickerEditor extends r.HLayout{constructor(t){super(t),this.mapPropEvents(t,"change")}render(t){let e,s=t.color;this._isTransp(s)?(s=l.Color.NONE,e="black"):e=l.Color.contrastColor(s).toString(),this.setContent([t.label?new a.Label({cls:"label",text:t.label,flex:t.labelWidth<0?-t.labelWidth:void 0,width:t.labelWidth>=0?t.labelWidth:void 0}):null,new a.Label({cls:"value",flex:1,text:s.toHex(),style:{backgroundColor:s.toString(),color:e},dom_events:{click:()=>this._showPicker()}})]),this._setTabIndex(t.tabIndex)}set value(t){this.m_props.color=t,this.update()}get value(){return this.m_props.color}set custom_colors(t){this.m_props.cust_colors=t}_showPicker(){let t=new ColorPickerBox({color:this.m_props.color,cust_colors:this.m_props.cust_colors,hasAlpha:this.m_props.hasAlpha,events:{change:t=>{this.m_props.color=t.value,this._change(),this.update()}}}),e=this.getBoundingRect();t.displayAt(e.left,e.bottom,"tl")}_change(){this.emit("change",(0,n.EvChange)(this.m_props.color))}_isTransp(t){return!t.alpha()}}e.ColorPickerEditor=ColorPickerEditor})),define("x4/formatters",["require","exports","x4/application","x4/tools"],(function(t,e,s,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.bool_formatter=e.money_formatter_nz=e.money_formatter=e.date_formatter=e.sql_date_formatter=void 0,e.sql_date_formatter=function(t){return null==t||""===t?"":new Date(Date.parse(t)).toLocaleDateString(s.Application.instance().locale,{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})},e.date_formatter=function(t){if(null==t||""===t)return"";let e="string"==typeof t?new Date(Date.parse(t)):t;return(0,i.formatIntlDate)(e)},e.money_formatter=function(t){if(null==t||""===t)return"";let e=(0,i.roundTo)("string"==typeof t?parseFloat(t):t,2);return-0===e&&(e=0),s.Application.instance().moneyFormatter.format(e)},e.money_formatter_nz=function(t){if(null==t||""===t)return"";let e=(0,i.roundTo)("string"==typeof t?parseFloat(t):t,2);return e?s.Application.instance().moneyFormatter.format(e):""},e.bool_formatter=function(t){return t?"oui":"-"}})),define("x4/image",["require","exports","x4/component"],(function(t,e,s){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Image=void 0;const i="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==";function o(t){return"data:"==t.substr(0,5)}class Image extends s.Component{m_created;m_lazysrc;constructor(t){super(t),this.m_created=!1,this.m_props.lazy=!1!==t.lazy,this.m_props.alt=t.alt,!1!==t.lazy&&(this.m_lazysrc=t.src,t.src=i),this.setDomEvent("create",(()=>{t.lazy&&this.setImage(this.m_lazysrc,!0)}))}render(){let t=this.m_props;const e=new s.Component({tag:"img",attrs:{draggable:!1,alt:t.alt??"",decoding:t.lazy?"async":void 0},style:{objectFit:t.alignment?t.alignment:void 0}});this.setContent(e)}setImage(t,e){t||(t=i),this.m_props.lazy?(e||this.m_lazysrc!=t)&&(o(t)?(this.m_props.src=t,this.m_lazysrc=t,this.dom&&this.dom.firstChild.setAttribute("src",this.m_props.src)):(this.m_props.src=i,this.dom&&this.dom.firstChild.setAttribute("src",this.m_props.src),this.m_lazysrc=t,this.dom&&this._update_image())):(this.m_props.src=t,this.m_lazysrc=t,this.dom&&this.dom.firstChild.setAttribute("src",t))}_update_image(){console.assert(!!this.dom),this.m_lazysrc&&!o(this.m_lazysrc)&&(Image.lazy_images_waiting.push({dom:this.dom,src:this.m_lazysrc}),void 0===Image.lazy_image_timer&&(Image.lazy_image_timer=setInterval(Image.lazyWatch,10)))}static lazy_images_waiting=[];static lazy_image_timer=void 0;static lazyWatch(){let t=[],e=0;Image.lazy_images_waiting.forEach((s=>{let i=s.dom,o=s.src;if(!i||!document.contains(i))return;let n=i.getBoundingClientRect();if(!e&&null!==i.offsetParent&&n.bottom>=0&&n.right>=0&&n.top<=(window.innerHeight||document.documentElement.clientHeight)&&n.left<=(window.innerWidth||document.documentElement.clientWidth)){i.firstChild.setAttribute("src",o),e++}else t.push(s)})),Image.lazy_images_waiting=t,0==t.length&&(clearInterval(Image.lazy_image_timer),Image.lazy_image_timer=void 0)}}e.Image=Image})),define("x4/gridview",["require","exports","x4/layout","x4/component","x4/label","x4/i18n","x4/tools","x4/datastore","x4/x4_events"],(function(t,e,s,i,o,n,r,a,l){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.GridView=e.EvGridCheck=void 0;Symbol("update");function h(t,e){return(0,l.BasicEvent)({rec:t,chk:e})}e.EvGridCheck=h;class GridView extends s.VLayout{m_dataview;m_data_cx;m_columns;m_view_el;m_container;m_header;m_footer;m_empty_msg;m_empty_text;m_selection;m_itemHeight;m_topIndex;m_visible_rows;m_hasMarks;m_marks;m_recycler;m_rowClassifier;constructor(t){super(t),this.m_columns=t.columns,this.m_hasMarks=t.hasMarks??!1,this.m_marks=new Set,this.m_hasMarks&&this.m_columns.unshift({id:"id",title:"",width:30,renderer:t=>this._renderCheck(t)}),this.setAttribute("tabindex",0),this.m_topIndex=0,this.m_itemHeight=0,this.m_recycler=[],this.m_rowClassifier=t.calcRowClass,this.m_empty_text=t.empty_text??n._tr.global.empty_list,this.setDomEvent("click",(t=>this._itemClick(t))),this.setDomEvent("dblclick",(t=>this._itemDblClick(t))),this.setDomEvent("contextmenu",(t=>this._itemMenu(t))),this.setDomEvent("keydown",(t=>this._handleKey(t))),this.setStore(t.store)}componentCreated(){this._updateScroll(!0)}_moveSel(t,e=!0){let s=this.m_selection,i=null;if(void 0===s)s=this.m_dataview.getByIndex(0).getID();else{let e=this.m_dataview.indexOfId(this.m_selection);1==t?e++:-1==t?e--:2==t?e+=this.m_visible_rows.length-1:-2==t&&(e-=this.m_visible_rows.length-1),i=t<0?"start":"end",e<0?e=0:e>=this.m_dataview.count&&(e=this.m_dataview.count-1),s=this.m_dataview.getByIndex(e).getID()}return this.m_selection!=s&&e&&this._selectItem(s,null,i),s}_handleKey(t){if(this.m_dataview&&0!=this.m_dataview.count)switch(t.key){case"ArrowDown":case"Down":this._moveSel(1);break;case"ArrowUp":case"Up":this._moveSel(-1);break;case"PageUp":this._moveSel(-2);break;case"PageDown":this._moveSel(2)}}getNextSel(t){return this._moveSel(t,!1)}_scrollIntoView(t,e){let s=this._findItem(t);s?s.scrollIntoView({block:"center"}):(this.m_topIndex=this.m_dataview.indexOfId(t),this.m_view_el.dom.scrollTop=this.m_topIndex*this.m_itemHeight,this._buildItems(),this._scrollIntoView(t))}setStore(t){this.m_selection=void 0,t instanceof a.DataStore?this.m_dataview=t.createView():this.m_dataview=t,this.m_hasMarks&&this.clearMarks(),this.m_data_cx&&this.m_data_cx.dispose(),this.m_dataview&&(this.m_data_cx=this.m_dataview.on("view_change",(t=>{"change"==t.action&&(this.m_selection=void 0),this._updateScroll(!0)})),this._updateScroll(!0))}getView(){return this.m_dataview}getSelection(){return this.m_selection}getSelRec(){return this.m_selection?this.m_dataview.getById(this.m_selection):null}setSelection(t){this._selectItem(t,null,"center")}render(){this.m_recycler=[],this.m_container=new i.Component({cls:"content"}),this.m_empty_msg=new o.Label({cls:"empty-msg",text:""}),this.m_view_el=new i.Component({cls:"@scroll-view",flex:1,dom_events:{sizechange:()=>this._updateScroll(!0),scroll:()=>this._updateScroll(!1)},content:this.m_container});let t=this.m_columns.map(((t,e)=>{let s="@cell";t.cls&&(s+=" "+t.cls);let o=new i.Component({cls:s,content:new i.Component({tag:"span",content:t.title}),flex:t.flex,sizable:"right",style:{width:t.width},dom_events:{click:e=>{(0,i.flyWrap)(e.target).hasClass("@sizer-overlay")||(this._sortCol(t),e.preventDefault())}}});const n=t=>{if(this._on_col_resize(e,t.size.width),this.m_footer){let s=i.Component.getElement(this.m_footer.dom.childNodes[e]);s&&s.setStyleValue("width",t.size.width)}};return new i.SizerOverlay({target:o,sens:"right",events:{resize:t=>n(t)}}),t.$col=o,o})),e=0;if(this.m_columns.forEach((t=>{e+=t.width??0})),this.m_header=new s.HLayout({cls:"@header",content:t,style:{minWidth:e}}),this.m_props.hasFooter){let t=this.m_columns.map(((t,e)=>{let s="@cell";return t.align&&(s+=" "+t.align),t.cls&&(s+=" "+t.cls),new i.Component({cls:s,data:{col:e},flex:t.flex,style:{width:t.width}})}));this.m_footer=new s.HLayout({cls:"@footer",content:t,style:{minWidth:e}})}else this.m_footer=null;this.setContent([this.m_header,this.m_view_el,this.m_footer,this.m_empty_msg])}_on_col_resize(t,e){this.m_columns[t].width=e,this.m_columns[t].flex=void 0,this._updateScroll(!0)}_sortCol(t){!1!==t.sortable&&(this.m_columns.forEach((e=>{e!==t&&(e.$sorted=!1,e.$col.removeClass("sort desc"))})),t.$sorted?(t.$sens=t.$sens?0:1,t.$col.setClass("desc",t.$sens)):(t.$sens=0,t.$sorted=!0,t.$col.addClass("sort"),t.$col.removeClass("desc")),this.m_dataview&&this.m_dataview.sort([{field:t.id,ascending:!t.$sens}]))}_computeItemHeight(){let t=document.createElement("div");t.classList.add("x-row");let e=document.createElement("div");e.classList.add("x-grid-view"),e.style.position="absolute",e.style.top="-1000px",e.appendChild(t),this.dom.appendChild(e);let s=t.getBoundingClientRect();this.dom.removeChild(e),this.m_itemHeight=s.height}_createRow(t){let e;if(this.m_recycler.length){e=this.m_recycler.pop(),e.clearClasses(),e.addClass(t.cls),e.setContent(t.content),e.setStyle(t.style);for(let s in t.data)e.setData(s,t.data[s])}else e=new s.HLayout(t);return e.dom||this.m_container.appendChild(e),e}_buildItems(t=!0){let e=this.getBoundingRect(),s=this.m_header.getBoundingRect(),o=e.height-s.height+this.m_itemHeight;0==this.m_itemHeight&&this._computeItemHeight();let n=this.m_topIndex*this.m_itemHeight,r=0,a=0,l=this.m_topIndex,h=this.m_dataview?this.m_dataview.count:0,c=0,m=!!(1&this.m_topIndex);if(this.m_columns.forEach((t=>{c+=t.width??0})),(h+1)*this.m_itemHeight>=o){let t=i.Component.getScrollbarSize();this.m_header.setStyleValue("paddingRight",t),this.m_footer?.setStyleValue("paddingRight",t)}else this.m_header.setStyleValue("paddingRight",0),this.m_footer?.setStyleValue("paddingRight",0);this.m_visible_rows&&this.m_visible_rows.forEach((t=>{this.m_recycler.push(t)})),this.m_visible_rows=[];let d=100;for(;r<o&&l<h&&--d>0;){let e=this.m_dataview.getByIndex(l),s=e.getID(),o=t?this.m_recycler.findIndex((t=>t.getData("row-id")==s)):-1;if(o>=0){let t=this.m_recycler.splice(o,1)[0];t.setStyle({top:r+n,minWidth:c}),this.m_hasMarks&&t.setClass("@marked",this.m_marks.has(s)),t.removeClass("@hidden"),t.setClass("@selected",this.m_selection===s),this.m_visible_rows[a]=t}else{let t=this.m_columns.map((t=>{let s,o="@cell";if(t.align&&(o+=" "+t.align),t.cls&&(o+=" "+t.cls),t.renderer)s=t.renderer(e),s&&(s.addClass(o),s.setStyleValue("width",t.width),void 0!==t.flex&&(s.addClass("@flex"),s.setStyleValue("flex",t.flex)));else{let n,r=t.formatter;n=r&&r instanceof Function?r(e.getRaw(t.id),e):e.getField(t.id),s=new i.Component({cls:o,width:t.width,content:i.html`<span>${n}</span>`,flex:t.flex})}return s})),o="@row";this.m_hasMarks&&this.m_marks.has(s)&&(o+=" @marked"),this.m_selection===s&&(o+=" @selected");let h=this.m_visible_rows[a]=this._createRow({cls:o,content:t,style:{top:r+n,minWidth:c},data:{"row-id":s,"row-idx":l}});h.addClass(m?"even":"odd"),m=!m,this.m_rowClassifier&&this.m_rowClassifier(e,h)}r+=this.m_itemHeight,l++,a++}this.m_recycler.forEach((t=>{t.addClass("@hidden")}));let u=!h,p=this.m_empty_text instanceof Function?this.m_empty_text():this.m_empty_text;this.m_empty_msg.text=p,u&&0==p.length&&(u=!1),this.m_empty_msg.show(u),c<e.width?(this.m_header.setStyleValue("width",null),this.m_footer?.setStyleValue("width",null),this.m_container.setStyle({height:h*this.m_itemHeight,width:null})):(this.m_header.setStyleValue("width",c),this.m_footer?.setStyleValue("width",c),this.m_container.setStyle({height:h*this.m_itemHeight,width:c}))}_updateScroll(t){if(!this.m_view_el||!this.m_view_el.dom)return;const e=()=>{let e=Math.floor(this.m_view_el.dom.scrollTop/(this.m_itemHeight||1));(e!=this.m_topIndex||t)&&(this.m_topIndex=e,this._buildItems(!t));let s=this.m_view_el.dom.scrollLeft;this.m_header.setStyleValue("left",-s),this.m_footer?.setStyleValue("left",-s)};t?this.singleShot(e,10):e()}_rowFromTarget(t){let e=this.dom;for(;t&&t!=e;){let e=i.Component.getElement(t);if(e){let t=e.getData("row-id");if(void 0!==t)return{id:t,itm:e}}t=t.parentElement}}_itemClick(t){let e=this._rowFromTarget(t.target);e?this._selectItem(e.id,e.itm):this._selectItem(void 0,void 0)}_itemDblClick(t){let e=this._rowFromTarget(t.target);if(e){this._selectItem(e.id,e.itm);let t=this.m_dataview.getById(e.id);this.emit("dblClick",(0,i.EvDblClick)(t)),this.m_hasMarks&&this._toggleMark(t)}}_itemMenu(t){let e=t.target,s=this.dom;for(;e&&e!=s;){let s=i.Component.getElement(e),o=s?.getData("row-id");if(void 0!==o){this._selectItem(o,s);let e=s.getData("row-idx"),i=this.m_dataview.getByIndex(e);return this._showItemContextMenu(t,i),void t.preventDefault()}e=e.parentElement}}_findItem(t){for(let e=0;e<this.m_visible_rows.length;e++){let s=this.m_visible_rows[e];if(s.getData("row-id")===t)return s}return null}_selectItem(t,e,s){if(void 0!==this.m_selection){let t=this._findItem(this.m_selection);t&&t.removeClass("@selected")}if(this.m_selection=t,t){s&&this._scrollIntoView(t,s),e||(e=this._findItem(t)),e&&e.addClass("@selected");let i=this.m_dataview.getById(t);this.emit("selectionChange",(0,l.EvSelectionChange)(i))}else this.emit("selectionChange",(0,l.EvSelectionChange)(null))}_showItemContextMenu(t,e){this.emit("contextMenu",(0,l.EvContextMenu)(t,e))}clearSelection(){this._selectItem(null,null)}exportData(t){let e="";let s="";this.m_columns.map((t=>{s.length&&(s+="\t"),s+=t.title})),e+=s+"\r\n";let i=this.m_dataview.count;for(let t=0;t<i;t++){let i=this.m_dataview.getByIndex(t);s="";this.m_columns.map((t=>{let e=i.getField(t.id),o=t.formatter;o&&o instanceof Function&&(e=o(e,i)),s.length>0&&(s+="\t"),s+=e}));e+=s+"\r\n"}e=e.replace(/[àâä]/gm,"a"),e=e.replace(/[éèê]/gm,"e"),e=e.replace(/[îï]/gm,"i"),e=e.replace(/[ûüù]/gm,"u"),e=e.replace(/ /gm," "),(0,r.downloadData)(e,"text/csv",t)}set empty_text(t){this.m_empty_msg.text=t}_renderCheck(t){let e="";return this.m_marks.has(t.getID())&&(e=" checked"),new i.Component({cls:"@grid-checkbox"+e})}_toggleMark(t){let e=t.getID(),s=!1;this.m_marks.has(e)?this.m_marks.delete(e):(this.m_marks.add(e),s=!0),this.emit("gridCheck",h(t,s)),this._buildItems(!1)}getMarks(){let t=[];for(const e of this.m_marks.values())t.push(e);return t}clearMarks(){this.m_marks.size&&(this.m_marks=new Set,this._buildItems(!1))}setFooterData(t){this.m_footer&&this.m_footer.enumChilds((e=>{let s,i=e.getData("col"),o=this.m_columns[i],n=o.formatter;s=n&&n instanceof Function?n(t[o.id],t):t[o.id],e.setContent(s,!1)}))}}e.GridView=GridView})),define("x4/link",["require","exports","x4/component","x4/x4_events"],(function(t,e,s,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Link=void 0;class Link extends s.Component{constructor(t){super(t),this.setDomEvent("click",(()=>this._handleClick())),this.mapPropEvents(t,"click")}_handleClick(){this.emit("click",(0,i.EvClick)())}render(t){let e=t.text??"",i=t.href??"#";this.setAttribute("tabindex",0),this.setProp("tag","a"),this.setAttribute("href",i),this.setAttribute("target",t.target),e&&this.setContent((0,s.isHtmlString)(e)?e:s.html`<span>${e}</span>`)}set text(t){this.m_props.text=t,this.update()}}e.Link=Link})),define("x4/messagebox",["require","exports","x4/dialog","x4/tools","x4/layout","x4/icon","x4/label","x4/textedit"],(function(t,e,s,i,o,n,r,a){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.PromptDialogBox=e.MessageBox=void 0;class MessageBox extends s.Dialog{m_label;constructor(t){let e=t.icon??61546;t.icon=void 0;let s=void 0===t.buttons?["ok"]:t.buttons;t.buttons=void 0,super(t),this.form.updateContent(new o.HLayout({style:{padding:8},content:[new n.Icon({cls:"icon",icon:e}),this.m_label=new r.Label({cls:"text",text:t.message})]}),s),this.on("btnClick",(t=>{this.m_props.click&&(0,i.asap)((()=>{this.m_props.click(t.button)}))}))}set text(t){this.m_label.text=t}static show(t){let e;return e=(0,i.isString)(t)||(0,i.isHtmlString)(t)?new MessageBox({message:t,click:()=>{}}):new MessageBox(t),e.show(),e}static alert(t,e=null){new MessageBox({cls:"warning",title:e,message:t,buttons:["ok"],click:()=>{}}).show()}}e.MessageBox=MessageBox;class PromptDialogBox extends s.Dialog{m_edit;constructor(t){let e=t.icon??62636;t.icon=void 0,t.buttons=void 0,t.width=t.width??500,super(t),this.form.updateContent(new o.HLayout({cls:"panel",content:[new n.Icon({cls:"icon",icon:e}),this.m_edit=new a.TextEdit({flex:1,autoFocus:!0,label:t.message,value:t.value})]}),["ok","cancel"]),t.click&&this.on("btnClick",(t=>{"ok"===t.button&&(0,i.asap)((()=>{this.m_props.click(this.m_edit.value)}))}))}set text(t){this.m_edit.label=t}static show(t,e){let s;return s=(0,i.isString)(t)||(0,i.isHtmlString)(t)?new PromptDialogBox({message:t,click:e}):new PromptDialogBox(t),s.show(),s}}e.PromptDialogBox=PromptDialogBox})),define("x4/spreadsheet",["require","exports","x4/component","x4/layout","x4/textedit","x4/tools","x4/tools","x4/x4_events","x4/combobox"],(function(t,e,s,i,o,n,r,a,l){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Spreadsheet=void 0;class CellData{text;cls;static empty_cell={text:""}}class Spreadsheet extends i.VLayout{m_columns;m_row_limit;m_cells_data;m_rows_data;m_view;m_container;m_header;m_itemHeight;m_topIndex;m_visible_cells;m_row_count;m_selection;m_editor;m_autoedit;m_lockupdate;m_auto_row_count;m_recycler;m_used_cells;constructor(t){super(t),this.m_columns=t.columns,this.m_autoedit=t.autoedit,this.m_lockupdate=0,this.m_cells_data=new Map,this.m_rows_data=new Map,this.m_itemHeight=0,this.m_selection={row:0,col:0},this.m_row_count=0,this.m_auto_row_count=!1,this.m_recycler=[],this.m_used_cells=[],void 0===t.maxrows||t.maxrows<0?(this.m_row_limit=0,this.m_auto_row_count=!0):this.m_row_limit=t.maxrows,this.setAttribute("tabIndex",0),this.setDomEvent("click",(t=>this._itemClick(t))),this.setDomEvent("dblclick",(t=>this._itemDblClick(t))),this.setDomEvent("keydown",(t=>this._handleKey(t))),this.setDomEvent("keypress",(t=>this._keyPress(t))),this.setDomEvent("focus",(()=>this._focus(!0))),this.setDomEvent("focusout",(()=>this._focus(!1))),this.setDomEvent("contextmenu",(t=>this._ctxMenu(t))),this.mapPropEvents(t,"dblClick","selectionChange","contextMenu","change")}componentCreated(){super.componentCreated(),this._updateScroll(!0)}setColWidth(t,e){this._on_col_resize(t,e),this.update(10)}getColWidth(t){if(this.m_columns[t])return this.m_columns[t].width}setColTitle(t,e){console.assert(void 0!==this.m_columns[t]),this.m_columns[t].title=e,this.update(10)}reset(t){this.m_columns=t,this.m_cells_data=new Map,this.m_rows_data=new Map,this.update(10)}insertRow(t){let e=new Map;this.m_cells_data.forEach(((s,i)=>{let{row:o,col:n}=c(i);o>=t?e.set(h(o+1,n),s):e.set(i,s)}));let s=new Map;this.m_rows_data.forEach(((e,i)=>{i>=t?s.set(i+1,e):s.set(i,e)})),this.m_cells_data=e,this.m_rows_data=s,this._buildItems()}deleteRow(t){let e=new Map,s=new Map;this.m_cells_data.forEach(((s,i)=>{let{row:o,col:n}=c(i);o>t?e.set(h(o-1,n),s):o<t&&e.set(i,s)})),this.m_rows_data.forEach(((e,i)=>{i>t?s.set(i-1,e):i<t&&s.set(i,e)})),this.m_cells_data=e,this.m_rows_data=s,this._buildItems()}insertCol(t,e){let s=t;if(s<0&&(s=this.m_columns.length+1),this.m_columns.splice(s,0,e),t>=0){let e=new Map;this.m_cells_data.forEach(((s,i)=>{let{row:o,col:n}=c(i);n>=t?e.set(h(o,n+1),s):e.set(i,s)})),this.m_cells_data=e}this.update()}deleteCol(t){this.m_columns.splice(t,1);let e=new Map;this.m_cells_data.forEach(((s,i)=>{let{row:o,col:n}=c(i);n>t?e.set(h(o,n-1),s):n<t&&e.set(i,s)})),this.m_cells_data=e,this.update()}_getCellData(t,e,s=!1){let i=this.m_cells_data.get(h(t,e));return void 0===i?s?null:CellData.empty_cell:i}_focus(t){this.setClass("@focus",t)}_ctxMenu(t){let e=t.target,i=this.dom;for(;e&&e!=i;){let i=s.Component.getElement(e),o=i.getData("row-id"),n=i.getData("col-id");if(void 0!==o)return this._selectItem(o,n),this.emit("contextMenu",(0,a.EvContextMenu)(t,{row:o,col:n,item:i})),void t.preventDefault();e=e.parentElement}}render(){this.m_recycler=[],this.m_container=new s.Component({cls:"content"}),this.m_view=new s.Component({cls:"@scroll-view",flex:1,dom_events:{sizechange:()=>this._updateScroll(!0),scroll:()=>this._updateScroll(!1)},content:this.m_container});let t=this.m_columns.map(((t,e)=>{let i=new s.Component({cls:"@cell c"+e,content:t.title?t.title:"&nbsp",flex:t.width<0?-t.width:void 0,attrs:{title:t.title},style:{width:t.width>=0?t.width:void 0,minWidth:t.min_width}});return new s.SizerOverlay({target:i,sens:"right",resize:t=>{this._on_col_resize(e,t.size.width)}}),t.$col=i,i}));this.m_header=new i.HLayout({cls:"@header",content:t}),this.setContent([this.m_header,this.m_view])}_on_col_resize(t,e){this.m_columns[t]&&(this.m_columns[t].width=e<=0?-1:e,this._updateScroll(!0))}_computeItemHeight(){let t=document.createElement("div");t.classList.add("x-spreadsheet");let e=document.createElement("div");e.classList.add("content");let s=document.createElement("div");s.classList.add("x-cell"),s.append("&nbsp;"),e.appendChild(s),t.appendChild(e),this.dom.appendChild(t);let i=s.getBoundingClientRect();this.dom.removeChild(t),this.m_itemHeight=i.height}_calcColWidths(t){let e=0,s=0,i=new Int32Array(this.m_columns.length),o=new Int32Array(this.m_columns.length),n=new Int32Array(this.m_columns.length);if(this.m_columns.forEach(((t,r)=>{let a=Math.max(10,t.min_width??0);if(t.width>0){let s=Math.max(t.width,a);e+=s,i[r]=s}else{let e=-t.width;o[r]=e,s+=e}n[r]=a})),s){let r=t-e;for(let t=0;t<this.m_columns.length&&s;t++)if(!i[t]){let e=Math.round(r/s)*o[t];e<n[t]&&(e=n[t]),i[t]=e,r-=e,s-=o[t]}}return i}_createCell(){let t;return this.m_recycler.length?(t=this.m_recycler.pop(),t.clearClasses()):t=new s.Component({cls:"@cell"}),t.dom||this.m_container.appendChild(t),t}_buildItems(){let t=this.getBoundingRect(),e=this.m_header.getBoundingRect(),i=t.height-e.height;0==this.m_itemHeight&&this._computeItemHeight();let o=this.m_topIndex*this.m_itemHeight,n=0,r=0,a=this.m_topIndex,l=this.m_row_limit;this.m_auto_row_count&&(this.m_row_limit=l=this.getMaxRowCount());let c=0;if(l*this.m_itemHeight>i){let e=s.Component.getScrollbarSize();t.width-=e,c=e}let m=!!(1&this.m_topIndex);this.m_visible_cells=new Map,this.m_used_cells.forEach((t=>{this.m_recycler.push(t)})),this.m_used_cells=[];let d=this._calcColWidths(t.width),u=0;for(let t=0;t<d.length;t++)u+=d[t];u<=t.width?(this.m_view.setStyleValue("overflow-x","hidden"),this.m_header.setStyleValue("width",t.width),this.m_container.setStyleValue("width",t.width),this.m_container.setStyle({height:l*this.m_itemHeight})):(this.m_header.setStyleValue("width",u),this.m_container.setStyleValue("width",u),this.m_view.setStyleValue("overflow-x","visible"),this.m_container.setStyle({height:l*this.m_itemHeight,width:u})),this.m_view.addClass("@hidden");let p=100;for(;n<i&&a<l&&--p>0;){let t=this.m_rows_data.get(a),e=0;this.m_columns.map(((s,i)=>{let r,l="@cell c"+i;s.align&&(l+=" "+s.align),s.cls&&(l+=" "+s.cls);let c=this._getCellData(a,i),u=c.text;return s.renderer&&u.length&&(u=s.renderer(u,{row:a,col:i})),l+=m?" even":" odd",t&&(l+=" "+t),r=this._createCell(),this.m_used_cells.push(r),r.setContent(u),r.addClass(l),r.setStyle({left:e,top:o+n,width:d[i]}),this.m_selection.row==a&&this.m_selection.col==i&&r.addClass("@selected"),r.setData("row-id",a),r.setData("col-id",i),c.cls&&r.addClass(c.cls),this.m_visible_cells.set(h(a,i),r),e+=d[i],r}));m=!m,n+=this.m_itemHeight,a++,r++}this.m_recycler.forEach((t=>{t.addClass("@hidden")})),this.m_row_count=r,this.m_view.removeClass("@hidden"),this.setClass("empty",0==l)}_itemClick(t){let e=t.target;if(this.m_editor&&this.m_editor.dom.contains(e))return;let i=s.Component.getElement(e,s.Component);if(!i)return;let o=i.getData("row-id"),n=i.getData("col-id");void 0!==o&&void 0!==n&&this._selectItem(o,n)}_itemDblClick(t){let e=t.target;if(this.m_editor&&this.m_editor.dom.contains(e))return;let i=s.Component.getElement(e),o=i.getData("row-id"),n=i.getData("col-id");void 0!==o&&void 0!==n&&(this.emit("dblClick",(0,s.EvDblClick)({row:o,col:n})),this.editCell(o,n))}_selectItem(t,e,s){t<0&&(t=0),t>this.m_row_limit-1&&(t=this.m_row_limit-1),e<0&&(e=0);let i=this.m_columns.length-1;e>i&&(e=i),this.m_selection.row==t&&this.m_selection.col==e||this.select(t,e,s)}_scrollIntoView(t,e){let s=(t,e="nearest")=>{t.scrollIntoView({block:e})},i=this.m_topIndex+this.m_row_count-1;t<this.m_topIndex?(this.m_topIndex=t,this.m_view.dom.scrollTop=this.m_topIndex*this.m_itemHeight,this._buildItems(),s(this._findItem(t,e),"start")):t>i?(this.m_topIndex=t-this.m_row_count+1,this.m_view.dom.scrollTop=this.m_topIndex*this.m_itemHeight,this._buildItems(),s(this._findItem(t,e),"end")):s(this._findItem(t,e))}_findItem(t,e){return this.m_visible_cells?this.m_visible_cells.get(h(t,e)):null}_updateScroll(t){if(!this?.m_view?.dom)return;let e=Math.floor(this.m_view.dom.scrollTop/(this.m_itemHeight||1));(e!=this.m_topIndex||t)&&(this.m_topIndex=e,this._buildItems());let s=this.m_view.dom.scrollLeft;this.m_header.setStyleValue("left",-s)}_moveSel(t,e){let s=this.m_selection,i=s.row??0,o=s.col??0;if(1==t?i++:-1==t?i--:2==t?i+=this.m_row_count-1:-2==t?i-=this.m_row_count-1:3==t?i=this.m_row_limit-1:-3==t&&(i=0),1==e)o++;else if(-1==e)o--;else if(2==e)o=this.m_columns.length-1;else if(-2==e)o=0;else if(3==e){o++;let t=this.m_columns.length-1;t:for(let e=0;e<2;e++){for(;o<t;){if(null!==this.m_columns[o].createEditor)break t;o++}o>t&&(i++,o=0)}}else if(-3==e){o--;let t=this.m_columns.length-1;t:for(let e=0;e<2;e++){for(;o>=0;){if(null!==this.m_columns[o].createEditor)break t;o--}o<0&&(i--,o=t)}}this._selectItem(i,o,!0)}_handleKey(t){let e=t.target;if(!this.m_editor||!this.m_editor.dom.contains(e))switch(t.key){case"ArrowDown":case"Down":this._moveSel(1,0);break;case"ArrowUp":case"Up":this._moveSel(-1,0);break;case"PageUp":this._moveSel(-2,0);break;case"PageDown":this._moveSel(2,0);break;case"ArrowLeft":case"Left":this._moveSel(0,-1);break;case"ArrowRight":case"Right":this._moveSel(0,1);break;case"Home":t.ctrlKey?this._moveSel(-3,0):this._moveSel(0,-2);break;case"End":t.ctrlKey?this._moveSel(3,0):this._moveSel(0,2);break;case"Enter":this.editCurCell(),t.stopPropagation();break;case"Delete":this.clearCell(this.m_selection.row,this.m_selection.col)}}_keyPress(t){let e=t.target;this.m_editor&&this.m_editor.dom.contains(e)||t.ctrlKey||t.altKey||this.editCurCell(t.key)}getSelection(){return this.m_selection}select(t,e,s=!0){if(this.m_selection.row==t&&this.m_selection.col==e)return;let i=this._findItem(this.m_selection.row,this.m_selection.col);i&&i.removeClass("@selected"),this.m_selection={row:t,col:e},s&&this._scrollIntoView(t,e);let o=this._findItem(t,e);o&&o.addClass("@selected"),this.emit("selectionChange",(0,a.EvSelectionChange)({row:t,col:e}))}rowCount(){return this.m_row_limit}getMaxRowCount(){let t=0;return this.m_cells_data.forEach(((e,s)=>{let i=Math.round(s/1e3)+1;t<i&&(t=i)})),t}getColCount(){return this.m_columns.length}setRowStyle(t,e){this.m_rows_data.set(t,e),0==this.m_lockupdate&&this._buildItems()}getRowStyle(t){return this.m_rows_data.get(t)}setCellStyle(t,e,s){let i=this._getCellData(t,e,!0);if(i||(i={text:""},this.m_cells_data.set(h(t,e),i)),i.cls=s,0==this.m_lockupdate&&this.m_visible_cells){let i=this._findItem(t,e);i?i.setClass(s,!0):this._buildItems()}}getCellText(t,e){return this._getCellData(t,e).text}getCellNumber(t,e){let s=this._getCellData(t,e).text;return(0,n.parseIntlFloat)(s)}clearRow(t){for(let e=0;e<this.m_columns.length;e++)this.clearCell(t,e);this.update(10)}clearCell(t,e){this.setCellText(t,e,null)}editCurCell(t){this.editCell(this.m_selection.row,this.m_selection.col,t)}editCell(t,e,s){if(!this.m_autoedit)return;if(null===this.m_columns[e].createEditor)return;this._scrollIntoView(t,e);let i=this._findItem(t,e).dom,n=i.parentElement,r=i.getBoundingClientRect(),a=n.getBoundingClientRect(),l=this._getCellData(t,e,!0),h=(t,e,s)=>new o.TextEdit(t);this.m_columns[e].createEditor&&(h=this.m_columns[e].createEditor);let c=s||(l?l.text:"");this.m_editor=h({cls:"@editor",style:{left:r.left-a.left,top:r.top-a.top,width:r.width,height:r.height},tabIndex:!1,value:c,data:{row:t,col:e}},t,e),this.m_editor&&(n.appendChild(this.m_editor._build()),this._setupEditor(),this.m_editor.setData("old-value",c),this.m_editor.focus(),this.m_editor instanceof o.TextEdit&&this.m_editor.selectAll())}_setupEditor(){let t=(t,e)=>{(0,r.deferCall)((()=>{this.killEditor(!0),this._moveSel(t,e),this.editCurCell()}))};if(this.m_editor instanceof o.TextEdit){let e=this.m_editor.input;e.setDomEvent("blur",(()=>{this.killEditor(!0)})),e.setDomEvent("keydown",(e=>{switch(e.key){case"Escape":this.killEditor(!1),e.stopPropagation();break;case"Enter":case"Tab":{let s=3;e.shiftKey&&(s=-3),t(0,s),e.stopPropagation();break}case"ArrowUp":case"Up":t(-1,0),e.stopPropagation();break;case"ArrowDown":case"Down":t(1,0),e.stopPropagation()}}))}else if(this.m_editor instanceof l.ComboBox){let e=this.m_editor.input;e.setDomEvent("blur",(()=>{this.killEditor(!0)})),e.setDomEvent("keydown",(e=>{switch(e.key){case"Escape":this.killEditor(!1),e.stopPropagation();break;case"Enter":case"Tab":{let s=3;e.shiftKey&&(s=-3),t(0,s),e.stopPropagation();break}}})),this.m_editor.showPopup(),this.m_editor.on("change",(t=>{this.killEditor(!0)})),this.m_editor.on("cancel",(t=>{this.killEditor(!1)}))}}killEditor(t){if(this.m_editor){if(t){let t,e;this.m_editor instanceof o.TextEdit?t=this.m_editor.value:this.m_editor instanceof l.ComboBox&&(e=this.m_editor.value,t=this.m_editor.valueText);let s=this.m_editor.getData("row"),i=this.m_editor.getData("col"),n=this.m_editor.getData("old-value");this.setCellText(s,i,t);const r=(0,a.EvChange)(t,{row:s,col:i,oldValue:n,id:e});this.emit("change",r),r.defaultPrevented&&this.setCellText(s,i,n)}let e=this.m_editor;(0,n.asap)((()=>{e.dispose()})),this.m_editor=null,this.focus()}}clearData(){this.m_cells_data=new Map,this.m_rows_data=new Map}setCellText(t,e,s){if(null==s||0==s.length)this.m_cells_data.delete(h(t,e)),s="";else{let i=this._getCellData(t,e,!0);i||(i={}),i.text=s,this.m_cells_data.set(h(t,e),i)}if(0==this.m_lockupdate&&this.m_visible_cells){let i=this._findItem(t,e);i?(this.m_columns[e].renderer&&(s=this.m_columns[e].renderer(s,{row:t,col:e})),i.setContent(s)):this._buildItems()}}lockUpdate(t){t?this.m_lockupdate++:0==--this.m_lockupdate&&this._updateScroll(!0)}}function h(t,e){return 1e3*t+e}function c(t){return{row:0|Math.floor(t/1e3),col:t%1e3|0}}e.Spreadsheet=Spreadsheet})),define("x4/property_editor",["require","exports","x4/component","x4/x4_events","x4/input","x4/textedit","x4/checkbox","x4/spreadsheet","x4/i18n"],(function(t,e,s,i,o,n,r,a,l){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.PropertyEditor=void 0;class PropertyEditor extends s.Component{m_fields;m_record;m_sheet;m_label_w;constructor(t){super(t),this.mapPropEvents(t,"change")}render(t){this.m_record=t.record,this.m_fields=t.fields??[],this.m_label_w=t.labelWidth,this.m_sheet=new a.Spreadsheet({cls:"@fit",columns:[{title:l._tr.global.property,width:this.m_label_w>0?this.m_label_w:-1,cls:"property"},{title:l._tr.global.value,width:-1,createEditor:(...t)=>this._editCell(...t),renderer:(...t)=>this._renderCell(...t)}],autoedit:!0,change:t=>this._cellChange(t)}),this._updateProperties(),this.setContent(this.m_sheet)}setFields(t){t?(this.m_fields=t,this._updateProperties()):this.m_sheet.clearData()}setRecord(t){this.m_record=t,this._updateProperties()}_updateProperties(){this.m_sheet.lockUpdate(!0),this.m_sheet.clearData(),this.m_fields.forEach(((t,e)=>{this.m_sheet.setCellText(e,0,t.title),this.m_record?this.m_sheet.setCellText(e,1,this.m_record.getField(t.id)):this.m_sheet.setCellText(e,1,t.value)})),this.m_sheet.lockUpdate(!1)}_cellChange(t){let e=t.context,s=t.value;if(1!=e.col)return;let o=this.m_fields[e.row];o.type,this.m_record?this.m_record.setField(o.id,s):o.value=s,this.emit("change",(0,i.EvChange)(s,o))}_renderCell(t,e){switch(this.m_fields[e.row].type){default:case"string":case"number":case"boolean":case"choice":break;case"password":t="●●●●●●"}return t}_editCell(t,e,s){let i,a=this.m_fields[e];switch(a.type){default:case"string":case"number":i=new n.TextEdit(t);break;case"password":t.type="password",t.value=this.m_record.getField(a.id),i=new o.Input(t);break;case"boolean":i=new r.CheckBox(t);case"choice":}return i}_choicesFromArray(t){return t.map((t=>"object"==typeof t?{id:t.id,text:t.value}:{id:t,text:""+t}))}_choicesFromStore(t,e){let s=[];for(let i=0,o=t.count;i<o;i++){let o=t.getByIndex(i);s.push({id:o.getID(),text:o.getField(e)})}return s}}e.PropertyEditor=PropertyEditor})),define("x4/radiobtn",["require","exports","x4/component","x4/x4_events","x4/input","x4/label"],(function(t,e,s,i,o,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.RadioBtn=void 0;class RadioBtn extends s.Component{m_ui_input;constructor(t){super(t),this.mapPropEvents(t,"change")}render(t){let e=t.text??"",s=t.name??t.group,i=t.labelWidth??-1,r=t.checked??!1,a=t.align??"left",l=t.value,h=t.icon;this.addClass("@hlayout"),this.setProp("tag","label"),this.addClass(a),this._setTabIndex(t.tabIndex),r&&this.addClass("checked"),this.setContent([this.m_ui_input=new o.Input({type:"radio",name:s,tabIndex:t.tabIndex,value:l,attrs:{checked:r?"":void 0},dom_events:{change:()=>this._change(),focus:()=>this.m_ui_input.focus()}}),new n.Label({ref:"label",icon:h,text:e,width:"flex"===i?void 0:i,flex:"flex"===i?1:void 0,style:{order:"right"==a?-1:void 0}})])}_change(){let t=".x-input[name="+this.m_props.name+"]";document.querySelectorAll(t).forEach((t=>{s.Component.getElement(t,RadioBtn).removeClass("checked")}));let e=this.m_ui_input.dom;this.setClass("checked",e.checked),this.emit("change",(0,i.EvChange)(!0))}get check(){return this.m_ui_input?this.m_ui_input.dom.checked:this.m_props.checked}set check(t){let e=this.m_ui_input.dom;t?(e&&(e.checked=!0),this.m_props.checked=!0):(e&&(e.checked=!1),this.m_props.checked=!1)}get text(){return this.itemWithRef("label").text}set text(t){this.itemWithRef("label").text=t}}e.RadioBtn=RadioBtn})),define("x4/cardview",["require","exports","x4/component","x4/x4_events","x4/tools"],(function(t,e,s,i,o){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.CardView=void 0;class CardView extends s.Component{m_cards;m_ipage;m_cpage;constructor(t){super(t),this.m_cards=[],this.m_ipage=t.active,this.m_cpage=null,this.singleShot((()=>{this.setPages(t.pages)}))}render(){let t=[];this.m_cards.forEach((e=>{e.page&&t.push(e.page)})),this.setContent(t)}switchTo(t){if(0!=this.m_cards.length&&(void 0===t&&(t=this.m_cards[0].name),t!==this.m_cpage?.name)){if(this.m_cpage&&(this.m_cpage.selector&&this.m_cpage.selector.removeClass("@active"),this.m_cpage.page&&!(this.m_cpage.page instanceof Function))){let t=this.m_cpage.page;t.removeClass("@active"),t.addClass("@hidden")}if(this.m_cpage=this.m_cards.find((e=>e.name==t)),this.m_cpage){if(this.m_cpage.page){(0,o.isFunction)(this.m_cpage.page)&&(this.m_cpage.page=this.m_cpage.page(),console.assert(null!=this.m_cpage.page,"You must return a valid component"));let t=this.m_cpage.page;t.addClass("@active"),t.removeClass("@hidden"),t.dom||this._preparePage(t)}this.emit("change",(0,i.EvChange)(this.m_cpage.name))}}}setPages(t){let e=this._initTabs(t);e&&(0,o.asap)((()=>{this.switchTo(e),this.update()}))}_initTabs(t){if(!t)return;let e=this.m_ipage;return t.forEach((t=>{let s={...t};s.selector=this._prepareSelector(t),s.active=!1,this.m_cards.push(s),e||(e=t.name),t.active&&(e=t.name)})),e}_updateSelector(){}_prepareSelector(t){return null}_preparePage(t){t.setStyleValue("flex",1),t.addClass("@tab-page")}}e.CardView=CardView})),define("x4/sidebarview",["require","exports","x4/layout","x4/button","x4/cardview"],(function(t,e,s,i,o){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.SideBarView=void 0;class SideBarView extends o.CardView{m_sidebar;m_content;constructor(t){super(t),this.addClass("@hlayout"),this.m_sidebar=new s.VLayout({cls:"@side-bar",sizable:t.bar_sizable?"right":void 0}),this.m_content=new s.HLayout({flex:1,cls:"@tab-container"})}render(){let t=[];this.m_cards.forEach((e=>{t.push(e.selector)})),this.m_sidebar.setContent(new s.VLayout({flex:1,cls:"content",content:t})),this.setContent([this.m_sidebar,this.m_content])}_prepareSelector(t){return new i.Button({text:t.title,icon:t.icon,tooltip:t.title,click:()=>{this.switchTo(t.name)}})}_preparePage(t){super._preparePage(t),t.dom||this.m_content.appendChild(t)}}e.SideBarView=SideBarView})),define("x4/smartedit",["require","exports","x4/textedit","x4/popup","x4/component","x4/x4_events"],(function(t,e,s,i,o,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.PopupTable=e.SmartEdit=void 0;class SmartEdit extends s.TextEdit{m_popup;m_dataview;m_field;m_minDisplay;m_maxCount;m_autoFill;m_renderer;m_tools;m_searchCallback;constructor(t){super(t),this.m_dataview=t.store.createView(),this.m_field=t.field,this.m_renderer=t.renderer,this.m_minDisplay=t.minDisplay??0,this.m_maxCount=t.maxCount??10,this.m_autoFill=void 0===t.autoFill||t.autoFill,this.m_popup=null,this.m_tools=t.tools??[],this.m_searchCallback=t.searchCallback,this.on("change",(t=>this._onChange(t))),this.on("focus",(t=>this._onFocus(t)))}render(t){super.render(t),this.m_ui_input.setDomEvent("keydown",(t=>this._onKey(t)))}_onChange(t){this._showPopup(t.value)}_onFocus(t){t.focus?this._showPopup(this.value):this.m_popup&&this.m_popup.close()}_onKey(t){switch(console.log(t.key),t.key){case"Backspace":{let e=t.target.selectionStart,s=t.target.selectionEnd;if(e>s){let t=e;e=s,s=t}let i=this.value,o=i.substr(0,e),n=i.substr(s);this.value=o+n;break}case"ArrowUp":case"Up":this.m_popup&&(this._moveNext(!1),t.preventDefault());break;case"ArrowDown":case"Down":this.m_popup&&(this._moveNext(!0),t.preventDefault());break;case"Enter":this.m_popup&&this._checkTool(t)}}_showSugg(t){let e=this.getSelection();this.value=t,this.select(e.start,e.length)}isOpen(){return null!==this.m_popup}componentDisposed(){this.m_popup&&this.m_popup.close(),super.componentDisposed()}_checkTool(t){let e=this.m_popup.selection;this._callTool(e)&&t.preventDefault()}_callTool(t){let e=this.m_popup.getRowData(t);return!!e&&(this.m_popup&&this.m_popup.close(),e.callback(this),!0)}_moveNext(t){let e=this.m_popup.selNext(t);if(console.log("movenext: ",e),!this.m_popup.getRowData(e)){let t=this.m_popup.getCell(e,0).text;this._showSugg(t)}}_showPopup(t){let e;this.m_popup&&(this.m_popup.close(),this.m_popup=null);let s=this.getSelection(),i=s.length?t.substr(0,s.start):t;if(i.length<this.m_minDisplay)return;let o=this.m_autoFill;if(0==i.length?e=this.m_dataview.filter(null):this.m_searchCallback?(o=this.m_searchCallback(i,this.m_dataview),e=this.m_dataview.count):e=this.m_dataview.filter({op:"=",field:this.m_field,value:new RegExp("^"+i.trim()+".*","mi")}),e>0){let e=this.m_dataview.getByIndex(0);o&&(this.value=e.getField(this.m_field)),this.select(t.length);let s,i=Math.min(this.m_dataview.count,this.m_maxCount),r=this.m_ui_input.getBoundingRect();for(this.m_popup=new PopupTable({cls:"@editor-popup",minWidth:r.width}),this.m_popup.on("click",(t=>{let{row:e,text:s}=t.context;this._callTool(e)||(this.value=s,this.emit("click",(0,n.EvClick)()))})),s=0;s<i;s++){let t=this.m_dataview.getByIndex(s),e=this.m_renderer(t);this.m_popup.setCell(s,0,e[0].text,e[0].cls),this.m_popup.setCell(s,1,e[1].text,e[1].cls)}for(let t=0;t<this.m_tools.length;t++,s++)this.m_popup.setCell(s,0,this.m_tools[t].text),this.m_popup.setCell(s,1,""),this.m_popup.setRowData(s,this.m_tools[t]),console.log("fill: ",s);this.m_popup.displayAt(r.left,r.bottom)}else if(this.m_tools.length){let t=this.m_ui_input.getBoundingRect();this.m_popup=new PopupTable({cls:"@editor-popup",minWidth:t.width}),this.m_popup.on("click",(t=>{let{row:e,text:s}=t.context;this._callTool(e)||(this.value=s)}));for(let t=0,e=0;t<this.m_tools.length;t++,e++)this.m_popup.setCell(e,0,this.m_tools[t].text),this.m_popup.setCell(e,1,""),this.m_popup.setRowData(e,this.m_tools[t]),console.log("fill: ",e);this.m_popup.displayAt(t.left,t.bottom)}}}e.SmartEdit=SmartEdit;class PopupTable extends i.Popup{m_rows;m_cols;m_cells;m_data;m_minw;m_defcell;m_sel;constructor(t){super(t),this.m_rows=t.rows??0,this.m_cols=t.cols??0,this.m_minw=t.minWidth,this.m_cells=new Map,this.m_data=new Map,this.m_defcell={text:"",cls:void 0},this.m_sel=0,this.enableMask(!1),this.setDomEvent("create",(()=>{this.dom.cellPadding="0px"})),this.setDomEvent("mousedown",(t=>{t.preventDefault();let e=o.Component.getElement(t.target).getData("row");this.m_sel=e,this.update(),this.emit("click",(0,n.EvClick)({row:e,text:this.getCell(e,0).text}))}))}setRowData(t,e){this.m_data.set(t,e)}getRowData(t){return this.m_data.get(t)}setCell(t,e,s,i){this.m_cells.set(r(t,e),{text:s,cls:i}),this.m_rows<t+1&&(this.m_rows=t+1),this.m_cols<e+1&&(this.m_cols=e+1)}getCell(t,e){let s=this.m_cells.get(r(t,e));return null==s?this.m_defcell:s}render(){this.setProp("tag","table"),this.m_minw&&this.setStyleValue("minWidth",this.m_minw);let t=[];for(let e=0;e<this.m_rows;e++){let s,i=[],n={row:e};for(let t=0;t<this.m_cols;t++){let s=this.getCell(e,t),r=new o.Component({tag:"td",content:s.text,cls:s.cls,data:n});i.push(r)}e===this.m_sel&&(s="@selected");let r=new o.Component({tag:"tr",cls:s,content:i,data:n});t.push(r)}this.setContent(t)}displayAt(t,e,s="top left"){this.show();let i="l",o="t";s.indexOf("right")>=0&&(i="r"),s.indexOf("bottom")>=0&&(o="b");let n=document.body.getBoundingClientRect(),r=this.getBoundingRect();"r"==i&&(t-=r.width),"b"==o&&(e-=r.height),t<4&&(t=4),t+r.width>n.right-4&&(t=n.right-4-r.width),e<4&&(e=4),e+r.height>n.bottom-4&&(e=n.bottom-4-r.height),this.setStyle({left:t,top:e})}selNext(t){return this.m_sel+=t?1:-1,this.m_sel>=this.m_rows?this.m_sel=0:this.m_sel<0&&(this.m_sel=this.m_rows-1),this.update(),this.m_sel}get selection(){return this.m_sel}}function r(t,e){return 1e3*t+e}e.PopupTable=PopupTable})),define("x4/tabbar",["require","exports","x4/layout","x4/button","x4/x4_events"],(function(t,e,s,i,o){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.TabBar=void 0;class TabBar extends s.HLayout{m_pages;m_curPage;constructor(t){super(t),this.m_pages=[],this.m_curPage=null,this.mapPropEvents(t,"change"),this.m_props.pages?.forEach((t=>this.addPage(t))),this.m_props.default&&this.select(this.m_props.default)}addPage(t){this.m_pages.push({...t}),this._updateContent()}render(){let t=[];this.m_pages.forEach((e=>{e.btn=new i.Button({cls:e===this.m_curPage?"selected":"",text:e.title,click:()=>this._select(e)}),t.push(e.btn)})),this.setContent(t)}select(t){let e=this.m_pages.find((e=>e.id===t));e&&this._select(e)}_select(t){this.dom&&this.m_curPage&&(this.m_curPage.btn.removeClass("selected"),this.m_curPage.page.hide()),this.m_curPage=t,this.signal("change",(0,o.EvChange)(t?t.id:null)),this.dom&&this.m_curPage&&(this.m_curPage.btn.addClass("selected"),this.m_curPage.page.show())}}e.TabBar=TabBar})),define("x4/tabview",["require","exports","x4/layout","x4/button","x4/cardview"],(function(t,e,s,i,o){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.TabView=void 0;class TabView extends o.CardView{m_tab_selector;m_menu;constructor(t){super(t),this.m_tab_selector=!!t.tab_selector,this.m_menu=t.menu,this.addClass("@vlayout")}render(){let t=[],e=[];this.m_menu&&(this.m_menu.addClass("@button @tab-btn"),this.m_menu.removeClass("@menu-item"),t.push(this.m_menu)),this.m_cards.forEach((s=>{t.push(s.selector),s.page instanceof Function||e.push(s.page)})),this.m_tab_selector&&e.unshift(new s.HLayout({cls:"@tab-switch",content:t})),this.setContent(e)}_updateSelector(){}_prepareSelector(t){return new i.Button({cls:"@tab-btn",text:t.title,icon:t.icon,click:()=>{this.switchTo(t.name)}})}_preparePage(t){super._preparePage(t),t.dom||this.appendChild(t)}}e.TabView=TabView})),define("x4/textarea",["require","exports","x4/component","x4/x4_events","x4/tools"],(function(t,e,s,i,o){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.TextArea=void 0;class TextArea extends s.Component{constructor(t){super(t),this.mapPropEvents(t,"change")}render(t){t.text=t.text??"",this.setAttribute("tabindex",t.tabIndex??0),void 0!==t.readOnly&&this.setAttribute("readonly",t.readOnly),t.rows&&this.setAttribute("rows",t.rows),t.placeHolder&&this.setAttribute("placeholder",t.placeHolder),t.autoFocus&&this.setAttribute("autofocus",t.autoFocus),t.name&&this.setAttribute("name",t.name),t.autoGrow&&(this.setProp("autoGrow",!0),this.setAttribute("rows",this._calcHeight(t.text)),this.setDomEvent("keydown",(()=>{(0,o.asap)((()=>this._updateHeight()))}))),this.setDomEvent("keydown",(t=>{t.stopPropagation()})),this.setDomEvent("input",(()=>this._change())),this.setProp("tag","textarea")}_change(){this.emit("change",(0,i.EvChange)(this.value))}componentCreated(){this.value=this.m_props.text}get value(){return this.dom?this.dom.value:this.m_props.text}set value(t){this.m_props.text=t??"",this.dom&&(this.dom.value=this.m_props.text,this.m_props.autoGrow&&this.setAttribute("rows",this._calcHeight(this.m_props.text)))}_calcHeight(t){return 1+(t.match(/\n/g)||[]).length}_updateHeight(){const t=this.value,e=this._calcHeight(t);this.getData("lines")!=e&&(this.setAttribute("rows",e),this.setData("lines",e))}insertText(t){if(this.dom){let e=this.dom,s=e.selectionStart;e.setRangeText(t),e.selectionStart=s,e.selectionEnd=s+t.length}}}e.TextArea=TextArea})),define("x4/toaster",["require","exports","x4/label","x4/popup"],(function(t,e,s,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Toaster=void 0;class Toaster extends i.Popup{m_message;m_icon;constructor(t){super(t),this.m_message=t.message,this.m_icon=t.icon,this.enableMask(!1),this.addClass("@non-maskable")}render(){this.addClass("@hlayout"),this.setContent([new s.Label({icon:this.m_icon,text:this.m_message})])}show(){this.show=super.show,this.displayAt(9999,9999,"br",{x:0,y:-24});let t=1;this.startTimer("fadeout",2e3,!1,(()=>{this.startTimer("opacity",100,!0,(()=>{this.setStyleValue("opacity",t),t-=.1,t<0&&this.dispose()}))}))}}e.Toaster=Toaster})),define("x4/treeview",["require","exports","x4/component","x4/icon","x4/label","x4/layout","x4/x4_events"],(function(t,e,s,i,o,n,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.TreeView=void 0;class TreeView extends n.VLayout{m_view;m_container;m_selection;constructor(t){super(t),t.root=t.root,t.indent=t.indent??8,t.gadgets=t.gadgets,t.sort=t.sort??!0,this.m_selection=null,this.m_container=new s.Container({cls:"@scroll-container"}),this.m_view=new s.Container({cls:"@scroll-view",flex:1,content:this.m_container}),this.setContent([this.m_view,t.gadgets?new n.HLayout({cls:"gadgets",content:t.gadgets}):null]),this.setDomEvent("click",(t=>this._click(t))),this.setDomEvent("dblclick",(t=>this._click(t))),t.canDragItems&&(this.setDomEvent("dragstart",(t=>{let e=s.Component.getElement(t.target,s.Component)?.getData("node");e?(t.dataTransfer.effectAllowed="move",t.dataTransfer.items.add(JSON.stringify({type:"treeview",id:e.id}),"string")):(t.preventDefault(),t.stopPropagation())})),this.setDomEvent("dragover",(t=>this._dragEnter(t))),this.setDomEvent("dragenter",(t=>this._dragEnter(t))),this.setDomEvent("dragend",(t=>this._dragLeave(t))),this.setDomEvent("dragleave",(t=>this._dragLeave(t))),this.setDomEvent("drop",(t=>this._dragLeave(t))),this.setDomEvent("drop",(t=>this._drop(t)))),this.mapPropEvents(t,"dblclick","drag","selectionchange")}_dragEnter(t){t.preventDefault();let e=s.Component.getElement(t.target,s.Component),i=e?.getData("node");i&&(e.addClass("@drag-over"),t.dataTransfer.dropEffect="move")}_dragLeave(t){let e=s.Component.getElement(t.target,s.Component),i=e?.getData("node");i&&e.removeClass("@drag-over")}_drop(t){let e=s.Component.getElement(t.target,s.Component),i=e?.getData("node");if(i||(i=this.m_props.root),i){let s;s=i.children?i:e.getData("parent");for(let e=0;e<t.dataTransfer.items.length;e++)t.dataTransfer.items[0].getAsString((t=>{let e=JSON.parse(t);this.emit("drag",(0,r.EvDrag)(i,e,s))}))}}render(){this.__update()}__update(){if(this.m_props.root){let t=[];this._buildBranch(this.m_props.root,-1,t,this.m_props.root),this.m_container.setContent(t)}}updateElement(t){const{node:e,item:s}=this._getNode(t);if(e){const t=e.dom.parentNode,i=this._makeNode(s,e.dom.classList.value,e.getData("icon"),e.getData("level")),o=i._build();t.replaceChild(o,e.dom),this.m_selection?.el===e&&(this.m_selection.el=i)}}set root(t){this.m_props.root=t,this.update()}refreshRoot(t){let e=[];this.forEach((t=>(t.open&&e.push(t.id),!1)));this.selection;this.m_props.root=t,this.forEach((t=>(e.indexOf(t.id)>=0&&(t.open=!0),!1))),this.__update()}_buildBranch(t,e,s,i){let o="@tree-item";t.cls&&(o+=" "+t.cls),!t.open&&t.children&&(o+=" collapsed"),t.children&&(o+=" folder",0==t.children.length&&(o+=" empty"));let n=t.icon;if(void 0===n&&(n=t.children?61560:61894),e>=0){const i=this._makeNode(t,o,n,e);this.m_selection?.id==t.id&&(this.m_selection.el=i,i.addClass("selected")),s.push(i)}(-1==e||t.open)&&t.children&&(this.m_props.sort&&(t.children=t.children.sort(((t,e)=>{let s=(t.children?"0"+t.text:t.text).toLocaleLowerCase(),i=(e.children?"0"+e.text:e.text).toLocaleLowerCase();return s<i?-1:s>i?1:0}))),t.children.forEach((i=>{this._buildBranch(i,e+1,s,t)})))}_renderDef(t){return new o.Label({cls:"tree-label",flex:1,text:t.text})}_makeNode(t,e,s,o){return new n.HLayout({cls:e,content:[new i.Icon({cls:"tree-icon",icon:s}),this.m_props.renderItem?this.m_props.renderItem(t):this._renderDef(t)],data:{node:t,level:o,icon:s},style:{paddingLeft:4+o*this.m_props.indent},attrs:{draggable:!!this.m_props.canDragItems||void 0}})}forEach(t){return this.m_props.root&&function e(s){if(1==t(s))return!0;if(s.children)for(let t=0;t<s.children.length;t++)if(e(s.children[t]))return!0}(this.m_props.root),null}ensureVisible(t){const{node:e}=this._getNode(t);e&&e.scrollIntoView()}set selection(t){if(this.m_selection?.el&&this.m_selection.el.removeClass("selected"),this.m_selection=null,void 0!==t){const{node:e}=this._getNode(t);e&&(this.m_selection={id:t,el:e},e.addClass("selected"),e.scrollIntoView())}}_getNode(t){let e={node:null,item:null};return this.m_container.enumChilds((s=>{let i=s.getData("node");if(i?.id==t)return e={node:s,item:i},!0})),e}get selection(){return this.m_selection?.id}getNodeWithId(t){return this.forEach((e=>e.id==t))}_click(t){let e=t.target,i=e;for(;e!=this.dom;){let n=s.Component.getElement(e),a=n?.getData("node");if(a){if(a.children){(n.hasClass("selected")||i.classList.contains("tree-icon"))&&(a.open=!a.open),this.m_selection={id:a.id,el:null};let t=this.m_view?.dom?.scrollTop;this.update(),t&&this.m_view.dom.scrollTo(0,t),this.emit("expand",(o=a,(0,r.BasicEvent)({node:o})))}else this.selection=a.id,"click"==t.type?this.emit("click",(0,r.EvClick)(a)):this.emit("dblclick",(0,s.EvDblClick)(a));return void this.emit("selectionchange",(0,r.EvSelectionChange)(a))}e=e.parentElement}var o;"click"==t.type&&this.emit("selectionchange",(0,r.EvSelectionChange)(null))}static buildFromStrings(t,e="/"){let s={id:0,text:"<root>",children:[]};function i(t,s){let o,n=s.indexOf(e),r=s.substr(0,n<0?void 0:n);n>=0&&(o=t.find((t=>t.text==r))),o||(o={id:s,text:r},t.push(o)),n>=0&&(o.children||(o.children=[]),i(o.children,s.substr(n+e.length)))}return t.forEach((t=>{i(s.children,t)})),s}static buildFromHierarchy(t,e){let s={id:0,text:"<root>",children:[]},i=[];return t.forEach((function(t){let e,o;t.parent>0?(o=i.find((e=>e.id==t.parent)),o||(o={id:t.parent,text:"",children:[]},i.push(o)),o.children||(o.children=[])):o=s,e=i.find((e=>e.id==t.id)),e?(e.text=t.name,e.parent=t.parent):(e={id:t.id,text:t.name,parent:t.parent},t.leaf?e.icon=null:e.children=[]),i.push(e),o.children.push(e)})),e&&i.forEach(e),s}}e.TreeView=TreeView})),define("x4/panel",["require","exports","x4/component","x4/layout","x4/label","x4/icon"],(function(t,e,s,i,o,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Panel=void 0;class Panel extends i.VLayout{m_ui_title;m_ui_body;constructor(t){super(t),this.m_ui_title=new o.Label({cls:"title",text:this.m_props.title}),this.m_ui_body=new s.Component({cls:"body @vlayout",content:this.m_props.content})}render(){const t=this.m_props.gadgets??[],e=this.m_props.icon?new n.Icon({icon:this.m_props.icon}):null;super.setContent([new i.HLayout({cls:"title",content:[e,this.m_ui_title,...t]}),this.m_ui_body])}setContent(t){this.m_ui_body.setContent(t)}set title(t){this.m_ui_title.text=t}}e.Panel=Panel})),define("x4/hosts/electron",["require","exports","x4/hosts/host","x4/hosts/host"],(function(t,s,i,o){"use strict";Object.defineProperty(s,"__esModule",{value:!0}),s.ElectronHost=s.path=s.electron=s.process=s.fs=void 0,e(o,s),globalThis.host_require||(globalThis.host_require=t),s.fs=host_require("fs"),s.process=host_require("process"),s.electron=host_require("electron"),s.path=host_require("path");class ElectronHost extends i.Host{makePath(...t){return s.path.join(...t)}readBinary(t){return new Promise(((e,i)=>{s.fs.readFile(t,((t,s)=>{t?i(t):e(s)}))}))}writeBinary(t,e){return new Promise(((i,o)=>{s.fs.writeFile(t,e,(t=>{t?o(t):i(!0)}))}))}readUtf8(t){return new Promise(((e,i)=>{s.fs.readFile(t,{encoding:"utf8"},((t,s)=>{t?i(t):e(s.toString())}))}))}writeUtf8(t,e){return new Promise(((i,o)=>{s.fs.writeFile(t,e,{encoding:"utf8"},(t=>{t?o(t):i(!0)}))}))}compress(t){return new Promise(((e,s)=>{this.require("zlib").gzip(t,((t,i)=>{t?s(t):e(i)}))}))}decompress(t){return new Promise(((e,s)=>{this.require("zlib").gunzip(t,((t,i)=>{t?s(t):e(i)}))}))}readLocalStorage(t){return localStorage.getItem(t)}writeLocalStorage(t,e){localStorage.setItem(t,e)}stat(t){let e=s.fs.statSync(t);return e?{atime:e.atimeMs,isDir:e.isDirectory()}:null}readDir(t){return new Promise(((e,i)=>{s.fs.readdir(t,((t,s)=>{t?i(t):e(s)}))}))}require(t){return host_require(t)}cwd(){return s.process.cwd()}get ipc(){return s.electron.ipcRenderer}getPath(t){return this.ipc.sendSync("getPath",t)}getPathPart(t,e){let i=s.path.parse(t);switch(e){case"dirname":return i.dir;case"basename":return i.base;case"filename":return i.name;case"extname":return i.ext}return""}createCanvas=()=>document.createElement("canvas")}s.ElectronHost=ElectronHost,new ElectronHost})),define("src/x4mod",["require","exports","x4/application","x4/component","x4/button","x4/calendar","x4/canvas","x4/checkbox","x4/combobox","x4/color","x4/colorpicker","x4/datastore","x4/dialog","x4/form","x4/formatters","x4/i18n","x4/icon","x4/input","x4/image","x4/formatters","x4/gridview","x4/label","x4/layout","x4/link","x4/listview","x4/menu","x4/messagebox","x4/property_editor","x4/radiobtn","x4/request","x4/sidebarview","x4/settings","x4/smartedit","x4/spreadsheet","x4/tabbar","x4/tabview","x4/textarea","x4/textedit","x4/toaster","x4/tools","x4/tooltips","x4/treeview","x4/panel","x4/x4_events","x4/hosts/electron"],(function(t,s,i,o,n,r,a,l,h,c,m,d,u,p,_,g,f,x,b,v,w,y,C,k,S,E,P,I,D,M,R,T,z,A,L,B,O,H,F,V,j,q,W,N,$){"use strict";Object.defineProperty(s,"__esModule",{value:!0}),s.Formatters=void 0,e(i,s),e(o,s),e(n,s),e(r,s),e(a,s),e(l,s),e(h,s),e(c,s),e(m,s),e(d,s),e(u,s),e(p,s),s.Formatters=_,e(g,s),e(f,s),e(x,s),e(b,s),e(v,s),e(w,s),e(y,s),e(C,s),e(k,s),e(S,s),e(E,s),e(P,s),e(I,s),e(D,s),e(M,s),e(R,s),e(T,s),e(z,s),e(A,s),e(L,s),e(B,s),e(O,s),e(H,s),e(F,s),e(V,s),e(j,s),e(q,s),e(W,s),e(N,s),e($,s)})),define("src/tools",["require","exports","x4/component","x4/hosts/electron","src/x4mod"],(function(t,e,s,i,o){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.openExternal=e.setWindowTitle=e.isElectron=e.saveFile=e.openFile=void 0;let n=null;function r(){return n&&n.dispose(),n=new s.Component({tag:"input",style:{display:"none",id:"fileDialog"},attrs:{type:"file"}}),document.body.appendChild(n._build()),n}function a(){return!!process.versions.electron}e.openFile=function(t,e,s=!1){if(a()){const n=[];for(const e in t){let s;s=(0,o.isArray)(t[e])?t[e]:[t[e]],n.push({name:e,extensions:s})}const{ipcRenderer:r}=i.host.require("electron");let a=r.sendSync("showOpenDialog",{filters:n,multiple:s});console.log(a),a&&e(a)}else{let s=r();s.setAttribute("accept",t),s.setDomEvent("change",(t=>{const i=s.dom.value;console.log(i),e([i])})),s.dom.click()}},e.saveFile=function(t,e,s){if(a()){const{ipcRenderer:o}=i.host.require("electron"),n=[];for(const t in e)n.push({name:t,extensions:[e[t]]});let r=o.sendSync("showSaveDialog",{defaultPath:t,filters:n});console.log(r),r&&s(r)}else{let i=r();i.setAttribute("nwsaveas",t),i.setAttribute("accept",e),i.setDomEvent("change",(t=>{let e=i.dom.value;console.log(e),s(e)})),i.dom.click()}},e.isElectron=a,e.setWindowTitle=function(t){i.host.ipc.send("setTitle",t)},e.openExternal=function(t){i.host.require("electron").shell.openExternal(t)}})),define("x4/drawtext",["require","exports","x4/tools"],(function(t,e,s){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.drawText=void 0;const i={align:"center",vAlign:"middle",fontSize:14,fontWeight:null,fontStyle:"",fontVariant:"",fontFamily:"Arial",lineHeight:0,clip:!0,columns:1,columnGap:0,lineBreak:!0};function o(t,e){return(0,s.roundTo)(t.measureText(e).width,2)}e.drawText=function(t,e,n,r){if(n.width<=0||n.height<=0)return;if(r={...i,...r},t.save(),r.clip&&(t.beginPath(),t.rect(n.left,n.top,n.width,n.height),t.clip()),r.rotation){const e=new s.Point(n.left+n.width/2,n.top+n.height/2),i=r.rotation/180*Math.PI;t.translate(e.x,e.y),t.rotate(i),t.translate(-e.x,-e.y)}t.textBaseline="bottom";let a=(0,s.roundTo)(r.fontSize,2)??12,l="";r.fontStyle&&(l+=r.fontStyle+" "),r.fontVariant&&(l+=r.fontVariant+" "),r.fontWeight&&(l+=r.fontWeight+" "),l+=a+"px ";let h=r.fontFamily??"sans-serif";h.indexOf(".")>0&&(h='"'+h+'"'),l+=h,t.font=l.trim();let c=[],m=e.split("\n");const d=r.columns<1?1:r.columns,u=r.columnGap;let p=(n.width-u*(d-1))/d,_=n.left,g=p;r.lineBreak||(g=99999999);const f=o(t," ");m.forEach((e=>{let s={width:0,words:[],space:0},i=o(t,e);if(i<g)s.width=i,s.words.push({width:i,text:e}),c.push(s);else{let n=e.split(/\s/).filter((t=>""!==t)).map((e=>({width:o(t,e),text:e}))),r=0,a=0;for(;r<n.length;){const t=n[r];let e=s.width;e&&(e+=f),e+=t.width,e>p&&a>0?(c.push(s),a=0,i=0,s={width:0,words:[],space:0}):(s.words.push(t),s.width=e,r++,a++)}a&&(c.push(s),s.last=!0)}}));const x=function(t,e){const s=t.measureText(e);return s.actualBoundingBoxAscent+s.actualBoundingBoxDescent}(t,"Ag");let b=(r.lineHeight??1.3)*x;const v=c.length;let w=n.top;if(1==d){let e=b*v;1==v&&(b=x,e=x),"middle"===r.vAlign?(w=n.top+n.height/2-e/2,w+=b/2,t.textBaseline="middle"):"bottom"===r.vAlign?e<n.height&&(w=n.top+n.height-e+b):(w=n.top,t.textBaseline="top")}else w+=x;const y="justify"==r.align;let C=d,k=w,S=0;switch(r.align){case"right":S=1;break;case"center":S=2}let E=1,P=0;return c.some((e=>{console.log(E++,P),e.space=f,y&&!e.last&&function(t,e,s){let i=(e-t.width)/(t.words.length-1)+s;if(i<=0)return;t.width=e,t.space=i}(e,p,f);let s=_;if(1==S?s+=p-e.width:2==S&&(s+=p/2-e.width/2),e.words.forEach((i=>{t.fillText(i.text,s,k),s+=i.width+e.space})),k+=b,P+=b,k>n.bottom+b&&(k=w,_+=p+u,0==--C))return!0})),t.restore(),{height:(c.length+.3)*b}}})),define("lib",["require","exports","x4/drawtext","src/x4mod"],(function(t,s,i,o){"use strict";Object.defineProperty(s,"__esModule",{value:!0}),e(i,s),e(o,s)})),define("src/tools/plugins",["require","exports","lib"],(function(t,e,s){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.loadPlugins=void 0,e.loadPlugins=async function(t,e){let i=new Map;const o=s.host.require("fs");try{let n=o.readdirSync(t);for(let r of n){let n=t+"/"+r,a=n;if(s.host.stat(n).isDir)n=t+"/"+r+"/"+r+".js";else if(".js"!=s.host.getPathPart(n,"extname"))continue;let l=[r];const h=(e,r=!1)=>{if(r)e=s.host.getPathPart(e,"basename");else{if("./"!=e.substring(0,2))return s.host.require(e);for(e=e.replaceAll("..","");"."==e[0]||"/"==e[0]||"\\"==e[0];)e=e.substring(1);s.host.getPathPart(e,"extname")||(e+=".js")}const a=l[l.length-1];console.log({topStack:a,file:e}),n=t+"/"+a+"/"+e;const c=i.get(n);if(c)return c;const m=s.host.getPathPart(a+"/"+e,"dirname");l.push(m);const d={exports:{}};console.log("loading module",n);try{let t=o.readFileSync(n,{encoding:"utf-8"});new Function("require","module",t)(h,d)}catch(t){console.error(`error loading plugin ${n}`,t)}return l.pop(),i.set(e,d.exports),d.exports};let c=h(n,!0);c.basedir=a,c.name=s.host.getPathPart(r,"filename"),e(c)}}catch(t){console.log("error loading plugins:",t)}}})),define("src/elements/container",["require","exports","src/elements/element"],(function(t,e,s){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.CContainer=void 0;class CContainer extends s.CElement{m_children;constructor(t,e){super(t,e);const s=this.getReport();this.m_children=[],t.children&&t.children?.forEach((t=>{const e=s.elementFactory(t,this);this.m_children.push(e)}))}changeZOrder(t,e){let s,i=this.m_children,o=i.indexOf(t);if(o<0)return;if("back"==e)s=-99999999;else if("front"==e)s=99999999;else if("before"==e)s=-1;else{if("after"!=e)return;s=1}let n=o+s;n<0?n=0:n>i.length&&(n=i.length),n!=o&&(i.splice(o,1),i.splice(n,0,t))}forEach(t,e){return this.m_children.some((s=>{if(!0===t(s))return!0;if(e&&s instanceof CContainer){if(!0===s.forEach(t,!0))return!0}}))}getChildren(t,e=!0,s=!1){let i;return e?(i=[],this.m_children.forEach((t=>{t instanceof CContainer&&(i=i.concat(t.getChildren(!1,!0,s))),!s&&t.isLocked()||i.push(t)}))):i=s?[...this.m_children]:this.m_children.filter((t=>!t.isLocked())),t?i.reverse():i}removeChild(t){const e=this.m_children.findIndex((e=>e===t));e>=0&&this.m_children.splice(e,1)}addChild(t,e=null){null===e?this.m_children.push(t):this.m_children.splice(e,0,t)}touchesPt(t){if(this.isLocked())return null;for(let e=this.m_children.length-1;e>=0;e--){const s=this.m_children[e].touchesPt(t);if(s)return s}return this.getAbsRect(!0).contains(t)?this:null}save(){const t=super.save();if(delete t.children,this.m_children.length>0){let e=[];this.m_children.forEach((t=>{e.push(t.save())})),t.children=e}return t}enumColors(t){super.enumColors(t),this.m_children.forEach((e=>{e.enumColors(t)}))}renderItem(t,e){let s=this.getRect();t.isVisible(s)&&(t.save(),t.translate(s.left,s.top),this.m_children.forEach((s=>{s.renderItem(t,e)})),t.restore())}fixZOrder(){this.m_children.sort(((t,e)=>t.zorder<e.zorder?-1:1)),this.forEach((t=>{t instanceof CContainer&&t.fixZOrder()}),!1)}getChild(t){return this.m_children[t]}savePos(){super.savePos(),this.forEach((t=>t.savePos()),!1)}restorePos(){super.restorePos(),this.forEach((t=>t.restorePos()),!1)}}e.CContainer=CContainer})),define("src/tools/region",["require","exports","lib"],(function(t,e,s){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Region=void 0;e.Region=class Region{m_rects;constructor(){}add(t,e){this.m_rects?this.m_rects.push({rect:t,data:e}):this.m_rects=[{rect:t,data:e}]}touches(t){return!!this.m_rects&&this.m_rects.some((e=>e.rect.touches(t)))}clear(){this.m_rects=void 0}getRect(){let t=null;return this.m_rects?.forEach((e=>{t?t.combine(e.rect):t=new s.Rect(e.rect)})),t}forEach(t){this.m_rects?.forEach(t)}getParts(){return this.m_rects??[]}}})),define("src/elements/theme",["require","exports","lib"],(function(t,e,s){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.userColors=e.UserColors=e.Theme=void 0,e.Theme={ghost:"rgba(0,0,0,0.2)",selection:{lines:"#18a0fb",back:"#18a0fb22",handles:"white",locked:"#9aa6af",label:{back:"#18a0fb",text:"white"}},size:{back:"#18a0fb",text:"white"},marks:{horz:"red",vert:"green"},margins:s.Color.fromCssVar("css:page-margins"),rulers:{back:"#394B59e0",outside:"#00000080",mark:"#e0e0e0",text:"white",cursor:"#18a0fb"},page:{header:{background:"#CED9E0",text:"black"}},markers:{hmark:{line:"#18a0fb",label:"red",text:"white"},vmark:{line:"#18a0fb",label:"red",text:"white"},page:{line:"#a018fb",text:"white"},pbreak:{line:"rgba(0,0,0,0.4)",text:"white"}},sections:{header:{back:"#4fa500",text:"white",hollow:"#4fa50020"},footer:{background:"#4fa500",text:"white"},template:{background:"#404040",text:"white"},guard:{background:"#7e5c9c",text:"white"},last:{background:"#7e5c9c",text:"white"}}};class UserColors{m_colors;constructor(){this.m_colors=[]}add(t){let e,i;t instanceof s.Color?(e=t,i=t.toHex()):(e=new s.Color(t),i=e.toHex()),this.m_colors.findIndex((t=>t.toHex()==i))<0&&this.m_colors.push(e)}values(){return this.m_colors}clear(){this.m_colors=[]}}e.UserColors=UserColors,e.userColors=new UserColors})),define("src/tools/conversion",["require","exports"],(function(t,e){"use strict";function s(t){return 1.3333333333*t}function i(t){return t/1.3333333333}function o(t){return t/2.8333333333}function n(t){return.0138889*t}function r(t){return 3.77777776*t}function a(t){return t/3.77777776}function l(t){return 25.4*t*3.77777776}function h(t){return t/25.4/3.77777776}Object.defineProperty(e,"__esModule",{value:!0}),e.pt2u=e.u2px=e.px2u=e.u2u=e.deg2rad=e.px2in=e.in2px=e.px2mm=e.mm2px=e.in2pt=e.pt2in=e.in2mm=e.mm2in=e.mm2pt=e.pt2mm=e.px2pt=e.pt2px=void 0,e.pt2px=s,e.px2pt=i,e.pt2mm=o,e.mm2pt=function(t){return 2.8333333333*t},e.mm2in=function(t){return t/25.4},e.in2mm=function(t){return 25.4*t},e.pt2in=n,e.in2pt=function(t){return t/.0138889},e.mm2px=r,e.px2mm=a,e.in2px=l,e.px2in=h,e.deg2rad=function(t){return t/180*Math.PI},e.u2u=function(t){return t},e.px2u=function(t,e){switch(e){case"in":return h(t);case"mm":return a(t);case"pt":return i(t);case"px":return t}},e.u2px=function(t,e){switch(e){case"in":return l(t);case"mm":return r(t);case"pt":return s(t);case"px":return t}},e.pt2u=function(t,e){switch(e){case"in":return n(t);case"mm":return o(t);case"pt":return t;case"px":return s(t)}}})),define("src/tools/paper",["require","exports","lib","src/tools/conversion"],(function(t,e,s,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.calcPaperSize=void 0;const o={A3:[297,420],A4:[210,297],A5:[148,210],A6:[105,148],letter:[215.9,279.4],legal:[215.9,355.6],executif:[184.2,266.7]};e.calcPaperSize=function(t,e){let n;if(t.size in o){const e=o[t.size][0],i=o[t.size][1];n=new s.Size(e,i)}else n=new s.Size(Math.max(t.width??210,50),Math.max(t.height??297,50));switch(e){case"mm":break;case"in":n.width=(0,i.mm2in)(n.width),n.height=(0,i.mm2in)(n.height);break;case"pt":n.width=(0,i.mm2pt)(n.width),n.height=(0,i.mm2pt)(n.height);break;case"px":n.width=(0,i.mm2px)(n.width),n.height=(0,i.mm2px)(n.height)}return n}})),define("src/renderers/base_canvas",["require","exports","lib","src/tools/conversion"],(function(t,e,s,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.alignRect=e.PaintCanvas=e.Color=e.Size=e.Point=e.Rect=void 0,Object.defineProperty(e,"Color",{enumerable:!0,get:function(){return s.Color}}),Object.defineProperty(e,"Rect",{enumerable:!0,get:function(){return s.Rect}}),Object.defineProperty(e,"Size",{enumerable:!0,get:function(){return s.Size}}),Object.defineProperty(e,"Point",{enumerable:!0,get:function(){return s.Point}});e.PaintCanvas=class PaintCanvas{m_options;m_unitcvt;m_unitcvt_r;constructor(t){this.m_options=t,this.m_unitcvt=t=>t,this.m_unitcvt_r=t=>t}convertUnits(t,e){let s=this.getUnits();if(s==e)return t;let o=(0,i.u2px)(t,e);return(0,i.px2u)(o,s)}beginHotSpot(t){}endHotSpot(){}},e.alignRect=function(t,e,i){if(!i||"fill"==i)return new s.Rect(e);const o=t.width/t.height,n=e.width/e.height;let r,a;return"cover"==i&&(o>n?(r=e.width,a=t.height*(r/t.width)):(a=e.height,r=t.width*(a/t.height))),new s.Rect(e.left+e.width/2-r/2,e.top+e.height/2-a/2,r,a)}})),define("src/elements/text",["require","exports","src/elements/element","src/elements/theme","src/tools/conversion"],(function(t,e,s,i,o){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.CText=void 0;class CText extends s.CElement{initWithDef(){super.initWithDef(),Object.assign(this.m_data,{font:{family:"<document>",size:12},color:"#000"})}renderItem(t,e){const n=this.m_data;if(!1===n.visible)return;let r=this.getRect(!0),a=n.border?.width,l=n.border?.color;"edit"!=e.mode||!(0,s.isTransp)(l)&&a||!(0,s.isTransp)(n.bkColor)||(a=(0,o.px2u)(1,t.getUnits()),l=i.Theme.ghost);let h=n.text;"execute"==e.mode&&(h=this.getReport().resolveText(n.text,e));const c=this._calcFont();if(t.save(),this.m_data.name&&t.beginHotSpot(this.m_data.name),n.rotation){const e=new s.Point(r.left+r.width/2,r.top+r.height/2);t.translate(e.x,e.y),t.rotate(n.rotation),t.translate(-e.x,-e.y)}t.fillRect(r.left,r.top,r.width,r.height,n.bkColor,n.radius),t.strokeRect(r.left,r.top,r.width,r.height,a,l,n.radius);const m={fontSize:n.font?.size,fontFace:c,fontWeight:n.font.weight??400,align:n.align??"left",vAlign:n.vAlign??"top",lineHeight:n.lineHeight??1.3,columns:n.columns>1?n.columns:void 0,columnGap:void 0===n.columnGap?(0,o.pt2px)(8):n.columnGap,padding:(n.padding??0)+(n.border?.width/2??0),lineBreak:!0!==n.noWordWrap,rotation:0};t.drawText(r.left,r.top,r.width,r.height,h,n.color,m),this.m_data.name&&t.endHotSpot(),t.restore()}_calcFont(){let t=this.m_data?.font?.family??"<page>";if("<page>"==t){t=this.getPage().getDefFont()}else if("<document>"==t){t=this.getReport().getDefFont()}return t}enumColors(t){this.m_data.color&&t.add(this.m_data.color),this.m_data.bkColor&&t.add(this.m_data.bkColor)}isAutoGrow(){return this.m_data.autoGrow}calcHeight(t,e){const s=this.m_data;let i=s.text;"execute"==e.mode&&(i=this.getReport().resolveText(s.text,e));const n=this._calcFont(),r={fontSize:s.font?.size,fontFace:n,fontWeight:s.font.weight??400,align:s.align??"left",vAlign:s.vAlign??"top",lineHeight:s.lineHeight??1.3,columns:s.columns>1?s.columns:void 0,columnGap:void 0===s.columnGap?(0,o.pt2px)(8):s.columnGap,padding:(s.padding??0)+(s.border?.width??0),lineBreak:!0!==s.noWordWrap,rotation:0};let a=this.getRect(!0);return t.measureText(i,a.width,r).height}}e.CText=CText})),define("src/elements/section",["require","exports","src/elements/element","src/elements/container","src/elements/text"],(function(t,e,s,i,o){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.CSection=void 0;class CSection extends i.CContainer{m_fixed_height;m_fixed_top;m_reppos;renderItem(t,e){"execute"==e.mode&&this._prepareGrowableElements(t,e),this.m_data.repeat>1&&void 0!==this.m_reppos?this.m_data.left=this.m_reppos*this.m_data.width:this.m_data.left=0,super.renderItem(t,e)}getBreak(){return this.m_data.break}getHandles(t,e){if(this.is("doc_head")||this.is("doc_back"))return[];const s=this.getRect();return[{code:"bottom",x:s.left+s.width/2,y:s.bottom}]}fill(t,e){super.fill(t,e),t.itemWithRef("break")?.show(!(this.is("header")||this.is("footer")||this.is("body")))}getName(){let t=super.getName();return t||(this.is("header")?t=s._tr.elements.section.name_header:this.is("footer")?t=s._tr.elements.section.name_footer:this.is("body")&&(t=s._tr.elements.section.name_body)),t}set_top(t){this.m_data.top=t}set_width(t){this.m_data.width=t}set_height(t){this.m_data.height=t}is(t){return this.m_data.kind==t}getKind(){return this.m_data.kind}getRect(){let t=super.getRect();return void 0!==this.m_fixed_top&&(t.top=this.m_fixed_top),void 0!==this.m_fixed_height&&(t.height=this.getHeight()),t}getHeight(){return void 0!==this.m_fixed_height?this.m_fixed_height:this.m_data.height}fix_top(t){this.m_fixed_top=t}fix_height(t){this.m_fixed_height=t}getPageOffset(t,e,s){return{x:this.m_data.left+t,y:this.m_data.top+e}}size(t,e){if(this.is("header")||this.is("footer")){const t=this.m_owner.getMinHeight()/3;e>t&&(e=t)}e<1&&(e=1),super.size(t,e)}getComputedName(){switch(this.m_data.kind){case"header":return s._tr.elements.section.name_header;case"footer":return s._tr.elements.section.name_footer;case"body":return s._tr.elements.section.name_body;case"doc_head":return s._tr.elements.section.name_dochead;case"doc_back":return s._tr.elements.section.name_docback}return this.m_data.name??"section"}touches(t,e){return!1}enterSizeMove(t){}exitSizeMove(t){}__set(t,e){super.__set(t,e),"break"==t&&this.notify("section.break_change",this)}repCount(){return this.m_data.repeat??1}repDispClear(){this.m_reppos=0}repDispNext(){return this.m_reppos++,this.m_reppos==this.m_data.repeat&&(this.m_reppos=0,!0)}repReset(){this.m_reppos=void 0,this.m_data.left=0}_prepareGrowableElements(t,e){let s=this.m_data.height;const i=[];this.forEach((t=>i.push(t)),!1);for(let n=0;n<i.length;n++){const r=i[n];if(r instanceof o.CText&&r.isAutoGrow()){const o=r.getRect(),a=o.bottom;let l=r.calcHeight(t,e);if(l>o.height){r.setData("height",l);for(let t=n+1;t<i.length;t++){const e=i[t],s=e.getRect();s.top>=a&&(s.top-=o.height,s.top+=l,e.setData("top",s.top))}s-=o.height,s+=l}}}this.m_data.height=s}restorePos(){this.repDispClear(),super.restorePos()}}e.CSection=CSection})),define("src/elements/page",["require","exports","src/tools/paper","src/elements/element","src/elements/section","src/elements/container"],(function(t,e,s,i,o,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.CPage=void 0;class CPage extends n.CContainer{constructor(t,e){super(t,e),this.updateRect(),this._sortSections(),this.fixSections()}getPage(){return this}isSelectable(){return!1}renderItem(t,e){let i=this.getRect();const n=this.getReport(),r=this.getSection("header"),a=this.getSection("footer"),l=(0,s.calcPaperSize)(this.m_data.size,n.getUnits());let h,c,m=!0;e.printInfo.rootData.document.pagenum=1,e.printInfo.rootData.document.pagecount=1,e.printInfo.started=!1,e.printInfo.top=0,e.printInfo.limit=0,r&&r.set_width(i.width),a&&a.set_width(i.width);const d=(s=!0)=>{if(e.printInfo.started&&t.endPage(),h=0,c=l.height,t.startPage(this.m_data.size),s&&(r&&(r.savePos(),r.fix_top(h),r.renderItem(t,e),h+=r.getHeight(),r.restorePos()),a)){a.savePos();const s=a.getHeight();c-=s,a.fix_top(c),a.renderItem(t,e),a.restorePos()}e.printInfo.rootData.document.pagenum++,e.printInfo.rootData.document.pagecount++,m=!1,e.printInfo.started=!0};this.savePos();const u=this.getSection("doc_head"),p=this.getSection("doc_back");u&&(d(!1),u.set_width(i.width),u.fix_top(h),u.renderItem(t,e)),d(),e.printInfo.start=d,e.printInfo.top=h,e.printInfo.limit=c;for(const s of this.m_children){if(s===r||s===a||s===u||s===p)continue;if(!(s instanceof o.CSection))continue;const n=s.getBreak();"before"==n&&d(),s.set_width(i.width),s.fix_top(h),s.savePos(),s.renderItem(t,e),h+=s.getHeight(),s.restorePos(),"after"==n&&d()}p&&(d(!1),p.set_width(i.width),p.fix_top(h),p.renderItem(t,e)),this.restorePos(),t.endPage()}computePageBreaks(){let t=this.getMinHeight(),e=0,s=0,i=0,n=[];const r=this.getSection("doc_head"),a=this.getSection("doc_back"),l=this.getSection("header"),h=this.getSection("footer"),c=this.getSection("body");this.m_children.forEach((m=>{if(m!==r&&m!==a&&(s>=i&&(i+=t),m instanceof o.CSection)){let o=m.getHeight();if(m===l)e+=o,t-=o,i=e+t;else if(m===h)e+=o,t-=o;else if(m===c);else switch(m.getBreak()){case"before":n.push(s),i=s+t;break;case"after":n.push(s+o),i=s+o+t}s+=o}})),i>s?n.push(i):i=s;let m=0,d=[];const u=this.getMinHeight();let p=0;r&&(d.push(u),p+=u),a&&(d.push(u),p+=u);let _=n[m]+p;for(let s=p+e+t;s<=p+i;s+=t)void 0!==_&&_<=s&&(s=_,_=n[++m]+p),d.push(s);return d}updateRect(){const t=(0,s.calcPaperSize)(this.m_data.size,this.m_owner.getUnits());"landscape"==this.m_data.orientation?(this.m_data.width=t.height,this.m_data.height=Math.max(t.width,this.m_data.height)):(this.m_data.width=t.width,this.m_data.height=Math.max(t.height,this.m_data.height))}getMinHeight(){const t=(0,s.calcPaperSize)(this.m_data.size,this.m_owner.getUnits());return"landscape"==this.m_data.orientation?t.width:t.height}getHandles(){return[]}getDescriptor(){return[...super.getDescriptor(!1,!1,!1),{type:"panel",title:i._tr.elements.properties,items:[{type:"choice",title:i._tr.elements.page.size,ref:"size.size",labelWidth:70,items:[{id:"A6",text:"A6"},{id:"A5",text:"A5"},{id:"A4",text:"A4"},{id:"letter",text:"letter"},{id:"legal",text:"legal"},{id:"custom",text:"custom"}]},[{type:"num",title:i._tr.elements.page.width,ref:"size.width",min:50,labelWidth:70},{type:"num",title:i._tr.elements.page.height,ref:"size.height",min:50,labelWidth:70}],{type:"choice",title:i._tr.elements.page.orientation,ref:"orientation",labelWidth:70,items:[{id:"portrait",text:i._tr.elements.page.portrait},{id:"landscape",text:i._tr.elements.page.landscape}]},{type:"panel",title:i._tr.elements.defaults,items:[{type:"choice",ref:"font",title:i._tr.elements.page.font,items:this.getReport().enumFontNames(!0,!1),default:"<document>"}]}]}]}fill(t,e){super.fill(t,e);const s="custom"==this.m_data.size.size;t.itemWithRef("size.width")?.show(s),t.itemWithRef("size.height")?.show(s)}__set(t,e){super.__set(t,e),"orientation"==t||"size.size"==t?("size.size"==t&&"custom"==e&&(this.m_data.size.width=this.m_data.width,this.m_data.size.height=this.m_data.height),this.updateRect(),this.notify("page.rotate",this),this.notify("element.refill",{el:this,pos:!0})):"size.width"!=t&&"size.height"!=t||(this.updateRect(),this.notify("page.resize",this))}getContextMenu(){return[]}getDefFont(){let t=this.m_data.font;return t||(t=this.getReport().getDefFont()),t}getAbsRect(t=!0){return this.getRect(t)}getPageOffset(t,e,s){return{x:t,y:e}}addSection(t,e){let s=-1;e&&(s=this.m_children.indexOf(e)),s<0?this.m_children.push(t):this.m_children.splice(s,0,t),this._sortSections(),this.fixSections(),this.dirty()}sectionOnPoint(t){if(!this.getRect().contains(t))return null;for(const e of this.m_children)if(e.getRect().contains(t))return e;return this.getSection("body")}getSection(t){return this.m_children.find((e=>e instanceof o.CSection&&e.getKind()==t))}_sortSections(){let t=[];const e=this.getSection("header"),s=this.getSection("footer"),i=this.getSection("body"),o=this.getSection("doc_head"),n=this.getSection("doc_back");o&&t.push(o),n&&t.push(n),e&&t.push(e),s&&t.push(s),this.m_children.forEach((r=>{r!==e&&r!==s&&r!==i&&r!==o&&r!=n&&t.push(r)})),i&&t.push(i),this.m_children=t}nextSection(t){let e=this.m_children.indexOf(t);if(!(e<0))return this.m_children[e+1]}fixSections(){const t=this.getSection("header"),e=this.getSection("footer"),s=this.getSection("doc_head"),i=this.getSection("doc_back"),o=this.getSection("body"),n=this.getMinHeight(),r=this.getRect();let a=0;s&&(s.set_top(a),s.set_height(n),s.set_width(r.width),a+=s.getHeight()),i&&(i.set_top(a),i.set_height(n),i.set_width(r.width),a+=i.getHeight());let l=0;t&&(t.set_top(a),t.set_width(r.width),a+=t.getHeight(),l+=t.getHeight()),e&&(e.set_top(a),e.set_width(r.width),a+=e.getHeight(),l+=t.getHeight());const h=n-l;if(this.m_children.forEach((n=>{if(n!==t&&n!==e&&n!==o&&n!==s&&n!==i){n.set_top(a),n.set_width(r.width);let t=n.getHeight();a+=t}})),o){o.set_top(a),o.set_width(r.width);const t=this.computePageBreaks();t.length?o.fix_height(t[t.length-1]-a):o.fix_height(h),a+=o.getHeight()}this.m_data.height=a,this.notify("element.refill",{el:this,pos:!0})}prepareZOrder(){let t=1;this.forEach((e=>{e.zorder=t++}),!0)}}e.CPage=CPage})),define("src/tools/json",["require","exports"],(function(t,e){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.parseJSON=void 0,e.parseJSON=function(t){if(t)try{return JSON.parse(t)}catch(e){let s=new Function("return "+t);try{return s()}catch(t){console.log(t)}}}})),define("src/elements/custom",["require","exports","src/tools/conversion","src/elements/element","src/elements/theme"],(function(t,e,s,i,o){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.CCustom=void 0;class CCustom extends i.CElement{m_init;constructor(t,e){super(t,e),this.m_init=void 0!==this.m_data.plugin}_prepareDefaults(){let t={font:{family:"<page>",size:9,weight:"normal"},color:"#000",...this.m_data.defaults};return t.font.family=this._calcFont(t.font.family),t}_preparePlugin(){if(!this.m_init){const t=this.getReport();this.m_data.plugin=t.getPlugin(this.m_data.reference),this.m_init=!0}}buildEditors(){return this._preparePlugin(),super.buildEditors()}renderItem(t,e){this._preparePlugin();const i=this.getRect(!0),n=this.m_data.plugin;if(n&&n.renderer){this.m_data.name&&t.beginHotSpot(this.m_data.name),t.save(),t.clip(i.left,i.top,i.width,i.height);const s=this._prepareDefaults(),o={solve_text:t=>"execute"==e.mode?this.getReport().resolveText(t,e):t,solve_link:t=>this._solver(t,e),translate:t=>e?.printInfo?.script?e.printInfo.script.translate(t):t};try{n.renderer.call(this,t,this.m_data.data,s,this.m_data.link,o)}catch(e){console.error(e),t.drawText(i.left,i.top,i.width,i.height,`error: ${e.message}`,"red",{})}this.m_data.name&&t.endHotSpot(),t.restore()}else t.drawText(i.left,i.top,i.width,i.height,`bad plugin: ${this.m_data.reference}`,"black",{});if("edit"==e.mode){let e=(0,s.px2u)(1,t.getUnits());t.strokeRect(i.left,i.top,i.width,i.height,e,o.Theme.ghost,0)}}_solver(t,e){if(!t)return;let s=[];const i=this.getReport().findData(t,e.printInfo.rootData,s);return s.length&&console.error(s),i}_calcFont(t){if("<page>"==t){t=this.getPage().getDefFont()}else if("<document>"==t){t=this.getReport().getDefFont()}return t}}e.CCustom=CCustom})),define("src/elements/image",["require","exports","src/tools/conversion","src/elements/element","src/elements/theme"],(function(t,e,s,i,o){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.CImage=void 0;class CImage extends i.CElement{renderItem(t,e){const i=this.m_data,n=this.getRect();i.imageid&&t.drawImage(i.imageid,n.left,n.top,n.width,n.height,i.fit),"edit"==e.mode&&t.strokeRect(n.left,n.top,n.width,n.height,(0,s.px2u)(1,t.getUnits()),o.Theme.ghost,0)}}e.CImage=CImage})),define("src/elements/script",["require","exports","src/tools/paper","src/elements/text","src/elements/custom","src/elements/image"],(function(t,e,s,i,o,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.ScriptReport=void 0;class ScriptElement{element;constructor(t){this.element=t}set bkColor(t){this.element instanceof i.CText&&this.element.setData("bkColor",t)}set color(t){this.element instanceof i.CText&&this.element.setData("color",t)}set text(t){this.element instanceof i.CText&&this.element.setData("text",t?.toString())}get data(){if(this.element instanceof o.CCustom)return this.element.getData("data")}set image(t){this.element instanceof n.CImage&&this.element.setData("imageid",t?.toString())}set visible(t){this.element.setData("visible",!!t)}}class ScriptSection{report;section;m_items;constructor(t,e){this.section=e,this.report=t,this.m_items=null}print(){this.report.print(this)}item(t){const e=this.items()[t];return e||console.log("element not found",t),e}items(){return this.m_items||(this.m_items={},this.section.forEach((t=>{let e=t.getName();e&&(this.m_items[e]=new ScriptElement(t))}),!0)),this.m_items}}e.ScriptReport=class ScriptReport{autoMode=!0;ctx;rsc;m_cpage;m_report;m_sections;m_slast;top=0;bot=0;constructor(t,e,s){this.m_report=t,this.m_slast=null,this.m_sections=null,this.m_cpage=this.m_report.getChild(0),this.ctx=e,this.rsc=s}get sections(){if(!this.m_sections){const t=this.m_cpage.getChildren(!1,!1,!0);this.m_sections={},t.forEach((t=>{this.m_sections[t.getName()]=new ScriptSection(this,t)}))}return this.m_sections}translate(t){return t}disableAutoMode(){this.autoMode=!1}begin(){const t=this.rsc;t.printInfo.rootData.document.pagenum=1,t.printInfo.rootData.document.pagecount=1,t.printInfo.started=!1,t.printInfo.top=0,t.printInfo.limit=0,t.printInfo.script=this}_startNewPage(t=!0){const e=this.rsc,i=this.ctx,o=this.m_cpage,n=(0,s.calcPaperSize)(o.getData("size"),this.m_report.getUnits()),r=o.getSection("header"),a=o.getSection("footer");if(this._closePage(),this.top=0,this.bot=n.height,this.m_slast=null,i.startPage(o.getData("size")),t&&(r&&(r.fix_top(this.top),r.renderItem(i,e),this.top+=r.getHeight()),a)){const t=a.getHeight();this.bot-=t,a.fix_top(this.bot),a.renderItem(i,e)}e.printInfo.rootData.document.pagenum++,e.printInfo.rootData.document.pagecount++,e.printInfo.started=!0,e.printInfo.top=this.top,e.printInfo.limit=this.bot}_closePage(){const t=this.rsc,e=this.ctx;t.printInfo.started&&(e.endPage(),t.printInfo.started=!1)}print(t){let e;if(t instanceof ScriptSection)e=t;else if(e=this.m_sections[t],!e)return;const s=e.section,i=this.rsc,o=this.m_cpage.getRect();if(s.is("doc_head")||s.is("doc_back"))this._startNewPage(!1),s.set_width(o.width),s.fix_top(this.top),s.renderItem(this.ctx,this.rsc),this._closePage();else{const t=s.getBreak(),e=s.getHeight();"before"!=t&&i.printInfo.started?this.top+e>i.printInfo.limit&&this._startNewPage(!0):this._startNewPage(!0);const n=s.repCount()||1;s.set_width(o.width/n),n>1?(this.m_slast!==s&&s.repDispClear(),s.fix_top(this.top),s.renderItem(this.ctx,this.rsc),s.repDispNext()&&(this.top+=s.getHeight())):(this.m_slast&&this.m_slast.repCount()>1&&(this.top+=this.m_slast.getHeight(),this.top+e>i.printInfo.limit&&this._startNewPage(!0)),s.set_width(o.width),s.fix_top(this.top),s.savePos(),s.renderItem(this.ctx,this.rsc),this.top+=s.getHeight(),s.restorePos()),this.m_slast=s,"after"==t&&this._closePage()}}nextPage(t){if(t){const e=this.rsc;this.top+t>e.printInfo.limit&&this._closePage()}else this._closePage()}end(){this.ctx.endPage();this.m_cpage.getChildren(!1,!1,!0).forEach((t=>{t.repReset()}))}}})),define("src/elements/report",["require","exports","src/elements/element","src/elements/container","src/tools/json","lib","src/elements/script"],(function(t,e,s,i,o,n,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.CReport=void 0;class CReport extends i.CContainer{m_plugins;m_dataSources;m_field_cache;constructor(t){if(super(t={grid_on:!0,grid_size:1,version:"1.0.0",...t},null),!this.m_data.version||this.m_data.version<"1.0.0")throw new Error("Incorrect file version.");this.m_plugins=[],this.m_dataSources=[]}getReport(){return this}getPage(){return null}getResources(){return this.m_data.rsrc??[]}setResources(t){this.m_data.rsrc?this.m_data.rsrc.splice(0,999999999,...t):this.m_data.rsrc=t,this.dirty()}renderItem(t,e){this.m_field_cache=new Map,t.setUnits(this.m_data.units);let s=!0;"execute"==e.mode&&(s=!this._parseScript(t,e)),s&&this.m_children.forEach((s=>{s?.renderItem(t,e)})),this.m_field_cache=null}isSelectable(){return!0}getUnits(){return this.m_data.units}getHandles(){return[]}getImage(t){const e=this.m_data?.rsrc.find((e=>e.name==t&&"image"==e.type));return e?Buffer.from(e.data,"base64"):null}getFont(t){const e=this.m_data?.rsrc.find((e=>e.name==t&&"font"==e.type));return e?Buffer.from(e.data,"base64"):null}getDataSources(){const t=(0,o.parseJSON)(this.getDataSource()),e={name:"document",description:s._tr.datasources.document.description,type:"object",elements:[{name:"pagenum",description:s._tr.datasources.document.pagenum,type:"number"},{name:"pagecount",description:s._tr.datasources.document.pagecount,type:"number"},{name:"name",description:s._tr.datasources.document.name,type:"string"}]},i={name:"system",description:s._tr.datasources.system.description,type:"object",elements:[{name:"today",description:s._tr.datasources.system.date,type:"date"}]};return[...this.m_dataSources,i,e,t].filter((t=>!!t))}setDataSources(t){this.m_dataSources=t}setDataSource(t){this.m_data.datasource=t,this.dirty()}getDataSource(){return this.m_data.datasource}setDataSample(t){this.m_data.datasample=t,this.dirty()}getDataSample(){return this.m_data.datasample}getScript(){return this.m_data.script??""}getPlugins(){return this.m_plugins}setPlugins(t){this.m_plugins=t}getPlugin(t){let e=t.split("."),s=e.shift(),i=e.join(".");for(const t of this.m_plugins)if(t.name==s){let e=t.elements;for(const t of e)if(t.name==i)return t;break}return null}save(){const t=super.save();return delete t.left,delete t.top,delete t.width,delete t.height,delete t.type,t}__set(t,e){const s=this.m_data.units;super.__set(t,e),"units"==t&&this.forEach((t=>{t.unitsChanged(s,e)}),!0)}getDefFont(){return this.m_data.font??"arial"}enumFontNames(t=!0,e=!0){let i=[];return t&&i.push({id:"<document>",text:s._tr.elements.report.font.as_doc}),e&&i.push({id:"<page>",text:s._tr.elements.report.font.as_page}),i.push({id:"sans-serif",text:"sans-serif"}),i.push({id:"monospace",text:"monospace"}),this.m_data.rsrc?.forEach((t=>{"font"==t.type&&i.push({id:t.name,text:t.name})})),i}resolveText(t,e){if(!t)return"";if(t.indexOf("${")<0)return t;return t.replace(/\$\{(.+?)(?<!\\)\}/g,((t,s)=>this.findData(s,e.printInfo.rootData,e.printInfo.errors)))}findData(t,e,s){try{let s=this.m_field_cache.get(t);s||(s=new Function(...Object.keys(e),"format","return "+t),this.m_field_cache.set(t,s));const i=(t,e)=>t instanceof Date?(0,n.formatIntlDate)(t,e):t.toString();return s.call(null,...Object.values(e),i)}catch(e){return s.push(e.message+" in: "+t),"@ERR"}}_parseScript(t,e){const s=this.getScript();if(!s)return!1;if(s.trim(),0==s.length)return!1;const i=new r.ScriptReport(this,t,e);return new Function("report","data","log",s).call(null,i,e.printInfo.rootData,console.log),!i.autoMode}}e.CReport=CReport})),define("src/elements/element",["require","exports","lib","src/tools/region","src/elements/theme","src/renderers/base_canvas","src/tools/conversion"],(function(t,e,s,i,o,n,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.rotateAroundPoint=e.cleanupData=e.CElement=e.isTransp=e._tr=e.sprintf=e.userColors=e.Theme=e.Color=e.Region=e.PaintCanvas=e.Point=e.Size=e.Rect=void 0,Object.defineProperty(e,"Point",{enumerable:!0,get:function(){return s.Point}}),Object.defineProperty(e,"Size",{enumerable:!0,get:function(){return s.Size}}),Object.defineProperty(e,"Rect",{enumerable:!0,get:function(){return s.Rect}}),Object.defineProperty(e,"Color",{enumerable:!0,get:function(){return s.Color}}),Object.defineProperty(e,"sprintf",{enumerable:!0,get:function(){return s.sprintf}}),Object.defineProperty(e,"_tr",{enumerable:!0,get:function(){return s._tr}}),Object.defineProperty(e,"Region",{enumerable:!0,get:function(){return i.Region}}),Object.defineProperty(e,"Theme",{enumerable:!0,get:function(){return o.Theme}}),Object.defineProperty(e,"userColors",{enumerable:!0,get:function(){return o.userColors}}),Object.defineProperty(e,"PaintCanvas",{enumerable:!0,get:function(){return n.PaintCanvas}}),e.isTransp=function(t){return!t||!new s.Color(t).alpha()};let a=Date.now()%1e6;class CElement{extraData;zorder;m_data;m_owner;m_report;m_page;m_selected;m_elname;m_saveStack;constructor(t,e){this.m_owner=e,this.extraData={},this.m_selected=!1,this.m_elname=this.constructor.name.toLocaleLowerCase().substr(1),this.m_data={left:0,top:0,width:0,height:0,type:this.m_elname,uid:++a,...t}}initWithDef(){}savePos(){this.m_saveStack||(this.m_saveStack=[]);const{left:t,top:e,width:s,height:i,visible:o}=this.m_data;this.m_saveStack.push({left:t,top:e,width:s,height:i,visible:o})}restorePos(){const t=this.m_saveStack.pop();this.m_data.left=t.left,this.m_data.top=t.top,this.m_data.width=t.width,this.m_data.height=t.height,this.m_data.visible=t.visible}setOwner(t){this.m_owner!=t&&(this.m_owner&&this.m_owner.removeChild(this),this.m_owner=t,this.m_owner&&this.m_owner.addChild(this))}getReport(){if(!this.m_report){let t=this.m_owner;for(;t&&"report"!=t.getElementName();)t=t.m_owner;this.m_report=t}return this.m_report}getPage(){if(!this.m_page){let t=this.m_owner;for(;t&&"page"!=t.getElementName();)t=t.m_owner;this.m_page=t}return this.m_page}getName(){return this.m_data.name}getUID(){return this.m_data.uid}regenUID(){this.m_data.uid=++a}getElementName(){return this.m_elname}getComputedName(){return this.m_elname}getRect(t=!0){const e=this.m_data,i=new s.Rect(e.left,e.top,e.width,e.height);return t&&i.normalize(),i}getAbsRect(t=!0){const e=this.getRect(t),s=this.getPageOffset(0,0,!1);return e.moveTo(s.x,s.y)}getPageOffset(t,e,s){return this.m_owner?this.m_owner.getPageOffset(this.m_data.left+t,this.m_data.top+e,s):{x:t,y:e}}isLocked(){return this.m_data.locked}isSelectable(){return!0}isVisible(){return this.m_data.visible??!0}size(t,e){const s=this.m_data;s.width==t&&s.height==e||(s.width=t,s.height=e,this.notify("element.refill",{el:this,pos:!0}))}notify(t,e,s){this.getReport().sendNotification(t,e,s)}exitSizeMove(t){const e=this.getRect(!0);this.setOwner(t);const s=t.getRect(),i=this.m_data;i.left=e.left-s.left,i.top=e.top-s.top,i.width=e.width,i.height=e.height,this.dirty(),this.notify("element.refill",{el:this,pos:!0})}enterSizeMove(t){const e=this.getAbsRect(),s=this.m_data;s.left=e.left,s.top=e.top,s.width=e.width,s.height=e.height,this.setOwner(t)}move(t,e){const s=this.m_data;void 0===t&&(t=s.left),void 0===e&&(e=s.top),s.left==t&&s.top==e||(s.left=t,s.top=e,this.notify("element.refill",{el:this,pos:!0}))}removeFromParent(){this.m_owner.removeChild(this),this.notify("element.delete",this)}unitsChanged(t,e){const s=this.m_data;s.left=(0,r.px2u)((0,r.u2px)(s.left,t),e),s.top=(0,r.px2u)((0,r.u2px)(s.top,t),e),s.width=(0,r.px2u)((0,r.u2px)(s.width,t),e),s.height=(0,r.px2u)((0,r.u2px)(s.height,t),e)}save(){this.m_data.type=this.m_elname;return l(this.m_data)}dirty(){this.notify("element.dirty",null,this)}update(t=null){this.notify("element.update",t,this)}getData(t){return this.m_data[t]}setData(t,e){this.m_data[t]=e}renderItem(t,e){}getHandles(t,e){const s=this.getRect(!1).moveTo(0,0).moveBy(t,e);return CElement.makeHandles(s)}static makeHandles(t){const e=[],s=t.left+t.width/2,i=t.top+t.height/2;return e.push({code:"bottom-right",x:t.right,y:t.bottom}),e.push({code:"top-left",x:t.left,y:t.top}),e.push({code:"top-right",x:t.right,y:t.top}),e.push({code:"bottom-left",x:t.left,y:t.bottom}),e.push({code:"top",x:s,y:t.top}),e.push({code:"bottom",x:s,y:t.bottom}),e.push({code:"left",x:t.left,y:i}),e.push({code:"right",x:t.right,y:i}),e}touches(t,e){if(this.isLocked())return!1;const s=this.getAbsRect();return e?t.touches(s):t.contains(s)}touchesPt(t){return this.getAbsRect().contains(t)?this:null}getDescriptor(t=!0,e=!0,i=!0,o=!0){return[{type:"title",text:this.getElementName()},e?{type:"panel",title:s._tr.elements.position,columns:2,style:{height:"8em"},absPos:!0,items:[{type:"num",title:"X",ref:"left",labelWidth:20,style:{position:"absolute",left:20,top:10,width:90}},{type:"num",title:"Y",ref:"top",labelWidth:20,style:{position:"absolute",left:120,top:10,width:90}},{type:"num",title:"W",ref:"width",labelWidth:20,style:{position:"absolute",left:20,top:"calc( 2em + 14px )",width:90}},{type:"num",title:"H",ref:"height",labelWidth:20,style:{position:"absolute",left:120,top:"calc( 2em + 14px )",width:90}}]}:null,i||o?{type:"panel",title:s._tr.elements.links,items:[i?{type:"text",ref:"name",title:s._tr.elements.name,labelWidth:50,validator:t=>{if(""==(t=t.trim()))return"";if(!/^[a-zA-Z_][a-zA-Z0-9_]+$/.test(t))throw s._tr.elements.bad_name;return t}}:null,o?{type:"link",ref:"link",title:s._tr.elements.link,labelWidth:50}:null]}:null,t?{type:"panel",title:s._tr.elements.fill,items:[{type:"color",ref:"bkColor"}]}:null]}sendBack(t){this.m_owner.changeZOrder(this,t)}edit(){}getContextMenu(){return[{text:s._tr.elements.lock,checked:this.m_data.locked,click:()=>this.toggleLock()}]}toggleLock(){this.m_data.locked=!0!==this.m_data.locked,this.notify("element.update",null,this)}toggleVisible(){this.m_data.visible=!0!==(this.m_data.visible??!0),this.notify("element.update",null,this)}enumColors(t){}selectElement(t){this.m_selected=t}buildEditors(){const t=this.getDescriptor();return this.getReport().createEditor(t,this)}fill(t,e){this.getReport().fillProps(t,this.m_data,e)}_set(t,e){const s=this.getReport(),{name:i,value:o}=s.parseProp(t,e);this.__set(i,o)}__set(t,e){let s=this.m_data;const i=t.split("."),o=i.length;if(o>1){for(let t=0;t<o-1;t++){const e=i[t];e in s||(s[e]={}),s=s[e]}s[i[o-1]]=e}else s[t]=e;1==o&&t&&this.notify("element.prop_changed",t,this),this.dirty(),this.update()}}function l(t){const e={};for(let i in t){const o=t[i];if(null!=o)if((0,s.isNumber)(o)){const t=(0,s.roundTo)(o,3);0!=t&&(e[i]=t)}else if((0,s.isString)(o))""!=o&&(e[i]=o);else if((0,s.isArray)(o)){if(0!=o.length){let t=[];o.forEach((e=>{t.push(l(e))})),e[i]=t}}else(0,s.isLiteralObject)(o)?e[i]=l(o):e[i]=o}return e}e.CElement=CElement,e.cleanupData=l,e.rotateAroundPoint=function(t,e,s){return{x:s.x+(t.x-s.x)*Math.cos(e)-(t.y-s.y)*Math.sin(e),y:s.y+(t.x-s.x)*Math.sin(e)+(t.y-s.y)*Math.cos(e)}}})),define("src/elements/line",["require","exports","src/tools/conversion","src/elements/theme","src/elements/element"],(function(t,e,s,i,o){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.lineTouchesRect=e.pointOnLine=e.CLine=void 0;class CLine extends o.CElement{initWithDef(){super.initWithDef(),Object.assign(this.m_data,{line:{width:1,color:"#000"}})}renderItem(t,e){const n=this.m_data,r=this.getRect(!1);let a=n.line?.width,l=n.line?.color;"edit"!=e.mode||!(0,o.isTransp)(l)&&a||(a=(0,s.px2u)(1,t.getUnits()),l=i.Theme.ghost),t.line(r.left,r.top,r.right,r.bottom,a,l)}touchesPt(t){const e=this.getAbsRect(!1);let i=this.m_data,o={x:e.left,y:e.top},r={x:e.left+e.width,y:e.top+e.height},a=(0,s.pt2u)(i.line?.width??0,this.getReport().getUnits())/2;return n(o,r,t,a<1?1:a)?this:null}touches(t,e){return e?r(this.getAbsRect(!1),t):t.contains(this.getAbsRect())}getRect(t){const e=this.m_data;return new o.Rect(e.left,e.top,e.width,e.height)}getHandles(t,e){const s=this.getRect(!1).moveTo(0,0).moveBy(t,e),i=[];return i.push({code:"top-left",x:s.left,y:s.top}),i.push({code:"bottom-right",x:s.right,y:s.bottom}),i}enumColors(t){this.m_data.line?.color&&t.add(this.m_data.line.color)}}function n(t,e,s,i){let o=Math.min(t.x,e.x)-i,n=Math.max(t.x,e.x)+i,r=Math.min(t.y,e.y)-i,a=Math.max(t.y,e.y)+i;return!(s.x>=n||s.x<=o||s.y<=r||s.y>=a)&&(t.x==e.x?!(Math.abs(t.x-s.x)>=i):t.y==e.y?!(Math.abs(t.y-s.y)>=i):Math.abs((e.x-t.x)*(t.y-s.y)-(t.x-s.x)*(e.y-t.y))/Math.sqrt((e.x-t.x)*(e.x-t.x)+(e.y-t.y)*(e.y-t.y))<i)}function r(t,e){let s=t.left,i=t.top,o=t.right,n=t.bottom,r=(e=e.normalized()).left,a=e.top,l=e.right,h=e.bottom;if(s<=r&&o<=r||i<=a&&n<=a||s>=l&&o>=l||i>=h&&n>=h)return!1;var c=(n-i)/(o-s),m=c*(r-s)+i;if(m>a&&m<h)return!0;if((m=c*(l-s)+i)>a&&m<h)return!0;var d=(a-i)/c+s;return d>r&&d<l||(d=(h-i)/c+s)>r&&d<l}e.CLine=CLine,e.pointOnLine=n,e.lineTouchesRect=r})),define("src/elements/shape",["require","exports","src/elements/element","src/elements/theme","src/tools/conversion"],(function(t,e,s,i,o){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.CEllipse=e.CRectangle=e.CShape=void 0;class CShape extends s.CElement{constructor(t,e){super(t,e),this.m_data.line}get shape(){return this.m_data.shape}getDescriptor(){return[...super.getDescriptor(),{type:"panel",title:s._tr.elements.shape.border,items:[[{type:"color",ref:"line.color"},{type:"num",ref:"line.width",step:.1,width:90,min:0,max:100,default:0}]]},{type:"panel",title:s._tr.elements.shape.extra,items:[{type:"num",ref:"percent",width:120,title:s._tr.elements.shape.percent,min:0,max:100,default:0}]}]}enumColors(t){this.m_data.bkColor&&t.add(this.m_data.bkColor),this.m_data.line?.color&&t.add(this.m_data.line.color)}}e.CShape=CShape;e.CRectangle=class CRectangle extends CShape{constructor(t,e){super(t,e)}initWithDef(){super.initWithDef(),Object.assign(this.m_data,{shape:"rectangle",line:{color:"#000",width:1}})}renderItem(t,e){const n=this.m_data,r=this.getRect(!0);n.percent;let a=n.line?.width,l=n.line?.color;"edit"!=e.mode||!(0,s.isTransp)(l)&&a||!(0,s.isTransp)(n.bkColor)||(a=(0,o.px2u)(1,t.getUnits()),l=i.Theme.ghost),this.m_data.name&&t.beginHotSpot(this.m_data.name),t.fillRect(r.left,r.top,r.width,r.height,n.bkColor,n.radius),t.strokeRect(r.left,r.top,r.width,r.height,a,l,n.radius),this.m_data.name&&t.endHotSpot()}};e.CEllipse=class CEllipse extends CShape{constructor(t,e){super(t,e)}initWithDef(){super.initWithDef(),Object.assign(this.m_data,{shape:"ellipse",line:{color:"#000",width:1}})}renderItem(t,e){const n=this.m_data,r=this.getRect(!0),a=n.percent??100;let l=n.line?.width,h=n.line?.color;"edit"!=e.mode||!(0,s.isTransp)(h)&&l||!(0,s.isTransp)(n.bkColor)||(l=(0,o.px2u)(1,t.getUnits()),h=i.Theme.ghost),this.m_data.name&&t.beginHotSpot(this.m_data.name),t.fillEllipse(r.left,r.top,r.width,r.height,n.bkColor,0,360),t.strokeEllipse(r.left,r.top,r.width,r.height,l,h,-90,360*a/100-90),this.m_data.name&&t.endHotSpot()}}})),define("src/elements/group",["require","exports","src/elements/container"],(function(t,e,s){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.CGroup=void 0;class CGroup extends s.CContainer{renderItem(t,e){this.m_data;const s=this.getRect(!0);t.save(),t.clip(s.left,s.top,s.width,s.height),t.translate(s.left,s.top),this.m_children.forEach((s=>{s?.renderItem(t,e)})),t.restore()}}e.CGroup=CGroup})),define("src/elements/_mod",["require","exports","src/elements/element","src/elements/custom","src/elements/image","src/elements/line","src/elements/shape","src/elements/text","src/elements/container","src/elements/group","src/elements/section","src/elements/page","src/elements/theme"],(function(t,s,i,o,n,r,a,l,h,c,m,d,u){"use strict";Object.defineProperty(s,"__esModule",{value:!0}),e(i,s),e(o,s),e(n,s),e(r,s),e(a,s),e(l,s),e(h,s),e(c,s),e(m,s),e(d,s),e(u,s)})),define("src/elements/mark",["require","exports","src/elements/element","src/elements/theme"],(function(t,e,s,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.showLabel=e.paintMarker=e.getMarkOffset=void 0,e.getMarkOffset=function(t,e){return"hmark"==t?e.x:e.y},e.paintMarker=function(t,e,s,o){let n=i.Theme.markers[e];n&&(t.save(),"hmark"==e?(t.beginPath(),t.moveTo(s,0),t.lineTo(s,20),t.strokeStyle=n.label,t.stroke(),t.beginPath(),t.moveTo(s,20),t.lineTo(s,o.height),t.setLineDash([2,2]),t.lineWidth=1,t.strokeStyle=n.line,t.stroke()):(t.beginPath(),t.moveTo(0,s),t.lineTo(20,s),t.strokeStyle=n.label,t.stroke(),t.beginPath(),t.moveTo(20,s),t.lineTo(o.width,s),t.setLineDash([2,2]),t.lineWidth=1,t.strokeStyle=n.line,t.stroke()),t.restore())},e.showLabel=function(t,e,i,o,n,r,a="tl"){let l=t.calcTextSize(e,!0),h=new s.Rect(0,0,l.width,l.height);h.inflate(4,4),h.left=i,h.top=o,a.indexOf("r")>=0?h.left-=h.width:a.indexOf("c")>=0&&(h.left-=h.width/2),a.indexOf("b")>=0?h.top-=h.height:a.indexOf("m")>=0&&(h.top-=h.height/2),t.save(),t.beginPath(),t.rect(h.left,h.top,h.width,h.height),t.fillStyle=n,t.fill(),t.fillStyle=r,t.textAlign="center",t.textBaseline="middle",t.fillText(e,h.left+h.width/2,h.top+h.height/2),t.restore()}})),define("src/tools/make_sample",["require","exports","src/x4mod"],(function(t,e,s){"use strict";function i(t,e){return Math.round(Math.random()*(e-t))+t}function o(t){return"\t".repeat(t)}function n(t){let e="???";switch(t){case"string":e='"'+function(t){let e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",s="";for(let o=0;o<t;o++)s+=e[i(0,e.length-1)];return s}(10)+'"';break;case"number":e=""+i(0,100);break;case"date":e='"'+(0,s.formatIntlDate)(new Date(i(1970,2021),i(1,12),i(1,28)),"Y/M/D")+'"';break;case"boolean":e=Math.random()>=.5?"true":"false";break;case"any":e='"any"'}return e}function r(t,e,i){if("object"==t.type){i.push(o(e)+'"'+t.name+'": {'),t.elements.forEach((t=>{r(t,e+1,i)})),i.push(o(e)+"},")}else if("array"==t.type){if(i.push(o(e)+'"'+t.name+'": ['),(0,s.isString)(t.elements))for(let s=0;s<10;s++)i.push(o(e+1)+n(t.elements)+",");else{let s=t.elements;if("object"==s.type){let t=s.elements;for(let s=0;s<10;s++)i.push(o(e+1)+"{"),t?.forEach((t=>{r(t,e+2,i)})),i.push(o(e+1)+"},")}}i.push(o(e)+"],")}else{const s=n(t.type);i.push(o(e)+'"'+t.name+'": '+s+",")}}Object.defineProperty(e,"__esModule",{value:!0}),e.makeSample=void 0,e.makeSample=function(t){const e=[];return e.push("{"),t.forEach((t=>{r(t,1,e)})),e.push("}"),e.join("\n")}})),define("src/renderers/disp_canvas",["require","exports","src/renderers/base_canvas","src/tools/conversion","x4/drawtext","src/x4mod","src/x4mod","src/elements/theme"],(function(t,e,s,i,o,n,r,a){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.DisplayCanvas=e.PaintCanvas=void 0,Object.defineProperty(e,"PaintCanvas",{enumerable:!0,get:function(){return s.PaintCanvas}});class DisplayCanvas extends s.PaintCanvas{m_source;m_ctx;m_units;m_view;m_org;m_ostack;m_images;m_rsrc;m_waiting;constructor(t){super(t),this.m_images=new Map,this.m_rsrc=[],this.m_units="px",this.m_ostack=[],this.m_view=new s.Rect,this.m_org=new s.Point,this.m_source=new r.EventSource,n.Application.instance().on("message",(t=>{"rsrc-changed"==t.msg&&this.m_images.size&&(this.m_images.clear(),this._changed())}))}onChange(t){this.m_source.on("change",t)}setResources(t){this.m_rsrc=t,this._loadFonts()}_loadFonts(){this.m_rsrc.forEach((t=>{if("font"==t.type){let e=t;new FontFace(e.name,"url("+e.data+")").load().then((e=>{console.log(`font ${t.name} loaded`),document.fonts.add(e),this._changed()})).catch((t=>{console.error(t)}))}}))}setUnits(t){switch(t){case"mm":this.m_unitcvt=i.mm2px,this.m_unitcvt_r=i.px2mm;break;case"in":this.m_unitcvt=i.in2px,this.m_unitcvt_r=i.px2in;break;case"pt":this.m_unitcvt=i.pt2px,this.m_unitcvt_r=i.px2pt;break;case"px":this.m_unitcvt=i.u2u,this.m_unitcvt_r=i.u2u}this.m_units=t}getUnits(){return this.m_units}startDoc(t){this.m_ctx=t.ctx,this.m_view=t.view,this.m_org=new s.Point(0,0),this.m_ostack=[],this.m_waiting=null}async endDoc(t){this.m_waiting&&Promise.all(this.m_waiting),t&&t(null)}startPage(t){}endPage(){}fillRect(t,e,i,o,r,a){if(!r||0==i||0==o)return;const l=new s.Color(r);if(0==l.alpha())return;const h=this.m_unitcvt,c=this.m_ctx;c.fillStyle=l.toHex(),t=h(t),e=h(e),i=h(i),o=h(o),a?(a=(0,n.clamp)(h(a),0,i/2),a=(0,n.clamp)(a,0,o/2),c.beginPath(),c.roundRect(t,e,i,o,a),c.fill()):c.fillRect(t,e,i,o)}strokeRect(t,e,o,r,a,l,h){if(!l||0==o||0==r||!a)return;const c=new s.Color(l);if(0==c.alpha())return;const m=this.m_unitcvt,d=this.m_ctx;d.strokeStyle=c.toHex(),d.lineWidth=(0,i.pt2px)(a),t=m(t),e=m(e),o=m(o),r=m(r),h?(h=(0,n.clamp)(m(h),0,o/2),h=(0,n.clamp)(h,0,r/2),d.beginPath(),d.roundRect(t,e,o,r,h),d.stroke()):d.strokeRect(t,e,o,r)}drawText(t,e,n,r,a,l,h){if(!l||0==n||0==r||!a)return;const c=new s.Color(l);if(0==c.alpha())return;const m=this.m_unitcvt,d=this.m_ctx;let u=new s.Rect(m(t),m(e),m(n),m(r));h.padding&&u.inflate(-(0,i.pt2px)(h.padding)),d.fillStyle=c.toHex(),(0,o.drawText)(d,a,u,{align:h.align,vAlign:h.vAlign,fontSize:(0,i.pt2px)(h.fontSize),fontWeight:h.fontWeight,columns:h.columns??1,columnGap:h.columnGap?(0,i.pt2px)(h.columnGap):0,fontFamily:h.fontFace,lineHeight:h.lineHeight,lineBreak:h.lineBreak,clip:!0,rotation:h.rotation})}measureText(t,e,i){return new s.Size(e,0)}_loadImage(t,e){return new Promise(((s,i)=>{let o=new Image;o.src=e,o.onload=()=>{this.m_images.set(t,o),s()},o.onerror=i}))}line(t,e,o,n,r,a){if(t==o&&e==n||!r||!a)return;const l=new s.Color(a);if(0==l.alpha())return;const h=this.m_unitcvt,c=this.m_ctx;c.beginPath(),c.moveTo(h(t),h(e)),c.lineTo(h(o),h(n)),c.strokeStyle=l.toHex(),c.lineWidth=(0,i.pt2px)(r??1),c.stroke()}drawImage(t,e,i,o,n,r){if(!t||!o||!n)return;const l=this.m_images.get(t);if(!l){if(void 0===l){const e=this.m_rsrc.find((e=>"image"==e.type&&e.name==t));return e?void this._loadImage(t,e.data).then((()=>{this._changed()})).catch((e=>{this.m_images.set(t,null)})):void this.m_images.set(t,null)}if(!l)return}const h=this.m_unitcvt,c=this.m_ctx;e=h(e),i=h(i),o=h(o),n=h(n);const m=(0,s.alignRect)(new s.Rect(0,0,l.width,l.height),new s.Rect(e,i,o,n),r);c.drawImage(l,m.left,m.top,m.width,m.height),m.width==o&&m.height==n||(c.save(),c.strokeStyle=a.Theme.ghost,c.lineWidth=1,c.strokeRect(m.left,m.top,m.width,m.height),c.restore())}save(){this.m_ctx.save(),this.m_ostack.push(this.m_org)}restore(){this.m_ctx.restore(),this.m_org=this.m_ostack.pop()}rotate(t){this.m_ctx.rotate(t/180*Math.PI)}translate(t,e){const s=this.m_unitcvt;this.m_ctx.translate(s(t),s(e)),this.m_org.x+=t,this.m_org.y+=e}clip(t,e,s,i){const o=this.m_unitcvt,n=this.m_ctx;n.rect(o(t),o(e),o(s),o(i)),n.clip()}fillEllipse(t,e,o,n,r,a,l){if(!r||0==o||0==n)return;const h=new s.Color(r);if(0==h.alpha())return;const c=this.m_unitcvt,m=this.m_ctx,d=new s.Rect(c(t),c(e),c(o),c(n)),u=(0,i.deg2rad)(a)-Math.PI/2,p=(0,i.deg2rad)(l)-Math.PI/2;m.beginPath(),m.ellipse(d.left+d.width/2,d.top+d.height/2,d.width/2,d.height/2,0,u,p),m.fillStyle=h.toHex(),m.fill()}strokeEllipse(t,e,o,n,r,a,l,h){if(!a||0==o||0==n||!r)return;const c=new s.Color(a);if(0==c.alpha())return;const m=this.m_unitcvt,d=this.m_ctx,u=new s.Rect(m(t),m(e),m(o),m(n)),p=(0,i.deg2rad)(l)-Math.PI/2,_=(0,i.deg2rad)(h)-Math.PI/2;d.beginPath(),d.ellipse(u.left+u.width/2,u.top+u.height/2,u.width/2,u.height/2,0,p,_),d.lineWidth=(0,i.pt2px)(r),d.strokeStyle=c.toHex(),d.stroke()}fillArc(t,e,o,n,r,a){if(!n||o<=0)return;const l=new s.Color(n);if(0==l.alpha())return;const h=this.m_unitcvt,c=this.m_ctx,m=h(o),d=(0,i.deg2rad)(r)-Math.PI/2,u=(0,i.deg2rad)(a)-Math.PI/2;c.beginPath(),c.arc(h(t),h(e),m,d,u),c.fillStyle=l.toHex(),c.fill()}strokeArc(t,e,o,n,r,a,l){if(!r||!n||n<0||!o||o<0)return;const h=new s.Color(r);if(0==h.alpha())return;const c=this.m_unitcvt,m=this.m_ctx,d=c(o),u=(0,i.deg2rad)(a??0)-Math.PI/2,p=(0,i.deg2rad)(l??360)-Math.PI/2;m.beginPath(),m.arc(c(t),c(e),d,u,p),m.lineWidth=(0,i.pt2px)(n),m.strokeStyle=h.toHex(),m.stroke()}getContext(){return this.m_ctx}_changed(){this.m_source.signal("change",(0,r.EvChange)(null))}isVisible(t){return!!t.touches(this.m_view)}addFont(t,e){throw"not imp"}addImage(t,e){throw"not imp"}drawSVG(t,e,s,i,o,r){const a="svg:"+(0,n.crc32)(t).toString(16),l=this.m_images?.get(a);if(null===l);else if(void 0!==l)this.drawImage(a,e,s,i,o,r);else{const n=this.m_ctx.getTransform();this.m_waiting||(this.m_waiting=[]),this.m_images||(this.m_images=new Map);const l=new Promise(((l,h)=>{const c=new Image;c.onload=()=>{this.m_images.set(a,c),this.m_ctx.save(),this.m_ctx.setTransform(n),this.drawImage(a,e,s,i,o,r),this.m_ctx.restore(),l()},c.onerror=t=>{console.log(t),this.m_images.set(a,null),l()},c.src="data:image/svg+xml;base64,"+Buffer.from(t).toString("base64")}));this.m_waiting.push(l)}}binFonts(){return!0}}e.DisplayCanvas=DisplayCanvas})),define("src/tools/explorer",["require","exports","x4/hosts/electron","src/x4mod","src/tools"],(function(t,e,s,i,o){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.ExplorerBox=void 0;class ExplorerBox extends i.Dialog{static show(t){let e,n,r,a;const l=[...t.report.getResources()],h=()=>l.filter((e=>e.type==t.type)).map((t=>({id:t.name,text:t.name}))),c=e=>{if("image"==t.type){const t=l.find((t=>"image"==t.type&&t.name==e));t&&n.setImage(t?.data)}};"image"==t.type?n=new i.Image({flex:1,cls:"preview",src:null,alignment:"contain",style:{padding:16}}):r=new i.Label({flex:1,cls:"preview",text:"the brown fox jumps over the lazy dog"});let m=new i.Dialog({title:"image"==t.type?"Images":"Fonts",icon:61502,height:"50%",width:"50%",movable:!0,sizable:!0,closable:!0,content:[new i.HLayout({flex:1,content:[e=new i.ListView({width:200,populate:h,selectionChange:t=>{if(t.selection){const e=t.selection;c(e.id),a.enable(!0),m.form.getButton("ok").enable(!0)}else a.enable(!1),m.form.getButton("ok").enable(!1)}}),new i.Separator({orientation:"horizontal",sizing:"before"}),n,r]})],buttons:[new i.Button({text:i._tr.explorer.add,click:"image"==t.type?()=>{(0,o.openFile)({images:["gif","jpg","png","svg"]},(t=>{for(let o of t){const t=s.path.basename(o),n=s.path.extname(o).substr(1);s.fs.readFile(o,((s,o)=>{if(s)i.MessageBox.show(s);else{let s;s="svg"==n?"data:image/svg+xml;base64,"+o.toString("base64"):"data:image/"+n+";base64,"+o.toString("base64");let i={type:"image",name:t,data:s};l.push(i),e.append({id:t,text:t}),e.selection=t,c(t)}}))}}),!0)}:()=>{(0,o.openFile)({fonts:["ttf","otf"]},(t=>{const o=s.path.basename(t[0]),n=s.path.extname(t[0]).substr(1);s.fs.readFile(t[0],((t,a)=>{if(t)i.MessageBox.show(t);else{const t={type:"font",name:s.path.parse(o).name,data:"data:font/"+n+";base64,"+a.toString("base64"),path:null};l.push(t),e.append({id:o,text:o}),e.selection=o,r.setStyleValue("font-family",o)}}))}))}}),a=new i.Button({enabled:!1,text:i._tr.explorer.del,click:()=>(s=>{const i=l.findIndex((e=>e.type==t.type&&e.name==s));i>=0&&(l.splice(i,1),e.items=h())})(e.selection.id)}),new i.Flex({}),"ok","cancel"]});t.callback&&m.on("btnClick",(s=>{"ok"==s.button&&(t.report.setResources(l),t.callback(e.selection?.id))})),m.form.getButton("ok").enable(!1),m.show(!0)}}e.ExplorerBox=ExplorerBox})),define("src/editor/esection",["require","exports","src/elements/element","src/elements/section","src/elements/theme","src/tools/conversion","src/elements/mark"],(function(t,e,s,i,o,n,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.ESection=void 0;class ESection extends i.CSection{renderItem(t,e){const s=this.getReport().getUnits(),i=this.getRect(),a=(0,n.u2px)(i.top,s),l=(0,n.u2px)(i.bottom,s),h=(0,n.u2px)(i.left,s)-7,c=(0,n.u2px)(i.right,s);if("edit"==e.mode){const e=this.m_data.repeat??1;if(e>1){const s=t.getContext();if(s.save(),null==ESection.hatch){const t=document.createElement("canvas"),e=t.getContext("2d");t.width=20,t.height=20,e.fillStyle=o.Theme.sections.header.hollow,e.fillRect(0,0,20,20),e.strokeStyle=o.Theme.ghost,e.beginPath(),e.moveTo(0,t.height),e.lineTo(t.width,0),e.lineWidth=1,e.stroke(),ESection.hatch=s.createPattern(t,"repeat")}s.fillStyle=ESection.hatch;const i=(c-h)/e;s.beginPath();for(let t=h,e=0;t<c;t+=i,e++)s.moveTo(t,a),s.lineTo(t,l),e>0&&s.fillRect(t+2,a+2,i-4,l-a-4);s.strokeStyle=o.Theme.ghost,s.setLineDash([2,2]),s.stroke(),s.restore()}}if(super.renderItem(t,e),"edit"==e.mode){const e=t.getContext();e.save();let s=this.m_selected?o.Theme.selection.label.back:o.Theme.sections.header.back,i=this.m_selected?o.Theme.selection.label.text:o.Theme.sections.header.text,n=this.m_data.name??this.getComputedName();(0,r.showLabel)(e,n,h,a,s,i,"tr"),e.strokeStyle=s,e.beginPath(),e.moveTo(h,a),e.lineTo(h,l-4),e.stroke(),e.strokeStyle=o.Theme.ghost,e.setLineDash([2,2]),e.beginPath(),e.moveTo(h+8,l),e.lineTo(c-4,l),e.stroke(),e.restore()}}getDescriptor(){return[...super.getDescriptor(!1,!1,!0),{type:"panel",title:s._tr.elements.properties,flex:1,items:[{type:"num",ref:"repeat",labelWidth:80,title:s._tr.elements.section.repeat,min:1,max:12},{type:"choice",ref:"break",min:0,max:20,title:s._tr.elements.section.break,labelWidth:80,items:[{id:"",text:s._tr.elements.section.break_none},{id:"before",text:s._tr.elements.section.break_before},{id:"after",text:s._tr.elements.section.break_after}],default:""},{type:"bool",ref:"splittable",text:s._tr.elements.section.split}]}]}static hatch}e.ESection=ESection})),define("src/editor/epage",["require","exports","src/elements/element","src/elements/_mod","src/tools/conversion","src/elements/mark"],(function(t,e,s,i,o,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.EPage=void 0;class EPage extends i.CPage{renderItem(t,e){let r=this.getRect();if(!t.isVisible(r))return;t.startPage(r.size),t.fillRect(r.left,r.top,r.width,r.height,"white",0);let a=this.getMinHeight(),l=0;r.bottom;t.save(),t.translate(r.left,r.top),this.m_children.forEach((s=>{if(s.renderItem(t,e),s instanceof i.CSection){const t=s.getHeight();(s.is("header")||s.is("footer"))&&(l+=t,a-=t)}})),t.restore();const h=t.getContext();h.save();const c=this.getReport().getUnits(),m=(0,o.u2px)(r.left,c),d=(0,o.u2px)(r.right,c),u=this.computePageBreaks().map((t=>(0,o.u2px)(t,c)));h.strokeStyle=s.Theme.ghost,u.forEach(((t,e)=>{h.beginPath(),h.moveTo(m,t),h.lineTo(d,t),h.stroke(),(0,n.showLabel)(h,(0,s.sprintf)(s._tr.elements.page.pageno,e+1),d+4,t,s.Theme.page.header.background,s.Theme.page.header.text,"bl")})),h.restore(),t.endPage()}}e.EPage=EPage})),define("src/editor/eimage",["require","exports","src/tools/conversion","src/elements/element","src/elements/image","src/elements/theme","src/tools/explorer","src/renderers/disp_canvas"],(function(t,e,s,i,o,n,r,a){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.EImage=void 0;class EImage extends o.CImage{renderItem(t){const e=this.m_data,i=this.getRect();e.imageid&&t.drawImage(e.imageid,i.left,i.top,i.width,i.height,e.fit),t instanceof a.DisplayCanvas&&t.strokeRect(i.left,i.top,i.width,i.height,(0,s.px2u)(1,t.getUnits()),n.Theme.ghost,0)}edit(){this._selectImage()}getDescriptor(){return[...super.getDescriptor(!1,!0),{type:"panel",title:"Image",items:[{type:"button",text:i._tr.elements.image.click_to_choose,click:()=>{this._selectImage()}},[{type:"choice",title:i._tr.elements.image.fit,ref:"fit",labelWidth:80,items:[{id:"fill",text:i._tr.elements.image.fill},{id:"cover",text:i._tr.elements.image.cover}],default:"fill"}]]}]}_selectImage(){r.ExplorerBox.show({type:"image",report:this.getReport(),readOnly:!1,callback:t=>{this.__set("imageid",t)}})}}e.EImage=EImage})),define("src/tools/monaco_editor",["require","exports","src/elements/section","src/x4mod","src/elements/text"],(function(t,e,s,i,o){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.ScriptReportEditor=e.MonacoEditor=void 0;class MonacoEditor extends i.Component{m_editor;m_lkChange;constructor(t){super(t),this.m_lkChange=!1,this.setAttributes({"wants-tab":!0,"wants-enter":!0})}componentCreated(){this._checkMonaco()}_checkMonaco(){"monaco"in window?this._monacoReady():setTimeout((()=>this._checkMonaco()),100)}_monacoReady(){monaco.languages.json.jsonDefaults.setDiagnosticsOptions({validate:!1,allowComments:!0,schemaValidation:"ignore",noSemanticValidation:!0,noSyntaxValidation:!1}),monaco.languages.typescript.javascriptDefaults.setCompilerOptions({target:monaco.languages.typescript.ScriptTarget.ES6,noLib:!0,allowNonTsExtensions:!0,allowJs:!0,checkJs:!0});let t=monaco.editor.create(this.dom,{value:this.m_props.source??"",language:this.m_props.language??"javascript",automaticLayout:!0});t.getModel().onDidChangeContent((t=>{this.m_lkChange||this._changed()})),this.m_editor=t}_changed(){this.emit("change",(0,i.EvChange)(this.source))}get source(){return this.m_editor.getValue()}set source(t){this.m_lkChange=!0,this.m_editor.setValue(t??""),this.m_lkChange=!1}insertText(t){this.m_editor&&this.m_editor.executeEdits("",[{range:this.m_editor.getSelection(),text:t}])}focus(){this.m_editor?.focus()}}e.MonacoEditor=MonacoEditor;e.ScriptReportEditor=class ScriptReportEditor extends MonacoEditor{_monacoReady(){super._monacoReady(),this.source=this.m_props.report.getScript(),this.updateCompletions()}set report(t){this.m_props.report=t,this.updateCompletions(),this.source=t.getScript()}_changed(){this.m_props.report.setScript(this.source),super._changed()}_genIndent(t){return"\t\t\t\t\t\t\t\t\t".substr(0,t)}_genElement(t,e){let i=this._genIndent(e),n=[],r=[];return t.forEach((t=>{const a=t.getName();if(a){let l;if(t instanceof s.CSection){l="Section";let[s]=this._genElement(t,e);if(""!=s){l="Section_"+a;let t=`\n${i}class ${l} extends Section {\n${s}\n${i}}`;r.push(t)}}else l="Element",t instanceof o.CText&&(l="TextElement");let h=`${this._genIndent(e+2)}${a}: ${l};`;n.push(h)}}),!1),[n.join("\n"),r.join("\n")]}_genInterface(t,e){let s="";return t.forEach((t=>{s+=this._genDataSource(t,e+1)+"\n"})),s}_genDataSource(t,e,s){let o=this._genIndent(e),n=o+(s??"")+t.name;if(s||(n+=": "),"object"==t.type)n+="{\n",t.elements&&(n+=this._genInterface(t.elements,e+1)),n+=`${o}}\n`;else if("array"==t.type){if(t.elements)if((0,i.isString)(t.elements))n+=t.elements;else{let s=t.elements;n+=" {\n",s&&s.elements&&(n+=this._genInterface(s.elements,e+1)),n+=o+"}"}else n=o+`type __${t.name} = any`;n+="[];"}else switch(t.type){case"string":case"number":case"boolean":n+=t.type;break;case"date":n+="Date";break;default:n+="any"}return n}updateCompletions(){let t=this.m_props.report,e=t.getCurPage(),[s,i]=this._genElement(e,2),o=t.getDataSources();const n=`\n\tdeclare class Element {\n\t}\n\n\tdeclare class TextElement extends Element {\n\t\t/**\n\t\t * text color.\n\t\t * @example 'green'\n\t\t */\n\t\tbkColor: string;\n\n\t\t/**\n\t\t * text color.\n\t\t * @example 'rgba(125,16,18,0.6)'\n\t\t */\n\t\tcolor: string;\n\n\t\t/**\n\t\t * text to display\n\t\t */\n\n\t\ttext: string;\n\t}\n\n\tdeclare class Section extends Element {\n\t\t/**\n\t\t * return the item with given name or null\n\t\t */\n\n\t\titem( name: string ): Element;\n\n\t\t/**\n\t\t * print the section\n\t\t */\n\n\t\tprint( ): void;\n\n\t\t/**\n\t\t *\n\t\t */\n\n\t\titems: Record<string,Element>;\n\t}\n\n${i}\n\n\tdeclare class Report {\n\t\tsections: { \n${s}\n\t\t}\n\n\t\t/**\n\t\t * disable automatic mode\n\t\t * \n\t\t * call this prior to handle by hand section printing\n\t\t */\n\n\t\tdisableAutoMode( );\n\n\t\t/**\n\t\t * start printing\n\t\t */\n\n\t\tbegin( ): void;\n\n\t\t/**\n\t\t * print the given section\n\t\t * \n\t\t * you can also use Section.print\n\t\t */\n\n\t\tprint( section: string | Section ): void;\n\n\t\t/**\n\t\t * close the current page and start a new one if the requiredSpace \n\t\t * set requiredSpace to 0 to force next page\n\t\t */\n\n\t\tnextPage( requiredSpace: number  ): void;\n\n\t\t/**\n\t\t * stop printing.\n\t\t * elements with retro actions (like pagecount) are updated\n\t\t */\n\n\t\tend( ): void;\n\n\t\t/**\n\t\t * custom translation function\n\t\t * @example\n\t\t * // you can change the behavour by setting a new function\n\t\t * report.translate = ( x ) => {\n\t\t * \treturn "my_transalted_text:"+x;\n\t\t * }\n\t\t */\n\n\t\ttranslate( x: string ): string;\n\t}\n\n${o.map((t=>this._genDataSource(t,1,"interface __"))).join("\n")}\n\n\tinterface Data {\n${o.map((t=>`\t\t\t${t.name}: _.__${t.name};`)).join("\n")}\n\t}\n\n\tdeclare function log( ...args );\n\tdeclare const data: Data;\n\tdeclare const report: Report;\t\t\n`;monaco.languages.typescript.javascriptDefaults.addExtraLib(n,"ts:filename/report.d.ts")}}})),define("src/tools/text_edit",["require","exports","src/x4mod","src/tools/monaco_editor"],(function(t,e,s,i){"use strict";function o(t,e){let i,o,n=new s.Dialog({title:s._tr.textedit.field_sel,cls:"field-chooser",sizable:!0,movable:!0,closable:!0,icon:"resources/img/edit.svg",width:"500",height:"520",content:[i=new s.TreeView({root:null,flex:1,sort:!1,selectionchange:t=>{const e=t.selection;o.text=s.html`<b>${e.data}</b>: ${e.id}`},dblclick:t=>{e(i.selection),n.close()}}),o=new s.Label({text:""})],buttons:["ok","cancel"],btnClick:t=>{"ok"==t.button&&e(i.selection)}}),r=t=>{switch(t){case"string":return"resources/img/input-text.svg";case"number":return"resources/img/input-numeric.svg";case"date":return"resources/img/calendar.svg";case"any":case"object":return"resources/img/object.svg";case"array":return"resources/img/array.svg"}},a=(t,e)=>{let i=e;i.length&&(i+="."),i+=t.name,"array"==t.type&&(i+="[x]");let o,n=t.description??" ",l="";if("object"==t.type){if(o=[],t.elements){t.elements.forEach((t=>{o.push(a(t,i))}))}l="object"}else if("array"==t.type)if(l="array",(0,s.isString)(t.elements))l=t.elements+"[]";else{let e=t.elements;if(e&&"object"==e.type){l=e.name+"[]";let t=e.elements;o=[],t?.forEach((t=>{o.push(a(t,i))}))}}else l=t.type;return{id:i,text:s.html`<b>${t.name}</b> ${n}`,icon:r(t.type),data:l,children:o,open:!!o,cls:""==e?"main":void 0}},l=[];for(const e of t)l.push(a(e,""));i.root={id:1,text:"",children:l},n.show()}Object.defineProperty(e,"__esModule",{value:!0}),e.selectField=e.showTextEditor=e.showScriptEditor=void 0,e.showScriptEditor=function(t,e,n){let r,a=n.getDataSources(),l=a?new s.Button({text:s._tr.textedit.field,tooltip:s._tr.textedit.field_tip,click:()=>{o(a,(t=>{r.insertText(t),r.focus()}))}}):void 0;new s.Dialog({title:s._tr.textedit.script,sizable:!0,movable:!0,closable:!0,width:"75%",height:"75%",content:[r=new i.MonacoEditor({ref:"scriptVal",flex:1,cls:"line",language:"javascript",report:n})],buttons:[l,new s.Flex,"ok","cancel"],btnClick:t=>{"ok"==t.button&&e(r.source)}}).show()},e.showTextEditor=function(t,e,i){let n,r=new s.Button({text:s._tr.textedit.icon,tooltip:s._tr.textedit.icon_tip,click:()=>{s.PromptDialogBox.show(s._tr.textedit.prompt,(t=>{let e=parseInt(t,16);isNaN(e)||n.insertText(String.fromCharCode(e))}))}}),a=i?new s.Button({text:s._tr.textedit.field,tooltip:s._tr.textedit.field_tip,click:()=>{o(i,(t=>{n.insertText("${"+t+"}")}))}}):void 0;new s.Dialog({title:s._tr.textedit.title,sizable:!0,movable:!0,closable:!0,icon:"resources/img/btn-text.svg",width:"50%",height:"75%",content:[n=new s.TextArea({text:t,flex:1})],buttons:[r,a,new s.Flex,"ok","cancel"],btnClick:t=>{"ok"==t.button&&e(n.value)}}).show()},e.selectField=o})),define("src/editor/etext",["require","exports","src/elements/element","src/elements/text","src/tools/text_edit"],(function(t,e,s,i,o){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.EText=void 0;class EText extends i.CText{getDescriptor(){let t=super.getDescriptor();const e=this.getReport();return[...t,{type:"panel",title:s._tr.elements.text.border,items:[[{type:"color",ref:"border.color"},{type:"num",ref:"border.width",width:90,default:1,min:0,max:100,step:.1}],{type:"num",ref:"radius",title:s._tr.elements.text.radius,labelWidth:74,width:90,min:0,max:10,step:.1}]},{type:"panel",title:s._tr.elements.text.font,items:[{type:"choice",ref:"font.family",items:e.enumFontNames(),default:"<page>"},[{type:"choice",ref:"font.weight",items:[{id:"light",text:"light"},{id:"normal",text:"normal"},{id:"bold",text:"bold"}],default:"normal"},{type:"num",ref:"font.size",width:90,min:6,max:100,default:"12"}],{type:"color",ref:"color"}]},{type:"panel",title:s._tr.elements.text.alignment,items:[[{type:"choice",ref:"align",cls:"col",items:[{id:"left",text:"left"},{id:"center",text:"center"},{id:"right",text:"right"},{id:"justify",text:"justify"}],default:"left"},{type:"choice",ref:"vAlign",items:[{id:"top",text:"top"},{id:"middle",text:"middle"},{id:"bottom",text:"bottom"}],default:"top"}]]},{type:"panel",title:s._tr.elements.text.spacing,items:[[{type:"num",ref:"lineHeight",title:s._tr.elements.text.lineheight,min:0,max:3,step:.1,default:1.3},{type:"num",ref:"padding",min:0,max:20,title:s._tr.elements.text.padding,step:.1,default:0}]]},{type:"panel",title:s._tr.elements.text.rotation,items:[[{type:"num",ref:"rotation",title:s._tr.elements.text.rotation2,min:-360,max:360,step:10,default:0}]]},{type:"panel",title:s._tr.elements.text.text,flex:1,items:[{type:"textarea",ref:"text",flex:1},{type:"bool",ref:"autoGrow",cls:"slider",text:s._tr.elements.text.autogrow},{type:"bool",ref:"noWordWrap",cls:"slider",text:s._tr.elements.text.nowwrap}]}]}edit(){const t=this.getReport().getDataSources();(0,o.showTextEditor)(this.m_data.text,(t=>{this.__set("text",t),this.notify("element.refill",{el:this,pos:!1})}),t)}enumColors(t){this.m_data.bkColor&&t.add(this.m_data.bkColor),this.m_data.color&&t.add(this.m_data.color)}}e.EText=EText})),define("src/editor/ecustom",["require","exports","src/elements/element","src/elements/custom"],(function(t,e,s,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.ECustom=void 0;class ECustom extends i.CCustom{save(){let t=super.save();return delete t.plugin,t}_solver(t,e){}getDescriptor(t,e,i){let o=super.getDescriptor(!1,!0,!0),n=this.m_data.plugin?.properties,r=[];n.forEach((t=>{switch(t.type){case"text":r.push([{type:"text",title:t.title??t.name,ref:"data."+t.name,labelWidth:t.labelWidth??70}]);break;case"num":r.push([{type:"num",title:t.title??t.name,ref:"data."+t.name,labelWidth:t.labelWidth??70}]);break;case"bool":r.push([{type:"bool",title:t.title??t.name,ref:"data."+t.name,labelWidth:t.labelWidth??70}]);break;case"link":r.push([{type:"link",title:t.title??t.name,ref:"data."+t.name,labelWidth:t.labelWidth??70}]);break;case"color":r.push([{type:"color",title:t.title??t.name,ref:"data."+t.name,default:t.default?new s.Color(t.default):s.Color.NONE,labelWidth:t.labelWidth??70}]);break;case"choice":r.push([{type:"choice",title:t.title??t.name,ref:"data."+t.name,default:t.default,labelWidth:t.labelWidth??70,items:t.items}])}}));const a=this.getReport(),l=[{type:"panel",title:s._tr.elements.text.font,items:[{type:"choice",ref:"defaults.font.family",items:a.enumFontNames(),default:"<page>"},[{type:"choice",ref:"defaults.font.weight",items:[{id:"light",text:"light"},{id:"normal",text:"normal"},{id:"bold",text:"bold"}],default:"normal"},{type:"num",ref:"defaults.font.size",width:90,min:6,max:100,default:"12"}],{type:"color",ref:"defaults.color"}]}];return[...o,{type:"panel",title:s._tr.elements.properties,items:r},...l]}}e.ECustom=ECustom})),define("src/editor/eline",["require","exports","src/elements/element","src/elements/line"],(function(t,e,s,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.ELine=void 0;class ELine extends i.CLine{getDescriptor(){return[...super.getDescriptor(!1,!0,!1,!1),{type:"panel",title:s._tr.elements.line.title,items:[[{type:"color",ref:"line.color"},{type:"num",ref:"line.width",width:50,min:0,max:100,step:.1}],{type:"choice",title:s._tr.elements.line.caps,ref:"cap",items:[{id:"round",text:s._tr.elements.line.round},{id:"square",text:s._tr.elements.line.square},{id:"butt",text:s._tr.elements.line.butt}]}]}]}}e.ELine=ELine})),define("src/editor/ereport",["require","exports","src/elements/_mod","src/elements/report","src/elements/mark","src/tools/explorer","src/editor/esection","src/editor/epage","src/editor/eimage","src/editor/etext","src/editor/ecustom","src/editor/eline","src/x4mod","src/tools/text_edit"],(function(t,e,s,i,o,n,r,a,l,h,c,m,d,u){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.EReport=void 0;class EReport extends i.CReport{m_org;m_scale;m_curPage;constructor(t){super(t={version:"1.0.0",grid_on:!0,grid_size:1,units:"mm",paging_type:"page",script:null,rsrc:[],children:[{type:"page",size:{size:"A4"},orientation:"portrait",children:[{type:"section",kind:"body"}]}],...t}),this.m_org=new s.Point(10,10),this.m_scale=100,this.m_curPage=this.m_children[0]}addMark(t,e){let s=this.m_data,i=(0,o.getMarkOffset)(t,e);if(s.markers){if(s.markers.find((e=>e.type==t&&e.pos==i)))return}else s.markers=[];s.markers.push({type:t,pos:i})}delMark(t){let e=this.m_data;if(!e.markers)return;let s=e.markers.findIndex((e=>e===t));s>=0&&e.markers.splice(s,1),0==e.markers.length&&delete e.markers}getMarks(){return this.m_data.markers}renderItem(t,e){const s=t,i=s.getContext(),o={mode:"edit",getFont:t=>this.getFont(t),getImage:t=>this.getImage(t)};i.save(),i.translate(this.m_org.x,this.m_org.y),i.scale(this.m_scale/100,this.m_scale/100),super.renderItem(s,o),i.restore()}save(){return super.save()}incScale(t){this.setScale(this.m_scale+t)}setOrg(t,e){this.m_org={x:t,y:e}}getOrg(){return this.m_org}scroll(t,e){this.m_org.x+=t,this.m_org.y+=e}setScale(t){t<10?t=10:t>400&&(t=400),this.m_scale=t}getScale(){return this.m_scale}select(t,e=!1){let s=[];const i=this.m_curPage,o=i.getChildren(!1,!0,!1),n=i.getRect(!0),r=t.movedBy(-n.left,-n.top);return o.forEach((t=>{t.touches(r,e)&&s.push(t)})),s}touchesPt(t){return this.m_curPage.touchesPt(t)??this}getFullRect(){return this.m_curPage.getRect()}getScript(){return this.m_data.script}setScript(t){this.m_data.script=t,this.dirty()}getCurPage(){return this.m_curPage}getSections(){return this.m_curPage.getChildren(!1,!1)}getDescriptor(){return[...super.getDescriptor(!1,!1,!1,!1),{type:"panel",title:s._tr.elements.report.grid,items:[[{type:"bool",ref:"grid_on",width:110,text:"on/off"},{type:"num",ref:"grid_size",label:s._tr.elements.report.grid_size,text:"size"}]]},{type:"panel",title:s._tr.elements.defaults,items:[[{type:"choice",title:s._tr.elements.report.units,ref:"units",labelWidth:80,items:[{id:"mm",text:"millimeters"},{id:"in",text:"inches"},{id:"px",text:"pixels"}]}],[{type:"choice",ref:"font",title:s._tr.elements.report.font_name,labelWidth:80,items:this.enumFontNames(!1,!1),default:"arial"}]]},{type:"panel",title:s._tr.elements.report.resources,items:[{type:"button",text:s._tr.elements.report.images,click:()=>{this._manageImages()}},{type:"button",text:s._tr.elements.report.fonts,click:()=>{this._manageFonts()}}]}]}_manageImages(){n.ExplorerBox.show({type:"image",report:this,readOnly:!1,callback:()=>{this.dirty()}})}_manageFonts(){n.ExplorerBox.show({type:"font",report:this,readOnly:!1,callback:()=>{this.dirty()}})}elementFactory(t,e){let i;switch(t.type){case"custom":i=new c.ECustom(t,e);break;case"group":i=new s.CGroup(t,e);break;case"image":i=new l.EImage(t,e);break;case"line":i=new m.ELine(t,e);break;case"page":i=new a.EPage(t,e);break;case"rectangle":i=new s.CRectangle(t,e);break;case"ellipse":i=new s.CEllipse(t,e);break;case"text":i=new h.EText(t,e);break;case"section":i=new r.ESection(t,e);break;default:return console.error(`Unknown element type: ${name}`),null}return i.notify("element.created",i),i}sendNotification(t,e,s){d.Application.instance().signal("message",(0,d.EvMessage)(t,e,s),0)}fillProps(t,e,s){const i={left:"element.move",top:"element.move",width:"element.size",height:"element.size"},o=(e,n)=>{for(let r in e){const a=n?n+"."+r:r;if("object"==typeof e[r])o(e[r],a);else{let o=t.itemWithRef(a);if(o){if(s&&!n&&!(r in i))return;let t=e[r];o instanceof d.ColorPickerEditor?o.value=t?new d.Color(t):d.Color.NONE:o instanceof d.CheckBox?o.check=t:o instanceof d.TextEdit&&"number"==o.type?o.value=""+(0,d.roundTo)(t,2):(null===t&&(t=""),o.value=""+t)}}}};o(e,null)}createEditor(t,e){let s=[];return t.forEach((t=>{t&&s.push(this._createSingleEditor(t,e))})),s}parseProp(t,e){if(t instanceof d.ColorPickerEditor){let t=e.toString();s.userColors.add(t),e=t}else t instanceof d.TextEdit&&"number"==t.type?(e=parseFloat(e),isNaN(e)&&(e=void 0)):t instanceof d.CheckBox&&(e=!!e);return{name:t.ref,value:e}}_createSingleEditor(t,e){const i=t.width>0?t.width:void 0;if((0,d.isArray)(t)){const s=t.some((t=>t.flex));return new d.HLayout({cls:"@hflex",flex:s?1:void 0,content:this.createEditor(t,e)})}switch(t.type){case"title":return new d.Label({cls:"title",text:t.text});case"link":{const s=new d.TextEdit({cls:"@hflex",label:t.title,ref:t.ref,width:i,labelWidth:t.labelWidth,style:t.style,data:{target:e,el:t},validator:t.validator,readOnly:!0,gadgets:[new d.Button({icon:"resources/img/scroll-light.svg",click:()=>{(0,u.selectField)(this.getDataSources(),(t=>{p(s,t),s.value=t}))}})]});return s}case"panel":{let s=[];return t.items.forEach((i=>{if(null!==i)if((0,d.isArray)(i)){const t=i.some((t=>t.flex)),o=new d.HLayout({cls:"@hflex",flex:t?1:void 0,content:this.createEditor(i,e)});s.push(o)}else if(t.absPos)s.push(this._createSingleEditor(i,e));else{const t=new d.HLayout({cls:"@hflex",flex:i.flex?1:void 0,content:this._createSingleEditor(i,e)});s.push(t)}})),new d.Panel({title:t.title,style:t.style,data:t.data,cls:t.cls,flex:t.flex,content:s})}case"num":{const s={};return t.step&&(s.step=t.step),new d.TextEdit({cls:void 0===t.width?"@hflex":"",label:t.title,ref:t.ref,labelWidth:t.labelWidth,value:t.default,min:t.min,max:t.max,type:"number",data:{target:e,el:t},attrs:s,style:t.style,focus:t=>{t.focus&&t.source.selectAll()},change:_})}case"text":return new d.TextEdit({cls:"@hflex",label:t.title,ref:t.ref,width:i,labelWidth:t.labelWidth,style:t.style,data:{target:e,el:t},validator:t.validator,change:_});case"textarea":return new d.TextArea({cls:"@hflex",ref:t.ref,style:t.style,data:{target:e,el:t},change:_});case"color":return new d.ColorPickerEditor({ref:t.ref,cls:"@hflex",hasAlpha:!0,color:t.default??d.Color.NONE,cust_colors:s.userColors.values(),label:t.title,labelWidth:t.labelWidth,width:i,data:{target:e,el:t},change:_});case"bool":return new d.CheckBox({text:t.text,ref:t.ref,width:i,cls:void 0===t.width?"@hflex slider":"slider",data:{target:e,el:t},change:_});case"choice":return new d.ComboBox({ref:t.ref,cls:"@hflex",label:t.title,value:t.default,labelWidth:t.labelWidth,items:t.items,data:{target:e,el:t},selectionChange:t=>{const e=t.source;p(e,e.value)}});case"button":return new d.Button({ref:t.ref,cls:"@hflex",text:t.text,click:t.click,data:{target:e,el:t}})}return console.error("error"),null}}function p(t,e){let s=t.getData("xtarget")??t.getData("target");console.assert(!!s),s._set(t,e)}function _(t){p(t.source,t.value)}e.EReport=EReport})),define("src/renderer/rreport",["require","exports","src/elements/report","src/elements/_mod"],(function(t,e,s,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.RReport=void 0;class RReport extends s.CReport{async renderItem(t,e){let s=[];this.m_data.rsrc?.forEach((e=>{if("font"==e.type){const i=e;if(t.binFonts()){let e=i.data,o=i.data.indexOf("base64,");o>=0&&(e=i.data.substr(o+7));const n=Buffer.from(e,"base64");s.push(t.addFont(i.name,n))}else s.push(t.addFont(i.name,i.data))}else if("image"==e.type){const i=e;s.push(t.addImage(i.name,i.data))}})),await Promise.all(s);const i={mode:"execute",getImage:t=>this.getImage(t),getFont:t=>this.getFont(t),printInfo:{rootData:{...e.printInfo?.rootData,...this.prepareRootData()},errors:[]}};super.renderItem(t,i),i.printInfo.errors&&i.printInfo.errors.length&&console.log(i.printInfo.errors)}prepareRootData(){return{document:{pagenum:0,pagecount:0,name:"<name>"},system:{today:new Date}}}elementFactory(t,e){let s;switch(t.type){case"custom":s=new i.CCustom(t,e);break;case"group":s=new i.CGroup(t,e);break;case"image":s=new i.CImage(t,e);break;case"line":s=new i.CLine(t,e);break;case"page":s=new i.CPage(t,e);break;case"rectangle":s=new i.CRectangle(t,e);break;case"ellipse":s=new i.CEllipse(t,e);break;case"text":s=new i.CText(t,e);break;case"section":s=new i.CSection(t,e);break;default:return console.error(`Unknown element type: ${t.type}`),null}return s}sendNotification(t,e,s){}parseProp(t,e){return null}fillProps(t,e,s){}createEditor(t,e){}}e.RReport=RReport})),define("src/tools/xml",["require","exports"],(function(t,e){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.parseXML=void 0;const s={quot:34,amp:38,lt:60,gt:62,apos:39,OElig:338,oelig:339,Scaron:352,scaron:353,Yuml:376,circ:710,tilde:732,ensp:8194,emsp:8195,thinsp:8201,zwnj:8204,zwj:8205,lrm:8206,rlm:8207,ndash:8211,mdash:8212,lsquo:8216,rsquo:8217,sbquo:8218,ldquo:8220,rdquo:8221,bdquo:8222,dagger:8224,Dagger:8225,permil:8240,lsaquo:8249,rsaquo:8250,euro:8364,nbsp:160,iexcl:161,cent:162,pound:163,curren:164,yen:165,brvbar:166,sect:167,uml:168,copy:169,ordf:170,laquo:171,not:172,shy:173,reg:174,macr:175,deg:176,plusmn:177,sup2:178,sup3:179,acute:180,micro:181,para:182,middot:183,cedil:184,sup1:185,ordm:186,raquo:187,frac14:188,frac12:189,frac34:190,iquest:191,Agrave:192,Aacute:193,Acirc:194,Atilde:195,Auml:196,Aring:197,AElig:198,Ccedil:199,Egrave:200,Eacute:201,Ecirc:202,Euml:203,Igrave:204,Iacute:205,Icirc:206,Iuml:207,ETH:208,Ntilde:209,Ograve:210,Oacute:211,Ocirc:212,Otilde:213,Ouml:214,times:215,Oslash:216,Ugrave:217,Uacute:218,Ucirc:219,Uuml:220,Yacute:221,THORN:222,szlig:223,agrave:224,aacute:225,acirc:226,atilde:227,auml:228,aring:229,aelig:230,ccedil:231,egrave:232,eacute:233,ecirc:234,euml:235,igrave:236,iacute:237,icirc:238,iuml:239,eth:240,ntilde:241,ograve:242,oacute:243,ocirc:244,otilde:245,ouml:246,divide:247,oslash:248,ugrave:249,uacute:250,ucirc:251,uuml:252,yacute:253,thorn:254,yuml:255,fnof:402,Alpha:913,Beta:914,Gamma:915,Delta:916,Epsilon:917,Zeta:918,Eta:919,Theta:920,Iota:921,Kappa:922,Lambda:923,Mu:924,Nu:925,Xi:926,Omicron:927,Pi:928,Rho:929,Sigma:931,Tau:932,Upsilon:933,Phi:934,Chi:935,Psi:936,Omega:937,alpha:945,beta:946,gamma:947,delta:948,epsilon:949,zeta:950,eta:951,theta:952,iota:953,kappa:954,lambda:955,mu:956,nu:957,xi:958,omicron:959,pi:960,rho:961,sigmaf:962,sigma:963,tau:964,upsilon:965,phi:966,chi:967,psi:968,omega:969,thetasym:977,upsih:978,piv:982,bull:8226,hellip:8230,prime:8242,Prime:8243,oline:8254,frasl:8260,weierp:8472,image:8465,real:8476,trade:8482,alefsym:8501,larr:8592,uarr:8593,rarr:8594,darr:8595,harr:8596,crarr:8629,lArr:8656,uArr:8657,rArr:8658,dArr:8659,hArr:8660,forall:8704,part:8706,exist:8707,empty:8709,nabla:8711,isin:8712,notin:8713,ni:8715,prod:8719,sum:8721,minus:8722,lowast:8727,radic:8730,prop:8733,infin:8734,ang:8736,and:8743,or:8744,cap:8745,cup:8746,int:8747,there4:8756,sim:8764,cong:8773,asymp:8776,ne:8800,equiv:8801,le:8804,ge:8805,sub:8834,sup:8835,nsub:8836,sube:8838,supe:8839,oplus:8853,otimes:8855,perp:8869,sdot:8901,lceil:8968,rceil:8969,lfloor:8970,rfloor:8971,lang:9001,rang:9002,loz:9674,spades:9824,clubs:9827,hearts:9829,diams:9830};class XmlNode{error;nodeValue;nodeType;nodeName;attributes;childNodes;parentNode;id;textContent;classList;constructor(t,e,s,i){this.error=i,this.nodeName=t,this.nodeValue=s,this.nodeType=e,this.attributes={},this.childNodes=[],this.parentNode=null,this.id="",this.textContent="",this.classList=[]}getAttribute(t){return this.attributes[t]??null}getElementById(t){return this.forEach((e=>{if(e.id===t)return e}))}getElementsByTagName(t){let e=[];return this.forEach((s=>{s.nodeName===t&&e.push(s)})),e}forEach(t){const e=s=>{if(1===s.nodeType){let i=t(s);if(i)return i;for(let t=0;t<s.childNodes.length;t++)if(i=e(s.childNodes[t]),i)return i}};e(this)}}e.parseXML=function(t,e){let s,o,n=new StringParser(t.trim()),r=!1;e||(e=console.log);let a=()=>{let t,s;if(t=n.match(/^<([\w:.-]+)\s*/,!0)){let o=new XmlNode(t[1],1,null,r);for(;t=n.match(/^([\w:.-]+)(?:\s*=\s*"([^"]*)"|\s*=\s*'([^']*)')?\s*/,!0);){let s=t[1],n=i(t[2]||t[3]||"");o.attributes[s]?(e('parseXml: duplicate attribute "'+s+'"'),r=!0):(o.attributes[s]=n,"id"===s&&(o.id=n),"class"===s&&(o.classList=n.split(" ")))}if(n.match(/^>/)){for(;s=a();)o.childNodes.push(s),s.parentNode=o,o.textContent+=3===s.nodeType||4===s.nodeType?s.nodeValue:s.textContent;return(t=n.match(/^<\/([\w:.-]+)\s*>/,!0))?(t[1]===o.nodeName||(e('parseXml: tag not matching, opening "'+o.nodeName+'" & closing "'+t[1]+'"'),r=!0),o):(e('parseXml: tag not matching, opening "'+o.nodeName+'" & not closing'),r=!0,o)}if(n.match(/^\/>/))return o;e('parseXml: tag could not be parsed "'+o.nodeName+'"'),r=!0}else{if(t=n.match(/^<!--[\s\S]*?-->/))return new XmlNode(null,8,t,r);if(t=n.match(/^<\?[\s\S]*?\?>/))return new XmlNode(null,7,t,r);if(t=n.match(/^<!DOCTYPE\s*([\s\S]*?)>/))return new XmlNode(null,10,t,r);if(t=n.match(/^<!\[CDATA\[([\s\S]*?)\]\]>/,!0))return new XmlNode("#cdata-section",4,t[1],r);if(t=n.match(/^([^<]+)/,!0))return new XmlNode("#text",3,i(t[1]),r)}};for(;o=a();)1!==o.nodeType||s?(1===o.nodeType||3===o.nodeType&&""!==o.nodeValue.trim())&&e("parseXml: data after document end has been discarded"):s=o;return n.matchAll()&&e("parseXml: parsing error"),s};class StringParser{str;constructor(t){this.str=t}match(t,e=!1){let s=this.str.match(t);if(s&&0===s.index)return this.str=this.str.substring(s[0].length),e?s:s[0]}matchSeparator(){return this.match(/^(?:\s*,\s*|\s*|)/)}matchSpace(){return this.match(/^(?:\s*)/)}matchLengthUnit(){return this.match(/^(?:px|pt|cm|mm|in|pc|em|ex|%|)/)}matchNumber(){return this.match(/^(?:[-+]?(?:[0-9]+[.][0-9]+|[0-9]+[.]|[.][0-9]+|[0-9]+)(?:[eE][-+]?[0-9]+)?)/)}matchAll(){return this.match(/^[\s\S]+/)}}function i(t){return t.replace(/&(?:#([0-9]+)|#[xX]([0-9A-Fa-f]+)|([0-9A-Za-z]+));/g,(function(t,e,i,o){return e?String.fromCharCode(parseInt(e,10)):i?String.fromCharCode(parseInt(i,16)):o&&s[o]?String.fromCharCode(s[o]):t}))}})),define("src/renderers/pdf_canvas",["require","exports","src/renderers/base_canvas","src/tools/conversion","lib","src/tools/xml"],(function(t,e,s,i,o,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.drawText=e.PDFCanvas=void 0;const r=o.host.require("svg-to-pdfkit"),{Writable:a}=o.host.require("stream");class PDFCanvas extends s.PaintCanvas{m_doc;m_stream;m_images;m_units;constructor(t){super(t),this.m_images=new Map,this.m_units="pt"}setUnits(t){switch(t){case"mm":this.m_unitcvt=i.mm2pt,this.m_unitcvt_r=i.pt2mm;break;case"in":this.m_unitcvt=i.in2pt,this.m_unitcvt_r=i.pt2in;break;case"px":this.m_unitcvt=i.px2pt,this.m_unitcvt_r=i.pt2px;break;case"pt":this.m_unitcvt=i.u2u,this.m_unitcvt_r=i.u2u}this.m_units=t}getUnits(){return this.m_units}startDoc(){const t=o.host.require("fs"),e=o.host.require("pdfkit");let s=this.m_options.output;this.m_doc=new e({autoFirstPage:!1}),this.m_stream=s?t.createWriteStream(s,{encoding:"binary"}):new BlobStream,this.m_doc.pipe(this.m_stream)}endDoc(t){this.m_doc&&(this.m_stream.on("finish",(()=>{let e=this.m_options.output;e||(e=this.m_stream.buffer()),t&&t(e),this.m_stream=null})),this.m_doc.end(),this.m_doc=null)}startPage(t){let e;e="custom"==t.size?{size:[(0,i.mm2pt)(t.width),(0,i.mm2pt)(t.height)]}:{size:t.size},e.margins={top:0,bottom:0,left:0,right:0},this.m_doc.addPage(e)}endPage(){}fillRect(t,e,i,o,n,r){if(!n||0==i||0==o)return;const a=new s.Color(n);if(0==a.alpha())return;const l=this.m_unitcvt;r?this.m_doc.roundedRect(l(t),l(e),l(i),l(o),l(r)):this.m_doc.rect(l(t),l(e),l(i),l(o)),this.m_doc.fillOpacity(a.alpha()).fillColor(a.toHex(!1)).fill("non-zero")}strokeRect(t,e,i,o,n,r,a){if(!r||0==i||0==o||!n)return;const l=new s.Color(r);if(0==l.alpha())return;const h=this.m_unitcvt;a?this.m_doc.roundedRect(h(t),h(e),h(i),h(o),h(a)):this.m_doc.rect(h(t),h(e),h(i),h(o)),this.m_doc.strokeOpacity(l.alpha()).strokeColor(l.toHex(!1)).lineWidth(n).stroke()}drawText(t,e,i,o,n,r,a){if(!r||0==i||0==o||!n)return;const l=new s.Color(r);if(0==l.alpha())return;const c=this.m_unitcvt;let m=new s.Rect(c(t),c(e),c(i),c(o));if("sans-serif"==a.fontFace)this.m_doc.font("Helvetica");else if("monospace"==a.fontFace)this.m_doc.font("Courier");else try{this.m_doc.font(a.fontFace)}catch(t){console.warn("font not found: "+a.fontFace)}this.m_doc.fontSize(a.fontSize),this.m_doc.fillColor(l.toHex(!1)),h(this.m_doc,n,m,{align:a.align,vAlign:a.vAlign,fontSize:a.fontSize,fontWeight:a.fontWeight,columns:a.columns??1,columnGap:a.columnGap?a.columnGap:0,fontFamily:a.fontFace,lineHeight:a.lineHeight,lineBreak:a.lineBreak,clip:!0,rotation:a.rotation})}measureText(t,e,o){const n=(0,i.pt2px)(o.padding);if("sans-serif"==o.fontFace)this.m_doc.font("Helvetica");else if("monospace"==o.fontFace)this.m_doc.font("Courier");else try{this.m_doc.font(o.fontFace)}catch(t){console.warn("font not found: "+o.fontFace)}const r=this.m_unitcvt,a=this.m_unitcvt_r;this.m_doc.fontSize(o.fontSize);return{width:e,height:a(h(this.m_doc,t,new s.Rect(0,0,r(e)-2*n,99999),{align:o.align,vAlign:o.vAlign,fontSize:o.fontSize,fontWeight:o.fontWeight,columns:o.columns??1,columnGap:o.columnGap?(0,i.pt2px)(o.columnGap):0,fontFamily:o.fontFace,lineHeight:o.lineHeight,clip:!1},!1).height+2*n)}}addFont(t,e){return this.m_doc.registerFont(t,e),Promise.resolve()}addImage(t,e){return this.m_images.set(t,e),Promise.resolve()}line(t,e,i,o,n,r){if(t==i&&e==o||!n||!r)return;const a=new s.Color(r);if(0==a.alpha())return;const l=this.m_unitcvt;this.m_doc.moveTo(l(t),l(e)).lineTo(l(i),l(o)).strokeOpacity(a.alpha()).strokeColor(a.toHex(!1)).lineWidth(n).stroke()}drawImage(t,e,i,o,n,r){if(!t||!o||!n)return;const a=this.m_images.get(t);if(!a)return;const l=a.toString();if("data:image/svg+xml;base64,"==l.substr(0,26))this.drawSVG(Buffer.from(l.substr(26),"base64").toString(),e,i,o,n,r);else{const t=this.m_unitcvt;if(e=t(e),i=t(i),o=t(o),n=t(n),"cover"==r){const t=this.m_doc.openImage(a);if(t){const l=(0,s.alignRect)(new s.Rect(0,0,t.width,t.height),new s.Rect(e,i,o,n),r);return void this.m_doc.image(a,l.left,l.top,{align:"center",valign:"center",width:l.width,height:l.height})}}this.m_doc.image(a,e,i,{align:"center",valign:"center",width:o,height:n})}}drawSVG(t,e,o,a,l,h){if(!a||!l)return;const c=this.m_unitcvt;if(e=c(e),o=c(o),a=c(a),l=c(l),"fill"==h)r(this.m_doc,t,e,o,{width:a,height:l,assumePt:!0,preserveAspectRatio:"none"});else{const c=(0,n.parseXML)(t);let m,d=a,u=l;if(null!==(m=c.getAttribute("width"))&&(d=(0,i.px2pt)(parseInt(m))),null!==(m=c.getAttribute("height"))&&(u=(0,i.px2pt)(parseInt(m))),null!==(m=c.getAttribute("viewBox"))){const t=/\s*(\d+)\s*(\d+)\s*(\d+)\s*(\d+)\s*/,e=m.match(t);e&&(d=(0,i.px2pt)(parseInt(e[3])),u=(0,i.px2pt)(parseInt(e[4])))}const p=(0,s.alignRect)(new s.Rect(0,0,d,u),new s.Rect(e,o,a,l),h);r(this.m_doc,t,p.left,p.top,{width:p.width,height:p.height,assumePt:!0,preserveAspectRatio:"none"})}}save(){this.m_doc.save()}restore(){this.m_doc.restore()}translate(t,e){const s=this.m_unitcvt;this.m_doc.translate(s(t),s(e))}rotate(t){this.m_doc.rotate(t)}clip(t,e,s,i){const o=this.m_unitcvt;this.m_doc.rect(o(t),o(e),o(s),o(i)).clip()}fillEllipse(t,e,o,n,r,a,l){if(!r||0==o||0==n)return;const h=new s.Color(r);if(0==h.alpha())return;const c=this.m_unitcvt,m=this.m_doc,d=new s.Rect(c(t),c(e),c(o),c(n));(0,i.deg2rad)(a??0),Math.PI,(0,i.deg2rad)(l??360),Math.PI;m.ellipse(d.left+d.width/2,d.top+d.height/2,d.width/2,d.height/2).fillOpacity(h.alpha()).fill(h.toHex(!1))}strokeEllipse(t,e,o,n,r,a,l,h){if(!a||0==o||0==n||!r)return;const c=new s.Color(a);if(0==c.alpha())return;const m=this.m_unitcvt,d=new s.Rect(m(t),m(e),m(o),m(n)),u=(0,i.deg2rad)(l??0)-Math.PI/2,p=(0,i.deg2rad)(h??360)-Math.PI/2;this._arc(d.left+d.width/2,d.top+d.height/2,d.width/2,d.height/2,u,p,!1).strokeOpacity(c.alpha()).strokeColor(c.toHex(!1)).lineWidth(r).stroke()}fillArc(t,e,o,n,r,a){if(!n||o<=0)return;const l=new s.Color(n);if(0==l.alpha())return;const h=this.m_unitcvt,c=(this.m_doc,h(o)),m=(0,i.deg2rad)(r??0)-Math.PI/2,d=(0,i.deg2rad)(a??360)-Math.PI/2;this._arc(h(t),h(e),c,c,0,d,m).fillOpacity(l.alpha()).fill(l.toHex(!1))}strokeArc(t,e,o,n,r,a,l){if(!r||o<=0||!n)return;const h=new s.Color(r);if(0==h.alpha())return;const c=this.m_unitcvt,m=(this.m_doc,c(o)),d=(0,i.deg2rad)(a??0)-Math.PI/2,u=(0,i.deg2rad)(l??360)-Math.PI/2;this._arc(c(t),c(e),m,m,d,u,!1).strokeOpacity(h.alpha()).strokeColor(h.toHex(!1)).lineWidth(n).stroke()}_arc(t,e,s,i,o,n,r){null==r&&(r=!1);const a=2*Math.PI,l=.5*Math.PI,h=(Math.sqrt(2)-1)/3*4;let c=n-o;if(Math.abs(c)>a)c=a;else if(0!==c&&r!==c<0){c=(r?-1:1)*a+c}const m=Math.ceil(Math.abs(c)/l),d=c/m,u=d/l*h*s;let p=o,_=-Math.sin(p)*u,g=Math.cos(p)*u,f=t+Math.cos(p)*s,x=e+Math.sin(p)*i;this.m_doc.moveTo(f,x);for(let o=0;o<m;o++){const o=f+_,n=x+g;p+=d,f=t+Math.cos(p)*s,x=e+Math.sin(p)*i,_=-Math.sin(p)*u,g=Math.cos(p)*u;const r=f-_,a=x-g;this.m_doc.bezierCurveTo(o,n,r,a,f,x)}return this.m_doc}isVisible(t){return!0}binFonts(){return!0}}e.PDFCanvas=PDFCanvas;class BlobStream extends a{_buffer;_chunks;constructor(){super(),this._buffer=null,this._chunks=[]}_write(t,e,s){this._chunks.push(t),this._chunks.length>64&&(this._chunks=[Buffer.concat(this._chunks)]),s&&s()}buffer(){return this._buffer||(this._buffer=Buffer.concat(this._chunks)),this._buffer}}const l={align:"center",vAlign:"middle",fontSize:14,fontWeight:null,fontStyle:"",fontVariant:"",fontFamily:"Arial",lineHeight:0,clip:!0,columns:1,columnGap:0,lineBreak:!0};function h(t,e,i,o,n=!0){if(i.width<=0||i.height<=0)return;if(o={...l,...o},t.save(),o.clip&&t.rect(i.left,i.top,i.width,i.height).clip(),o.rotation){const e=new s.Point(i.left+i.width/2,i.top+i.height/2),n=o.rotation/180*Math.PI;t.translate(e.x,e.y),t.rotate(n),t.translate(-e.x,-e.y)}let r=o.fontSize??12,a=[],h=e.split("\n");const m=o.columns<1?1:o.columns,d=o.columnGap;let u=(i.width-d*(m-1))/m,p=i.left,_=u;o.lineBreak||(_=99999999);const g=c(t," ");h.forEach((e=>{let s={width:0,words:[],space:0},i=c(t,e);if(i<_)s.width=i,s.words.push({width:i,text:e}),a.push(s);else{let o=e.split(/\s/).filter((t=>""!==t)).map((e=>({width:c(t,e),text:e}))),n=0,r=0;for(;n<o.length;){const t=o[n];let e=s.width;e&&(e+=g),e+=t.width,e>u&&r>0?(a.push(s),r=0,i=0,s={width:0,words:[],space:0}):(s.words.push(t),s.width=e,n++,r++)}r&&(a.push(s),s.last=!0)}}));const f=function(t,e,s){return t._font.ascender/1e3*s}(t,0,r);let x=(o.lineHeight??1.3)*f;const b=a.length;if(!n)return{height:b*x};let v=i.top,w="bottom";if(1==m){let t=x*b;1==b&&(x=f,t=f),"middle"===o.vAlign?(v=i.top+i.height/2-t/2,v+=x/2,w="middle"):"bottom"===o.vAlign?t<i.height&&(v=i.top+i.height-t+x):(v=i.top,w="top")}else v+=f;const y="justify"==o.align;let C=m,k=v,S=0;switch(o.align){case"right":S=1;break;case"center":S=2}let E=1,P=0;return a.some((e=>{console.log(E++,P),e.space=g,y&&!e.last&&function(t,e,s){let i=(e-t.width)/(t.words.length-1)+s;if(i<=0)return;t.width=e,t.space=i}(e,u,g);let s=p;if(1==S?s+=u-e.width:2==S&&(s+=u/2-e.width/2),e.words.forEach((i=>{t.text(i.text,s,k,{baseline:w,width:9999999999}),s+=i.width+e.space})),k+=x,P+=x,k>i.bottom+x&&(k=v,p+=u+d,0==--C))return!0})),t.restore(),{height:(a.length+.3)*x}}function c(t,e){return t.widthOfString(e)}e.drawText=h})),define("src/renderers/html_canvas",["require","exports","src/renderers/base_canvas","src/tools/conversion","src/tools/paper","lib"],(function(t,e,s,i,o,n){"use strict";function r(t,e,s,o){const n=(0,i.deg2rad)(o);return{x:t+s*Math.cos(n),y:e+s*Math.sin(n)}}function a(t,...e){return e=e.map((t=>"number"==typeof t&&isFinite(t)?Math.round(10*t)/10:t)),String.raw(t,...e)}Object.defineProperty(e,"__esModule",{value:!0}),e.HtmlCanvas=e.PaintCanvas=void 0,Object.defineProperty(e,"PaintCanvas",{enumerable:!0,get:function(){return s.PaintCanvas}});class HtmlCanvas extends s.PaintCanvas{m_styles;m_content;m_fonts;m_images;m_rotation;m_colors;m_stack;m_cpos;m_units;m_hotspots;m_measurer;constructor(t){super(t),this.m_units="px",this.m_hotspots=null}setResources(t){}setUnits(t){switch(t){case"mm":this.m_unitcvt=i.mm2px,this.m_unitcvt_r=i.px2mm;break;case"in":this.m_unitcvt=i.in2px,this.m_unitcvt_r=i.px2in;break;case"pt":this.m_unitcvt=i.pt2px,this.m_unitcvt_r=i.px2pt;break;case"px":this.m_unitcvt=i.u2u,this.m_unitcvt_r=i.u2u}this.m_units=t}getUnits(){return this.m_units}startDoc(t){this.m_cpos={x:0,y:0},this.m_stack=[],this.m_colors=[],this.m_content=[],this.m_styles=[],this.m_fonts=[],this.m_images=new Map,this.m_styles.push("\t\t\tbody {\n\t\t\t\tposition: absolute;\n\t\t\t\tleft: 0;\n\t\t\t\ttop: 0;\n\t\t\t\tright: 0;\n\t\t\t\tbottom: 0;\n\t\t\t\toverflow: auto;\n\t\t\t\tpadding: 0;\n\t\t\t\tmargin: 0;\n\t\t\t}\n\n\t\t\t.content {\n\t\t\t\tdisplay: flex;\n\t\t\t\tflex-wrap: wrap;\n\t\t\t\tjustify-content: center;\n\t\t\t\tbackground-color: #525659;\n\t\t\t\t/*min-height: 100%;*/\n\t\t\t\tmin-width: min-content;\n\t\t\t}\n\n\t\t\t.page {\n\t\t\t\tposition: relative;\n\t\t\t\tbackground-color: white;\n\t\t\t\tmargin: 24px;\n\t\t\t\toverflow: hidden;\n\t\t\t}\n\n\t\t\t.f, .s, .t, .i {\n\t\t\t\tposition: absolute;\n\t\t\t}\n\n\t\t\t.i svg, .i img {\n\t\t\t\twidth: 100%;\n\t\t\t\theight: 100%;\n\t\t\t}\n\n\t\t\t.t {\n\t\t\t\tdisplay: flex;\n\t\t\t\tline-height: 1em;\n\t\t\t}\n\n\t\t\t.zoomer {\n\t\t\t\tposition: fixed;\n\t\t\t\tbackground-color: rgba(0,0,0,0.5);\n\t\t\t\tleft: 10px;\n\t\t\t\ttop: 10px;\n\t\t\t\twidth: 100px;\n\t\t\t\theight: 24px;\n\t\t\t\tdisplay: flex;\n\t\t\t\tcolor: white;\n\t\t\t\talign-items: center;\n\t\t\t\tfont-family: sans-serif;\n\t\t\t\tfont-size: 12px;\n\t\t\t\tz-index: 100;\n\t\t\t\tpadding: 4px 4px 4px 8px;\n\t\t\t\tborder-radius: 16px;\n\t\t\t}\n\n\t\t\t.btn {\n\t\t\t\twidth: 20px;\n\t\t\t\theight: 20px;\n\t\t\t\tbackground-color: rgba(255,255,255,0.1);\n\t\t\t\tmargin: 4px;\n\t\t\t\tcolor: white;\n\t\t\t\tborder-radius: 50%;\n\t\t\t\tpadding: 4px;\n\t\t\t}\t\t\t\n\n\t\t\t.btn:hover {\n\t\t\t\tbackground-color: rgba(255,255,255,0.5);\n\t\t\t}\n\n")}async endDoc(t){const e=`\t\t\n${!1!==this.m_options.full?'<!DOCTYPE html>\n<html lang="en">\n\t<head>\n\t\t<meta charset="utf-8">\n\t</head>\n\t<body>\n':""}\n\t\t<style>\n${this.m_styles.join("\n")}\n${this.m_fonts.join("\n")}\n\t\t\t* { box-sizing: border-box; user-select: none; }\n\t\t\t.s {border-width: 1px; border-style: solid; background-color: transparent;}\n\t\t\t.t {background-color: transparent;}\n\t\t\t.ta-l { text-align: left; justify-content: left }\n\t\t\t.ta-r { text-align: right; justify-content: right }\n\t\t\t.ta-c { text-align: center; justify-content: center }\n\t\t\t.ta-j { text-align: left; justify-content: left; text-align: justify; }\n\n\t\t\t.tv-t { align-items: start }\n\t\t\t.tv-m { align-items: center }\n\t\t\t.tv-b { align-items: end }\n\n\t\t\t.hotspot { position: absolute; z-index: 1; cursor: pointer; }\n\t\t\t.hotspot:hover { background-color: rgb(95, 167, 197, 0.20); }\n\n\t\t</style>\n\t\t<script>\n\t\t\tlet czoom = 100;\n\n\t\t\tfunction zoom( n ) {\n\t\t\t\tlet nzoom = czoom + n;\n\t\t\t\tif( nzoom>=10 && nzoom<400 ) {\n\t\t\t\t\tczoom = nzoom;\n\t\t\t\t\tlet el = document.getElementById( 'content' );\n\t\t\t\t\tel.style.zoom = czoom+"%";\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// default hotspot handler\n\t\t\tif( !('hotspot' in window) ) {\n\t\t\t\thotspot = ( name ) => {\n\t\t\t\t\tdebugger;\n\t\t\t\t}\n\t\t\t}\n\n\t\t<\/script>\n\t\t<div class="zoomer"><span style="flex:1">Zoom:</span>\n\t\t\t<div class="btn" onclick="zoom(-10)" >\n\t\t\t\t<svg aria-hidden="true" focusable="false" data-prefix="fal" data-icon="minus-circle" class="svg-inline--fa fa-minus-circle fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M140 274c-6.6 0-12-5.4-12-12v-12c0-6.6 5.4-12 12-12h232c6.6 0 12 5.4 12 12v12c0 6.6-5.4 12-12 12H140zm364-18c0 137-111 248-248 248S8 393 8 256 119 8 256 8s248 111 248 248zm-32 0c0-119.9-97.3-216-216-216-119.9 0-216 97.3-216 216 0 119.9 97.3 216 216 216 119.9 0 216-97.3 216-216z"></path></svg>\n\t\t\t</div>\n\t\t\t<div class="btn" onclick="zoom(10)" >\n\t\t\t\t<svg aria-hidden="true" focusable="false" data-prefix="fal" data-icon="plus-circle" class="svg-inline--fa fa-plus-circle fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M384 250v12c0 6.6-5.4 12-12 12h-98v98c0 6.6-5.4 12-12 12h-12c-6.6 0-12-5.4-12-12v-98h-98c-6.6 0-12-5.4-12-12v-12c0-6.6 5.4-12 12-12h98v-98c0-6.6 5.4-12 12-12h12c6.6 0 12 5.4 12 12v98h98c6.6 0 12 5.4 12 12zm120 6c0 137-111 248-248 248S8 393 8 256 119 8 256 8s248 111 248 248zm-32 0c0-119.9-97.3-216-216-216-119.9 0-216 97.3-216 216 0 119.9 97.3 216 216 216 119.9 0 216-97.3 216-216z"></path></svg>\n\t\t\t</div>\n\t\t</div>\n\t\t<div class='content' id='content'>\n${this.m_content.join("\n")}\n\t\t</div>\n${!1!==this.m_options.full?"\t</body>\n</html>\n":""}\t\t\n`;this.m_options.output&&await n.host.writeUtf8(this.m_options.output,e),t&&t(e)}startPage(t){const e=(0,o.calcPaperSize)(t,"px");this.m_content.push(a`<div class="page" style="width:${e.width}px;height:${e.height}px">`)}endPage(){this.m_content.push("</div>")}_calcColorClass(t,e){let s=this.m_colors.indexOf(e+"-"+t);if(s<0){let i;switch(s=this.m_colors.push(t)-1,e){case"bk":i="background-color";break;case"brd":i="border-color";break;case"tx":i="color"}this.m_styles.push(`\t\t\t.cx-${s} { ${i}: ${t}; }`)}return`cx-${s}`}_calcRect(t,e,s,i){const o=this.m_unitcvt;return t=o(t+this.m_cpos.x),e=o(e+this.m_cpos.y),s=o(s),i=o(i),this._updateHotspot(t,e,s,i),a`${this.m_rotation??""}left:${t}px;top:${e}px;width:${s}px;height:${i}px;`}fillRect(t,e,i,o,n,r){if(!n||0==i||0==o)return;const l=new s.Color(n);if(0==l.alpha())return;const h=l.toHex(),c=this._calcRect(t,e,i,o),m=this._calcColorClass(h,"bk");let d=a`${c}`;r&&(d+=`border-radius:${r}pt`),this.m_content.push(`\t\t\t<div class="f ${m}" style="${d}"></div>`)}strokeRect(t,e,o,n,r,l,h){if(!l||0==o||0==n||!r)return;const c=new s.Color(l);if(0==c.alpha())return;const m=this._calcRect(t,e,o,n),d=this._calcColorClass(c.toHex(),"brd");let u=a`${m}border-width:${(0,i.pt2px)(r)}pt;`;h&&(u+=`border-radius:${h}pt`),this.m_content.push(`\t\t\t<div class="s ${d}" style="${u}"></div>`)}drawSVG(t,e,s,i,o,n){const r=this._calcRect(e,s,i,o);this.m_content.push(`\t\t\t<div class="i" style="${r}">${t}</div>`)}drawText(t,e,i,o,n,r,l){if(!r||0==i||0==o||!n)return;const h=new s.Color(r);if(0==h.alpha())return;const c=this._calcRect(t,e,i,o);let m=this._calcColorClass(h.toHex(),"tx"),d=a`${c}`;switch(l.align){case"left":m+=" ta-l";break;case"center":m+=" ta-c";break;case"right":m+=" ta-r";break;case"justify":m+=" ta-j"}switch(l.vAlign){case"top":m+=" tv-t";break;case"middle":m+=" tv-m";break;case"bottom":m+=" tv-b"}l.padding&&(d+=`padding: ${l.padding}pt;`),1!=l.lineHeight&&(d+=`line-height: ${l.lineHeight}em;`),d+=a`font-size: ${l.fontSize}pt;`;let u=l.fontFace??"sans-serif";var p;u.indexOf(".")>=0&&(u="'"+u+"'"),d+=`font-family: ${u};`,d+=`font-weight: ${l.fontWeight};`,this.m_content.push(`\t\t\t<div class="t ${m}" style="${d}"><span>${p=n,p?p=(p=(p=(p=p.replaceAll("&","&amp;")).replaceAll("<","&lt;")).replaceAll(">","&gt;")).replaceAll("\n","<br/>"):""}</span></div>`)}measureText(t,e,o){if(!this.m_measurer){const t=n.host.createCanvas();this.m_measurer=t.getContext("2d")}const r=this.m_unitcvt,a=this.m_unitcvt_r,l=(0,i.pt2px)(o.padding);return{width:e,height:a((0,n.drawText)(this.m_measurer,t,new s.Rect(0,0,r(e)-2*l,99999),{align:o.align,vAlign:o.vAlign,fontSize:(0,i.pt2px)(o.fontSize),fontWeight:o.fontWeight,columns:o.columns??1,columnGap:o.columnGap?(0,i.pt2px)(o.columnGap):0,fontFamily:o.fontFace,lineHeight:o.lineHeight,clip:!1}).height+2*l)}}line(t,e,o,n,r,l){if(t==o&&e==n||!r||!l)return;const h=new s.Color(l);if(0==h.alpha())return;const c=this._calcColorClass(h.toHex(),"bk");if(t==o){let s=a`${this._calcRect(t,e,(0,i.pt2u)(r,this.m_units),n-e)}`;this.m_content.push(`\t\t\t<div class="f ${c}" style="${s}"></div>`)}else if(e==n){let s=a`${this._calcRect(t,e,o-t,(0,i.pt2u)(r,this.m_units))}`;this.m_content.push(`\t\t\t<div class="f ${c}" style="${s}"></div>`)}}drawImage(t,e,s,i,o,n){if(!t||!i||!o)return;const r=this._calcRect(e,s,i,o),a=this.m_images.get(t);let l="";"cover"==n&&(l+="object-fit: contain;"),this.m_content.push(`\t\t\t<div class="i" style="${r}"><img src="${a}" style="${l}"/></div>`)}fillEllipse(t,e,i,o,n,l,h){if(!n||0==i||0==o)return;const c=new s.Color(n);if(0==c.alpha())return;const m=this.m_unitcvt;let d=this._calcRect(t,e,i,o),u=m(t),p=m(e),_=m(i/2),g=m(o/2);const f=this._calcColorClass(c.toHex(),"bk");if(i==o&&0==l&&h>=360)d+="border-radius:50%;",this.m_content.push(`\t\t\t<div class="f ${f}" style="${d}"></div>`);else{let t=r(u,p,_,h),e=r(u,p,_,l),s=Math.abs(h-l)<=180?"0":"1";const i=a`M ${t.x} ${t.y} A ${_} ${_} 0 ${s} 0 ${e.x} ${e.y} L ${u} ${p} Z`;this.m_content.push(`<div class="i" style="${d}"><svg viewbox="0 0 ${2*_} ${2*g}" xmlns="http://www.w3.org/2000/svg"><path d="${i}"></path></svg></div>`)}}strokeEllipse(t,e,i,o,n,r,a,l){if(!r||0==i||0==o||!n)return;new s.Color(r).alpha()}fillArc(t,e,i,o,n,r){if(!o||i<=0)return;new s.Color(o).alpha()}strokeArc(t,e,i,o,n,r,a){if(!n||o<=0||i<=0)return;new s.Color(n).alpha()}save(){this.m_stack.push({...this.m_cpos})}restore(){this.m_stack.length,this.m_cpos=this.m_stack.pop(),this.m_rotation=null}rotate(t){this.m_rotation=`transform: rotate( ${t}deg );`}translate(t,e){(t||e)&&(this.m_cpos.x+=t,this.m_cpos.y+=e)}clip(t,e,s,i){}isVisible(t){return!0}addFont(t,e){return this.m_fonts.push(`\t\t\t@font-face {\n\t\t\t\tfont-family: "${t}";\n\t\t\t\tsrc: url("${e}");\n\t\t\t}\n`),Promise.resolve()}addImage(t,e){return this.m_images.set(t,e),Promise.resolve()}binFonts(){return!1}beginHotSpot(t){this.m_hotspots||(this.m_hotspots=[]),this.m_hotspots.push({name:t})}_updateHotspot(t,e,s,i){if(!this.m_hotspots||0==this.m_hotspots.length)return;let o=this.m_hotspots[this.m_hotspots.length-1],n=t+s,r=e+i;void 0===o.left?(o.left=t,o.top=e,o.right=n,o.bottom=r):(o.left<t&&(o.left=t),o.top<e&&(o.top=e),o.right>n&&(o.right=n),o.bottom>r&&(o.bottom=r))}endHotSpot(){let t=this.m_hotspots.pop();this.m_content.push(a`<div class="hotspot" style="left:${t.left}px;top:${t.top}px;width:${t.right-t.left}px;height:${t.bottom-t.top}px;" onclick="hotspot('${t.name}')"></div>`)}}e.HtmlCanvas=HtmlCanvas})),define("src/renderer",["require","exports","src/renderer/rreport","src/renderers/pdf_canvas","src/renderers/html_canvas"],(function(t,e,s,i,o){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.PDFRenderer=void 0;e.PDFRenderer=class PDFRenderer{m_report;m_plugins;m_datasources;constructor(t){if(this.m_plugins=[],t){let e=t.save();this.m_report=new s.RReport(e),this.m_report.setPlugins(t.getPlugins())}else this.m_report=new s.RReport(null)}load_data(t){const e=t;this.m_report=new s.RReport(e)}async render(t,e){if(this.m_report){let s;"pdf"==t?s=new i.PDFCanvas({output:e.output}):"img"==t||"html"==t&&(s=new o.HtmlCanvas(e)),s.startDoc(e),await this.m_report.renderItem(s,e.paintCtx),s.endDoc(e.callback)}}registerPlugin(t){this.m_report.setPlugins([t])}registerDataSource(t){this.m_datasources.push(t)}}})),define("src/builder",["require","exports","src/x4mod","src/elements/_mod","src/elements/mark","src/tools/conversion","src/tools/make_sample","src/editor/ereport","src/renderers/disp_canvas","x4/hosts/electron","src/tools/monaco_editor","src/renderer","src/tools/json"],(function(t,e,s,i,o,n,r,a,l,h,c,m,d){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.ReportBuilder=e.Selection=void 0;const u=20;class Selection extends s.EventSource{dpRect;lpRect;handles;section;m_locked;m_type;m_elements;constructor(){super(),this.m_elements=[],this.lpRect=null,this.dpRect=null,this.handles=null,this.section=null}clear(t=!0){this.m_elements.forEach((t=>t.selectElement(!1))),this.m_elements=[],this._changed(t)}get count(){return this.m_elements.length}get first(){return this.m_elements[0]}get empty(){return 0==this.m_elements.length}get locked(){return this.m_locked}forEach(t){this.m_elements.forEach(t)}find(t){return this.m_elements.findIndex((e=>e===t))}toggle(t){if(this.empty||this.m_locked)t.selectElement(!0),this.m_elements=[t];else{let e=this.find(t);e<0?(this.m_elements.push(t),t.selectElement(!0)):(this.m_elements.splice(e,1),t.selectElement(!1))}this._changed()}set(t){let e=[];this.m_elements.forEach((t=>{t.selectElement(!1),e.push(t.getUID())})),e.sort(),(0,s.isArray)(t)?this.m_elements=t:this.m_elements=[t];let i=[];this.m_elements.forEach((t=>{t.selectElement(!0),i.push(t.getUID())})),i.sort();let o=!1;if(i.length!=e.length)o=!0;else for(let t=0,s=e.length;t<s;t++)if(i[t]!=e[t]){o=!0;break}o&&this._changed()}_changed(t=!0){const e=this.count;this.m_type=0==e?null:1==e?this.first.getElementName():"multiple",this.m_locked=1==e&&(this.first.isLocked()||!this.first.isSelectable()),this.lpRect=null,this.dpRect=null,this.handles=null,this.section=null,t&&this.signal("change",(0,s.EvChange)(this.count))}is(t){return this.m_type==t}}e.Selection=Selection;class ReportBuilder extends s.VLayout{m_container;m_report;m_cpage;m_csection;m_painter;m_headerbar;m_statusbar;m_edScript;m_edDSource;m_edDSample;m_props_cont;m_toolbar;m_hierarchy;m_canvas;m_ovr_canvas;m_curObject;m_uid_cache;m_rc_marquee;m_marks;m_cursor;m_hit;m_selection;m_alt_on;m_ctrl_on;m_shift_on;m_mouse_dp;m_dirty;m_state;m_state_param;m_scroll_hz;m_scroll_vt;m_undoStack;m_undoSize;m_plugins;m_datasources;constructor(t){super(t),this.m_container=new s.Container({}),this.setContent(this.m_container),this.setDomEvent("create",(()=>this._onCreate())),this.setDomEvent("contextmenu",(t=>this._showCtxMenu(t))),this.m_state=null,this.m_state_param=void 0,window.addEventListener("mousewheel",p,{passive:!1,capture:!0}),this.m_rc_marquee=null,this.m_selection=new Selection,this.m_scroll_hz=null,this.m_scroll_vt=null,this.m_dirty=!1,this.m_alt_on=!1,this.m_ctrl_on=!1,this.m_shift_on=!1,this.m_cursor=null,this.m_marks=null,this.m_undoSize=0,this.m_undoStack=[],this.m_hit=null,this._updateCursor(null,null),this.m_painter=new l.DisplayCanvas({}),this.m_plugins=[],this.m_datasources=[],this.m_painter.onChange((()=>{this._updateSelRect(),this._update(),this._update_ovr()})),this.addShortcut("F5","try",(()=>{this._tryReportHtml()})),s.Application.instance().on("message",(t=>{if("element.update"==t.msg){if(t.params){t.params.split(",").findIndex((t=>"hierarchy"==t))>=0&&this._fillHierarchy()}this.startTimer("update",30,!1,(()=>{this._updateSelRect(),this._update(),this._update_ovr()}))}else if("element.prop_changed"==t.msg){const e=t.params;"left"!=e&&"top"!=e&&"width"!=e&&"height"!=e||t.source instanceof i.CSection&&this._fixSections()}else if("element.refill"==t.msg){const{el:e,pos:s}=t.params;e==this.m_curObject&&e.fill(this.m_props_cont,s),this._fillHierarchy(),this._update(),this._update_ovr()}else if("element.dirty"==t.msg)this._setDirty();else if("report.reset"==t.msg)this._centerView(),this._updateSelRect(),this._update(),this._update_ovr();else if("element.delete"==t.msg)t.params.getElementName(),this._fillHierarchy();else if("section.break_change"==t.msg)this._fixSections();else if("element.created"==t.msg||"page.rotate"==t.msg||"page.resize"==t.msg){t.params instanceof i.CPage&&this._fixSections()}})),this.m_selection.on("change",(t=>{if(!this.dom)return;t.value?this._calcSelRect():(this.m_hit=null,this._updateCursor(null,null)),this._update(),this._update_ovr(),this._updateCursor(null,null),this._fillProperties();const e=this.m_selection.first;e&&(this.m_hierarchy.selection=e.getUID())})),this._createReport(null)}registerPlugin(t){this.m_plugins.push(t),this.update(1e3)}registerDataSource(t){this.m_datasources.push(t)}exec(t){switch(t){case"undo":this._undo();break;case"cut":this._delSelection();break;case"copy":this._copy();break;case"paste":this._paste();break;case"zoomin":this._zoom("in"),this._updateSelRect(),this._update(),this._update_ovr();break;case"zoomout":this._zoom("out"),this._updateSelRect(),this._update(),this._update_ovr()}}render(){let t,e,o;this.m_statusbar=new s.HLayout({cls:"statusbar",content:[new s.Label({text:""})]}),this.m_headerbar=new s.TabBar({change:t=>{"editor"==t.value&&this.m_edScript.updateCompletions()}}),this.m_canvas=new s.Canvas({cls:"page @fit",tabIndex:0,paint:t=>{this._onPaint(t.ctx)},dom_events:{wheel:t=>this._onMouseWheel(t),keydown:t=>this._onKeyDown(t),keyup:t=>this._onKeyUp(t),dblclick:t=>this._onDblClick(t),pointerdown:t=>this._onMouseDown(t),pointermove:t=>this._onMouseMove(t),pointerup:t=>this._onMouseUp(t),sizechange:()=>this._centerView()}}),this.m_ovr_canvas=new s.Canvas({cls:"ovr @fit",paint:t=>{this._paint_ovr(t.ctx)}}),this.m_props_cont=new s.VLayout({cls:"properties",width:250}),this.m_hierarchy=new s.TreeView({flex:1,cls:"hierarchy",root:null,sort:!1,selectionchange:t=>{t.selection&&this._selectItem(t.selection.id)},renderItem:t=>{const e=this.getNodeByUID(t.id),o=e instanceof i.CPage,n=e.isLocked(),r=e.isVisible();return new s.HLayout({flex:1,cls:"center",content:[new s.Label({cls:"tree-label",flex:1,text:t.text}),o?null:new s.Icon({cls:n?"tree-btn bold":"tree-btn",icon:n?"resources/img/lock.svg":"resources/img/lock-open.svg",dom_events:{click:()=>{e.toggleLock(),this.m_hierarchy.updateElement(t.id)}}}),o?null:new s.Icon({cls:r?"tree-btn bold":"tree-btn",icon:r?"resources/img/eye.svg":"resources/img/eye-slash.svg",dom_events:{click:()=>{e.toggleVisible(),this.m_hierarchy.updateElement(t.id)}}})]})}}),this.m_edScript=new c.ScriptReportEditor({cls:"x-flex",language:"javascript",report:this.m_report}),this.m_edDSource=new c.MonacoEditor({cls:"x-flex",language:"json",source:this.m_report.getDataSource(),events:{change:t=>{this.m_report.setDataSource(t.value)}}}),this.m_edDSample=new c.MonacoEditor({cls:"x-flex",language:"json",source:this.m_report.getDataSample(),events:{change:t=>{this.m_report.setDataSample(t.value)}}});let n=[];this.m_report.getPlugins().forEach((t=>{t.elements?.forEach((e=>{let i=e.icon;i?(0,s.isString)(i)&&(i=t.basedir+"/"+i):i="resources/img/btn-special.svg";let o=new s.Button({cls:"tool w20",tabIndex:!1,icon:i,tooltip:t.name+": "+e.name,click:()=>{this.createElement({type:"custom",reference:t.name+"."+e.name,plugin:e,data:{}})}});n.push(o)}))})),this.m_toolbar=new s.VLayout({flex:1,cls:"toolsbar",content:[new s.Panel({icon:"resources/img/cube.svg",title:s._tr.builder.tools.objects,content:[new s.Button({cls:"tool",tabIndex:!1,icon:"resources/img/btn-text.svg",tooltip:s._tr.builder.tools.text,click:()=>this.createElement({type:"text"})}),new s.Button({cls:"tool",tabIndex:!1,icon:"resources/img/btn-line.svg",tooltip:s._tr.builder.tools.line,click:()=>this.createElement({type:"line"})}),new s.Button({cls:"tool",tabIndex:!1,icon:"resources/img/btn-rect.svg",tooltip:s._tr.builder.tools.rect,click:()=>this.createElement({type:"rectangle"})}),new s.Button({cls:"tool",tabIndex:!1,icon:"resources/img/btn-circle.svg",tooltip:s._tr.builder.tools.ellipse,click:()=>this.createElement({type:"ellipse"})}),new s.Button({cls:"tool",tabIndex:!1,icon:"resources/img/btn-image.svg",tooltip:s._tr.builder.tools.image,click:()=>this.createElement({type:"image"})}),new s.Button({cls:"tool",tabIndex:!1,icon:"resources/img/btn-section.svg",tooltip:s._tr.builder.section_sections,menu:()=>[new s.MenuItem({text:s._tr.builder.section_normal,click:()=>this._createSection("generic")}),new s.MenuSeparator,new s.MenuItem({text:s._tr.builder.section_header,click:()=>this._createSection("header")}),new s.MenuItem({text:s._tr.builder.section_footer,click:()=>this._createSection("footer")}),new s.MenuItem({text:s._tr.builder.section_dochead,click:()=>this._createSection("doc_head")}),new s.MenuItem({text:s._tr.builder.section_docback,click:()=>this._createSection("doc_back")})]}),new s.Flex({cls:"wrap-break"}),...n]}),new s.Panel({icon:"resources/img/crosshairs.svg",title:s._tr.builder.tools.alignment,content:[new s.Button({cls:"tool w20",tabIndex:!1,icon:"resources/img/align-left.svg",tooltip:s._tr.builder.tools.left,click:()=>{this._align("left")}}),new s.Button({cls:"tool w20",tabIndex:!1,icon:"resources/img/align-center.svg",tooltip:s._tr.builder.tools.center,click:()=>{this._align("center")}}),new s.Button({cls:"tool w20",tabIndex:!1,icon:"resources/img/align-right.svg",tooltip:s._tr.builder.tools.right,click:()=>{this._align("right")}}),new s.Button({cls:"tool w20",tabIndex:!1,icon:"resources/img/align-top.svg",tooltip:s._tr.builder.tools.top,click:()=>{this._align("top")}}),new s.Button({cls:"tool w20",tabIndex:!1,icon:"resources/img/align-middle.svg",tooltip:s._tr.builder.tools.middle,click:()=>{this._align("middle")}}),new s.Button({cls:"tool w20",tabIndex:!1,icon:"resources/img/align-bottom.svg",tooltip:s._tr.builder.tools.bottom,click:()=>{this._align("bottom")}}),new s.Button({cls:"tool w20",tabIndex:!1,icon:"resources/img/distribute-hz.svg",tooltip:s._tr.builder.tools.dist_hz,click:()=>{}}),new s.Button({cls:"tool w20",tabIndex:!1,icon:"resources/img/distribute-vt.svg",tooltip:s._tr.builder.tools.dist_vt,click:()=>{}})]}),new s.Panel({icon:"resources/img/layer-group-regular.svg",title:s._tr.builder.tools.arrange,content:[new s.Button({cls:"tool w20",tabIndex:!1,icon:"resources/img/bring-front-solid.svg",tooltip:s._tr.builder.tools.bring_front,click:()=>{this._sendBack("front")}}),new s.Button({cls:"tool w20",tabIndex:!1,icon:"resources/img/bring-forward-solid.svg",tooltip:s._tr.builder.tools.bring_forward,click:()=>{this._sendBack("after")}}),new s.Button({cls:"tool w20",tabIndex:!1,icon:"resources/img/send-backward-solid.svg",tooltip:s._tr.builder.tools.send_backward,click:()=>{this._sendBack("before")}}),new s.Button({cls:"tool w20",tabIndex:!1,icon:"resources/img/send-back-solid.svg",tooltip:s._tr.builder.tools.send_back,click:()=>{this._sendBack("back")}})]})]}),this.setContent([this.m_headerbar,t=new s.HLayout({flex:1,style:{overflow:"hidden"},content:[new s.VLayout({width:250,content:[this.m_toolbar,new s.Separator({sizing:"before",orientation:"vertical"}),this.m_hierarchy]}),new s.Separator({sizing:"before",orientation:"horizontal"}),new s.Component({flex:1,content:[this.m_canvas,this.m_ovr_canvas]}),new s.Separator({sizing:"after",orientation:"horizontal"}),this.m_props_cont]}),e=new s.VLayout({flex:1,cls:"@hidden",content:[new s.HLayout({flex:1,content:this.m_edScript}),new s.HLayout({content:[new s.Flex,new s.Button({text:"try HTML",click:()=>this._tryReportHtml()}),new s.Button({text:"try PDF",click:()=>this._tryReport()})]})]}),o=new s.VLayout({flex:1,cls:"@hidden",content:[new s.HLayout({cls:"source-tb",content:[new s.Button({text:"check",icon:"resources/img/spell-check-regular.svg",click:()=>this._checkSources()}),new s.Button({text:"generate",icon:"resources/img/digging-light.svg",click:()=>this._makeSample()})]}),new s.HLayout({flex:1,content:[this.m_edDSource,new s.Separator({sizing:"before",orientation:"horizontal"}),this.m_edDSample]})]}),this.m_statusbar]),this.m_headerbar.addPage({id:"designer",title:s._tr.builder.tabs.designer,page:t}),this.m_headerbar.addPage({id:"editor",title:s._tr.builder.tabs.script,page:e}),this.m_headerbar.addPage({id:"datasource",title:s._tr.builder.tabs.datasource,page:o}),this.m_headerbar.select("designer"),this._fillHierarchy(),this._fillProperties()}_checkSources(){}_makeSample(){const t=this.m_report.getDataSources(),e=(0,r.makeSample)(t);this.m_edDSample.source=e,this.m_report.setDataSample(e)}_selectItem(t){let e=null;this.m_report.forEach((s=>{if(s.getUID()==t)return e=s,!0}),!0),e&&this.m_selection.set([e])}_align(t){if(this.m_selection.count<2)return;const e=this.m_selection.lpRect;this.m_selection.forEach((s=>{const i=s.getRect();switch(t){case"left":s.move(e.left,i.top);break;case"top":s.move(i.left,e.top);break;case"right":s.move(e.right-i.width,i.top);break;case"bottom":s.move(i.left,e.bottom-i.height);break;case"center":s.move(e.left+e.width/2-i.width/2,i.top);break;case"middle":s.move(i.left,e.top+e.height/2-i.height/2)}})),this._updateSelRect(),this._update(),this._update_ovr()}_createSection(t){this.m_state=null;const e=this.m_report.elementFactory({type:"section",kind:t,height:10},this.m_cpage);this.m_cpage.addSection(e,this.m_csection),this.m_selection.set(e),this._fillHierarchy(),this._update(),this._update_ovr()}_sendBack(t){if(1!=this.m_selection.count)return;let e=this.m_selection.first;e.sendBack(t),this.m_cpage.prepareZOrder(),this._fillHierarchy(),e instanceof i.CSection?this._fixSections():this._update()}_clearState(){this.m_state=null,this.m_state_param=null,this._update_ovr()}_onKeyDown(t){let e=!1,s=1;switch(this.m_report.getData("grid_on")&&(s=this.m_report.getData("grid_size"),s||(s=1),this.m_ctrl_on&&(s*=10)),t.key){case"Escape":this._clearState(),this.m_selection.clear(),e=!0;break;case"c":t.ctrlKey&&this._copy();break;case"v":t.ctrlKey&&this._paste();break;case"z":t.ctrlKey&&this._undo();break;case"Control":this.m_ctrl_on=!0;break;case"Alt":this.m_alt_on=!0;break;case"Shift":this.m_shift_on=!0;break;case"Delete":"moving-marker"==this.m_state?(this.m_report.delMark(this.m_state_param.marker),this._clearState(),this._setDirty()):this._delSelection();break;case"Home":{let t=this.m_report.getOrg();this.m_report.setOrg(t.x,0),e=!0;break}case"PageUp":{let t=this.m_report.getOrg(),s=this.m_canvas.getBoundingRect().height;this.m_report.setOrg(t.x,t.y+2*s/3),e=!0;break}case"PageDown":{let t=this.m_report.getOrg(),s=this.m_canvas.getBoundingRect().height;this.m_report.setOrg(t.x,t.y-2*s/3),e=!0;break}case"End":{let t=this.m_report.getOrg(),s=this.m_report.getFullRect().height,i=this.m_canvas.getBoundingRect().height;this.m_report.setOrg(t.x,-s+i),e=!0;break}case"ArrowUp":this.m_shift_on?this._expandSel(0,-s):this._offsetSel(0,-s);break;case"ArrowDown":this.m_shift_on?this._expandSel(0,s):this._offsetSel(0,s);break;case"ArrowLeft":this.m_shift_on?this._expandSel(-s,0):this._offsetSel(-s,0);break;case"ArrowRight":this.m_shift_on?this._expandSel(s,0):this._offsetSel(s,0)}e&&(this._updateSelRect(),this._update_ovr(),this._update())}_onKeyUp(t){switch(t.key){case"Shift":this.m_shift_on=!1;break;case"Control":this.m_ctrl_on=!1;break;case"Alt":this.m_alt_on=!1}}_copy(t=!0){if(this.m_selection.empty)return null;let e=[];this.m_selection.forEach((t=>{e.push(t.save())}));let s=JSON.stringify(e);if(t){if(!navigator.clipboard)return null;navigator.clipboard.writeText(s)}return e}async _paste(t=null){if(!t&&navigator.clipboard){const e=await navigator.clipboard.readText();t=JSON.parse(e)}if(t&&(0,s.isArray)(t)){this._addUndo();let e=[];for(const s of t){if(!s.type)continue;delete s.uid;let t=this._createElement(s,this.m_csection??this.m_cpage);if("section"==s.type){return t.forEach((t=>{t.regenUID()}),!0),this.m_cpage.addSection(t,this.m_csection),this._fillHierarchy(),this._update(),this._update_ovr(),void this.m_selection.set(t)}t&&e.push(t)}this.m_selection.set(e),e.length&&(this.m_cpage.fixZOrder(),this.m_state="moving",this._prepareSizeMove())}}_delSelection(){if(this.m_selection.empty)return;this._addUndo();const t=()=>{this.m_selection.is("section")?(this.m_selection.first.removeFromParent(),this._fixSections()):this.m_selection.forEach((t=>{t.removeFromParent()})),this.m_selection.clear(),this.m_hit=null,this._updateCursor(null,null),this._update(),this._update_ovr(),this._fillProperties(),this._setDirty()};this.m_selection.is("page")?s.MessageBox.show({message:s._tr.builder.confirm_del_page,buttons:["ok","cancel"],click:e=>{"ok"==e&&t()}}):this.m_selection.is("section")?s.MessageBox.show({message:s._tr.builder.confirm_del_section,buttons:["ok","cancel"],click:e=>{"ok"==e&&t()}}):t()}_createMark(t){this.m_canvas.focus(),this.m_state="marking",this.m_state_param={type:t,pos:0}}createElement(t){this.m_state="create",this.m_state_param=t,this.m_selection.clear(),this._update(),this._update_ovr(),this._setDirty()}_createElement(t,e){return this.m_report.elementFactory(t,e)}_rectToLP(t){let e=this.m_report.getOrg(),i=this.m_report.getScale()/100;const o=this.m_report.getUnits(),r=(0,n.px2u)((t.left-e.x)/i,o),a=(0,n.px2u)((t.top-e.y)/i,o),l=(0,n.px2u)(t.width/i,o),h=(0,n.px2u)(t.height/i,o);return new s.Rect(r,a,l,h)}_pointToLP(t){let e=this.m_report.getOrg(),i=this.m_report.getScale()/100;const o=this.m_report.getUnits(),r=(0,n.px2u)((t.x-e.x)/i,o),a=(0,n.px2u)((t.y-e.y)/i,o);return new s.Point(r,a)}_rectToDP(t){let e=this.m_report.getOrg(),i=this.m_report.getScale()/100;const o=this.m_report.getUnits(),r=(0,n.u2px)(t.left,o),a=(0,n.u2px)(t.top,o),l=(0,n.u2px)(t.width,o),h=(0,n.u2px)(t.height,o);return new s.Rect(r*i+e.x,a*i+e.y,l*i,h*i)}_pointToDP(t){let e=this.m_report.getOrg(),i=this.m_report.getScale()/100;const o=this.m_report.getUnits(),r=(0,n.u2px)(t.x,o),a=(0,n.u2px)(t.y,o);return new s.Point(r*i+e.x,a*i+e.y)}_onMouseDown(t){t.target.setPointerCapture(t.pointerId);let e=(0,s.getMousePos)(t,!1);if(this.m_hit&&"scroll"==this.m_hit.type)this.m_state="scrolling";else if(this.m_hit&&"marker"==this.m_hit.type)e.x=this._snapGrid(e.x,!0),e.y=this._snapGrid(e.y,!0),this.m_state="moving-marker",this.m_state_param={marker:this.m_hit.data,pos:e,dpos:e};else if(this.m_hit&&"selection"==this.m_hit.type){if(this.m_selection.is("section"));else if(this.m_ctrl_on){const t=this._copy(!1);t&&this._paste(t)}else if(this.m_shift_on){let t=this._pointToLP(e),s=this.m_report.touchesPt(t);return void(s&&this.m_selection.toggle(s))}if(this.m_selection.locked)return;"in"==this.m_hit.subtype?this.m_state="moving":this.m_state="sizing",this._prepareSizeMove()}else if("create"==this.m_state){e.x=this._snapGrid(e.x,!0),e.y=this._snapGrid(e.y,!1),this.m_rc_marquee=new s.Rect(e.x,e.y,0,0);let t=this._calcRel(this._rectToLP(this.m_rc_marquee),this.m_csection);this._addUndo();let i=this._createElement(this.m_state_param,this.m_cpage);i.initWithDef(),i.move(t.left,t.top),i.size(t.width,t.height),i.setOwner(this.m_csection),this.m_cpage.fixZOrder(),i.extraData.irect_lp=i.getRect(),this.m_selection.set(i),this.m_selection.section=this.m_csection,this.m_state="sizing",this.m_hit={type:"selection",subtype:"bottom-right",delta:new s.Point(0,0),data:null},this._prepareSizeMove()}else if(!this.m_state){const t=this.getBoundingRect(),i=new s.Rect(0,0,t.width,u),o=new s.Rect(0,0,u,t.height);i.contains(e)?this._createMark("vmark"):o.contains(e)?this._createMark("hmark"):(this.m_state="selecting",this.m_rc_marquee=new s.Rect(e.x,e.y,0,0))}this._update_ovr()}_prepareSizeMove(){this._addUndo(),this.m_cpage.prepareZOrder(),this.m_selection.is("section")||(this.m_selection.forEach((t=>{t.enterSizeMove(this.m_cpage),t.extraData.irect_lp=t.getRect()})),this._calcSelRect()),this.m_state_param={delta:this.m_hit?.delta??new s.Point(0,0),irect_dp:new s.Rect(this.m_selection.dpRect),irect_lp:new s.Rect(this.m_selection.lpRect)}}_doneSizeMove(){this.m_selection.forEach((t=>{t.exitSizeMove(this.m_csection)})),this.m_cpage.fixZOrder(),this._fixSections(),this._updateSelRect()}$_fix_rep=0;_fixSections(){let t=()=>{this.m_cpage.fixSections(),this._centerView(),this._updateSelRect(),this._update(),this._update_ovr(),this.$_fix_rep=0};this.$_fix_rep++,this.$_fix_rep>20&&t(),this.startTimer("sections",0,!1,t)}_onMouseMove(t){this.m_alt_on=t.altKey,this.m_ctrl_on=t.ctrlKey,this.m_shift_on=t.shiftKey;let e=(0,s.getMousePos)(t,!1);if(this.m_mouse_dp=e,this._update_ovr(),"sizing"!=this.m_state){const t=this.m_cpage.sectionOnPoint(this._pointToLP(e));t&&(this.m_csection=t)}if("scrolling"==this.m_state){const t=this.m_report.getOrg(),s=this.m_scroll_vt.min/this.m_scroll_vt.max;if("vert"==this.m_hit.subtype){let i=e.y-this.m_hit.delta.y;this.m_report.setOrg(t.x,-i/s)}else{let i=e.x-this.m_hit.delta.x;this.m_report.setOrg(-i/s,t.y)}this._updateSelRect(),this._update_ovr(),this._update()}else if("moving-marker"==this.m_state){e.x=this._snapGrid(e.x,!0),e.y=this._snapGrid(e.y,!1);let t=this.m_state_param.marker,s=this._pointToLP(e);t.pos=(0,o.getMarkOffset)(t.type,s),this.m_state_param.dpos=e,this._update_ovr()}else if("marking"==this.m_state)e.x=this._snapGrid(e.x,!0),e.y=this._snapGrid(e.y,!1),this.m_state_param.pos=e,this._update_ovr();else if("selecting"==this.m_state)this.m_rc_marquee&&(this.m_rc_marquee.width=e.x-this.m_rc_marquee.left,this.m_rc_marquee.height=e.y-this.m_rc_marquee.top,this._update_ovr());else if("moving"==this.m_state){if(e.x-=this.m_state_param.delta.x,e.y-=this.m_state_param.delta.y,e.x=this._snapGrid(e.x,!0),e.y=this._snapGrid(e.y,!1),this.m_shift_on){let t=this.m_state_param.irect_dp;Math.abs(t.left-e.x)>Math.abs(t.top-e.y)?e.y=t.top:e.x=t.left}this._moveSel(e.x,e.y)}else if("sizing"==this.m_state){e.x-=this.m_state_param.delta.x,e.y-=this.m_state_param.delta.y,e.x=this._snapGrid(e.x,!0),e.y=this._snapGrid(e.y,!1);let t=!1,s=0;if(this.m_shift_on)if(this.m_selection.is("section"))t=!0,s=this.m_selection.first.getRect().height;else if(this.m_selection.is("line")){let t,s=this.m_state_param.irect_dp,i=e.x-s.left,o=e.y-s.top;t=i<0?270-180*Math.atan(o/-i)/Math.PI:90+180*Math.atan(o/i)/Math.PI;let n=Math.round(Math.sqrt(i*i+o*o));function r(t){return Math.round(Math.cos(t/180*Math.PI)*n)}function a(t){return Math.round(Math.sin(t/180*Math.PI)*n)}t>330||t<30?(e.x=s.left,e.y=s.top-n):t<60?(e.x=s.left+r(45),e.y=s.top-a(45)):t<120?(e.x=s.left+n,e.y=s.top):t<150?(e.x=s.left+r(45),e.y=s.top+a(135)):t<210?(e.x=s.left,e.y=s.top+n):t<240?(e.x=s.left+r(135),e.y=s.top+a(135)):t<300?(e.x=s.left-n,e.y=s.top):(e.x=s.left+r(225),e.y=s.top+a(225))}else{let t=this.m_state_param.irect_dp;0==t.height?e.y=t.top+Math.round(e.x-t.left):e.y=Math.round(t.top+t.width/t.height*(e.x-t.left))}if(this._sizeSel(e.x,e.y,this.m_hit.subtype),t){let t=this.m_selection.first,e=this.m_cpage.nextSection(t);if(e){let i=e.getRect(),o=t.getRect().height-s;e.size(i.width,i.height-o),this._fixSections()}}}else this.m_scroll_vt&&this.m_scroll_vt.rc.contains(e)?(this.m_hit={type:"scroll",subtype:"vert",delta:new s.Point(0,e.y-this.m_scroll_vt.rc.top),data:null},this._update_ovr(),this._updateCursor(this.m_hit.type,this.m_hit.subtype)):this.m_scroll_hz&&this.m_scroll_hz.rc.contains(e)?(this.m_hit={type:"scroll",subtype:"horz",delta:new s.Point(e.x-this.m_scroll_hz.rc.left,0),data:null},this._update_ovr(),this._updateCursor(this.m_hit.type,this.m_hit.subtype)):(this.m_hit=null,this.m_selection.empty||this.m_selection.locked||(this.m_hit=this._checkSelHitTest(e)),this.m_state||null==this.m_hit&&(this.m_hit=this._checkMarkers(e)),this._updateCursor(this.m_hit?.type,this.m_hit?.subtype))}_checkMarkers(t){let e=this.m_report.getMarks();if(e)for(const s of e){let e=this._pointToDP({x:s.pos,y:s.pos}),i=(0,o.getMarkOffset)(s.type,e),n=(0,o.getMarkOffset)(s.type,t);if(Math.abs(i-n)<4)return{type:"marker",subtype:s.type,delta:{x:i-n,y:i-n},data:s}}return null}_onMouseUp(t){if(this.dom.releasePointerCapture(t.pointerId),"marking"==this.m_state)this.m_report.addMark(this.m_state_param.type,this._pointToLP(this.m_state_param.pos)),this._setDirty(),this._update_ovr();else if("moving-marker"==this.m_state)this._setDirty();else if("selecting"==this.m_state){let t=this._rectToLP(this.m_rc_marquee);if(Math.abs(t.width)<2&&Math.abs(t.height)<2){let e=this.m_report.touchesPt({x:t.left,y:t.top});!e||e instanceof i.CSection?this.m_csection?this.m_selection.set(this.m_csection):this.m_shift_on||this.m_selection.clear():this.m_shift_on?this.m_selection.toggle(e):this.m_selection.set(e)}else{let e=t.right<t.left||t.bottom<t.top;t=t.normalized();let s=this.m_report.select(t,e);this.m_selection.set(s)}}else("moving"==this.m_state||"sizing"==this.m_state)&&this._doneSizeMove();this.m_state=null,this.m_state_param=void 0,this.m_marks=null,this.m_rc_marquee=null,this._update_ovr()}_onDblClick(t){1==this.m_selection.count&&this.m_selection.first.edit()}_checkSelHitTest(t){const e=this.m_selection.dpRect;if(!e)return null;const i=this.m_selection.handles.getParts().find((e=>e.rect.contains(t)));if(i){const e=this._pointToDP({x:i.data.x,y:i.data.y});return{type:"selection",subtype:i.data.code,delta:new s.Point(t.x-e.x,t.y-e.y),data:null}}if(this.m_selection.is("line")){let i=this.m_selection.first,o=this._pointToLP(t);const n=this.m_cpage.getRect();if(o.x-=n.left,o.y-=n.top,i.touchesPt(o))return{type:"selection",subtype:"in",delta:new s.Point(t.x-e.left,t.y-e.top),data:null}}else{let i=e.normalized();if(0==i.width&&(i.left-=1,i.width+=1),0==i.height&&(i.top-=1,i.height+=1),!this.m_selection.is("section")&&i.contains(t)){return{type:"selection",subtype:"in",delta:new s.Point(t.x-e.left,t.y-e.top),data:null}}}return null}_expandSel(t,e){this.m_selection.empty||(this.m_selection.forEach((s=>{const i=s.getRect();s.size(i.width+t,i.height+e)})),this._updateSelRect(),this.m_marks=this._calcMarkers(),this.m_selection.is("section")&&this._fixSections(),this._update(),this._update_ovr(),this._setDirty())}_offsetSel(t,e){this.m_selection.empty||this.m_selection.is("section")||(this.m_selection.forEach((s=>{const i=s.getRect();s.move(i.left+t,i.top+e)})),this._updateSelRect(),this.m_marks=this._calcMarkers(),this._update(),this._update_ovr(),this._setDirty())}_moveSel(t,e){this.m_selection.dpRect.left=t,this.m_selection.dpRect.top=e,this.m_selection.lpRect=this._rectToLP(this.m_selection.dpRect);let s=this.m_selection.lpRect,i=this.m_state_param.irect_lp;if(1==this.m_selection.count){this.m_selection.first.move(s.left,s.top)}else this.m_selection.forEach((t=>{const e=t.extraData.irect_lp,o=e.left-i.left,n=e.top-i.top;t.move(s.left+o,s.top+n)}));this._updateSelRect(),this.m_marks=this._calcMarkers(),this._update(),this._update_ovr(),this._setDirty()}_sizeSel(t,e,i){let o=this.m_selection.dpRect,n=o.left,r=o.right,a=o.width,l=o.top,h=o.bottom,c=o.height;switch(i){case"top-left":case"left":case"bottom-left":n=t,a=r-n;break;case"top-right":case"right":case"bottom-right":a=t-n;break;case"abs":a=t}switch(i){case"top-left":case"top":case"top-right":l=e,c=h-l;break;case"bottom-left":case"bottom":case"bottom-right":c=e-l;break;case"abs":c=e}let m=new s.Rect(n,l,a,c),d=this._rectToLP(m);this.m_selection.dpRect=m,this.m_selection.lpRect=d;let u=this.m_state_param.irect_lp,p=d.width/u.width,_=d.height/u.height;if(1==this.m_selection.count){const t=this.m_selection.first;t.move(d.left,d.top),t.size(d.width,d.height)}else this.m_selection.forEach((t=>{let e=t.getRect(),s=t.extraData.irect_lp,i=s.left-u.left,o=s.top-u.top;e.left=d.left+i*p,e.top=d.top+o*_,e.width=s.width*p,e.height=s.height*_,t.move(e.left,e.top),t.size(e.width,e.height)}));this.m_selection.is("section")&&this._fixSections(),this.m_marks=this._calcMarkers(),this._updateSelRect(),this._update(),this._update_ovr(),this._setDirty()}_calcRel(t,e){const i=e.getRect();return new s.Rect(t).moveBy(-i.left,-i.top)}_onCreate(){this._centerView()}_centerView(){let t=this.m_canvas.getBoundingRect(),e=this._rectToDP(this.m_report.getFullRect());t.left+=u,t.width-=u,t.top+=u,t.height-=u;let{x:s,y:i}=this.m_report.getOrg();t.width>e.width&&(s=u+(t.width-e.width)/2),t.height>e.height&&(i=u+(t.height-e.height)/2),this.m_report.setOrg(s,i)}_zoom(t){"reset"==t?this.m_report.setScale(100):this.m_report.incScale("in"==t?10:-10),this._centerView(),new s.Toaster({message:`Zoom: ${this.m_report.getScale()}%`}).show()}_onMouseWheel(t){if(t.ctrlKey)this._zoom(t.deltaY<0?"in":"out");else{let e=t.deltaY<0?50:-50;t.shiftKey?this.m_report.scroll(e,0):this.m_report.scroll(0,e)}t.stopPropagation(),this._updateSelRect(),this._update(),this._update_ovr()}async _onPaint(t){t.fillStyle=i.Theme.margins,t.fillRect(0,0,t.width+1,t.height+1),t.save();let e=this.m_canvas.getBoundingRect().moveTo(0,0);const s=this._rectToLP(e);this.m_painter.startDoc({ctx:t,view:s}),this.m_report.renderItem(this.m_painter,{mode:"edit",getFont:null,getImage:null}),await this.m_painter.endDoc(),t.restore()}_paint_marquee(t){let e=this.m_rc_marquee.normalized();this.m_selection.is("line")||(e=e.normalized(),t.beginPath(),t.strokeStyle=i.Theme.selection.lines,t.fillStyle=i.Theme.selection.back,t.rect(e.left,e.top,e.width,e.height),t.fill(),t.stroke())}_paint_selection(t){const e=this.m_selection;let n=e.dpRect;if(!n)return;t.save(),"moving"!=this.m_state&&"sizing"!=this.m_state||(t.globalAlpha=.3);let r=!1;const a=e.locked?i.Theme.selection.locked:i.Theme.selection.lines;t.strokeStyle=a,t.beginPath(),e.is("line")?(t.moveTo(n.left,n.top),t.lineTo(n.right,n.bottom),t.stroke()):e.is("section")?(r=!0,t.moveTo(n.left,n.bottom),t.lineTo(n.right,n.bottom)):(n=n.normalized(),t.rect(n.left,n.top,n.width,n.height)),t.stroke(),t.beginPath(),e.handles.forEach((e=>{t.rect(e.rect.left,e.rect.top,e.rect.width,e.rect.height)})),t.fillStyle=i.Theme.selection.handles,t.stroke(),t.fill(),t.restore();let l=e.lpRect;if(!l.isEmpty()){const a=this.m_report.getUnits(),h=(0,s.roundTo)(l.width,1),c=(0,s.roundTo)(l.height,1);let m=r?`${Math.abs(c)} ${a}`:`${Math.abs(h)} x ${Math.abs(c)} ${a}`,d=r?"":1==e.count?`${e.first.getComputedName()} : `:(0,s.sprintf)(s._tr.builder.multi_sel,e.count);(0,o.showLabel)(t,d+m,n.left,n.bottom+4,i.Theme.selection.label.back,i.Theme.selection.label.text)}}_paint_construction_marks(t){t.save(),t.beginPath(),t.lineWidth=1.5;this.m_marks.hmarks.forEach((e=>{let s=[];for(let t=0;t<e.dpos.length;t++)s.push(this._pointToDP({x:e.pos,y:e.dpos[t]}));let o=s.length-1;t.beginPath(),t.moveTo(s[0].x,s[0].y),t.lineTo(s[o].x,s[o].y),s.forEach((e=>{t.moveTo(e.x-2,e.y+2),t.lineTo(e.x+2,e.y-2),t.moveTo(e.x+2,e.y+2),t.lineTo(e.x-2,e.y-2)})),t.strokeStyle=i.Theme.marks.vert,t.stroke()})),this.m_marks.vmarks.forEach((e=>{let s=[];for(let t=0;t<e.dpos.length;t++)s.push(this._pointToDP({y:e.pos,x:e.dpos[t]}));let o=s.length-1;t.beginPath(),t.moveTo(s[0].x,s[0].y),t.lineTo(s[o].x,s[o].y),s.forEach((e=>{t.moveTo(e.x-2,e.y+2),t.lineTo(e.x+2,e.y-2),t.moveTo(e.x+2,e.y+2),t.lineTo(e.x-2,e.y-2)})),t.strokeStyle=i.Theme.marks.horz,t.stroke()})),t.restore()}_paint_scrollbars(t){const e=this.m_canvas.getBoundingRect();e.top+=u,e.height-=u;const i="scrolling"==this.m_state;let o=this._rectToDP(this.m_report.getFullRect()),n=this.m_report.getScale(),r={...this.m_report.getOrg()};r.x*=n/100,r.y*=n/100;let a=Math.min(o.top,e.top),l=Math.max(o.bottom,e.bottom),h=Math.max(l-a,e.height);if(h>e.height||i&&this.m_scroll_vt){let n=8,a=i,l=-o.top/h*e.height,c=i?this.m_scroll_vt.rc.height:e.height/h*e.height;"scroll"==this.m_hit?.type&&"vert"==this.m_hit.subtype&&(a=!0,n=10);const m=new s.Rect(e.width-4-n/2,u+l,n,c);this.m_scroll_vt={rc:m,min:e.height,max:h,pos:r.y},t.beginPath(),t.rect(m.left,m.top,m.width,m.height),t.fillStyle=a?"black":"rgba(0,0,0,0.5)",t.fill()}else this.m_scroll_vt=null;let c=Math.min(o.left,e.left),m=Math.max(o.right,e.width),d=Math.max(m-c,e.width);if(d>e.width||i&&this.m_scroll_hz){let n=8,a=i,l=-o.left/d*e.width,h=i?this.m_scroll_hz.rc.width:e.width/d*e.width;"scroll"==this.m_hit?.type&&"horz"==this.m_hit.subtype&&(a=!0,n=10);const c=new s.Rect(u+l,e.height-4-n/2,h,n);this.m_scroll_hz={rc:c,min:e.width,max:d,pos:r.y},t.beginPath(),t.rect(c.left,c.top,c.width,c.height),t.fillStyle=a?"black":"rgba(0,0,0,0.5)",t.fill()}else this.m_scroll_hz=null}_paint_ovr(t){t.clearRect(0,0,t.width+1,t.height),this.m_rc_marquee&&this._paint_marquee(t),this.m_selection.empty||this._paint_selection(t),this.m_marks&&this._paint_construction_marks(t);let e=this.m_canvas.getBoundingRect();if(e.moveTo(0,0),"marking"==this.m_state||"moving-marker"==this.m_state){const n="marking"==this.m_state,r=n?this.m_state_param.type:this.m_state_param.marker.type,a=n?this.m_state_param.pos:this.m_state_param.dpos,l=n?this._pointToLP(a):{x:this.m_state_param.marker.pos,y:this.m_state_param.marker.pos};let h=(0,o.getMarkOffset)(r,a),c=(0,o.getMarkOffset)(r,l);const m=this.m_report.getUnits(),d=(0,s.roundTo)(c,2)+m;n&&(0,o.paintMarker)(t,r,h,e),"hmark"==r?(0,o.showLabel)(t,d,h+20,this.m_state_param.pos.y+20,i.Theme.selection.lines,i.Theme.size.text):(0,o.showLabel)(t,d,this.m_state_param.pos.x+20,h+20,i.Theme.selection.lines,i.Theme.size.text)}this._paintRulers(t);let n=this.m_report.getMarks();n&&n.forEach((s=>{let i=this._pointToDP({x:s.pos,y:s.pos});(0,o.paintMarker)(t,s.type,(0,o.getMarkOffset)(s.type,i),e)})),this._paint_scrollbars(t)}_paintRulers(t){if(!this.m_cpage)return;let e=this.m_cpage.getRect();this.m_csection&&(e=this.m_csection.getRect());const s=this._rectToDP(e),o=this.m_canvas.getBoundingRect().moveTo(0,0),r=this.m_report.getUnits(),a=(0,n.u2px)(1,r)*this.m_report.getScale()/100;let l=1;"in"==r?l=.1:"px"==r&&(l=10);const h=a*l,c=this.m_mouse_dp?this._pointToLP(this.m_mouse_dp):void 0;t.beginPath(),t.rect(0,0,o.width,u),t.rect(0,u,u,o.height-u),t.fillStyle=i.Theme.rulers.back,t.fill(),t.beginPath(),t.rect(0,0,s.left,u),t.rect(s.right,0,o.width-s.right+u,u),t.rect(0,u,u,s.top-u),t.rect(0,s.bottom,u,o.height-s.top),t.fillStyle=i.Theme.rulers.outside,t.fill(),t.beginPath(),t.fillStyle=i.Theme.rulers.text,t.textBaseline="bottom",t.textAlign="center";for(let e=0,i=0;e<s.width+h;e+=h,i++)i%10==0?(t.moveTo(e+s.left,u),t.lineTo(e+s.left,14),t.fillText(i*l+"",e+s.left,13)):h>3&&(t.moveTo(e+s.left,u),t.lineTo(e+s.left,18));t.textBaseline="bottom",t.textAlign="center";for(let e=0,i=0;e<s.height+h;e+=h,i++)i%10==0?(t.moveTo(u,e+s.top),t.lineTo(14,e+s.top),t.save(),t.translate(13,e+s.top),t.rotate((0,n.deg2rad)(-90)),t.fillText(i+"",0,0),t.restore()):h>3&&(t.moveTo(u,e+s.top),t.lineTo(18,e+s.top));if(t.strokeStyle=i.Theme.rulers.mark,t.stroke(),c){t.beginPath();const e=this._snapGrid(s.left+c.x*a,!0);t.moveTo(e,0),t.lineTo(e,u);const o=this._snapGrid(s.top+c.y*a,!1);t.moveTo(0,o),t.lineTo(u,o),t.strokeStyle=i.Theme.rulers.cursor,t.stroke()}}_calcSelRect(){if(this.m_selection.empty)return;let t,e=null;if(1==this.m_selection.count){const s=this.m_selection.first;e=s.getAbsRect(!1),t=s.getHandles(e.left,e.top)}else this.m_selection.forEach((t=>{let s=t.getAbsRect();e?e.combine(s):e=s})),t=i.CElement.makeHandles(e);const o=new i.Region;t.forEach((t=>{const e=this._rectToDP(new s.Rect(t.x,t.y,0,0)).inflatedBy(4);o.touches(e)||o.add(e,t)})),this.m_selection.lpRect=e,this.m_selection.dpRect=this._rectToDP(e),this.m_selection.handles=o}_updateSelRect(){this._calcSelRect(),this._update_ovr()}_showCtxMenu(t){let e,i=t.target;if("TEXTAREA"!=i.nodeName&&"INPUT"!=i.nodeName){if(this.m_selection.empty)e=[new s.MenuItem({text:s._tr.global.paste,click:()=>this._paste()}),new s.MenuSeparator];else{let t=[];1==this.m_selection.count&&(t=this.m_selection.first.getContextMenu().map((t=>new s.MenuItem(t))),t.length&&t.push(new s.MenuSeparator)),e=[...t,new s.MenuItem({icon:"resources/img/layer-group-regular.svg",text:s._tr.builder.tools.arrange,items:[new s.MenuItem({icon:"resources/img/bring-front-solid.svg",text:s._tr.builder.tools.bring_front,click:()=>this._sendBack("front")}),new s.MenuItem({icon:"resources/img/bring-forward-solid.svg",text:s._tr.builder.tools.bring_forward,click:()=>this._sendBack("after")}),new s.MenuItem({icon:"resources/img/send-backward-solid.svg",text:s._tr.builder.tools.send_backward,click:()=>this._sendBack("before")}),new s.MenuItem({icon:"resources/img/send-back-solid.svg",text:s._tr.builder.tools.send_back,click:()=>this._sendBack("back")})]}),new s.MenuSeparator,new s.MenuItem({icon:"resources/img/cut.svg",text:s._tr.global.cut,click:()=>this._delSelection()}),new s.MenuItem({icon:"resources/img/copy.svg",text:s._tr.global.copy,click:()=>this._copy()}),new s.MenuItem({icon:"resources/img/paste.svg",text:s._tr.global.paste,click:()=>this._paste()}),new s.MenuSeparator]}new s.Menu({items:[...e,new s.MenuItem({text:s._tr.builder.try_report+" (html)",click:()=>this._tryReportHtml()}),new s.MenuItem({text:s._tr.builder.try_report+" (pdf)",click:()=>this._tryReport()})]}).displayAt(t.clientX,t.clientY,"top left")}}async _tryReport(){let t=h.host.getPath("temp")+"/test.pdf";new m.PDFRenderer(this.m_report).render("pdf",{output:t,paintCtx:{printInfo:{rootData:(0,d.parseJSON)(this.m_report.getDataSample())}},callback:()=>{new s.Dialog({width:"75%",height:"75%",title:"PDF Viewer",closable:!0,movable:!0,sizable:!0,maximizable:!0,content:[new s.Component({tag:"embed",cls:"@pdfobject",attrs:{width:"100%",height:"100%",type:"application/pdf",src:"file:///"+t}})]}).show()}})}async _tryReportHtml(){let t=h.host.getPath("temp")+"/test.html";new m.PDFRenderer(this.m_report).render("html",{output:t,paintCtx:{printInfo:{rootData:(0,d.parseJSON)(this.m_report.getDataSample())}},callback:()=>{new s.Dialog({width:"75%",height:"75%",title:"HTML Viewer",closable:!0,movable:!0,sizable:!0,maximizable:!0,content:[new s.Component({tag:"iframe",attrs:{width:"100%",height:"100%",src:"file:///"+t}})]}).show()}})}_update(){this.m_canvas.redraw(1)}_update_ovr(){this.m_ovr_canvas.redraw(0)}_updateCursor(t,e){let s="url(resources/img/pointer.png) 4 4, crosshair";switch(t){case"scroll":s="pointer";break;case"marker":switch(e){case"hmark":s="col-resize";break;case"vmark":s="row-resize"}break;case"selection":switch(e){default:case"in":s="move";break;case"top-left":case"bottom-right":s="se-resize";break;case"top-right":case"bottom-left":s="ne-resize";break;case"top":case"bottom":s="ns-resize";break;case"left":case"right":s="ew-resize"}}s!==this.m_cursor&&(this.m_cursor=s,this.setStyleValue("cursor",this.m_cursor))}_snapGrid(t,e){let s=t;if(this.m_report.getData("grid_on")&&this.m_report.getData("grid_size")>0&&!this.m_alt_on){const i=this.m_report.getScale()/100;let o=this.m_report.getData("grid_size")*i;const r=this.m_report.getOrg();t-=e?r.x:r.y,s=(0,n.px2u)(t,this.m_report.getUnits()),s=Math.round(s/o)*o,s=(0,n.u2px)(s,this.m_report.getUnits()),s+=e?r.x:r.y}return s}_calcMarkers(){if(this.m_selection.empty)return null;let t=[],e=[],s=!1;function o(t,e,...i){s=!0;let o=t.find((t=>t.pos==e));o?i.forEach((t=>o.dots.add(t))):t.push({pos:e,dots:new Set(i),dpos:null})}function n(t,e){return Math.abs(t-e)<1e-4}let r=this.m_selection.lpRect,a=r.left+r.width/2,l=r.top+r.height/2;this.m_report.getChildren(!0,!0).forEach((s=>{if(s instanceof i.CSection)return;if(this.m_selection.find(s)>=0)return;let h=s.getAbsRect(),c=h.left+h.width/2;(n(r.left,h.left)||n(r.left,h.right)||n(r.left,c))&&o(t,r.left,h.top,h.bottom,r.top,r.bottom),(n(r.right,h.left)||n(r.right,h.right)||n(r.right,c))&&o(t,r.right,h.top,h.bottom,r.top,r.bottom),n(c,a)&&o(t,c,h.top,h.bottom,l);s.getPage();c=h.top+h.height/2,(n(r.top,h.top)||n(r.top,h.bottom)||n(r.top,c))&&o(e,r.top,h.left,h.right,r.left,r.right),(n(r.bottom,h.top)||n(r.bottom,h.bottom)||n(r.bottom,c))&&o(e,r.bottom,h.left,h.right,r.left,r.right),n(c,l)&&o(e,c,h.left,h.right,a)}));let h=this.m_report.getMarks(),c=this._rectToLP(this.getBoundingRect().moveTo(0,0));return h&&h.forEach((s=>{"hmark"==s.type?(n(r.left,s.pos)||n(r.right,s.pos)||n(a,s.pos))&&o(t,s.pos,c.top,c.bottom):"vmark"==s.type&&(n(r.top,s.pos)||n(r.bottom,s.pos)||n(l,s.pos))&&o(e,s.pos,c.left,c.right)})),s?(t.forEach((t=>{t.dpos=[...t.dots.values()].sort(((t,e)=>t-e)),t.dots=null})),e.forEach((t=>{t.dpos=[...t.dots.values()].sort(((t,e)=>t-e)),t.dots=null})),{hmarks:t,vmarks:e}):null}_fillProperties(){let t;if(this.m_selection.empty?t=this.m_report:1==this.m_selection.count&&(t=this.m_selection.first),t){let e=t.buildEditors();this.m_props_cont.setContent(e,!1),t.fill(this.m_props_cont,!1)}else this.m_props_cont.setContent([],!1);this.m_curObject=t}_createReport(t){this.m_hit=null,this.m_report=new a.EReport(t),this.m_report.setPlugins(this.m_plugins),this.m_report.setDataSources(this.m_datasources),this.m_painter.setResources(this.m_report.getResources()),this.m_cpage=this.m_report.getCurPage(),this.m_cpage.fixZOrder(),this.m_csection=null,this.m_selection.clear(!1),this._updateCursor(null,null)}getNodeByUID(t){return this.m_uid_cache&&this.m_uid_cache.has(t)||(this.m_uid_cache=new Map,this.m_report.forEach((t=>this.m_uid_cache.set(t.getUID(),t)),!0)),this.m_uid_cache.get(t)}_fillHierarchy(){if("moving"==this.m_state||"sizing"==this.m_state)return;const t=function t(e){let s,o=e.getElementName(),n=e.getData("name"),r=e.getUID();switch(o){case"page":case"report":break;case"text":s="resources/img/btn-text.svg";break;case"line":s="resources/img/btn-line.svg";break;case"image":s="resources/img/btn-image.svg";break;case"section":s="resources/img/btn-section.svg",n=e.getComputedName();break;case"custom":s="resources/img/btn-special.svg";break;case"rectangle":s="resources/img/btn-rect.svg";break;case"ellipse":s="resources/img/btn-circle.svg";break;default:console.error("unknown type",o)}const a={id:r,text:n??o,icon:s,cls:o};if(e instanceof i.CContainer){const s=[];e.forEach((e=>{s.push(t(e))}),!1),a.children=s,a.open=!0}return a}(this.m_report);this.m_hierarchy.refreshRoot(t)}clear(){this._clear(!1)}_clear(t){this.m_selection.clear(),this.m_hit=null,this.m_state=null,this.m_state_param=null,this.m_dirty=!1,t||(this._createReport(null),this._centerView(),this._update(),this._update_ovr(),this._fillProperties(),this._fillHierarchy())}isDirty(){return this.m_dirty}_setDirty(){this.m_dirty=!0}load(t){this._clear(!0),this._createReport(t),this._centerView(),this._fillProperties(),this._update(),this._update_ovr(),i.userColors.clear(),this.m_report.enumColors(i.userColors),this.m_edScript.report=this.m_report,this.m_edDSource.source=this.m_report.getDataSource(),this.m_edDSample.source=this.m_report.getDataSample(),this._fillHierarchy(),t.builder_options&&(this.m_report.setOrg(t.builder_options.org.x,t.builder_options.org.y),this.m_report.setScale(t.builder_options.scale))}save(){this.m_dirty=!1;let t=this.m_report.save(),e={org:this.m_report.getOrg(),scale:this.m_report.getScale()};return t.builder_options=e,t}async _addUndo(){let t=[];this.m_selection.forEach((e=>{t.push(e.getUID())}));let e={org:this.m_report.getOrg(),scale:this.m_report.getScale(),data:this.m_report.save(),selection:t},s=JSON.stringify(e),i=await h.host.compress(Buffer.from(s));this.m_undoStack.push(i),this.m_undoSize+=i.length,(this.m_undoSize>1e7||this.m_undoStack.length>100)&&this.m_undoStack.shift()}async _undo(){let t=this.m_undoStack.pop();if(t){this.m_undoSize-=t.length,this.m_selection.clear();const e=await h.host.decompress(t),s=JSON.parse(e.toString());this._createReport(s.data),this.m_report.setOrg(s.org.x,s.org.y),this.m_report.setScale(s.scale);let i=new Map;this.m_report.forEach((t=>i.set(t.getUID(),t)),!0);let o=[];s.selection.forEach((t=>{let e=i.get(t);e&&o.push(e)})),this.m_selection.set(o),this._fillHierarchy()}}}function p(t){t.ctrlKey&&t.preventDefault()}e.ReportBuilder=ReportBuilder})),define("src/i18n",["require","exports"],(function(t,e){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.EN=e.FR=void 0,e.FR={menus:{},main:{recent_files:"Fichiers récents",start:"Démarrer",open:"Ouvrir...",new:"Nouveau",file_saved:"Modifications enregistrées",invalid_format:"Format de fichier invalide",ask_save:"Voulez-vous enregistrer les modifications ?",about:"A propos",copyright:"<p>Copyright © 2021 R-Libre. Tous droits réservés</p><p><i style='font-size:80%'>Avertissement : Ce programme est protégé par la loi sur le droit d'auteur et les conventions internationales. Toute reproduction ou distribution partielle ou totale du logiciel, par quelque moyen que ce soit, est strictement interdite. Toute personne ne respectant pas ces dispositions se rendra coupable du délit de contrefaçon et sera passible des sanctions pénales prévues par la loi.</i></p>"},builder:{section_sections:"Sections...",section_header:"Entête",section_footer:"Pied_de_page",section_normal:"Standard",section_dochead:"Page_de_garde",section_docback:"Dernière_de_couverture",tools:{objects:"Objets",text:"Texte",line:"Ligne",rect:"Rectangle",ellipse:"Cercle",image:"Image",alignment:"Alignements",left:"Gauche",center:"Centre",right:"Droite",top:"Haut",middle:"Milieu",bottom:"Bas",dist_hz:"Distribution Hz",dist_vt:"Distribution Vt",arrange:"Ordre",bring_front:"Amener devant",bring_forward:"Monter",send_backward:"Descendre",send_back:"Envoyer derrière"},tabs:{designer:"Designer",script:"Script",datasource:"Data Source"},confirm_del_page:"Voulez-vous réellement supprimer la page et tous ce qu'elle contient ?",confirm_del_section:"Voulez-vous réellement supprimer la section et tout ce qu'elle contient ?",multi_sel:"multiple( {0} ): ",try_report:"Essayer le rapport"},elements:{properties:"Propriétés",position:"Position",defaults:"Défauts",links:"Liens",name:"nom",bad_name:"le nom ne peut comporter que des lettres ou '_'.",link:"lien",fill:"Remplissage",lock:"Vérouillé",image:{click_to_choose:"cliquez pour choisir l'image...",fit:"Alignement",cover:"Recouvrement",contain:"Contenu",fill:"Remplissage"},line:{title:"Ligne",caps:"terminaison",round:"round",square:"square",butt:"butt"},page:{pageno:"Page {0}",size:"Taille",width:"largeur",height:"hauteur",orientation:"Orientation",portrait:"portrait",landscape:"paysage",font:"police"},report:{font:{as_doc:"<idem document>",as_page:"<idem page>"},grid:"Grille",grid_mode:"Mode",grid_size:"taille",units:"Unités",font_name:"Police",resources:"Ressources",images:"Images...",fonts:"Polices..."},section:{break:"Rupture",break_none:"aucune",break_before:"avant",break_after:"après",name_header:"Entête",name_footer:"Pied_de_page",name_body:"Contenu",name_dochead:"Page_de_garde",name_docback:"Dernière_de_couverture",split:"Séccable",repeat:"Répétitions"},shape:{extra:"Extra",percent:"pourcentage",border:"Bordure"},text:{border:"Bordure",font:"Police",alignment:"Alignement",spacing:"Espacement",lineheight:"haut. ligne",padding:"padding",rotation:"Rotation",rotation2:"rotation",text:"Texte",autogrow:"grossissement auto",nowwrap:"sans retour auto",radius:"rayon"}},datasources:{document:{description:"Document",pagenum:"Numéro de page",pagecount:"Nombre de pages",name:"Nom du document"},system:{description:"Système",date:"Date courante"}},explorer:{add:"Ajouter",del:"Supprimer"},textedit:{field:"Champ",field_tip:"Insère un champd e données",icon:"Icone",icon_tip:"Insère une icone ou une emoji (windows + ';')",prompt:"Saisissez le codepoint de l'icone (ex: f012)",title:"Saisie de texte",script:"Script",field_sel:"Sélection de champ"}},e.EN={main:{recent_files:"Recent files",start:"Start",open:"Open...",new:"New",file_saved:"Modifications saved",invalid_format:"Invalid file formar",ask_save:"Do you wan't to save modifications ?",about:"About",copyright:"<p>Copyright © 2021 R-Libre. Tous droits réservés</p><p><i style='font-size:80%'>Disclaimer: This program is protected by copyright law and international conventions.Any reproduction or partial or total distribution of the software, by any means whatsoever, is strictly prohibited.Anyone not respecting these provisions will be guilty of the offense for counterfeit and will be liable to the criminal penalties provided for by law.</i></p>"},builder:{section_sections:"Sections...",section_header:"Header",section_footer:"Footer",section_normal:"Standard",section_dochead:"Cover page",section_docback:"Back cover",tools:{objects:"Objects",text:"Text",line:"Line",rect:"Rectangle",ellipse:"Circle",image:"Image",alignment:"Alignments",left:"Left",center:"Center",right:"Right",top:"Top",middle:"Middle",bottom:"Bottom",dist_hz:"Distribute Hz",dist_vt:"Distribute Vt",arrange:"Arrange",bring_front:"Bring to front",bring_forward:"Bring forward",send_backward:"Send backward",send_back:"Send to back"},tabs:{designer:"Designer",script:"Script",datasource:"Data Source"},confirm_del_page:"Do you really wan't to delete the page and all of its elements ?",confirm_del_section:"Do you really wan't to delete the section and all of its elements ?",multi_sel:"multiple( {0} ): ",try_report:"Try..."},elements:{properties:"Properties",position:"Position",defaults:"Defaults",links:"Links",name:"name",bad_name:"name must be letters or '_'.",link:"link",fill:"Fill",lock:"Lock",image:{click_to_choose:"click to choose the image...",fit:"Alignment",cover:"Cover",contain:"Contain",fill:"Fill"},line:{title:"Line",caps:"line end",round:"round",square:"square",butt:"butt"},page:{pageno:"Page {0}",size:"Page size",width:"width",height:"height",orientation:"Orientation",portrait:"portrait",landscape:"landscape",font:"font"},report:{font:{as_doc:"<as document>",as_page:"<as page>"},grid:"Grid",grid_mode:"Grid mode",grid_size:"size",units:"Units",font_name:"Font",resources:"Resources",images:"Images...",fonts:"Fonts..."},section:{break:"break",break_none:"none",break_before:"before",break_after:"after",name_header:"Header",name_footer:"Footer",name_body:"Body",name_dochead:"Cover page",name_docback:"Back cover",split:"Splittable",repeat:"Repeat count"},shape:{extra:"Extra",percent:"percent",border:"Bordure"},text:{border:"Border",font:"Font",alignment:"Alignment",spacing:"Spacing",lineheight:"line height",padding:"padding",rotation:"Rotation",rotation2:"rotation",text:"Text",autogrow:"auto grow",nowwrap:"no word wrap",radius:"radius"}},datasources:{document:{description:"Document object",pagenum:"Page number",pagecount:"Page count",name:"Document name"},system:{description:"System Object",date:"Current date"}},explorer:{add:"Ajouter",del:"Supprimer"},textedit:{field:"Field",field_tip:"Insert a data field",icon:"Icon",icon_tip:"Insert icon or emoji (windows + ';')",prompt:"Enter the icon code point (ex: f012)",title:"Text input",script:"Script",field_sel:"Field selection"}}})),define("src/main_designer",["require","exports","src/x4mod","src/tools","src/tools/plugins","x4/hosts/electron","src/builder","src/i18n"],(function(t,e,s,i,o,n,r,a){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.editor=e.Editor=void 0,(0,s.extendTranslation)("fr",a.FR),(0,s.selectLanguage)("fr"),n.host.ipc.send("setLang","fr"),globalThis._tr=s._tr;let l="";(0,i.isElectron)();{const{ipcRenderer:t}=n.host.require("electron");t.on("openFile",(()=>e.editor.openFile())),t.on("createFile",(()=>e.editor.createFile())),t.on("save",(()=>e.editor.save())),t.on("saveAs",(()=>e.editor.saveAs())),t.on("undo",(()=>e.editor.exec("undo"))),t.on("cut",(()=>e.editor.exec("cut"))),t.on("copy",(()=>e.editor.exec("copy"))),t.on("paste",(()=>e.editor.exec("paste"))),t.on("zoomin",(()=>e.editor.exec("zoomin"))),t.on("zoomout",(()=>e.editor.exec("zoomout"))),t.on("about",(()=>e.editor.showAbout())),t.on("quit",(()=>e.editor.askQuit()));const s=n.host.require("./package.json");l=s.title,(0,i.setWindowTitle)(l)}class OpenBox extends s.Dialog{constructor(){let t;super({width:800,height:450,title:"",movable:!0,closable:!0}),this.form.updateContent([new s.HLayout({cls:"main",content:[new s.Image({src:"./resources/img/logo-red.svg"}),new s.Label({text:l})]}),new s.HLayout({flex:1,content:[new s.Panel({flex:1,title:s._tr.main.recent_files,content:[t=new s.ListView({flex:1,items:[],renderItem:t=>new s.HLayout({tooltip:t.id,content:[new s.Label({flex:1,text:t.text}),new s.Label({text:t.data.date})]}),click:t=>{let s=t.context;e.editor.load(s.id),this.close()}})]}),new s.Panel({flex:1,title:s._tr.main.start,content:[new s.ListView({flex:1,items:[{id:1,icon:63490,text:s._tr.main.open},{id:2,icon:63070,text:s._tr.main.new}],renderItem:t=>new s.HLayout({content:[new s.Icon({icon:t.icon}),new s.Label({text:t.text})]}),click:t=>{let s=t.context;switch(this.close(),s.id){case 1:e.editor.openFile();break;case 2:e.editor.createFile()}}})]})]})],[new s.Button({text:s._tr.global.cancel,click:()=>this.close()})]),this._fillItems(t)}async _fillItems(t){let i=n.host.require("path"),o=e.editor.local_storage.get("last_open",[]),r=[];for(let t of o)try{let e=n.host.stat(t);e&&r.push({id:t,text:i.basename(t),data:{date:(0,s.formatIntlDate)(new Date(e.atime))}})}catch(t){}t.items=r}}class MainPage extends s.VLayout{m_editor;constructor(t){super(t)}render(){this.setContent([this.m_editor=new r.ReportBuilder({flex:1})])}save(){return this.m_editor.save()}load(t){this.m_editor.load(t)}new(){this.m_editor.clear()}isDirty(){return this.m_editor.isDirty()}componentCreated(){(new OpenBox).show(!0);const t=process.cwd();console.log(`looking into '${t}' for plugins & datasources`),(0,o.loadPlugins)(t+"/plugins",(t=>{this.m_editor.registerPlugin(t)})),this.loadDataSources(t+"/datasources")}async loadDataSources(t){try{let e=await n.host.readDir(t);for(let s of e){let e=t+"/"+s,i=e;n.host.stat(e).isDir&&(e=t+"/"+s+"/"+s+".js");try{let t=await n.host.readUtf8(e),o=new Function(t)();o&&"elements"in o&&(o.name=n.host.getPathPart(s,"filename"),o.basedir=i,this.m_editor.registerDataSource(o))}catch(t){console.error(`error loading datasource ${s}`,t)}}}catch(t){}}exec(t){this.m_editor.exec(t)}}class Editor extends s.Application{debugMode;m_file_name;m_editor;constructor(){const t=n.host.require("./package.json");super({app_name:t.title,app_version:t.version,app_uid:t.name+"-"+t.version,locale:"fr-FR"}),this.debugMode=0,this.user_data.app_path=process.cwd()+"/data/",this.m_editor=new MainPage({cls:"x-fit",id:"root"}),this.mainView=this.m_editor}openFile(){(0,i.openFile)({"packed file":"report","json file":"report.json"},(t=>{this.load(t[0])}))}createFile(){this.new()}save(){this.m_file_name?this._save(this.m_file_name):this.saveAs()}saveAs(){(0,i.saveFile)("no-name",{"packed file":"report","json file":"report.json"},(t=>{t&&(this._save(t),this.m_file_name=t,this._addLastOpen(t),(0,i.setWindowTitle)(l+" - "+t))}))}exec(t){this.m_editor.exec(t)}_addLastOpen(t){let e=this.local_storage.get("last_open",[]),s=e.indexOf(t);s>=0&&e.splice(s,1),e.unshift(t),this.local_storage.set("last_open",e)}async _save(t){const e=this.m_editor.save();let i=JSON.stringify(e);try{if(t.match(/.*\.json$/gi))await n.host.writeUtf8(t,i);else{let e=await n.host.compress(Buffer.from(i));await n.host.writeBinary(t,e)}new s.Toaster({message:s._tr.main.file_saved}).show()}catch(t){console.log(t),s.MessageBox.show(t)}}async load(t,e=!1){this._askSave((async()=>{try{let e;if(t.match(/.*\.json$/gi)){const s=await n.host.readUtf8(t);try{e=JSON.parse(s)}catch(t){const i=s.replace(/\/\/[^"]*$/gm,"");e=JSON.parse(i)}}else{let s=await n.host.readBinary(t);const i=await n.host.decompress(s);e=JSON.parse(i.toString())}if(!e)throw new Error(s._tr.main.invalid_format);this.m_file_name=t,this._addLastOpen(t),this.m_editor.load(e),(0,i.setWindowTitle)(l+" - "+t)}catch(t){console.error(t),e||s.MessageBox.alert(t.message)}}))}new(){this._askSave((()=>{this.m_file_name=void 0,this.m_editor.new(),(0,i.setWindowTitle)(l)}))}askQuit(){this._askSave((()=>{n.host.ipc.sendSync("quit")}))}_askSave(t){this.m_editor.isDirty()?s.MessageBox.show({message:s._tr.main.ask_save,buttons:["yes","no","cancel"],click:e=>{"yes"==e?(this.save(),t()):"no"==e&&t()}}):t()}showAbout(){const t=n.host.require("./package.json");new s.Dialog({title:s._tr.main.about,cls:"@about-box",width:600,content:[new s.HLayout({cls:"main",content:[new s.Image({src:"./resources/img/logo-red.svg"}),new s.Label({text:l})]}),new s.Label({text:new s.HtmlString(`<p>Version: ${t.version}</p><p>Electron: ${process.versions.electron}</p>`+s._tr.main.copyright)})],buttons:[new s.Link({text:"site web",href:"#",click:()=>{(0,i.openExternal)("https://r-libre.fr")}}),new s.Flex,"ok"]}).show()}enterModal(t){n.host.ipc.send("enableMenubar",!t)}}e.Editor=Editor,e.editor=new Editor,(0,s.initTooltips)()})),define("x4/base64",["require","exports"],(function(t,e){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Base64=void 0;const s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";let i=null;class Base64{lookup=null;static encode(t){let e;t instanceof Uint8Array?(e=[],t.forEach((t=>{e.push(t)}))):e=Base64._toUtf8(t);let i,o,n=-1,r=e.length,a=[,,,],l="";for(;++n<r;)i=e[n+1],o=e[n+2],a[0]=e[n]>>2,a[1]=(3&e[n])<<4|e[++n]>>4,isNaN(i)?a[2]=a[3]=64:(a[2]=(15&e[n])<<2|e[++n]>>6,a[3]=isNaN(o)?64:63&e[n]),l+=s[a[0]]+s[a[1]]+s[a[2]]+s[a[3]];return l}static decode(t){let e=Base64._fromUtf8(t),s=0,i=e.length,o="";for(;s<i;)e[s]<128?o+=String.fromCharCode(e[s++]):e[s]>191&&e[s]<224?o+=String.fromCharCode((31&e[s++])<<6|63&e[s++]):o+=String.fromCharCode((15&e[s++])<<12|(63&e[s++])<<6|63&e[s++]);return o}static _toUtf8(t){let e,s=-1,i=t.length,o=[];if(/^[\x00-\x7f]*$/.test(t))for(;++s<i;)o.push(t.charCodeAt(s));else for(;++s<i;)e=t.charCodeAt(s),e<128?o.push(e):e<2048?o.push(e>>6|192,63&e|128):o.push(e>>12|224,e>>6&63|128,63&e|128);return o}static _fromUtf8(t){let e,o=-1,n=[],r=[,,,];if(!i){for(e=s.length,i={};++o<e;)i[s[o]]=o;o=-1}for(e=t.length;o<e&&(r[0]=i[t.charAt(++o)],r[1]=i[t.charAt(++o)],n.push(r[0]<<2|r[1]>>4),r[2]=i[t.charAt(++o)],64!=r[2])&&(n.push((15&r[1])<<4|r[2]>>2),r[3]=i[t.charAt(++o)],64!=r[3]);)n.push((3&r[2])<<6|r[3]);return n}}e.Base64=Base64})),define("x4/fileupload",["require","exports","x4/component","x4/layout","x4/input","x4/image"],(function(t,e,s,i,o,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.saveFile=e.openFile=e.ImageUpload=e.FileUpload=void 0;class FileUpload extends i.HLayout{constructor(t){super(t)}clear(){this.m_props.value=""}}e.FileUpload=FileUpload;e.ImageUpload=class ImageUpload extends FileUpload{m_path;m_ui_img;m_ui_input;render(t){let e="up"+this.uid;this.setContent([new s.Component({tag:"label",attrs:{for:e},content:[this.m_ui_img=new n.Image({src:this.m_props.value})]}),this.m_ui_input=new o.Input({cls:"@hidden",id:e,type:"file",name:this.m_props.name,value_hook:{get:()=>this._get_value(),set:t=>{this._set_value(t)}},attrs:{accept:"image/*"},dom_events:{change:t=>{this._handleChange(t)}}})])}clear(){super.clear(),this.m_ui_input.dom.value="",this.m_ui_img.setImage(null,!1)}_get_value(){return this.m_path}_set_value(t){}_handleChange(t){let e=this;function s(t){let s=new FileReader;s.addEventListener("load",(t=>{e.m_ui_img.setImage(s.result.toString())})),s.readAsDataURL(t)}const i=["png","jpg","jpeg","gif"];let o=t.target.files,n=o.length;for(let t=0;t<n;t++){let e=o[t].name.split(".");if(e=e[e.length-1],e=e.toLowerCase(),-1!=i.indexOf(e)){s(o[t]),this.m_path=o[t];break}}}};let r=null;function a(){return r||(r=new s.Component({tag:"input",style:{display:"none",id:"fileDialog"},attrs:{type:"file"}}),document.body.appendChild(r._build())),r.clearDomEvent("change"),r}e.openFile=function(t,e,s=!1){let i=a();i.removeAttribute("nwsaveas"),i.setAttribute("accept",t),i.setAttribute("multiple",s),i.setDomEvent("change",(t=>{let s=i.dom.files;e(s)})),i.dom.click()},e.saveFile=function(t,e,s){let i=a();i.setAttribute("nwsaveas",t),i.setAttribute("accept",e),i.setDomEvent("change",(t=>{let e=i.dom.files;s(e[0])})),i.dom.click()}})),define("x4/md5",["require","exports"],(function(t,e){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Md5=void 0;class Md5{static hashStr(t,e=!1){return this.onePassHasher.start().appendStr(t).end(e)}static hashAsciiStr(t,e=!1){return this.onePassHasher.start().appendAsciiStr(t).end(e)}static stateIdentity=new Int32Array([1732584193,-271733879,-1732584194,271733878]);static buffer32Identity=new Int32Array([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]);static hexChars="0123456789abcdef";static hexOut=[];static onePassHasher=new Md5;static _hex(t){const e=Md5.hexChars,s=Md5.hexOut;let i,o,n,r;for(r=0;r<4;r+=1)for(o=8*r,i=t[r],n=0;n<8;n+=2)s[o+1+n]=e.charAt(15&i),i>>>=4,s[o+0+n]=e.charAt(15&i),i>>>=4;return s.join("")}static _md5cycle(t,e){let s=t[0],i=t[1],o=t[2],n=t[3];s+=(i&o|~i&n)+e[0]-680876936|0,s=(s<<7|s>>>25)+i|0,n+=(s&i|~s&o)+e[1]-389564586|0,n=(n<<12|n>>>20)+s|0,o+=(n&s|~n&i)+e[2]+606105819|0,o=(o<<17|o>>>15)+n|0,i+=(o&n|~o&s)+e[3]-1044525330|0,i=(i<<22|i>>>10)+o|0,s+=(i&o|~i&n)+e[4]-176418897|0,s=(s<<7|s>>>25)+i|0,n+=(s&i|~s&o)+e[5]+1200080426|0,n=(n<<12|n>>>20)+s|0,o+=(n&s|~n&i)+e[6]-1473231341|0,o=(o<<17|o>>>15)+n|0,i+=(o&n|~o&s)+e[7]-45705983|0,i=(i<<22|i>>>10)+o|0,s+=(i&o|~i&n)+e[8]+1770035416|0,s=(s<<7|s>>>25)+i|0,n+=(s&i|~s&o)+e[9]-1958414417|0,n=(n<<12|n>>>20)+s|0,o+=(n&s|~n&i)+e[10]-42063|0,o=(o<<17|o>>>15)+n|0,i+=(o&n|~o&s)+e[11]-1990404162|0,i=(i<<22|i>>>10)+o|0,s+=(i&o|~i&n)+e[12]+1804603682|0,s=(s<<7|s>>>25)+i|0,n+=(s&i|~s&o)+e[13]-40341101|0,n=(n<<12|n>>>20)+s|0,o+=(n&s|~n&i)+e[14]-1502002290|0,o=(o<<17|o>>>15)+n|0,i+=(o&n|~o&s)+e[15]+1236535329|0,i=(i<<22|i>>>10)+o|0,s+=(i&n|o&~n)+e[1]-165796510|0,s=(s<<5|s>>>27)+i|0,n+=(s&o|i&~o)+e[6]-1069501632|0,n=(n<<9|n>>>23)+s|0,o+=(n&i|s&~i)+e[11]+643717713|0,o=(o<<14|o>>>18)+n|0,i+=(o&s|n&~s)+e[0]-373897302|0,i=(i<<20|i>>>12)+o|0,s+=(i&n|o&~n)+e[5]-701558691|0,s=(s<<5|s>>>27)+i|0,n+=(s&o|i&~o)+e[10]+38016083|0,n=(n<<9|n>>>23)+s|0,o+=(n&i|s&~i)+e[15]-660478335|0,o=(o<<14|o>>>18)+n|0,i+=(o&s|n&~s)+e[4]-405537848|0,i=(i<<20|i>>>12)+o|0,s+=(i&n|o&~n)+e[9]+568446438|0,s=(s<<5|s>>>27)+i|0,n+=(s&o|i&~o)+e[14]-1019803690|0,n=(n<<9|n>>>23)+s|0,o+=(n&i|s&~i)+e[3]-187363961|0,o=(o<<14|o>>>18)+n|0,i+=(o&s|n&~s)+e[8]+1163531501|0,i=(i<<20|i>>>12)+o|0,s+=(i&n|o&~n)+e[13]-1444681467|0,s=(s<<5|s>>>27)+i|0,n+=(s&o|i&~o)+e[2]-51403784|0,n=(n<<9|n>>>23)+s|0,o+=(n&i|s&~i)+e[7]+1735328473|0,o=(o<<14|o>>>18)+n|0,i+=(o&s|n&~s)+e[12]-1926607734|0,i=(i<<20|i>>>12)+o|0,s+=(i^o^n)+e[5]-378558|0,s=(s<<4|s>>>28)+i|0,n+=(s^i^o)+e[8]-2022574463|0,n=(n<<11|n>>>21)+s|0,o+=(n^s^i)+e[11]+1839030562|0,o=(o<<16|o>>>16)+n|0,i+=(o^n^s)+e[14]-35309556|0,i=(i<<23|i>>>9)+o|0,s+=(i^o^n)+e[1]-1530992060|0,s=(s<<4|s>>>28)+i|0,n+=(s^i^o)+e[4]+1272893353|0,n=(n<<11|n>>>21)+s|0,o+=(n^s^i)+e[7]-155497632|0,o=(o<<16|o>>>16)+n|0,i+=(o^n^s)+e[10]-1094730640|0,i=(i<<23|i>>>9)+o|0,s+=(i^o^n)+e[13]+681279174|0,s=(s<<4|s>>>28)+i|0,n+=(s^i^o)+e[0]-358537222|0,n=(n<<11|n>>>21)+s|0,o+=(n^s^i)+e[3]-722521979|0,o=(o<<16|o>>>16)+n|0,i+=(o^n^s)+e[6]+76029189|0,i=(i<<23|i>>>9)+o|0,s+=(i^o^n)+e[9]-640364487|0,s=(s<<4|s>>>28)+i|0,n+=(s^i^o)+e[12]-421815835|0,n=(n<<11|n>>>21)+s|0,o+=(n^s^i)+e[15]+530742520|0,o=(o<<16|o>>>16)+n|0,i+=(o^n^s)+e[2]-995338651|0,i=(i<<23|i>>>9)+o|0,s+=(o^(i|~n))+e[0]-198630844|0,s=(s<<6|s>>>26)+i|0,n+=(i^(s|~o))+e[7]+1126891415|0,n=(n<<10|n>>>22)+s|0,o+=(s^(n|~i))+e[14]-1416354905|0,o=(o<<15|o>>>17)+n|0,i+=(n^(o|~s))+e[5]-57434055|0,i=(i<<21|i>>>11)+o|0,s+=(o^(i|~n))+e[12]+1700485571|0,s=(s<<6|s>>>26)+i|0,n+=(i^(s|~o))+e[3]-1894986606|0,n=(n<<10|n>>>22)+s|0,o+=(s^(n|~i))+e[10]-1051523|0,o=(o<<15|o>>>17)+n|0,i+=(n^(o|~s))+e[1]-2054922799|0,i=(i<<21|i>>>11)+o|0,s+=(o^(i|~n))+e[8]+1873313359|0,s=(s<<6|s>>>26)+i|0,n+=(i^(s|~o))+e[15]-30611744|0,n=(n<<10|n>>>22)+s|0,o+=(s^(n|~i))+e[6]-1560198380|0,o=(o<<15|o>>>17)+n|0,i+=(n^(o|~s))+e[13]+1309151649|0,i=(i<<21|i>>>11)+o|0,s+=(o^(i|~n))+e[4]-145523070|0,s=(s<<6|s>>>26)+i|0,n+=(i^(s|~o))+e[11]-1120210379|0,n=(n<<10|n>>>22)+s|0,o+=(s^(n|~i))+e[2]+718787259|0,o=(o<<15|o>>>17)+n|0,i+=(n^(o|~s))+e[9]-343485551|0,i=(i<<21|i>>>11)+o|0,t[0]=s+t[0]|0,t[1]=i+t[1]|0,t[2]=o+t[2]|0,t[3]=n+t[3]|0}_dataLength;_bufferLength;_state=new Int32Array(4);_buffer=new ArrayBuffer(68);_buffer8;_buffer32;constructor(){this._buffer8=new Uint8Array(this._buffer,0,68),this._buffer32=new Uint32Array(this._buffer,0,17),this.start()}start(){return this._dataLength=0,this._bufferLength=0,this._state.set(Md5.stateIdentity),this}appendStr(t){const e=this._buffer8,s=this._buffer32;let i,o,n=this._bufferLength;for(o=0;o<t.length;o+=1){if(i=t.charCodeAt(o),i<128)e[n++]=i;else if(i<2048)e[n++]=192+(i>>>6),e[n++]=63&i|128;else if(i<55296||i>56319)e[n++]=224+(i>>>12),e[n++]=i>>>6&63|128,e[n++]=63&i|128;else{if(i=1024*(i-55296)+(t.charCodeAt(++o)-56320)+65536,i>1114111)throw new Error("Unicode standard supports code points up to U+10FFFF");e[n++]=240+(i>>>18),e[n++]=i>>>12&63|128,e[n++]=i>>>6&63|128,e[n++]=63&i|128}n>=64&&(this._dataLength+=64,Md5._md5cycle(this._state,s),n-=64,s[0]=s[16])}return this._bufferLength=n,this}appendAsciiStr(t){const e=this._buffer8,s=this._buffer32;let i,o=this._bufferLength,n=0;for(;;){for(i=Math.min(t.length-n,64-o);i--;)e[o++]=t.charCodeAt(n++);if(o<64)break;this._dataLength+=64,Md5._md5cycle(this._state,s),o=0}return this._bufferLength=o,this}appendByteArray(t){const e=this._buffer8,s=this._buffer32;let i,o=this._bufferLength,n=0;for(;;){for(i=Math.min(t.length-n,64-o);i--;)e[o++]=t[n++];if(o<64)break;this._dataLength+=64,Md5._md5cycle(this._state,s),o=0}return this._bufferLength=o,this}getState(){const t=this,e=t._state;return{buffer:String.fromCharCode.apply(null,t._buffer8),buflen:t._bufferLength,length:t._dataLength,state:[e[0],e[1],e[2],e[3]]}}setState(t){const e=t.buffer,s=t.state,i=this._state;let o;for(this._dataLength=t.length,this._bufferLength=t.buflen,i[0]=s[0],i[1]=s[1],i[2]=s[2],i[3]=s[3],o=0;o<e.length;o+=1)this._buffer8[o]=e.charCodeAt(o)}end(t=!1){const e=this._bufferLength,s=this._buffer8,i=this._buffer32,o=1+(e>>2);let n;if(this._dataLength+=e,s[e]=128,s[e+1]=s[e+2]=s[e+3]=0,i.set(Md5.buffer32Identity.subarray(o),o),e>55&&(Md5._md5cycle(this._state,i),i.set(Md5.buffer32Identity)),n=8*this._dataLength,n<=4294967295)i[14]=n;else{const t=n.toString(16).match(/(.*?)(.{0,8})$/);if(null===t)return;const e=parseInt(t[2],16),s=parseInt(t[1],16)||0;i[14]=e,i[15]=s}return Md5._md5cycle(this._state,i),t?this._state:Md5._hex(this._state)}}e.Md5=Md5})),define("x4/rating",["require","exports","x4/component","x4/layout","x4/input","x4/x4_events"],(function(t,e,s,i,o,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Rating=void 0;class Rating extends i.HLayout{m_els;m_input;constructor(t){super(t),t.steps=t.steps??5}render(t){let e=t.shape??"star",i=t.value??0;this.m_input=new o.Input({cls:"@hidden",name:t.name,value:""+i}),this.addClass(e),this.setDomEvent("click",(t=>this._onclick(t))),this.m_els=[];for(let e=0;e<t.steps;e++){let t="item";e+1<=i&&(t+=" checked");let o=new s.Component({tag:"option",cls:t,data:{value:e+1}});this.m_els.push(o)}this.m_els.push(this.m_input),this.setContent(this.m_els)}getValue(){return this.m_props.value??0}set value(t){this.m_props.value=t;for(let e=0;e<this.m_props.steps;e++)this.m_els[e].setClass("checked",this.m_els[e].getData("value")<=t);this.m_input.value=""+this.m_props.value}set steps(t){this.m_props.steps=t,this.update()}set shape(t){this.removeClass(this.m_props.shape),this.m_props.shape=t,this.addClass(this.m_props.shape)}_onclick(t){let e=!0;for(let i=this.dom.firstChild;i;i=i.nextSibling){let o=s.Component.getElement(i);o.setClass("checked",e),i==t.target&&(this.m_input.value=o.getData("value"),e=!1)}this.emit("change",(0,n.EvChange)(this.m_props.value))}}e.Rating=Rating})),define("x4/svgcomponent",["require","exports","x4/component"],(function(t,e,s){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.SVGComponent=e.SVGPathBuilder=void 0;e.SVGPathBuilder=class SVGPathBuilder{m_path;m_attrs;constructor(){this.clear()}moveTo(t,e){return this.m_path+=`M${t} ${e}`,this}lineTo(t,e){return this.m_path+=`L${t} ${e}`,this}attr(t,e){return this.m_attrs.set(t,e),this}render(t=!0){let e='<path d="'+this.m_path+'"';return this.m_attrs.forEach(((t,s)=>{e+=` ${s} = "${t}"`})),e+="></path>",t&&this.clear(),e}clear(){this.m_path="",this.m_attrs=new Map}};class SVGComponent extends s.Component{constructor(t){super(t),this.setProp("tag","svg"),this.setProp("namespace","http://www.w3.org/2000/svg"),this.setProp("xmlns","http://www.w3.org/2000/svg"),this.setAttributes({viewBox:t.viewBox}),this.setContent(t.path)}}e.SVGComponent=SVGComponent})),define("x4/texthiliter",["require","exports","x4/component"],(function(t,e,s){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.TextHiliter=void 0;class TextHiliter extends s.Component{m_text;m_ed;m_hi;m_top;m_kwList;constructor(t){super(t),this.m_kwList=t.kwList,this.m_top=0,this.m_text=t.text??"",this.mapPropEvents(t,"change")}render(){this.setContent([this.m_hi=new s.Component({tag:"span",cls:"@fit @syntax-hiliter"}),this.m_ed=new s.Component({tag:"textarea",cls:"@fit",width:"100%",attrs:{spellcheck:"false",wrap:"off"},dom_events:{input:()=>this._hiliteText(),scroll:()=>this._updateScroll(),keydown:t=>this._keydown(t)}})])}componentCreated(){super.componentCreated(),this.value=this.m_text}get value(){return this.dom?this.m_ed.dom.value:this.m_text}set value(t){this.dom&&(this.m_ed.dom.value=t),this.m_text=t,this._hiliteText()}_keydown(t){if("Tab"==t.key){t.preventDefault(),t.stopPropagation();let e=this.m_ed.dom,s=e.selectionStart,i=e.selectionEnd;e.setRangeText("\t",s,i),e.setSelectionRange(s+1,s+1),e.dispatchEvent(new Event("input"))}else"Enter"==t.key&&t.stopPropagation()}_hiliteText(){let t=this.m_ed.dom.value;this.m_hi.dom.firstChild||(this.m_hi.dom.innerHTML='<div style="position:absolute"></div>'),this.m_hi.dom.firstChild.innerHTML=this._tokenize(t)}_updateScroll(){this.startTimer("sync",0,!1,(()=>{let t=this.m_ed.dom.scrollTop;t!=this.m_top&&(this.m_hi.dom.scrollTop=t,this.m_top=t),this.m_hi.dom.scrollLeft=this.m_ed.dom.scrollLeft}))}_escape(t){return t=(t=(t=t.replace(/&/gm,"&amp;")).replace(/</gm,"&lt;")).replace(/>/gm,"&gt;")}_tokenize(t){const e=/\d/,s=/[\d.]/,i=/\+|-|,|\/|\*|=|%|!|\||;|\.|\[|\]|\{|\|\(|\)|}|<|>|&/,o=/[a-zA-Z_]/,n=/[a-zA-Z0-9_]/;let r,a="",l=0,h=t.length;for(console.time("hilite");l<h;){let c=t.charAt(l);if(e.test(c)){let e=l;do{c=t.charAt(++l)}while(s.test(c)&&l<h);a+='<span class="num">'+t.substring(e,l)+"</span>"}else if(this.m_kwList&&o.test(c)){let e=l;do{c=t.charAt(++l)}while(n.test(c)&&l<h);let s=t.substring(e,l);this.m_kwList.has(s)?a+='<span class="kword">'+s+"</span>":a+=s}else if("#"!=c){if("/"==c){let e=t.charAt(l+1);if("*"==e){let e=t.indexOf("*/",l+2);e<0&&(e=t.length),a+='<span class="cmt">'+this._escape(t.substring(l,e+2))+"</span>",l=e+2;continue}if("/"==e){let e=t.indexOf("\n",l+2);e<0&&(e=t.length),a+=`<span class="cmt">${this._escape(t.substring(l,e))}</span>`,l=e;continue}}if(i.test(c)){r=l;do{c=t.charAt(++l)}while(i.test(c)&&l<h);a+=`<span class="punc">${t.substring(r,l)}</span>`}else if('"'!=c&&"'"!=c&&"`"!=c)l++,a+=c;else{r=l;let e=c;do{c=t.charAt(++l)}while(c!=e&&l<h);a+=`<span class="str">${this._escape(t.substring(r,++l))}</span>`}}else{let e=t.indexOf("\n",l+1);e<0&&(e=t.length),a+='<span class="cmt">'+this._escape(t.substring(l,e))+"</span>",l=e}}return console.timeEnd("hilite"),a+"\n\n\n"}}e.TextHiliter=TextHiliter}));